import AVFoundation
import Foundation
import os

// REVIEW: Use a Value Type for presets. See SF2Preset

final class SoundFontNotePlayer: NotePlayer {

    // MARK: - Logger

    private let logger = Logger(subsystem: "com.peach.app", category: "SoundFontNotePlayer")

    // MARK: - Audio Components

    private let engine: AVAudioEngine
    private let sampler: AVAudioUnitSampler

    // MARK: - State

    private var isSessionConfigured = false
    private var loadedProgram: Int
    private var loadedBank: Int

    // MARK: - Constants

    static let channel: UInt8 = 0
    private static let defaultBankMSB: UInt8 = 0x79 // kAUSampler_DefaultMelodicBankMSB
    static let pitchBendCenter: UInt16 = 8192
    static let validFrequencyRange = 20.0...20000.0

    // Default SF2 preset: Sine Wave (bank 8, program 80, tag "sf2:8:80")
    private static let defaultPresetProgram: Int = 80
    private static let defaultPresetBank: Int = 8

    // MARK: - SF2 URL

    private let sf2URL: URL

    // MARK: - Initialization

    init(sf2Name: String = "GeneralUser-GS") throws {
        guard let sf2URL = Bundle.main.url(forResource: sf2Name, withExtension: "sf2") else {
            throw AudioError.contextUnavailable
        }

        self.sf2URL = sf2URL
        self.engine = AVAudioEngine()
        self.sampler = AVAudioUnitSampler()
        self.loadedProgram = Self.defaultPresetProgram
        self.loadedBank = Self.defaultPresetBank

        engine.attach(sampler)
        engine.connect(sampler, to: engine.mainMixerNode, format: nil)

        try engine.start()
        try sampler.loadSoundBankInstrument(
            at: sf2URL,
            program: UInt8(Self.defaultPresetProgram),
            bankMSB: Self.defaultBankMSB,
            bankLSB: UInt8(Self.defaultPresetBank)
        )

        sendPitchBendRange()

        logger.info("SoundFontNotePlayer initialized with \(sf2Name).sf2, program \(Self.defaultPresetProgram)")
    }

    // MARK: - Preset Switching

    func loadPreset(program: Int, bank: Int = 0) async throws {
        guard (0...127).contains(program) else {
            throw AudioError.invalidPreset("Program \(program) outside valid MIDI range 0-127")
        }
        guard (0...127).contains(bank) else {
            throw AudioError.invalidPreset("Bank \(bank) outside valid range 0-127")
        }
        guard program != loadedProgram || bank != loadedBank else { return }

        try sampler.loadSoundBankInstrument(
            at: sf2URL,
            program: UInt8(clamping: program),
            bankMSB: Self.defaultBankMSB,
            bankLSB: UInt8(clamping: bank)
        )

        loadedProgram = program
        loadedBank = bank

        sendPitchBendRange()

        // Allow audio graph to settle after instrument load â€” without this delay
        // the first MIDI note-on after a preset switch produces no sound.
        try await Task.sleep(for: .milliseconds(20))

        logger.info("Loaded preset bank \(bank) program \(program)")
    }

    // MARK: - NotePlayer Protocol

    func play(frequency: Double, velocity: UInt8, amplitudeDB: Float) async throws -> PlaybackHandle {
        // Select preset from UserDefaults sound source setting
        let source = UserDefaults.standard.string(forKey: SettingsKeys.soundSource)
            ?? SettingsKeys.defaultSoundSource

        if let (bank, program) = Self.parseSF2Tag(from: source) {
            do {
                try await loadPreset(program: program, bank: bank)
            } catch {
                try await loadPreset(program: Self.defaultPresetProgram, bank: Self.defaultPresetBank)
            }
        } else {
            try await loadPreset(program: Self.defaultPresetProgram, bank: Self.defaultPresetBank)
        }

        // Validate inputs
        guard Self.validFrequencyRange.contains(frequency) else {
            throw AudioError.invalidFrequency(
                "Frequency \(frequency) Hz is outside valid range \(Self.validFrequencyRange)"
            )
        }
        guard velocity >= 1, velocity <= 127 else {
            throw AudioError.invalidVelocity(
                "Velocity \(velocity) is outside valid MIDI range 1-127"
            )
        }
        guard (-90.0...12.0).contains(amplitudeDB) else {
            throw AudioError.invalidAmplitude(
                "Amplitude \(amplitudeDB) dB is outside valid range -90.0...12.0"
            )
        }

        // Configure audio session once
        if !isSessionConfigured {
            let session = AVAudioSession.sharedInstance()
            try session.setCategory(.playback, mode: .default, options: [])
            try session.setActive(true)
            isSessionConfigured = true
        }

        if !engine.isRunning {
            try engine.start()
        }

        let conversion = FrequencyCalculation.midiNoteAndCents(frequency: frequency)
        let clampedNote = conversion.midiNote.clamped(to: 0...127)
        let midiNote = UInt8(clampedNote)
        let bendValue = Self.pitchBendValue(forCents: conversion.cents)

        // Set volume offset (independent of MIDI velocity)
        sampler.overallGain = amplitudeDB

        // Apply pitch bend before starting note
        sampler.sendPitchBend(bendValue, onChannel: Self.channel)
        sampler.startNote(midiNote, withVelocity: velocity, onChannel: Self.channel)

        return SoundFontPlaybackHandle(sampler: sampler, midiNote: midiNote, channel: Self.channel)
    }

    func stopAll() async throws {
        sampler.sendController(123, withValue: 0, onChannel: Self.channel)
        sampler.sendPitchBend(Self.pitchBendCenter, onChannel: Self.channel)
    }

    // MARK: - MIDI Helpers

    private func sendPitchBendRange() {
        sampler.sendController(101, withValue: 0, onChannel: Self.channel)
        sampler.sendController(100, withValue: 0, onChannel: Self.channel)
        sampler.sendController(6, withValue: 2, onChannel: Self.channel)
        sampler.sendController(38, withValue: 0, onChannel: Self.channel)
    }

    // MARK: - Static Helpers

    nonisolated static func parseSF2Tag(from source: String) -> (bank: Int, program: Int)? {
        guard source.hasPrefix("sf2:") else { return nil }
        let parts = source.dropFirst(4).split(separator: ":")
        guard parts.count == 2,
              let bank = Int(parts[0]),
              let program = Int(parts[1]) else { return nil }
        return (bank: bank, program: program)
    }

    nonisolated static func pitchBendValue(forCents cents: Double) -> UInt16 {
        let raw = Int(8192.0 + cents * 8192.0 / 200.0)
        let clamped = raw.clamped(to: 0...16383)
        return UInt16(clamped)
    }

}
