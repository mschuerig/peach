# Retrospective: Epics 19 & 20 — Dependency Management

**Date:** 2026-02-27
**Facilitator:** Bob (Scrum Master)
**Participants:** Michael (Project Lead), Winston (Architect), Amelia (Developer), Quinn (QA)
**Focus:** How to help dev agents manage dependencies better

---

## Epics Reviewed

- **Epic 19:** Clean Foundations — Code Review Refactoring (5 stories, all done)
- **Epic 20:** Right Direction — Dependency Inversion Cleanup (11 stories, all done)

---

## Problem Statement

Across all 16 stories in Epics 19 and 20, every story required a "Fix code review findings" commit. Dependency direction violations were a recurring theme in those fixes, and they were mostly flagged by Michael during manual review — not by the review agent.

The dev agents satisfy literal acceptance criteria but don't evaluate the dependency graph holistically. The review agent checks code quality and AC fulfillment but lacks a systematic dependency checklist.

---

## Specific Dependency Issues Found

### Design-Level (requires judgment)

1. **Story 20.10** — Dev agent injected `TrainingDataStore` into SettingsScreen but left the view orchestrating resets across `ComparisonSession`, `PerceptualProfile`, and `TrainingDataStore`. Fix: moved reset coordination into a closure owned by `PeachApp`, reducing SettingsScreen's `@Environment` surface from 4 dependencies to 2.

2. **Story 19.5** — `VerticalPitchSlider` retained domain knowledge (cent ranges, frequency conversion) instead of being a pure UI component with a normalized `-1.0...1.0` API. `commitResult()` was public when only called internally. Dead method `adjustFrequency()` remained.

3. **Story 20.5** — Dev agent changed parameter types from concrete to protocol but didn't add protocol-validation tests to prove the abstraction works independently.

4. **Story 20.1** — Pure file moves without tests verifying the types work in their new location.

### Import-Level (mechanically detectable)

5. **Story 20.6** — `import Foundation` left in a pure protocol file (`TrainingSession.swift`) where no Foundation types were used.

6. **Pre-Epic 20 state** — SwiftUI imports in Core/ files, SwiftData import in SettingsScreen, UIKit import in AudioSessionInterruptionMonitor, cross-feature reference to `ComparisonFeedbackIndicator.defaultIconSize`.

---

## Root Cause Analysis

Two categories of dependency problems:

| Category | Description | Detectable by |
|----------|-------------|---------------|
| Import-level | Wrong framework imported in wrong layer | Script/linter |
| Design-level | View orchestrates too many services, public API wider than needed, component retains domain knowledge it shouldn't have | Review checklist + judgment |

The dev agent optimizes for "does it compile and pass tests" rather than "is the dependency graph clean." The review agent's instructions include "dependency problems" in a fallback list but don't provide a systematic checklist for evaluating them.

---

## Action Items Delivered

### 1. Mechanical Enforcement: `tools/check-dependencies.sh`

Shell script enforcing 6 rules:

| # | Rule | Would have caught |
|---|------|-------------------|
| 1 | Core/ must not import SwiftUI, UIKit, or Charts | SwiftUI in Core/ files (pre-Epic 20) |
| 2 | `import SwiftData` only in Core/Data/ and App/ | SwiftData in SettingsScreen |
| 3 | `import UIKit` only in HapticFeedbackManager and App/ | UIKit in AudioSessionInterruptionMonitor |
| 4 | No `import Combine` anywhere | Future violations |
| 5 | No cross-feature Screen type references (Start/ exempt as router) | Future violations |
| 6 | PitchMatching/ must not reference ComparisonFeedbackIndicator | Cross-feature icon size dependency (story 20.4) |

Passes clean on current codebase. Can be run manually or added to pre-commit hook.

### 2. Design-Level Rules: `project-context.md` update

Added "Dependency Direction Rules" section read by both dev and review agents:

- **Views must not orchestrate services** — wrap multi-service coordination in a closure at the composition root
- **Minimize `@Environment` surface** — if a view only uses a dependency to pass it through, the dependency belongs higher up
- **Public API must be intentional** — default to `private`; unnecessary `internal` surface creates accidental coupling
- Points agents to run `tools/check-dependencies.sh`

---

## Recommendations for Future Epics

1. **Run `tools/check-dependencies.sh` as part of the dev workflow** — after implementation, before marking a story ready for review
2. **Extend the script as new rules emerge** — the cross-feature type check (rule 5/6) can be expanded with known type names as the codebase grows
3. **Consider adding the script to a pre-commit hook** if dependency violations recur despite the documentation
4. **Review agent should ask these questions for every story:**
   - For each `@Environment` dependency in a view: does this view *need* this, or is it pass-through?
   - For each public method: is this called from outside the file?
   - For each import: is every imported module actually used?
   - If a view coordinates multiple services: should that coordination live in the composition root instead?

---

## Files Changed

- `tools/check-dependencies.sh` — new, dependency rule enforcement script
- `docs/project-context.md` — added Dependency Direction Rules section
