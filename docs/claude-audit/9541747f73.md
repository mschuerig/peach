---
commit: "9541747f73ae15fdc381a0d167119a2c36c9c012"
date: "2026-02-24T20:58:45+01:00"
author: "Michael Sch√ºrig <michael@schuerig.de>"
subject: "Upgrade to Swift 6.2 with default MainActor isolation and @Entry environment keys"
sessions: ["f23eb6e0-abb3-4ee5-bd5f-fa9a85d8f9e1"]
prev: "2dcc50f0b2.md"
next: "3cb6ee7628.md"
---

[‚Üê Previous (2dcc50f0b2)](2dcc50f0b2.md) | [Index](index.md) | [Next (3cb6ee7628) ‚Üí](3cb6ee7628.md)

# Commit 9541747f73

**Date:** 2026-02-24 20:58:45 UTC+01:00  
**Author:** Michael Sch√ºrig <michael@schuerig.de>

## Commit message

Upgrade to Swift 6.2 with default MainActor isolation and @Entry environment keys

Replace all 5 nonisolated(unsafe) EnvironmentKey blocks with @Entry macros,
eliminating ~60 lines of unsafe boilerplate (resolves U3 and D2 from future-work.md).
Remove all redundant @MainActor annotations across 55 source and test files
(~160 occurrences) since default MainActor isolation makes them implicit.
Keep only the 2 Task { @MainActor ... } annotations in notification callbacks
and the 3 nonisolated annotations on pure static functions.

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>

## Changed files

```
Peach.xcodeproj/project.pbxproj                    | 12 ++--
 Peach/Core/Algorithm/AdaptiveNoteStrategy.swift    |  1 -
 Peach/Core/Algorithm/KazezNoteStrategy.swift       |  1 -
 Peach/Core/Algorithm/NextNoteStrategy.swift        |  1 -
 Peach/Core/Audio/NotePlayer.swift                  |  1 -
 Peach/Core/Audio/SoundFontLibrary.swift            | 17 +----
 Peach/Core/Audio/SoundFontNotePlayer.swift         |  1 -
 Peach/Core/Data/ComparisonRecordStoring.swift      |  1 -
 Peach/Core/Data/TrainingDataStore.swift            |  1 -
 Peach/Core/Profile/PerceptualProfile.swift         |  1 -
 Peach/Core/Profile/ThresholdTimeline.swift         | 17 +----
 Peach/Core/Profile/TrendAnalyzer.swift             | 17 +----
 Peach/Profile/ProfileScreen.swift                  | 17 +----
 Peach/Profile/SummaryStatisticsView.swift          |  1 -
 Peach/Training/ComparisonObserver.swift            |  1 -
 Peach/Training/HapticFeedbackManager.swift         |  3 -
 Peach/Training/TrainingScreen.swift                | 41 ++++--------
 Peach/Training/TrainingSession.swift               |  1 -
 .../AdaptiveNoteStrategyRegionalTests.swift        |  1 -
 .../Core/Algorithm/AdaptiveNoteStrategyTests.swift |  1 -
 .../Core/Algorithm/KazezNoteStrategyTests.swift    |  1 -
 .../Core/Audio/FrequencyCalculationTests.swift     | 74 +++++++++++-----------
 PeachTests/Core/Audio/SF2PresetParserTests.swift   | 20 +++---
 PeachTests/Core/Audio/SoundFontLibraryTests.swift  | 28 ++++----
 .../Core/Audio/SoundFontNotePlayerTests.swift      | 62 +++++++++---------
 .../Core/Data/TrainingDataStoreEdgeCaseTests.swift |  7 --
 PeachTests/Core/Data/TrainingDataStoreTests.swift  | 10 ---
 .../Core/Profile/PerceptualProfileTests.swift      |  1 -
 .../Core/Profile/ThresholdTimelineTests.swift      |  1 -
 PeachTests/Profile/ProfileScreenLayoutTests.swift  |  1 -
 PeachTests/Profile/ProfileScreenTests.swift        |  1 -
 PeachTests/Profile/SummaryStatisticsTests.swift    |  1 -
 PeachTests/Profile/TrendAnalyzerTests.swift        |  1 -
 PeachTests/Settings/SettingsTests.swift            |  3 -
 PeachTests/Start/ProfilePreviewViewTests.swift     |  1 -
 PeachTests/Start/StartScreenLayoutTests.swift      |  1 -
 PeachTests/Start/StartScreenTests.swift            |  1 -
 .../Training/DifficultyDisplayViewTests.swift      |  1 -
 PeachTests/Training/MockNextNoteStrategy.swift     |  1 -
 PeachTests/Training/MockNotePlayer.swift           |  1 -
 PeachTests/Training/MockTrainingDataStore.swift    |  1 -
 .../TrainingScreenAccessibilityTests.swift         |  1 -
 .../Training/TrainingScreenFeedbackTests.swift     |  7 --
 .../Training/TrainingScreenLayoutTests.swift       |  1 -
 .../TrainingSessionAudioInterruptionTests.swift    | 11 ----
 .../Training/TrainingSessionDifficultyTests.swift  |  1 -
 .../Training/TrainingSessionFeedbackTests.swift    |  7 --
 .../Training/TrainingSessionIntegrationTests.swift | 13 ----
 .../Training/TrainingSessionLifecycleTests.swift   | 10 ---
 .../Training/TrainingSessionResetTests.swift       |  5 --
 .../Training/TrainingSessionSettingsTests.swift    |  4 --
 PeachTests/Training/TrainingSessionTests.swift     | 11 ----
 .../TrainingSessionUserDefaultsTests.swift         |  5 --
 PeachTests/Training/TrainingTestHelpers.swift      |  4 --
 docs/arc42/11-risks-and-technical-debt.md          |  4 +-
 docs/implementation-artifacts/future-work.md       | 29 ++-------
 docs/project-context.md                            | 21 +++---
 57 files changed, 137 insertions(+), 352 deletions(-)
```

## Session `f23eb6e0‚Ä¶`

*2026-02-24 17:57:27 UTC ‚Üí 2026-02-24 19:59:31 UTC*

### üßë Human (17:57:27)

<command-message>bmad-bmm-code-review</command-message>
<command-name>/bmad-bmm-code-review</command-name>
<command-args>In the past we had some issues with concurrency and isolation. There is an issue in future-work.md: "U3: `nonisolated(unsafe)` Environment Key Pattern". Please check if this is still relevant or can be simplified. For research, read this article:https://www.donnywals.com/should-you-opt-in-to-swift-6-2s-main-actor-isolation/</command-args>

### ü§ñ Assistant (17:57:35)

Let me find the future-work.md and load the remaining workflow files.

### ü§ñ Assistant (17:57:50)

Now let me load the relevant code files and the article for research. This is a focused code review on issue U3 (`nonisolated(unsafe)` Environment Key Pattern).

### ü§ñ Assistant (17:58:17)

Let me also check for any other environment keys and the project's Swift/Xcode settings.

### ü§ñ Assistant (17:58:29)

Let me check the project's Swift version and whether default MainActor isolation is already enabled.

### ü§ñ Assistant (17:59:12)

Let me research the Swift 6.2 / iOS 26 specifics for EnvironmentKey and check one more file.

### ü§ñ Assistant (18:01:24)

Let me check the init signatures of these `@MainActor` types to understand if `@Entry` can work.

### ü§ñ Assistant (18:02:38)

Now I have everything I need. Let me present the review findings.

---

## Code Review: U3 ‚Äî `nonisolated(unsafe)` Environment Key Pattern

**Reviewer:** Code Review Workflow
**Scope:** Issue U3 from `future-work.md` + article research
**Date:** 2026-02-24

---

### Finding 1: U3 is Still Relevant ‚Äî And Has Grown

**Severity:** MEDIUM (unchanged)

The issue is **still present and has expanded**. The `future-work.md` documents **3 occurrences**, but there are now **5**:

| # | Key | File | Line |
|---|-----|------|------|
| 1 | `TrainingSessionKey` | `Peach/Training/TrainingScreen.swift` | 162 |
| 2 | `PerceptualProfileKey` | `Peach/Profile/ProfileScreen.swift` | 103 |
| 3 | `TrendAnalyzerKey` | `Peach/Core/Profile/TrendAnalyzer.swift` | 92 |
| 4 | `ThresholdTimelineKey` | `Peach/Core/Profile/ThresholdTimeline.swift` | 127 |
| 5 | `SoundFontLibraryKey` | `Peach/Core/Audio/SoundFontLibrary.swift` | 46 |

All 5 use the identical 8-line `nonisolated(unsafe)` + `MainActor.assumeIsolated()` pattern. The risk remains: if `EnvironmentKey.defaultValue` is ever accessed off the main thread internally by SwiftUI, it's undefined behavior.

---

### Finding 2: The Pattern CAN Be Simplified ‚Äî Two Paths Available

Based on the [Donny Wals article on Swift 6.2 MainActor isolation](https://www.donnywals.com/should-you-opt-in-to-swift-6-2s-main-actor-isolation/) and additional research:

#### Path A: Swift 6.2 Default MainActor Isolation (Recommended)

The project targets **iOS 26.0** (Xcode 26, Swift 6.2 compiler), but uses **Swift 6.0 language mode** (`SWIFT_VERSION = 6.0` in `project.pbxproj`). Upgrading to Swift 6.2 language mode with default MainActor isolation would make all code MainActor-isolated by default, which should resolve the protocol conformance tension ‚Äî `defaultValue` would naturally be in a MainActor context.

From the article:
> *"When you're in doubt, isolating to the Main Actor is a good default choice"* ‚Äî especially for app targets where most interactions occur on the main thread.

**Action:** Change `SWIFT_VERSION` from `6.0` to `6.2` in the Xcode project settings. Xcode 26 new projects get default MainActor isolation automatically. The pattern could then simplify to:

```swift
private struct TrendAnalyzerKey: EnvironmentKey {
    static var defaultValue = TrendAnalyzer()
}
```

No `nonisolated(unsafe)`, no `MainActor.assumeIsolated()`, no nested `@MainActor func`. The compiler knows the context is MainActor.

**Caveat:** This is a module-wide change that may surface other warnings/errors. Async functions would need explicit `@concurrent` (previously `nonisolated`) where background execution is intended. Needs a test-and-fix pass.

#### Path B: `@Entry` Macro (Simpler Syntax, May Also Fix Isolation)

Research from [fatbobman](https://fatbobman.com/en/posts/swiftui-environment-concepts-and-practice/) and [Avanderlee](https://www.avanderlee.com/swiftui/entry-macro-custom-environment-values/) indicates `@Entry` generates `defaultValue` as a computed property and "alleviates concurrency constraints for reference types." This would replace the 5 boilerplate blocks with:

```swift
extension EnvironmentValues {
    @Entry var trendAnalyzer = TrendAnalyzer()
    @Entry var perceptualProfile = PerceptualProfile()
    @Entry var thresholdTimeline = ThresholdTimeline()
    @Entry var soundFontLibrary = SoundFontLibrary()
}
```

`TrainingSessionKey` is more complex (mock dependencies for previews), but the real instance is always injected by `PeachApp.swift`, so a simple default would also work.

**Caveat:** Whether `@Entry` actually compiles with `@MainActor @Observable` inits under Swift 6.0 language mode needs to be tested. The macro's internal code generation may or may not handle the isolation correctly.

---

### Finding 3: `future-work.md` is Stale

**Severity:** LOW

- U3 lists **3** occurrences; there are now **5** (ThresholdTimeline and SoundFontLibrary were added later)
- D2 (boilerplate duplication) also lists 3; should be 5
- The line references in U3 are outdated (e.g., `TrainingScreen.swift:152` is now line 162)

---

### Recommendation

**Best approach: Combine Path A + Path B.**

1. Upgrade `SWIFT_VERSION` to `6.2` and enable default MainActor isolation (this is the project's natural trajectory given iOS 26 deployment target)
2. Replace all 5 `nonisolated(unsafe)` EnvironmentKey blocks with `@Entry` macros (eliminates both U3 and D2 in one move)
3. Fix any `@concurrent` annotations needed for async functions that should run off the main actor
4. Run full test suite to verify
5. Update `future-work.md` to mark U3 and D2 as resolved

This would eliminate ~40 lines of unsafe boilerplate across 5 files and remove the undefined-behavior risk entirely.

---

**Sources:**
- [Should you opt-in to Swift 6.2's Main Actor isolation? ‚Äî Donny Wals](https://www.donnywals.com/should-you-opt-in-to-swift-6-2s-main-actor-isolation/)
- [SwiftUI Environment Concepts and Practice ‚Äî fatbobman](https://fatbobman.com/en/posts/swiftui-environment-concepts-and-practice/)
- [@Entry macro: Creating custom environment values ‚Äî Avanderlee](https://www.avanderlee.com/swiftui/entry-macro-custom-environment-values/)
- [Default isolation with Swift 6.2 ‚Äî Matt Massicotte](https://www.massicotte.org/default-isolation-swift-6_2/)
- [SE-0411: Isolated default value expressions](https://www.massicotte.org/concurrency-swift-6-se-411/)
- [Swift 6: SwiftUI Environment ‚Äî simonnickel (GitHub gist)](https://gist.github.com/simonnickel/98091efcc33b052cc1932a8e90654012)

---

What should I do with these findings?

1. **Fix them automatically** ‚Äî I'll upgrade to `@Entry` and/or Swift 6.2, run tests, and update future-work.md
2. **Create action items** ‚Äî Add tasks to future-work.md for later
3. **Show me details** ‚Äî Deep dive into a specific approach

Choose [1], [2], [3], or specify which aspect to examine.

### üßë Human (19:23:28)

1. I agree with your recommendation.

### ü§ñ Assistant (19:23:57)

I'll implement the combined approach: `@Entry` macros to eliminate all 5 `nonisolated(unsafe)` blocks. Let me start by creating tasks and reading the full files I need to modify.

### ü§ñ Assistant (19:24:09)

Let me read the full files I need to modify to understand all context.

### ü§ñ Assistant (19:24:14)

Now let me read TrainingScreen.swift fully to understand the mock dependencies.

### ü§ñ Assistant (19:24:40)

Let me apply the `@Entry` changes to all 5 files. Starting with the 4 simple cases.

### ü§ñ Assistant (19:26:24)

Now let me handle the TrainingSession case. I'll replace the EnvironmentKey block with `@Entry` using the same mock factory.

### ü§ñ Assistant (19:26:35)

I see a SourceKit diagnostic suggesting `@Entry` may not handle `@MainActor` inits under Swift 6.0. Let me try building to get the real compiler verdict.

### ü§ñ Assistant (19:27:23)

As expected, `@Entry` alone doesn't solve the `@MainActor` init issue in Swift 6.0 ‚Äî the macro generates a nonisolated context. Let me try the Swift 6.2 upgrade path first.

### ü§ñ Assistant (19:28:55)

The `@Entry` macro generates a nonisolated context internally, so it can't call `@MainActor` inits under Swift 6.0. Let me try the Swift 6.2 upgrade path ‚Äî this should change how `@Entry` handles actor isolation.

### ü§ñ Assistant (19:29:01)

Now I'll upgrade `SWIFT_VERSION` to `6.2` and add `SWIFT_DEFAULT_ACTOR_ISOLATION = MainActor` for the Peach target. I'll keep the test target at `nonisolated` default to avoid cascading test issues initially.

### ü§ñ Assistant (19:29:13)

Now update the test target to Swift 6.2 as well (keeping `nonisolated` default for tests to avoid issues).

### ü§ñ Assistant (19:29:23)

Now let me also apply the `@Entry` change for TrainingSession and try to build.

### ü§ñ Assistant (19:29:38)

SourceKit diagnostics are likely stale. Let me do an actual build to get the real compiler result.

### ü§ñ Assistant (19:29:49)

Build succeeded with zero errors! Swift 6.2 + default MainActor isolation + `@Entry` works perfectly. Now let me run the full test suite.

### ü§ñ Assistant (19:30:12)

The app builds clean, but the test target needs default MainActor isolation too ‚Äî some test functions are missing explicit `@MainActor`. Let me add it to the test target.

### ü§ñ Assistant (19:32:59)

All 367 tests pass. Let me update the task and move to documentation.

### ü§ñ Assistant (19:33:04)

Now let me update `future-work.md` to mark U3 and D2 as resolved, and update the arc42 risks document.

### ü§ñ Assistant (19:33:28)

Now update the arc42 risks document.

### ü§ñ Assistant (19:33:39)

Now let me also update `project-context.md` to reflect the Swift 6.2 upgrade and the new `@Entry` pattern.

### ü§ñ Assistant (19:33:49)

Now update the `@Environment` rule and the "When Adding New Components" section to reference `@Entry`.

### ü§ñ Assistant (19:34:09)

Now let me also update the concurrency rules to reflect the default MainActor isolation.

### ü§ñ Assistant (19:34:22)

Now update the "Last Updated" date.

### ü§ñ Assistant (19:34:45)

All tasks complete. Here's a summary of everything that was done:

---

## Summary

### Changes Made

**Swift 6.2 Upgrade (project-wide)**
- `Peach.xcodeproj/project.pbxproj` ‚Äî `SWIFT_VERSION` changed from `6.0` to `6.2` for all 4 build configurations (Peach Debug/Release, PeachTests Debug/Release), and `SWIFT_DEFAULT_ACTOR_ISOLATION = MainActor` added to all 4 configurations

**5 `nonisolated(unsafe)` blocks replaced with `@Entry`**
- `Peach/Core/Profile/TrendAnalyzer.swift` ‚Äî 17 lines ‚Üí 3 lines
- `Peach/Core/Profile/ThresholdTimeline.swift` ‚Äî 19 lines ‚Üí 3 lines
- `Peach/Profile/ProfileScreen.swift` ‚Äî 18 lines ‚Üí 3 lines
- `Peach/Core/Audio/SoundFontLibrary.swift` ‚Äî 18 lines ‚Üí 3 lines
- `Peach/Training/TrainingScreen.swift` ‚Äî 29 lines ‚Üí 15 lines (TrainingSession has a more complex default)

**Documentation updated**
- `docs/implementation-artifacts/future-work.md` ‚Äî U3 and D2 marked as resolved
- `docs/arc42/11-risks-and-technical-debt.md` ‚Äî env key rows struck through
- `docs/project-context.md` ‚Äî Swift version updated to 6.2, concurrency rules updated for default MainActor isolation, `@Entry` pattern documented

### Results
- **Build:** Clean, zero errors
- **Tests:** All 367 tests pass
- **Net code reduction:** ~60 lines of unsafe boilerplate eliminated
- **Safety:** Undefined behavior risk from `nonisolated(unsafe)` + `MainActor.assumeIsolated()` is completely removed

### üßë Human (19:43:01)

There are still lots of MainActor occurrences in the code and some nonisolated. What should happen to them?

### ü§ñ Assistant (19:43:06)

Good question. With default MainActor isolation enabled, the landscape changes:

- **Explicit `@MainActor`** on types/functions is now **redundant** ‚Äî everything is already implicitly MainActor
- **Explicit `nonisolated`** may or may not still be needed depending on context

Let me audit the actual occurrences before recommending.

### ü§ñ Assistant (19:43:37)

Here's the breakdown:

### Main target (`Peach/`) ‚Äî 21 `@MainActor`, 3 `nonisolated`

**`@MainActor` (21 occurrences):** All **redundant** now. With `SWIFT_DEFAULT_ACTOR_ISOLATION = MainActor`, every type and function is implicitly MainActor. These annotations are harmless but noisy ‚Äî they're like writing `internal` on everything (which is already the default).

**`nonisolated` (3 occurrences in `SoundFontNotePlayer.swift`):** These **should stay**. They're on pure static utility functions (`parseSF2Tag`, `pitchBendValue`, `midiVelocity`) that are deliberately opt-outs from MainActor. With default isolation, `nonisolated` becomes *more* meaningful ‚Äî it marks intentional exceptions.

### Test target (`PeachTests/`) ‚Äî ~140 `@MainActor`, 0 `nonisolated`

All **redundant**. Every `@MainActor` on `@Test` functions, `@Suite` structs, mock classes, and helpers is now implicit.

### Recommendation

| Annotation | Action | Rationale |
|---|---|---|
| `@MainActor` (all ~160) | **Remove** | Redundant with default isolation; adds noise |
| `nonisolated` (3) | **Keep** | Marks intentional opt-outs from the default ‚Äî correct pattern |

Removing them is a large but purely mechanical change (~30 files). The code becomes cleaner and aligns with the Swift 6.2 idiom: only annotate what *differs* from the default.

Want me to go ahead and strip all the redundant `@MainActor` annotations across both targets?

### üßë Human (19:45:17)

yes, go ahead

### ü§ñ Assistant (19:45:31)

Let me read each file that needs changes in the main target, then apply them. I'll handle the different patterns: `@MainActor` on its own line before a class/struct, `@MainActor` inline on a function, and the `Task { @MainActor ... }` closures.

### ü§ñ Assistant (19:46:02)

Let me read the remaining files I need to understand before making changes.

### ü§ñ Assistant (19:46:22)

Now I have a clear picture of all 21 main target occurrences. The two `Task { @MainActor ... }` in `TrainingSession.swift:466,479` must **stay** (they're in `@Sendable` notification callbacks where the explicit hop to MainActor is needed). I'll remove the other 19.

Let me apply the edits in parallel batches.

### ü§ñ Assistant (19:46:34)

SourceKit false positives ‚Äî continuing with the remaining files.

### ü§ñ Assistant (19:46:45)

Now the remaining files with `@MainActor` on class/type declarations.

### ü§ñ Assistant (19:47:05)

Main target done (19 removed, 2 kept in notification callbacks). Let me verify and move to the test target.

### ü§ñ Assistant (19:47:12)

Only the two `Task { @MainActor ... }` remain ‚Äî exactly right.

### ü§ñ Assistant (19:47:17)

Now the test target. There are ~140 occurrences across many files. Let me handle this systematically ‚Äî I'll use subagents to process files in parallel.

### ü§ñ Assistant (19:47:41)

36 files to process. Let me use parallel agents to handle them efficiently.

### ü§ñ Assistant (19:52:04)

All 36 test files processed. Let me verify no `@MainActor` remains anywhere in the test target.

### ü§ñ Assistant (19:52:12)

Now build and run the full test suite.

### ü§ñ Assistant (19:54:07)

All 367 tests pass. Let me also verify no failures.

### ü§ñ Assistant (19:54:58)

367 passed, 0 failed.

### ü§ñ Assistant (19:55:03)

Now update `project-context.md` to reflect the new Swift 6.2 patterns.

### ü§ñ Assistant (19:55:15)

Now update the testing rules to remove the explicit `@MainActor` requirement.

### ü§ñ Assistant (19:55:24)

Now update the "Never Do This" section.

### ü§ñ Assistant (19:55:46)

Done. Here's the summary:

### What was removed

| Target | `@MainActor` removed | `@MainActor` kept | `nonisolated` kept |
|---|---|---|---|
| `Peach/` (19 files) | 19 | 2 (notification Task closures) | 3 (pure static functions) |
| `PeachTests/` (36 files) | ~140 | 0 | 0 |

### What was updated in `project-context.md`

- Concurrency rule: "do not add explicit `@MainActor`" ‚Äî only use it in `@Sendable` closures
- Testing rule: `@Test` functions need `async` but no longer `@MainActor`
- "Never Do This" section: added explicit `@MainActor`, manual `EnvironmentKey`, and `nonisolated(unsafe)` as anti-patterns

### Verification
- Build: clean
- Tests: 367 passed, 0 failed

### üßë Human (19:58:17)

commit this

### ü§ñ Assistant (19:58:59)

Committed. The only remaining change is `Localizable.xcstrings` which was already modified before this work (it was in the git status at the start of the conversation).

**Commit `9541747`:** 57 files changed, +137 / -352 lines ‚Äî net deletion of 215 lines.

### üßë Human (19:59:31)

<command-name>/exit</command-name>
            <command-message>exit</command-message>
            <command-args></command-args>

### üßë Human (19:59:31)

<local-command-stdout>Goodbye!</local-command-stdout>

---

[‚Üê Previous (2dcc50f0b2)](2dcc50f0b2.md) | [Index](index.md) | [Next (3cb6ee7628) ‚Üí](3cb6ee7628.md)
