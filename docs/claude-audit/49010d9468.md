---
commit: "49010d9468f24ca6a8daa7b149bebdf51d79858e"
date: "2026-02-21T15:35:20+01:00"
author: "Michael SchÃ¼rig <michael@schuerig.de>"
subject: "Fix P0 test quality issues from TEA review"
sessions: ["9291a221-baf9-4afe-95b6-c4199bdfc638"]
prev: "1c50d36e0a.md"
next: "a68a6688c9.md"
---

[â† Previous (1c50d36e0a)](1c50d36e0a.md) | [Index](index.md) | [Next (a68a6688c9) â†’](a68a6688c9.md)

# Commit 49010d9468

**Date:** 2026-02-21 15:35:20 UTC+01:00  
**Author:** Michael SchÃ¼rig <michael@schuerig.de>

## Commit message

Fix P0 test quality issues from TEA review

Replace fatalError() with Issue.record() in test helpers so timeouts
fail the current test instead of crashing the entire test runner.
Replace guard/fatalError with try #require() in test bodies. Add defer
cleanup for UserDefaults tests to prevent state leaks on assertion
failure. Delete placeholder PeachTests.swift. Add @MainActor to
StartScreenTests for proper actor isolation.

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>

## Changed files

```
PeachTests/PeachTests.swift                        |  5 ----
 PeachTests/Start/StartScreenTests.swift            |  1 +
 .../Training/TrainingSessionFeedbackTests.swift    | 34 +++++++++-------------
 PeachTests/Training/TrainingSessionTests.swift     | 14 ++++-----
 4 files changed, 22 insertions(+), 32 deletions(-)
```

## Session `9291a221â€¦`

*2026-02-21 14:20:53 UTC â†’ 2026-02-21 14:35:23 UTC*

### ğŸ§‘ Human (14:20:53)

Commands are in the form `/command [args]`

### ğŸ§‘ Human (14:21:31)

<command-message>bmad-tea-testarch-test-review</command-message>
<command-name>/bmad-tea-testarch-test-review</command-name>
<command-args>Read docs/test-artifacts/test-review.md and fix the P0 issues (fatalError replacements, defer cleanup, placeholder deletion, @MainActor addition).</command-args>

### ğŸ¤– Assistant (14:21:33)

I'll start by loading the workflow system and configuration files.

### ğŸ¤– Assistant (14:21:38)

Now I'll load the config source, instructions, template, and validation checklist.

### ğŸ¤– Assistant (14:21:47)

Now let me load the first step file and the existing test review report.

### ğŸ¤– Assistant (14:21:59)

I've loaded the test review. Now I need to read the actual test files to fix the P0 issues. The user's arguments specify four fix categories:

1. **fatalError replacements** â†’ `Issue.record()` and `try #require()`
2. **defer cleanup** â†’ UserDefaults tests
3. **placeholder deletion** â†’ PeachTests.swift
4. **@MainActor addition** â†’ StartScreenTests.swift

Let me create tasks and read all the affected files.

### ğŸ¤– Assistant (14:22:16)

Now let me read all the affected test files in parallel.

### ğŸ¤– Assistant (14:22:31)

I've read all affected files. Let me now execute the fixes systematically.

---

## Task 1: Replace `fatalError()` with `Issue.record()` in test helpers

### ğŸ¤– Assistant (14:23:17)

Now the same for `TrainingSessionFeedbackTests.swift`:

### ğŸ¤– Assistant (14:23:27)

## Task 2: Replace `guard/fatalError` with `try #require()` in test bodies

### ğŸ¤– Assistant (14:23:30)

There are 6 `guard/fatalError` patterns in `TrainingSessionFeedbackTests.swift`. Let me replace each one.

### ğŸ¤– Assistant (14:24:05)

## Task 3: Add `defer` cleanup for UserDefaults tests

### ğŸ¤– Assistant (14:24:10)

There are 5 UserDefaults test methods. Each starts with `cleanUpSettingsDefaults()` and ends with `session.stop()` + `cleanUpSettingsDefaults()`. I need to add `defer { cleanUpSettingsDefaults() }` right after the first cleanup call, and remove the trailing `cleanUpSettingsDefaults()`.

### ğŸ¤– Assistant (14:24:46)

Now remove the trailing `cleanUpSettingsDefaults()` from the last test:

### ğŸ¤– Assistant (14:24:53)

## Task 4: Delete placeholder test

### ğŸ¤– Assistant (14:25:08)

File deleted successfully.

### ğŸ¤– Assistant (14:25:11)

## Task 5: Add `@MainActor` to StartScreenTests

### ğŸ¤– Assistant (14:25:21)

Now let me build and run tests to verify everything compiles and passes.

### ğŸ¤– Assistant (14:29:05)

The build succeeded (no compilation errors for our changes). The runtime crash is a destination issue (Mac "Designed for iPad" can't bootstrap the test process). Let me verify the build compiles clean:

### ğŸ¤– Assistant (14:29:23)

**TEST BUILD SUCCEEDED** -- all changes compile cleanly with zero errors.

Let me do a final verification of all the changes by spot-checking the modified files.

### ğŸ¤– Assistant (14:29:27)

Zero `fatalError` calls remaining in tests.

### ğŸ¤– Assistant (14:29:32)

4 `fatalError` â†’ `Issue.record()` replacements in the helper functions (lines 49, 63, 56, 70). The other `Issue.record()` calls are pre-existing.

### ğŸ¤– Assistant (14:29:36)

All 6 `guard/fatalError` patterns replaced with `try #require()`.

### ğŸ¤– Assistant (14:29:40)

All 5 UserDefaults tests have `defer` cleanup.

### ğŸ¤– Assistant (14:29:50)

`@MainActor` added to `StartScreenTests` struct.

---

## Summary of All Changes

All 5 P0 fix tasks completed. **TEST BUILD SUCCEEDED** with zero compilation errors.

| # | Fix | Files Changed | Details |
|---|-----|---------------|---------|
| 1 | `fatalError()` â†’ `Issue.record()` in helpers | `TrainingSessionTests.swift`, `TrainingSessionFeedbackTests.swift` | 4 replacements in `waitForState`, `waitForPlayCallCount`, `waitForFeedbackToClear` |
| 2 | `guard/fatalError` â†’ `try #require()` in test bodies | `TrainingSessionFeedbackTests.swift` | 6 replacements across feedback and haptic tests |
| 3 | `defer { cleanUpSettingsDefaults() }` added | `TrainingSessionTests.swift` | 5 tests in `TrainingSessionUserDefaultsTests`; removed redundant trailing cleanup calls |
| 4 | Deleted placeholder test | `PeachTests.swift` | File removed entirely |
| 5 | Added `@MainActor` | `StartScreenTests.swift` | Annotation added to struct |

**Result**: Zero `fatalError` calls remain in the test target. All test helpers now fail gracefully via `Issue.record()`, all precondition guards use `try #require()`, UserDefaults cleanup is failure-safe, and all test suites have proper `@MainActor` isolation.

### ğŸ§‘ Human (14:35:06)

Great. Please commit these changes. We're going to look after the remaining issues in another session.

### ğŸ¤– Assistant (14:35:23)

Committed as `0bf633b`. The `docs/test-artifacts/` directory (containing the test review report) remains untracked for you to commit separately if desired.

---

[â† Previous (1c50d36e0a)](1c50d36e0a.md) | [Index](index.md) | [Next (a68a6688c9) â†’](a68a6688c9.md)
