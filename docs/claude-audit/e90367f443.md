---
commit: "e90367f443004b2ea317329fb33da41e387d65f9"
date: "2026-02-25T21:09:32+01:00"
author: "Michael Sch√ºrig <michael@schuerig.de>"
subject: "Implement story 12.1: PlaybackHandle Protocol and NotePlayer Redesign"
sessions: ["a49e7719-4781-4403-837c-685f19981db6"]
prev: "b34e86df73.md"
next: "cd3f1d6089.md"
---

[‚Üê Previous (b34e86df73)](b34e86df73.md) | [Index](index.md) | [Next (cd3f1d6089) ‚Üí](cd3f1d6089.md)

# Commit e90367f443

**Date:** 2026-02-25 21:09:32 UTC+01:00  
**Author:** Michael Sch√ºrig <michael@schuerig.de>

## Commit message

Implement story 12.1: PlaybackHandle Protocol and NotePlayer Redesign

Redesign the audio layer around a PlaybackHandle pattern where callers
own the notes they start. NotePlayer.play() now returns a PlaybackHandle
for explicit note lifecycle control (stop, adjustFrequency). A default
extension preserves the fixed-duration play(frequency:duration:...) for
backward compatibility. SoundFontPlaybackHandle wraps MIDI note + sampler
with idempotent stop and real-time pitch bend adjustment.

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>

## Changed files

```
Peach/Comparison/ComparisonScreen.swift            |   7 +-
 Peach/Core/Audio/NotePlayer.swift                  |  55 ++++++++++-
 Peach/Core/Audio/PlaybackHandle.swift              |  22 +++++
 Peach/Core/Audio/SoundFontNotePlayer.swift         |  39 +-------
 Peach/Core/Audio/SoundFontPlaybackHandle.swift     |  45 +++++++++
 .../ComparisonSessionLifecycleTests.swift          |   9 +-
 PeachTests/Comparison/MockNotePlayer.swift         |  40 ++++++--
 .../Core/Audio/NotePlayerConvenienceTests.swift    |  69 +++++++++++++
 PeachTests/Core/Audio/PlaybackHandleTests.swift    | 102 ++++++++++++++++++++
 .../Core/Audio/SoundFontNotePlayerTests.swift      |  24 ++---
 .../Core/Audio/SoundFontPlaybackHandleTests.swift  |  53 ++++++++++
 PeachTests/Mocks/MockPlaybackHandle.swift          |  64 ++++++++++++
 ...ybackhandle-protocol-and-noteplayer-redesign.md | 107 ++++++++++++++-------
 docs/implementation-artifacts/sprint-status.yaml   |   2 +-
 14 files changed, 536 insertions(+), 102 deletions(-)
```

## Session `a49e7719‚Ä¶`

*2026-02-25 19:37:47 UTC ‚Üí 2026-02-25 20:10:29 UTC*

### üßë Human (19:37:47)

<command-message>bmad-bmm-dev-story</command-message>
<command-name>/bmad-bmm-dev-story</command-name>
<command-args>12.1</command-args>

### ü§ñ Assistant (19:37:50)

I'll start by loading the workflow OS and configuration files.

### ü§ñ Assistant (19:37:54)

Now let me load the config source and instructions file.

### ü§ñ Assistant (19:38:06)

All workflow components loaded. Now executing **Step 1: Find next ready story and load it**.

The argument "12.1" was provided. Let me locate the story file.

### ü§ñ Assistant (19:38:11)

Found story `12-1-playbackhandle-protocol-and-noteplayer-redesign` with status `ready-for-dev`. Let me load the complete story file.

### ü§ñ Assistant (19:38:17)

Now let me load the project context and the key source files referenced in the story's Dev Notes.

### ü§ñ Assistant (19:39:31)

**Step 2: Context Loaded**

‚úÖ **Context Loaded** ‚Äî Story and project context available for implementation.

**Step 3: Detect Review Continuation**

üöÄ **Starting Fresh Implementation**

- **Story:** 12-1-playbackhandle-protocol-and-noteplayer-redesign
- **Story Status:** ready-for-dev
- **First incomplete task:** Task 1 ‚Äî Create PlaybackHandle protocol

**Step 4: Mark Story In-Progress**

### ü§ñ Assistant (19:40:34)

üöÄ Starting work on story 12-1-playbackhandle-protocol-and-noteplayer-redesign
Status updated: ready-for-dev ‚Üí in-progress

Now let me check existing tests and the FrequencyCalculation helper before starting implementation.

### ü§ñ Assistant (19:41:42)

Now let me check git status before starting, and also look at the Mocks directory and test helpers.

### ü§ñ Assistant (19:41:48)

Let me check the test helpers to understand the factory pattern used.

### ü§ñ Assistant (19:41:54)

Good. Now I have complete context. Let me begin implementing **Step 5** ‚Äî the task-by-task implementation cycle.

---

## Task 1: Create PlaybackHandle Protocol

### RED PHASE ‚Äî Writing tests first

I need to create the `PlaybackHandle` protocol and `MockPlaybackHandle` (for testing), then write tests. Since MockPlaybackHandle is needed to test the PlaybackHandle contract, I'll create both, starting with the protocol and mock.

### ü§ñ Assistant (19:42:04)

Now create MockPlaybackHandle for testing:

### ü§ñ Assistant (19:42:16)

Now write tests for PlaybackHandle contract:

### ü§ñ Assistant (19:42:33)

I need to add the new files to the Xcode project. Let me check the project structure.

### ü§ñ Assistant (19:43:02)

This uses `PBXFileSystemSynchronizedRootGroup` ‚Äî modern Xcode folder-based project. Files added to directories are automatically picked up. No need to modify pbxproj.

Now let me build and run the tests to verify the new files compile. But first, let me implement all tasks before running the full test suite, since the protocol changes will break existing code until everything is updated.

Let me proceed to **Task 2: Redesign NotePlayer protocol**.

### ü§ñ Assistant (19:43:20)

Now **Task 3: Create SoundFontPlaybackHandle**.

### ü§ñ Assistant (19:43:35)

Now **Task 4: Update SoundFontNotePlayer**. I need to expose `pitchBendCenter` and `channel` for use by `SoundFontPlaybackHandle`, change `play()` to return a handle, and remove `stop()`.

### ü§ñ Assistant (19:43:41)

Now I'll refactor SoundFontNotePlayer ‚Äî make constants accessible, change `play()` to return a handle, and remove `stop()`:

### ü§ñ Assistant (19:43:46)

Now replace the `play()` and `stop()` methods:

### ü§ñ Assistant (19:44:14)

Now **Task 5: Update MockNotePlayer** to return MockPlaybackHandle.

### ü§ñ Assistant (19:45:43)

Now I'll rewrite MockNotePlayer to conform to the redesigned protocol:

### ü§ñ Assistant (19:45:52)

Now I need to update the test fixtures and existing tests that reference the old `playHistory` tuple (which had `duration`) and `lastDuration`. Let me find all references.

### ü§ñ Assistant (19:46:34)

I need to reconsider the design. Since the convenience method `play(frequency:duration:...)` is extension-only, it won't dynamically dispatch to MockNotePlayer overrides when called through a `NotePlayer` protocol reference. This breaks test timing and duration tracking. 

I'll add the convenience method as a protocol requirement WITH a default implementation ‚Äî this enables dynamic dispatch while keeping it optional for implementors:

### ü§ñ Assistant (19:46:48)

Now update MockNotePlayer to override the convenience method with `instantPlayback` support and `lastDuration` tracking:

### ü§ñ Assistant (19:47:08)

Now let me check the existing tests that reference `stopCallCount` and `onStopCalled` from MockNotePlayer ‚Äî these need updating since `stop()` is now a no-op extension.

### ü§ñ Assistant (19:48:01)

Let me clean up `currentNote` from SoundFontNotePlayer since the handle now owns note lifecycle, and update the affected test.

### ü§ñ Assistant (19:48:21)

Let me verify the current state of SoundFontNotePlayer:

### ü§ñ Assistant (19:48:26)

Good ‚Äî `currentNote` is fully removed. The SourceKit diagnostics are stale. Now let me update the test that checks `stopCallCount`:

### ü§ñ Assistant (19:48:35)

Now let me also update SoundFontNotePlayerTests ‚Äî several tests call `player.stop()` which is now a no-op. These tests still compile and pass (no-op doesn't throw), but the `playStopLifecycle` test should verify the handle-based lifecycle instead:

### ü§ñ Assistant (19:48:52)

Now let me also update the tests that validate input parameters ‚Äî they use `play(frequency:duration:...)` which should still work through the extension. But I need to check the `duration > 0` validation. The old SoundFontNotePlayer validated duration, but now the primary `play()` doesn't have duration. The extension method sleeps for the duration ‚Äî what happens with `duration: 0` or negative?

### ü§ñ Assistant (19:49:05)

Let me now check which other test files might be affected. Let me search for `\.stop()` calls through the `NotePlayer` protocol in tests:

### ü§ñ Assistant (19:49:10)

Good ‚Äî no direct `mockPlayer.stop()` calls in tests. Let me now add new tests for the convenience method delegation to handle (Task 6.3), and write tests for SoundFontPlaybackHandle (Task 3.4). Let me first write the SoundFontPlaybackHandle tests:

### ü§ñ Assistant (19:49:20)

Now let me add the convenience method delegation tests (Task 6.3):

### ü§ñ Assistant (19:50:08)

Let me fix the MockNotePlayer convenience method to properly handle cancellation cleanup (matching the extension's error handling pattern):

### ü§ñ Assistant (19:50:18)

Now let me run the full test suite to see if everything compiles and passes:

### ü§ñ Assistant (19:50:30)

There's a `MockNotePlayerForPreview` that needs updating. Let me find it.

### ü§ñ Assistant (19:57:29)

All tests pass. Let me verify the full results:

### ü§ñ Assistant (19:57:56)

The tail -60 from the original run showed only test case results (all passing) and the exit code was 0 (success). **All 60 tests passed with 0 failures.** The test suite summary was captured earlier in the original output ending with `** TEST SUCCEEDED **` (based on exit code 0).

Now let me check how many new tests we added vs. old total. Let me look at the new test files:

### ü§ñ Assistant (19:58:10)

The new test files didn't run ‚Äî likely because the `PeachTests/Mocks/` directory is new and may need to be recognized by Xcode. Let me check the project structure:

### ü§ñ Assistant (19:59:29)

The new test suites ARE running. Let me get the complete count:

### ü§ñ Assistant (20:02:19)

**All 400 test cases pass with 0 failures.** The earlier background task output was truncated at 60 lines. The full suite includes all new tests.

Let me verify the new test suites ran specifically:

### ü§ñ Assistant (20:05:28)

All 18 new tests pass:
- **PlaybackHandleTests**: 9/9 passed
- **SoundFontPlaybackHandleTests**: 5/5 passed
- **NotePlayerConvenienceTests**: 4/4 passed (including cancellation test)

Now let me update the story file. I'll mark all completed tasks, update the Dev Agent Record, and verify all ACs are satisfied.

**Step 8: Validate and mark tasks complete**

Let me verify each task's completion status against the ACs:

1. **AC #1** ‚Äî PlaybackHandle protocol with `stop()` and `adjustFrequency(_:)` ‚úÖ
2. **AC #2** ‚Äî NotePlayer redesigned: primary returns PlaybackHandle, stop() removed, default extension for fixed-duration ‚úÖ
3. **AC #3** ‚Äî SoundFontNotePlayer returns SoundFontPlaybackHandle, idempotent stop, adjustFrequency with pitch bend ‚úÖ
4. **AC #4** ‚Äî MockNotePlayer returns MockPlaybackHandle with tracking ‚úÖ
5. **AC #5** ‚Äî Backward compat: convenience extension, ComparisonSession plays without call-site changes ‚úÖ
6. **AC #6** ‚Äî All 400 tests pass, new tests verify handle behavior ‚úÖ

Now update the story file:

### ü§ñ Assistant (20:06:11)

Now update sprint-status to "review":

### ü§ñ Assistant (20:06:26)

**Step 9: Story completion** ‚Äî Status updated to "review" in both story file and sprint-status.yaml.

**Step 10: Completion communication**

---

Michael, story 12.1 implementation is **complete and ready for review**.

## Summary

**Story:** 12-1-playbackhandle-protocol-and-noteplayer-redesign
**Status:** review

### Key Changes

| Component | What Changed |
|-----------|-------------|
| **PlaybackHandle** (new) | Protocol with `stop()` (idempotent) and `adjustFrequency(_:)` |
| **NotePlayer** | Primary `play()` returns `PlaybackHandle`; `stop()` removed from protocol; convenience `play(frequency:duration:...)` via default extension |
| **SoundFontPlaybackHandle** (new) | Wraps MIDI note + sampler; stop sends noteOff + resets pitch bend; adjustFrequency computes pitch bend from Hz |
| **SoundFontNotePlayer** | Returns handle immediately after note onset; no more defer block or `currentNote` state |
| **MockPlaybackHandle** (new) | Tracks stop/adjustFrequency calls with error injection |
| **MockNotePlayer** | Returns `MockPlaybackHandle`; preserves `instantPlayback`, `playHistory`, `onPlayCalled` semantics |

### Tests

- **400 total tests pass** (18 new + 382 existing), 0 failures
- New test suites: `PlaybackHandleTests` (9), `SoundFontPlaybackHandleTests` (5), `NotePlayerConvenienceTests` (4)

### Design Decisions

1. `play(frequency:duration:...)` declared in protocol (not just extension) to enable dynamic dispatch ‚Äî MockNotePlayer overrides it for `instantPlayback` support in tests
2. `stop()` kept as extension-only no-op for backward compatibility ‚Äî ComparisonSession still compiles; handle-based stopping migrates in story 12.2
3. Exposed `channel`, `pitchBendCenter`, `validFrequencyRange` from SoundFontNotePlayer for handle access

### Next Steps

- Run `code-review` workflow (ideally with a different LLM)
- Story 12.2 (ComparisonSession PlaybackHandle integration) is next in the backlog

Would you like me to explain any of the technical decisions, or would you like to proceed with committing these changes?

### üßë Human (20:09:09)

commit this

### ü§ñ Assistant (20:09:40)

Committed successfully: `e90367f` ‚Äî 14 files changed (6 new, 8 modified), clean working tree.

### üßë Human (20:10:29)

<command-name>/exit</command-name>
            <command-message>exit</command-message>
            <command-args></command-args>

### üßë Human (20:10:29)

<local-command-stdout>See ya!</local-command-stdout>

---

[‚Üê Previous (b34e86df73)](b34e86df73.md) | [Index](index.md) | [Next (cd3f1d6089) ‚Üí](cd3f1d6089.md)
