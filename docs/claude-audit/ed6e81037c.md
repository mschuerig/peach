---
commit: "ed6e81037cf70c93a0cc0b86c479459025871abc"
date: "2026-02-23T22:43:01+01:00"
author: "Michael SchÃ¼rig <michael@schuerig.de>"
subject: "Add story 8.3: Remove SineWaveNotePlayer and RoutingNotePlayer"
sessions: ["0007e94c-8ea9-4e56-aebb-a587bc6d3c02", "1543d4c0-3bf0-4ca4-beb5-8e61cd0525b1"]
prev: "4391637271.md"
next: "d8ea3124b3.md"
---

[â† Previous (4391637271)](4391637271.md) | [Index](index.md) | [Next (d8ea3124b3) â†’](d8ea3124b3.md)

# Commit ed6e81037c

**Date:** 2026-02-23 22:43:01 UTC+01:00  
**Author:** Michael SchÃ¼rig <michael@schuerig.de>

## Commit message

Add story 8.3: Remove SineWaveNotePlayer and RoutingNotePlayer

SoundFontNotePlayer's SF2 Sine Wave preset makes the custom sine wave
generator obsolete. This story consolidates to a single NotePlayer
implementation, removing ~400 lines of code and the routing layer.

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>

## Changed files

```
...ove-sinewavenoteplayer-and-routingnoteplayer.md | 210 +++++++++++++++++++++
 docs/implementation-artifacts/sprint-status.yaml   |   1 +
 2 files changed, 211 insertions(+)
```

## Session 1 (`0007e94câ€¦`)

*2026-02-23 21:43:36 UTC â†’ 2026-02-23 21:43:57 UTC*

### ğŸ§‘ Human (21:43:36)

<command-message>bmad-bmm-dev-story</command-message>
<command-name>/bmad-bmm-dev-story</command-name>
<command-args>8-3</command-args>

### ğŸ¤– Assistant (21:43:39)

I'll start by loading the workflow execution framework and the dev-story workflow configuration.

### ğŸ¤– Assistant (21:43:43)

Now let me load the config source and the instructions file.

### ğŸ¤– Assistant (21:43:51)

Now I'm executing the workflow. Let me start with **Step 1: Find the story and load it**.

The argument "8-3" was provided. Let me locate the story file and sprint status.

### ğŸ¤– Assistant (21:43:57)

Found the story file. Let me load it completely along with the project context.

## Session 2 (`1543d4c0â€¦`)

*2026-02-23 21:18:30 UTC â†’ 2026-02-23 21:43:18 UTC*

### ğŸ§‘ Human (21:18:30)

<command-message>bmad-party-mode</command-message>
<command-name>/bmad-party-mode</command-name>
<command-args>With the introduction of SoundFontNotePlayer we have gained a large set of new sounds. Among them is a Sine Wave. We already have our own SineWaveNotePlayer, but that may have become obsolete. Removing it would remove quite a bit of complexity from the code. Discuss.</command-args>

### ğŸ¤– Assistant (21:18:41)

Now let me gather context about the topic before launching the party.

### ğŸ¤– Assistant (21:23:57)

---

ğŸ‰ **PARTY MODE ACTIVATED!** ğŸ‰

Welcome Michael! All BMAD agents are here and ready for a dynamic group discussion. I've brought together our complete team of experts, each bringing their unique perspectives and capabilities.

**Let me introduce a few of our collaborating agents:**

- ğŸ—ï¸ **Winston** (Architect) â€” calm pragmatist who balances "what could be" with "what should be"
- ğŸ’» **Amelia** (Developer) â€” ultra-succinct, speaks in file paths and AC IDs
- ğŸ§ª **Quinn** (QA) â€” practical, ship-it-and-iterate mentality
- ğŸš€ **Barry** (Quick Flow Solo Dev) â€” minimum ceremony, ruthless efficiency

Now, this is a great topic â€” let's get the team's take on whether `SineWaveNotePlayer` has become obsolete now that `SoundFontNotePlayer` includes an SF2 Sine Wave preset.

---

ğŸ—ï¸ **Winston**: Let's slow down and look at what we'd actually be removing versus what we'd be gaining. The architecture today has a clear separation of concerns: `SineWaveNotePlayer` is a zero-dependency, mathematically precise tone generator. `SoundFontNotePlayer` is a sampler that depends on a 30+ MB SF2 file and Apple's `AVAudioUnitSampler` pipeline.

The critical thing people often miss in "let's remove X because Y can do it too" discussions: **`SineWaveNotePlayer` is the fallback**. `RoutingNotePlayer` defaults to it when the SF2 file is missing, when `SoundFontNotePlayer` init fails, or when a sound source tag is unrecognized. If we remove it, we need a new fallback strategy. What does that look like? `SoundFontNotePlayer` loading its own sine preset? That just moves the complexity â€” and now your fallback depends on the same SF2 infrastructure that might have failed in the first place.

That said, I want to be honest about the other side: maintaining two separate `AVAudioEngine` instances, two separate player implementations, the routing logic that switches between them â€” that *is* real complexity. If we could confidently say "the SF2 file will always be available," the simplification argument has merit. But "always available" is a dangerous assumption on a mobile platform.

My instinct? **Keep it, but simplify it.** The sine player serves a legitimate architectural role as a resource-independent fallback. But we could potentially slim it down further if all it needs to be is a reliable safety net.

---

ğŸ’» **Amelia**: Let me lay out the actual code surface.

`SineWaveNotePlayer.swift` â€” 187 lines. `SoundFontNotePlayer.swift` â€” 185 lines. `RoutingNotePlayer.swift` â€” 60 lines of routing logic that exists specifically to manage the two.

Remove sine player, here's what changes:
- Delete `SineWaveNotePlayer.swift`
- Delete or heavily refactor `RoutingNotePlayer.swift` (its entire reason for existing is routing between the two)
- Delete ~50 tests across 2 test files (though many are actually `FrequencyCalculation` tests that stay regardless)
- Update `PeachApp.swift` composition root â€” no more dual instantiation
- Update `SettingsScreen.swift` â€” remove the hardcoded `"sine"` tag, the SF2 Sine Wave preset (`sf2:8:80`) takes its place in the picker
- Update `project-context.md` architecture docs

Net deletion: roughly 250 lines of production code + 50 tests. That's not trivial.

But here's what bothers me: `SineWaveNotePlayer` uses `public` access (violates project rules), has a bug where `.invalidFrequency` is thrown for bad duration/amplitude, and its 25ms stop propagation delay is a different approach than `SoundFontNotePlayer`'s MIDI note-off. Two different stop semantics for the same `NotePlayer` protocol. That's a code smell.

---

ğŸ§ª **Quinn**: From a testing perspective â€” I'd actually *like* to consolidate. Right now we're testing two completely different audio codepaths for what the user perceives as "play a note." The sine player tests are testing buffer math, sample rates, amplitude scaling. The SF2 player tests are testing MIDI velocity mapping, pitch bend calculations, preset switching. Completely different internals for the same protocol method.

If we go down to one implementation, test surface shrinks significantly. One set of behaviors to verify. One stop mechanism. One audio engine lifecycle.

But â€” and Winston's going to love this â€” if we keep it *as the fallback*, the testing story actually gets worse, not better. Because now we'd need to test: "SF2 loads â†’ use SF2 sine preset. SF2 fails â†’ use... what?" If the answer is "use SineWaveNotePlayer as emergency fallback," then we haven't simplified the test matrix at all.

So my question is really: **how likely is SF2 failure in production?** If the answer is "essentially never because it's bundled in the app," then the fallback is just defensive code we'll never exercise. If the answer is "it can fail," then we need the fallback and the full test matrix.

---

ğŸš€ **Barry**: Alright, let me cut through this. Here's the pragmatic take:

**The user doesn't care.** A sampled sine wave through the SF2 sampler at `sf2:8:80` and a mathematically generated sine wave from `SineWaveNotePlayer` â€” in a music learning app, the difference is inaudible. Nobody is doing spectral analysis on the output. The 0.024-cent pitch resolution of the MIDI pitch bend is *way* beyond human perception. The envelope differences? Negligible for the use case.

What the user *does* care about: simpler Settings UI, fewer things that can go wrong, app that works.

What *I* care about as a dev: less code to maintain, fewer tests to write, one audio path to debug when something breaks.

Here's what I'd do: **keep SineWaveNotePlayer but demote it.** Remove it from the Settings UI entirely. Remove the `"sine"` tag from the picker. Make the SF2 Sine Wave preset the user-facing option. Keep `SineWaveNotePlayer` as a silent emergency fallback only â€” the thing that plays if `SoundFontNotePlayer` completely fails to initialize. Simplify `RoutingNotePlayer` to just route to `SoundFontNotePlayer` normally and only touch the sine player in the catastrophic fallback case.

This gets you most of the simplification without removing your safety net.

---

ğŸ—ï¸ **Winston**: I like Barry's approach, actually. It's the boring-technology answer â€” and boring is good architecture. You don't remove the parachute just because the engine is reliable. But you also don't advertise the parachute as a feature.

There is one thing I'd push back on, though. If we demote `SineWaveNotePlayer` to emergency-only fallback, we should consider whether 187 lines is the right size for a fallback. Could we strip it down to the absolute minimum â€” no validation, no configurable envelope, just "produce a tone at this frequency for this duration"? A 50-line emergency tone generator is easier to maintain than the current full-featured implementation.

---

ğŸ’» **Amelia**: Counterpoint: stripping features from `SineWaveNotePlayer` means it behaves *differently* from `SoundFontNotePlayer` in fallback mode. User's playing along, SF2 fails mid-session, suddenly the tone has no attack envelope, different stop behavior. That's a worse user experience than the current inconsistency. If we keep it, keep it working properly.

---

**Quinn** has a question for you, Michael:

ğŸ§ª **Quinn asks: What's your gut feeling â€” is the SF2 Sine Wave preset (`sf2:8:80`) audibly "good enough" compared to the pure mathematical sine? Have you A/B tested them? That answer basically decides whether this is a "remove it" or "demote it" discussion.**

_[Awaiting your response...]_

---

`[E] Exit Party Mode - End the collaborative session`

### ğŸ§‘ Human (21:31:41)

Yes, the SF2 Sine Wave preset is good enough.

I don't see how the SoundFontNotePlayer could suddenly fail during usage. The SF2 file is included in our app bundle, it is not something optional. The underlying APIs that we are using are always available. Am I missing any failure scenarios that can't be fixed by a restart of the app or at worst a re-install?

### ğŸ¤– Assistant (21:32:18)

ğŸ—ï¸ **Winston**: That's... a fair challenge, Michael. Let me think through this honestly instead of just defending the fallback reflex.

The SF2 file is in the app bundle â€” so it's as available as any other compiled resource. `AVAudioUnitSampler` is a core Apple framework, not some optional capability. The realistic failure scenarios would be:

1. **Bundle corruption** â€” but if the bundle is corrupted, the app probably won't launch at all
2. **`AVAudioEngine` failure** â€” and here's the thing that actually undermines my own argument: `SineWaveNotePlayer` *also uses `AVAudioEngine`*. If the engine fails, **both players fail**. The "fallback" falls back to nothing useful.
3. **`loadSoundBankInstrument` throwing** â€” theoretically possible, but with a bundled file, this would indicate an OS-level bug, not something our fallback code solves
4. **Memory pressure** â€” iOS would kill the app, which is your "restart" scenario
5. **Audio session interruption** (phone call) â€” affects both players equally

I have to be honest with myself here: I was defending the fallback on architectural instinct, not on actual failure analysis. The sine player doesn't protect against any scenario that the SF2 player wouldn't also survive â€” because they share the same underlying infrastructure. A fallback is only useful if it fails *independently* from the thing it's backing up. These two don't.

I'm revising my position. The parachute metaphor breaks down when both parachutes are strapped to the same cord.

---

ğŸ’» **Amelia**: Winston just made my case for me. Let me lay out the actual removal path:

**Delete:**
- `SineWaveNotePlayer.swift` â€” 187 lines gone
- `SineWaveNotePlayerTests.swift` â€” relocate `FrequencyCalculation` tests, delete the rest
- `SineWaveNotePlayerPlaybackTests.swift` â€” gone

**Simplify heavily:**
- `RoutingNotePlayer.swift` â€” no longer needs to route between two players. Either collapse into a thin wrapper around `SoundFontNotePlayer` or eliminate entirely and use `SoundFontNotePlayer` directly
- `RoutingNotePlayerTests.swift` â€” most tests become irrelevant

**Update:**
- `PeachApp.swift` â€” single player instantiation, no dual construction
- `SettingsScreen.swift` â€” remove hardcoded `"sine"` tag, SF2 Sine Wave preset at `sf2:8:80` takes its place
- `SettingsKeys.defaultSoundSource` â€” change from `"sine"` to `"sf2:8:80"` (or whatever we choose as default)
- `project-context.md` â€” update architecture docs
- `public` access level violation goes away for free

Also fixes the bug where `SineWaveNotePlayer` throws `.invalidFrequency` for bad duration/amplitude â€” gone, not fixed.

---

ğŸš€ **Barry**: I'm flipping my position from "demote" to "remove." Michael's right â€” I was being cautious for the sake of caution. The fallback adds no value if both players depend on the same `AVAudioEngine`. That's not defensive programming, that's dead code with extra steps.

One thing to think about though: **what becomes the default sound source?** Right now `"sine"` is the default in `SettingsKeys`. If we remove it, the new default should probably be the SF2 Sine Wave (`sf2:8:80`) since that's the closest equivalent. Or do we want a more interesting default now that we have a whole library? Cello? Piano? That's a product decision, not a technical one.

---

ğŸ§ª **Quinn**: From the test side, this is a net win. Here's what I'm counting:

- **Tests removed:** ~50 sine-specific tests + ~14 routing tests that test sine/SF2 switching = ~64 tests
- **Tests relocated:** `FrequencyCalculation` tests currently living in `SineWaveNotePlayerTests.swift` â€” these are still needed, just move them to their own file or into `SoundFontNotePlayerTests`
- **Tests added:** maybe 2-3 to verify the SF2 Sine Wave preset loads and plays correctly at `sf2:8:80`
- **Tests simplified:** remaining routing tests (if `RoutingNotePlayer` survives) become trivial

Net: significantly smaller test surface, easier to maintain, fewer flaky audio integration test paths. I'm in favor.

---

ğŸ“‹ **John**: Hold on â€” before this becomes purely a technical discussion, there's a product angle. The Settings UI currently shows "Sine Wave" as the first and default option, distinct from all the SF2 instruments. If we remove `SineWaveNotePlayer`, the user now sees "Sine Wave" as just another SF2 instrument in the list â€” same level as "Cello" and "Grand Piano." 

Is that what we want? Or was there a reason "Sine Wave" was elevated as the primary, default experience? If Peach is a music learning app, should the default sound be a pure sine wave at all, or should it be something more musically expressive like a piano or cello? This might be an opportunity to rethink the default, not just a code cleanup.

---

**John has a question for you, Michael:**

ğŸ“‹ **John asks: With the sine player gone, what should the new default sound source be? Keep it as the SF2 Sine Wave, or take this opportunity to default to something more musical?**

_[Awaiting your response...]_

---

`[E] Exit Party Mode - End the collaborative session`

### ğŸ§‘ Human (21:37:11)

Use the Sine Wave preset as the default sound source.

I'm very much in favor of getting rid of the RoutingNotePlayer and all associated tests. I don't expect we will need any more sound sources than what we can get from the SoundFontNotePlayer.

DO NOT start the work immediately. Write a story and append it to the current epic.

### ğŸ¤– Assistant (21:37:18)

ğŸ—ï¸ **Winston**: Clean architectural decision. One player, one path, no routing layer. The `NotePlayer` protocol stays as the abstraction point â€” if you ever need a different source in the future, you implement the protocol. But you don't build the routing infrastructure until you need it. That's exactly the kind of simplicity I advocate for.

---

ğŸ’» **Amelia**: Noted. `SoundFontNotePlayer` becomes the sole `NotePlayer` implementation. `RoutingNotePlayer` â€” gone. Clean.

---

ğŸš€ **Barry**: Love it. Let me draft that story. Give me a moment to check the current epic structure so I get the format right.

---

Let me find the current epic and story format before writing.

### ğŸ¤– Assistant (21:38:07)

Now let me check the current source files that will be affected.

### ğŸ¤– Assistant (21:38:12)

Now let me check the test files and Settings to complete the picture.

### ğŸ¤– Assistant (21:39:05)

Good. Now I have all the context. Let me write the story.

ğŸš€ **Barry**: Got the format, got the context, got the scope. Drafting 8.3 now â€” lean and precise, no bureaucracy.

---

### ğŸ¤– Assistant (21:40:29)

Now let me append the story entry to sprint-status.yaml.

### ğŸ¤– Assistant (21:40:43)

---

ğŸš€ **Barry**: Done. Story 8.3 is written and appended to the sprint status.

**Summary of what I wrote:**

- **Story 8.3: Remove SineWaveNotePlayer and RoutingNotePlayer**
- 8 tasks, clean decomposition
- **Deletes** 5 files (~300+ lines production code, ~100+ lines tests)
- **Core change**: `SoundFontNotePlayer` absorbs the ~15 lines of preset routing logic from `RoutingNotePlayer` â€” reads `UserDefaults` in `play()`, parses the `sf2:` tag, switches preset if needed
- **New default**: `"sf2:8:80"` (SF2 Sine Wave preset) replaces `"sine"`
- **Migrations**: `"sine"` â†’ `"sf2:8:80"`, `"cello"` â†’ `"sf2:0:42"` (existing)
- **Cleanup**: `public` â†’ `internal` on `NotePlayer` protocol and `AudioError`, dead enum cases removed

---

ğŸ’» **Amelia**: Clean scope. Net negative LOC. My favorite kind of story.

ğŸ—ï¸ **Winston**: Architecturally sound. One player, one path, protocol stays for testability. No over-engineering. I approve.

ğŸ§ª **Quinn**: Test plan is clear â€” relocate `FrequencyCalculation` tests, add preset-routing coverage, delete the rest. Net test reduction with better signal-to-noise.

---

Files created/modified:
- `docs/implementation-artifacts/8-3-remove-sinewavenoteplayer-and-routingnoteplayer.md` (new)
- `docs/implementation-artifacts/sprint-status.yaml` (updated)

`[E] Exit Party Mode - End the collaborative session`

### ğŸ§‘ Human (21:42:21)

e

### ğŸ¤– Assistant (21:42:27)

ğŸ‰ **Thanks for the party, Michael!**

ğŸ—ï¸ **Winston**: Solid decision-making today. Simple architecture wins.

ğŸ’» **Amelia**: Story's tight. Ready for implementation whenever you are.

ğŸš€ **Barry**: Less code, fewer bugs. Ship it.

ğŸ§ª **Quinn**: Looking forward to deleting tests for once.

ğŸ“‹ **John**: Good call on keeping Sine Wave as the default â€” continuity matters.

---

**Party Mode deactivated.** Back to regular operations. Story 8.3 is ready for dev in `docs/implementation-artifacts/8-3-remove-sinewavenoteplayer-and-routingnoteplayer.md`.

### ğŸ§‘ Human (21:42:49)

commit

### ğŸ¤– Assistant (21:43:04)

Committed as `ed6e810`. Two files: the new story and the sprint status update. Working tree is clean.

### ğŸ§‘ Human (21:43:18)

<command-name>/exit</command-name>
            <command-message>exit</command-message>
            <command-args></command-args>

### ğŸ§‘ Human (21:43:18)

<local-command-stdout>Catch you later!</local-command-stdout>

---

[â† Previous (4391637271)](4391637271.md) | [Index](index.md) | [Next (d8ea3124b3) â†’](d8ea3124b3.md)
