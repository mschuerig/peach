---
commit: "b52f8364a4b091324f4eb1de0a60658105d0ed78"
date: "2026-02-27T01:39:01+01:00"
author: "Michael SchÃ¼rig <michael@schuerig.de>"
subject: "Refine SoundFontNotePlayer static helpers with value object params"
sessions: ["da4dafa4-842d-41d0-b006-225e5cec5fcf"]
prev: "dca269f2f4.md"
next: "4aa3076699.md"
---

[â† Previous (dca269f2f4)](dca269f2f4.md) | [Index](index.md) | [Next (4aa3076699) â†’](4aa3076699.md)

# Commit b52f8364a4

**Date:** 2026-02-27 01:39:01 UTC+01:00  
**Author:** Michael SchÃ¼rig <michael@schuerig.de>

## Commit message

Refine SoundFontNotePlayer static helpers with value object params

parseSF2Tag takes SoundSourceID and returns SF2Preset instead of raw
String/(bank,program) tuple. pitchBendValue takes Cents instead of
Double. Removes empty-string test case now prevented by SoundSourceID
precondition.

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>

## Changed files

```
Peach/Core/Audio/SoundFontNotePlayer.swift          | 21 ++++++++++-----------
 Peach/Core/Audio/SoundFontPlaybackHandle.swift      |  2 +-
 .../Core/Audio/SoundFontNotePlayerTests.swift       |  3 +--
 3 files changed, 12 insertions(+), 14 deletions(-)
```

## Session `da4dafa4â€¦`

*2026-02-27 00:21:25 UTC â†’ 2026-02-27 00:39:06 UTC*

### ğŸ§‘ Human (00:21:25)

Implement the following plan:

# Plan: Refine UserSettings Protocol with Value Objects

## Context

Story 19.3 code review refinement. Four UserSettings properties use raw types where value objects would enforce domain invariants.

## Changes

- `noteDuration: TimeInterval` -> `NoteDuration` (clamped 0.3...3.0)
- `referencePitch: Double` -> `Frequency` (existing value object)
- `soundSource: String` -> `SoundSourceID` (type-safe string wrapper)
- `varyLoudness: Double` -> `UnitInterval` (clamped 0.0...1.0)

`naturalVsMechanical` stays `Double`. AppUserSettings stays dependency-free. SoundFontNotePlayer unchanged (keeps parseSF2Tag for preset resolution).

## New Value Objects

1. `Peach/Core/UnitInterval.swift` -- clamped 0.0...1.0, follows AmplitudeDB pattern
2. `Peach/Settings/NoteDuration.swift` -- clamped 0.3...3.0
3. `Peach/Settings/SoundSourceID.swift` -- wraps String, precondition non-empty

## Modified Files

- `UserSettings.swift`, `AppUserSettings.swift`, `MockUserSettings.swift` -- type changes
- `ComparisonSession.swift`, `PitchMatchingSession.swift` -- `.rawValue` extraction at boundaries
- `SoundFontNotePlayer.swift` -- `userSettings.soundSource.rawValue` instead of `userSettings.soundSource`
- Test files -- literal assignments mostly auto-resolve via ExpressibleBy*Literal

## Verification

Full test suite passes with zero regressions.


If you need specific details from before exiting plan mode (like exact code snippets, error messages, or content you generated), read the full transcript at: /Users/michael/.claude/projects/-Users-michael-Projekte-peach/7cddf369-60e4-4fff-882d-192bcb6fea07.jsonl

### ğŸ¤– Assistant (00:21:28)

I'll start by reading the project context and the relevant existing files to understand the current codebase before implementing.

### ğŸ¤– Assistant (00:21:35)

Let me read the files I need.

### ğŸ¤– Assistant (00:22:08)

Now let me check the `TrainingSettings` struct and the existing test files I need to update.

### ğŸ¤– Assistant (00:22:21)

Now let me look at how these values are used at boundaries, and also the test files I need to update.

### ğŸ¤– Assistant (00:22:29)

Now let me look at the `Comparison` struct to see how `referencePitch` flows through, and check what `note1Frequency` / `note2Frequency` expect.

### ğŸ¤– Assistant (00:22:48)

Let me check the NotePlayer protocol for the `play` signature with duration.

### ğŸ¤– Assistant (00:22:53)

Good. The `NotePlayer.play` duration parameter takes `TimeInterval`. Now I have all the information I need. Let me create the task list and start implementing.

### ğŸ¤– Assistant (00:23:05)

Let me read the existing AmplitudeDB and Frequency test files for the pattern to follow.

### ğŸ¤– Assistant (00:23:09)

Now let me check where the `clamped(to:)` extension is defined.

### ğŸ¤– Assistant (00:23:15)

Good, I have all the info. Now let me implement everything. I'll start with the three new value objects.

### ğŸ¤– Assistant (00:23:37)

The `clamped` is on `Comparable`. Let me check the extension.

### ğŸ¤– Assistant (00:23:41)

This should work fine â€” `Double` conforms to `Comparable`. The SourceKit diagnostic is likely transient (the file hasn't been added to the Xcode project yet). Let me continue creating the other value objects.

### ğŸ¤– Assistant (00:23:55)

Now update the `UserSettings` protocol.

### ğŸ¤– Assistant (00:24:01)

Now update `AppUserSettings`.

### ğŸ¤– Assistant (00:24:07)

These errors are expected â€” the new files aren't in the Xcode project yet. They'll resolve when we build. Now update `MockUserSettings`.

### ğŸ¤– Assistant (00:24:15)

Now update boundary code. Starting with `ComparisonSession.swift`.

### ğŸ¤– Assistant (00:24:24)

Now update `PitchMatchingSession.swift`.

### ğŸ¤– Assistant (00:24:28)

Now update `SoundFontNotePlayer.swift`.

### ğŸ¤– Assistant (00:24:39)

Now let me write the tests. I need to check existing test files to see if any tests reference the old types directly.

### ğŸ¤– Assistant (00:25:00)

Good â€” the test literal assignments will auto-resolve through `ExpressibleBy*Literal` conformances. Now let me write the tests for the new value objects.

### ğŸ¤– Assistant (00:25:31)

Now I need to add the new files to the Xcode project. Let me check the project structure.

### ğŸ¤– Assistant (00:25:41)

Good â€” it uses file system synchronized groups, so new files will be picked up automatically. Let me run the full test suite.

### ğŸ¤– Assistant (00:29:57)

All tests pass. Let me verify the test count to make sure the new tests were included.

### ğŸ¤– Assistant (00:31:56)

All 608 tests pass, including all 22 new value object tests. Let me mark the final task as complete and commit.

### ğŸ¤– Assistant (00:32:06)

Everything looks clean. Let me commit.

### ğŸ¤– Assistant (00:32:31)

Done. Here's a summary of what was implemented:

**3 new value objects created:**
- `Peach/Core/UnitInterval.swift` â€” clamped `0.0...1.0`, follows the `AmplitudeDB` pattern
- `Peach/Settings/NoteDuration.swift` â€” clamped `0.3...3.0`
- `Peach/Settings/SoundSourceID.swift` â€” wraps `String` with non-empty precondition

**4 protocol/implementation files updated:**
- `UserSettings.swift` â€” protocol now uses `NoteDuration`, `Frequency`, `SoundSourceID`, `UnitInterval`
- `AppUserSettings.swift` â€” wraps `UserDefaults` reads in value object constructors
- `MockUserSettings.swift` â€” updated to use value object types
- `ComparisonSession.swift`, `PitchMatchingSession.swift`, `SoundFontNotePlayer.swift` â€” `.rawValue` extraction at boundaries

**3 test files added** (22 new tests), and all **608 tests pass** with zero regressions.

### ğŸ§‘ Human (00:34:49)

SoundFontNotePlayer:
* parseSF2Tag() should take a SoundSourceID param and return SF2Preset
* pitchBendValue() should take a Cents param

### ğŸ¤– Assistant (00:34:52)

Let me read the relevant types first.

### ğŸ¤– Assistant (00:34:56)

Good. Now let me check all callers of both methods.

### ğŸ¤– Assistant (00:35:01)

Now let me read the `SoundFontPlaybackHandle` and the test file for the full picture.

### ğŸ¤– Assistant (00:35:07)

Now let me also check `FrequencyCalculation.midiNoteAndCents` return type to understand the `conversion.cents` type.

### ğŸ¤– Assistant (00:35:43)

Now I have the full picture. Let me implement both changes.

### ğŸ¤– Assistant (00:35:47)

Now I'll make all four changes: the two method signatures, the internal caller in `play()`, and the caller in `SoundFontPlaybackHandle`.

### ğŸ¤– Assistant (00:36:06)

Now update `SoundFontPlaybackHandle.swift` â€” the `pitchBendValue` caller.

### ğŸ¤– Assistant (00:36:13)

Now update the tests. The `pitchBendValue` tests use `Double` literals which will auto-resolve via `ExpressibleByFloatLiteral` on `Cents`. But `parseSF2Tag` tests pass `String` â€” they need `SoundSourceID`. Most will auto-resolve via `ExpressibleByStringLiteral`, but the empty string `""` test case will crash since `SoundSourceID` has a non-empty precondition. Let me update the tests.

### ğŸ¤– Assistant (00:36:17)

The `parseSF2Tag` tests with string literals will auto-resolve via `ExpressibleByStringLiteral` except for `""` which would crash. I need to remove that case and adjust the test.

### ğŸ¤– Assistant (00:36:24)

Now let me run the full test suite.

### ğŸ¤– Assistant (00:36:38)

The `result.cents` from `FrequencyCalculation.midiNoteAndCents` is `Double`, so in the test calling `pitchBendValue(forCents: result.cents)` it's a variable, not a literal â€” needs explicit wrapping.

### ğŸ¤– Assistant (00:37:48)

All tests pass. Let me verify the count.

### ğŸ¤– Assistant (00:38:53)

All 609 tests pass (the one removed assertion was within a multi-assertion test, not a separate test case). Now let me commit.

### ğŸ¤– Assistant (00:39:06)

Done. Summary of changes:

- **`parseSF2Tag`** â€” now takes `SoundSourceID` and returns `SF2Preset?` instead of `(bank: Int, program: Int)?`. The `play()` method passes `userSettings.soundSource` directly without `.rawValue` extraction.
- **`pitchBendValue`** â€” now takes `Cents` instead of `Double`. Callers in `SoundFontNotePlayer` and `SoundFontPlaybackHandle` wrap the raw cents in `Cents(...)`.
- Removed the empty-string test case from `parseSF2Tag_malformedTags` since `SoundSourceID` prevents empty strings at construction time.

---

[â† Previous (dca269f2f4)](dca269f2f4.md) | [Index](index.md) | [Next (4aa3076699) â†’](4aa3076699.md)
