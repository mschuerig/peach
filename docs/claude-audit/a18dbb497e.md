---
commit: "a18dbb497ed9013a04ef404496634ba162ec9b25"
date: "2026-02-24T16:24:44+01:00"
author: "Michael Sch√ºrig <michael@schuerig.de>"
subject: "Fix code review findings for 9-2-rethink-profile-display-and-progress-tracking"
sessions: ["45f85421-9bca-4845-b108-b445bb7ea5cf"]
prev: "3cb6ee7628.md"
next: "0693992460.md"
---

[‚Üê Previous (3cb6ee7628)](3cb6ee7628.md) | [Index](index.md) | [Next (0693992460) ‚Üí](0693992460.md)

# Commit a18dbb497e

**Date:** 2026-02-24 16:24:44 UTC+01:00  
**Author:** Michael Sch√ºrig <michael@schuerig.de>

## Commit message

Fix code review findings for 9-2-rethink-profile-display-and-progress-tracking

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>

## Changed files

```
Peach/Core/Profile/ThresholdTimeline.swift         | 14 +++++++++---
 Peach/Profile/ThresholdTimelineView.swift          | 26 +++++++++++++---------
 Peach/Start/ProfilePreviewView.swift               |  2 +-
 ...ethink-profile-display-and-progress-tracking.md |  6 ++---
 docs/implementation-artifacts/sprint-status.yaml   |  2 +-
 5 files changed, 32 insertions(+), 18 deletions(-)
```

## Session `45f85421‚Ä¶`

*2026-02-24 13:12:51 UTC ‚Üí 2026-02-24 15:24:48 UTC*

### üßë Human (13:12:51)

<command-message>bmad-bmm-code-review</command-message>
<command-name>/bmad-bmm-code-review</command-name>
<command-args>9-2 Note that during development I decided to aggregate comparisons over a day.</command-args>

### ü§ñ Assistant (13:13:00)

Now let me load the config source and the instructions/validation files.

### ü§ñ Assistant (13:13:13)

Good. I've loaded the workflow engine, config, instructions, and checklist. Let me resolve variables and begin executing.

**Resolved Variables:**
- user_name: Michael
- communication_language: English
- user_skill_level: intermediate
- date: 2026-02-24
- planning_artifacts: `docs/planning-artifacts`
- implementation_artifacts: `docs/implementation-artifacts`
- template: false (action-workflow)

---

## Step 1: Load story and discover changes

Let me find and load the story file for 9-2, check git status, and discover inputs.

### ü§ñ Assistant (13:13:21)

Working directory is clean. The implementation was committed in `0693992`. Let me load the story file, get the actual files changed in that commit, and load context documents.

### ü§ñ Assistant (13:13:29)

Let me search for planning artifacts with broader patterns, and load the epic file for story 9.

### ü§ñ Assistant (13:13:34)

Good, these are whole documents (not sharded). Let me load the architecture and epics for context, then start reading the actual implementation files.

### ü§ñ Assistant (13:14:01)

Good. Step 1 complete. Let me summarize before moving to Step 2.

**Story loaded:** `docs/implementation-artifacts/9-2-rethink-profile-display-and-progress-tracking.md`
**story_key:** `9-2-rethink-profile-display-and-progress-tracking`
**Status:** review

**Git vs Story File List Cross-Reference:**
All 15 files from git match the story's File List. The only additional git files are the story file itself and `sprint-status.yaml` ‚Äî both expected. **No discrepancies.**

**Input Discovery:**
- architecture_content: Loaded from `docs/planning-artifacts/architecture.md`
- project_context: Loaded from `docs/project-context.md`
- epics: Epic 9 context from `docs/planning-artifacts/epics.md` (partial load)
- ux_design: No separate files found (whole document pattern)

---

## Step 2: Build review attack plan

**Acceptance Criteria extracted:** 8 ACs
**Tasks extracted:** 9 tasks, all marked [x] complete
**Review plan:**
1. **AC Validation** ‚Äî verify each of the 8 ACs against implementation
2. **Task Audit** ‚Äî verify each [x] task is truly done
3. **Code Quality** ‚Äî security, performance, maintainability
4. **Test Quality** ‚Äî real assertions, not placeholders

Now executing Step 3. Let me read every implementation file.

### ü§ñ Assistant (13:14:07)

Now let me read the test files and the localization strings.

### ü§ñ Assistant (13:16:07)

Now let me check the `Comparison` struct to verify `centDifference` is always positive.

### ü§ñ Assistant (13:16:52)

Good ‚Äî confirmed `Comparison.centDifference` is "always positive magnitude" (line 19). No issue there.

---

## Step 3: Execute adversarial review ‚Äî FINDINGS

I've read every file in the implementation. Here are my findings:

---

**CODE REVIEW FINDINGS, Michael!**

**Story:** `9-2-rethink-profile-display-and-progress-tracking.md`
**Git vs Story Discrepancies:** 0 (all files accounted for)
**Issues Found:** 2 High, 3 Medium, 2 Low

---

### CRITICAL / HIGH ISSUES

**H1. Zoom gesture resets to default on every new pinch** (`ThresholdTimelineView.swift:136-143`)

`handleZoom(scale:)` always divides `defaultVisibleDomainLength` (7 days) by the gesture's `magnification`. Since `MagnifyGesture.onChanged` provides scale relative to the *gesture start* (always starts at 1.0), each new pinch jumps the visible domain back to 7 days before applying the new scale.

Example: User zooms to 3.5 days, lifts fingers, starts a new pinch ‚Üí visible domain jumps to 7 days, then scales from there. The user cannot incrementally zoom.

Fix: Capture the current `visibleDomainLength` at gesture start and use that as the base for the ongoing gesture.

**H2. Force unwrap `proxy.plotFrame!`** (`ThresholdTimelineView.swift:105`)

```swift
let plotOrigin = geometry[proxy.plotFrame!].origin
```

Violates the project's hard rule: **"No force unwrapping (`!`)"** (project-context.md line 54). Should use `guard let plotFrame = proxy.plotFrame else { return }`.

---

### MEDIUM ISSUES

**M1. `aggregatedPoints` computed 3+ times per chart render** (`ThresholdTimelineView.swift:35-37, ThresholdTimeline.swift:39-60`)

In `chartView`, three calls occur:
- `timeline.rollingMean()` ‚Üí internally calls `aggregatedPoints`
- `timeline.rollingStdDev()` ‚Üí internally calls `aggregatedPoints`
- `timeline.aggregatedPoints` ‚Üí called directly for `PointMark`

Plus `handleTap` calls it again. Each call iterates all data points, builds a dictionary, and sorts. As training data grows (hundreds/thousands of comparisons), this becomes a performance concern.

Fix: Cache `aggregatedPoints` as a stored property invalidated on `dataPoints` change, or compute it once in the view and pass it down.

**M2. Detail popup can overflow chart bounds on X axis** (`ThresholdTimelineView.swift:122-125`)

The popup's X position is `pointX + plotOrigin.x` with no horizontal clamping. Tapping points near the right edge causes the popup to extend off-screen. The Y axis has `max(80, ...)` protection, but X has none.

**M3. Story File List documents incorrect test count** (story file, line 324)

File List says "20 unit tests" for `ThresholdTimelineTests.swift`. Completion Notes say "27 total". Actual count in the file: **28** `@Test` functions. None of the three numbers agree.

---

### LOW ISSUES

**L1. Redundant comparison count in detail popup** (`ThresholdTimelineView.swift:176-179`)

```swift
Text(String(localized: "\(point.comparisonCount) comparisons"))
Text(String(localized: "\(point.correctCount) of \(point.comparisonCount) correct"))
```

`comparisonCount` appears twice in adjacent lines. The accuracy line already implies the total. Consider dropping the standalone "N comparisons" line or combining them.

**L2. `accessibilityLabel` property not `private`** (`ProfilePreviewView.swift:37`)

The instance property `var accessibilityLabel: String` has internal access but is only used within the struct. Per project convention: "Default to `private` ‚Äî only use `internal` when cross-file access is needed." The `static func accessibilityLabel(timeline:)` on line 41 correctly needs internal access for tests.

---

### AC Validation Summary

| AC | Status | Notes |
|----|--------|-------|
| #1 Time-series chart | IMPLEMENTED | Chart with AreaMark, LineMark, PointMark, aggregation by day |
| #2 Horizontal scroll | IMPLEMENTED | `.chartScrollableAxes(.horizontal)` with trailing anchor |
| #3 Pinch-to-zoom | PARTIAL | Present but H1 bug makes it unreliable across gestures |
| #4 Tap-for-details | IMPLEMENTED | Shows date, mean, count, accuracy; M2 overflow concern |
| #5 Cold start | IMPLEMENTED | "Start training to build your profile" text |
| #6 Sparkline preview | IMPLEMENTED | Rolling mean LineMark, no axes, 45pt, tappable |
| #7 SummaryStatisticsView | IMPLEMENTED | Unchanged below chart |
| #8 All tests pass | IMPLEMENTED | Story claims zero failures, 28 tests written |

---

What should I do with these issues?

1. **Fix them automatically** ‚Äî I'll update the code and tests
2. **Create action items** ‚Äî Add to story Tasks/Subtasks for later
3. **Show me details** ‚Äî Deep dive into specific issues

Choose [1], [2], or specify which issue to examine:

### üßë Human (13:17:48)

1

### ü§ñ Assistant (13:18:51)

I'll fix all HIGH and MEDIUM issues now, plus the LOW ones since they're straightforward. Let me start with all the code changes.

### ü§ñ Assistant (13:19:17)

Now let me fix all the code issues. Starting with M1 (cache aggregatedPoints) since other fixes in the view depend on the model.

### ü§ñ Assistant (13:19:29)

Now add `recomputeAggregatedPoints()` call to the init, comparisonCompleted, and reset.

### ü§ñ Assistant (13:19:45)

Now fix H1 (zoom gesture), H2 (force unwrap), and M2 (popup overflow) in ThresholdTimelineView.swift.

### ü§ñ Assistant (13:19:55)

Now update the MagnifyGesture to add `.onEnded` for H1:

### ü§ñ Assistant (13:20:00)

Those are just SourceKit diagnostics from incomplete indexing ‚Äî the types exist in other files. Now fix the `handleZoom` method to use `baseVisibleDomainLength` instead of `defaultVisibleDomainLength`:

### ü§ñ Assistant (13:20:10)

Now fix H2 (force unwrap) and M2 (popup X overflow) in the tap handler:

### ü§ñ Assistant (13:20:32)

Now fix L1 (redundant popup text) and L2 (private accessibilityLabel):

### ü§ñ Assistant (13:20:40)

Now fix L2 ‚Äî make the instance `accessibilityLabel` property private in ProfilePreviewView:

### ü§ñ Assistant (13:20:46)

Now fix M3 ‚Äî update the story file test count:

### ü§ñ Assistant (13:20:52)

Also fix the Completion Notes which say "27 total":

### ü§ñ Assistant (13:21:06)

Let me verify the final state of the edited files before running tests.

### ü§ñ Assistant (13:21:10)

All edits look clean. Now let me run the full test suite.

### ü§ñ Assistant (13:22:12)

**TEST SUCCEEDED** ‚Äî all tests pass.

### ü§ñ Assistant (13:22:16)

All tests pass. Now let me execute **Step 5: Update story status and sync sprint tracking**.

Let me update the story file with review notes and status, and check sprint tracking.

### ü§ñ Assistant (13:22:22)

All issues are fixed, all ACs are implemented, all tests pass. Let me update the story status to "done" and sync sprint tracking.

### ü§ñ Assistant (13:22:40)

Sprint status synced: `9-2-rethink-profile-display-and-progress-tracking` -> done

---

## Review Complete!

**Story Status:** done
**Issues Fixed:** 7 (2 High, 3 Medium, 2 Low)
**Action Items Created:** 0

### Fixes Applied

| Issue | File | Fix |
|-------|------|-----|
| **H1** Zoom resets on each pinch | `ThresholdTimelineView.swift` | Added `baseVisibleDomainLength` state; captures current domain on gesture end, uses it as base for next gesture |
| **H2** Force unwrap `plotFrame!` | `ThresholdTimelineView.swift` | Replaced with `guard let plotFrame = proxy.plotFrame` |
| **M1** `aggregatedPoints` computed 3x/render | `ThresholdTimeline.swift` | Converted from computed to stored property; recomputed on `init`, `comparisonCompleted`, and `reset` |
| **M2** Popup overflows X bounds | `ThresholdTimelineView.swift` | Added horizontal clamping with 80pt padding from chart edges |
| **M3** Wrong test count in story | Story file | Fixed "20" -> "28" in File List, "27" -> "28" in Completion Notes |
| **L1** Redundant comparison count | `ThresholdTimelineView.swift` | Removed standalone "N comparisons" line; accuracy line already contains the count |
| **L2** Non-private `accessibilityLabel` | `ProfilePreviewView.swift` | Added `private` to instance property |

All tests pass. Code review complete!

### üßë Human (15:24:33)

commit this

### ü§ñ Assistant (15:24:48)

Committed as `a18dbb4` ‚Äî Fix code review findings for 9-2-rethink-profile-display-and-progress-tracking.

---

[‚Üê Previous (3cb6ee7628)](3cb6ee7628.md) | [Index](index.md) | [Next (0693992460) ‚Üí](0693992460.md)
