---
commit: "d6323e57096228700fd8573e16d12f27cc5715ca"
date: "2026-02-22T23:54:01+01:00"
author: "Michael Sch√ºrig <michael@schuerig.de>"
subject: "Fix code review findings for fix-feedback-icon-flicker-on-correctness-change"
sessions: ["62bec8ec-5abd-46f6-999d-d44f30602eee"]
prev: "bb6c28a637.md"
next: "aafd7821f3.md"
---

[‚Üê Previous (bb6c28a637)](bb6c28a637.md) | [Index](index.md) | [Next (aafd7821f3) ‚Üí](aafd7821f3.md)

# Commit d6323e5709

**Date:** 2026-02-22 23:54:01 UTC+01:00  
**Author:** Michael Sch√ºrig <michael@schuerig.de>

## Commit message

Fix code review findings for fix-feedback-icon-flicker-on-correctness-change

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>

## Changed files

```
Peach/Training/FeedbackIndicator.swift             |  8 ++++--
 .../Training/TrainingScreenFeedbackTests.swift     | 33 ++++++++++++++++++++--
 ...-feedback-icon-flicker-on-correctness-change.md |  8 ++++--
 docs/implementation-artifacts/sprint-status.yaml   |  2 +-
 4 files changed, 43 insertions(+), 8 deletions(-)
```

## Session `62bec8ec‚Ä¶`

*2026-02-22 22:37:02 UTC ‚Üí 2026-02-22 22:54:04 UTC*

### üßë Human (22:37:02)

<command-message>bmad-bmm-code-review</command-message>
<command-name>/bmad-bmm-code-review</command-name>
<command-args>fix-feedback-icon-flicker-on-correctness-change</command-args>

### ü§ñ Assistant (22:37:05)

I'll start by loading the workflow engine and the code review workflow configuration.

### ü§ñ Assistant (22:37:11)

Now I'll load the config source and required components.

### ü§ñ Assistant (22:37:29)

Good. All components loaded. This is an **action-workflow** (no template). Let me resolve variables and begin executing instructions.

**Resolved Variables:**
- `user_name` = Michael
- `communication_language` = English
- `planning_artifacts` = `/Users/michael/Projekte/peach/docs/planning-artifacts`
- `implementation_artifacts` = `/Users/michael/Projekte/peach/docs/implementation-artifacts`
- `story_key` = `fix-feedback-icon-flicker-on-correctness-change`
- `date` = 2026-02-22

---

## Step 1: Load story and discover changes

Let me find and load the story file and check git status.

### ü§ñ Assistant (22:37:37)

Working tree is clean. The story was committed in `aafd782`. Let me load the story and check what files that commit actually changed.

### ü§ñ Assistant (22:37:52)

**Git vs Story File List cross-reference:**
- Story claims: `TrainingScreen.swift` (Modified), `TrainingScreenFeedbackTests.swift` (New)
- Git shows: Those 2 + story file itself + sprint-status.yaml (both expected infrastructure changes)
- **No discrepancies** ‚Äî File List matches git reality.

Now loading project context and executing the discover_inputs protocol.

### ü§ñ Assistant (22:38:02)

Now let me load the supporting files for full context ‚Äî FeedbackIndicator, TrainingSession, and find the test helpers used.

### ü§ñ Assistant (22:42:01)

I now have everything I need. Let me proceed to **Step 2** and **Step 3** ‚Äî building the attack plan and executing the adversarial review.

---

## Step 2: Review Attack Plan

**Acceptance Criteria to validate:** 7 ACs covering correctness transitions, same-correctness case, first answer, Reduce Motion, feedback timing, and regression safety.

**Tasks to audit:** 3 tasks (all marked [x]), 5 subtasks (all marked [x]).

**Files to deep-review:**
- `Peach/Training/TrainingScreen.swift` ‚Äî the actual fix
- `PeachTests/Training/TrainingScreenFeedbackTests.swift` ‚Äî 6 new tests

**Attack vectors:**
1. AC Validation ‚Äî is each AC actually implemented and tested?
2. Task Audit ‚Äî are marked-complete tasks really done?
3. Code Quality ‚Äî correctness of SwiftUI pattern, architecture compliance
4. Test Quality ‚Äî real assertions vs. placeholders, TDD discipline

---

## Step 3: Adversarial Review Execution

### Git vs Story Discrepancies

Story File List claims 2 files. Git commit `aafd782` changed 4 files: the 2 claimed + the story file itself + sprint-status.yaml. Both additional files are expected infrastructure. **0 discrepancies.**

### AC Validation

| AC | Status | Evidence |
|----|--------|----------|
| AC1 (incorrect‚Üícorrect, no flash) | IMPLEMENTED | Conditional `if` removes view from tree; test `feedbackReflectsCorrectnessAfterIncorrectToCorrect` |
| AC2 (correct‚Üíincorrect, no flash) | IMPLEMENTED | Same mechanism; test `feedbackReflectsCorrectnessAfterCorrectToIncorrect` |
| AC3 (same correctness, no glitch) | **PARTIAL** | Mechanism handles it, but **no test** covers same‚Üísame scenario |
| AC4 (first answer, clean) | IMPLEMENTED | Test `firstAnswerShowsFeedbackCleanly` |
| AC5 (Reduce Motion, instant) | IMPLEMENTED | `feedbackAnimation` returns `nil`; 2 tests verify |
| AC6 (400ms timing unchanged) | IMPLEMENTED | No TrainingSession changes; timing preserved |
| AC7 (no regressions) | CLAIMED | Commit landed cleanly; cannot independently verify without running suite |

### Task Audit

All tasks marked [x] have corresponding implementation evidence in the diff and test file. However, **Task 1 ("Write failing test reproducing the flicker")** has a fundamental TDD issue ‚Äî see findings below.

### Code Quality

The `TrainingScreen.swift` fix is clean, correct, and follows standard SwiftUI patterns. The `.transition(.opacity)` + container-level `.animation()` approach is the canonical way to handle conditional view insertion with animated transitions. No security, performance, or architecture issues.

---

## Step 4: Findings

**CODE REVIEW FINDINGS, Michael!**

**Story:** `fix-feedback-icon-flicker-on-correctness-change.md`
**Git vs Story Discrepancies:** 0 found
**Issues Found:** 1 High, 2 Medium, 1 Low

---

### CRITICAL/HIGH ISSUES

**H1: Tests would have passed BEFORE the fix ‚Äî broken TDD red phase**
- `PeachTests/Training/TrainingScreenFeedbackTests.swift` (all 6 tests)
- Task 1 says "Write failing test reproducing the flicker" but every test verifies the `TrainingSession` **state contract** (`showFeedback`, `isLastAnswerCorrect`), which was **never broken**. The Dev Notes themselves acknowledge: "the state management is correct; the flicker was purely a view-rendering artifact."
- These tests would pass identically on the commit BEFORE the fix. No test actually failed before the fix was applied, meaning the TDD red-green cycle was skipped.
- **Impact:** No regression guard exists for the actual fix. If someone reverts the `if` + `.transition(.opacity)` pattern back to `.opacity()` toggling, all 6 tests still pass ‚Äî the flicker returns undetected.
- **Mitigation:** This is inherently difficult to unit-test (SwiftUI view rendering artifacts). Acknowledge in the story that TDD red phase was not achievable for this visual bug, and consider adding a manual verification step or snapshot test if the project adopts that infrastructure.

---

### MEDIUM ISSUES

**M1: Missing test for AC3 (same correctness between consecutive answers)**
- `PeachTests/Training/TrainingScreenFeedbackTests.swift`
- AC3: "Given the user answers with the same correctness as the previous answer, the icon displays normally with no visual glitch"
- Tests cover AC1 (incorrect‚Üícorrect), AC2 (correct‚Üíincorrect), AC4 (first answer), AC5 (Reduce Motion) ‚Äî but no test verifies two consecutive correct or two consecutive incorrect answers.
- **Fix:** Add a test like `feedbackShowsCorrectlyOnConsecutiveSameCorrectnessAnswers()` that answers correctly twice in a row and verifies state is clean each time.

**M2: Reduce Motion tests violate `@MainActor async` rule**
- `PeachTests/Training/TrainingScreenFeedbackTests.swift:134-142`
- `feedbackAnimationReturnsNilForReduceMotion()` and `feedbackAnimationReturnsAnimationNormally()` are neither `@MainActor` nor `async`.
- Project context rule: "Every `@Test` function must be `@MainActor async` ‚Äî Swift Testing runs tests in parallel; without `@MainActor`, data races against isolated services."
- While these specific tests call a pure static function with no shared state, the rule is explicit and exists to prevent subtle issues.
- **Fix:** Add `@MainActor` and make both functions `async`.

---

### LOW ISSUES

**L1: Stale usage example in FeedbackIndicator.swift doc comment**
- `Peach/Training/FeedbackIndicator.swift:14-17`
- The doc comment still shows the OLD pattern:
  ```swift
  /// FeedbackIndicator(isCorrect: trainingSession.isLastAnswerCorrect)
  ///     .opacity(trainingSession.showFeedback ? 1 : 0)
  /// ```
- This was correct before the fix but is now misleading. The dev agent correctly followed the "no documentation drive-bys" rule by not modifying an unchanged file, but the usage example is now wrong.
- **Fix:** Update the usage example to show the current `if` + `.transition(.opacity)` pattern.

---

What should I do with these issues?

1. **Fix them automatically** ‚Äî I'll update the code and tests
2. **Create action items** ‚Äî Add to story Tasks/Subtasks for later
3. **Show me details** ‚Äî Deep dive into specific issues

Choose [1], [2], or specify which issue to examine:

### üßë Human (22:42:56)

1

### ü§ñ Assistant (22:43:20)

Fixing all HIGH and MEDIUM issues now. Let me also fix the LOW since it's trivial.

**Fixes to apply:**
- **H1**: Add acknowledgment to story that TDD red phase wasn't achievable for this visual bug
- **M1**: Add test for AC3 (consecutive same-correctness answers)
- **M2**: Add `@MainActor async` to the two Reduce Motion tests
- **L1**: Update stale doc comment in FeedbackIndicator.swift

### ü§ñ Assistant (22:43:58)

Now updating the story file ‚Äî adding H1 acknowledgment and updating the File List and Change Log.

### ü§ñ Assistant (22:44:22)

Now let me run the full test suite to verify everything passes.

### ü§ñ Assistant (22:50:57)

All 309 tests pass, 0 failures. Now proceeding to **Step 5** ‚Äî update story status and sync sprint tracking.

### ü§ñ Assistant (22:51:02)

Now checking sprint status.

### ü§ñ Assistant (22:51:17)

Sprint status synced: `fix-feedback-icon-flicker-on-correctness-change` ‚Üí done

---

## Review Complete

**Story Status:** done
**Issues Fixed:** 3 (1 High, 2 Medium) + 1 Low
**Action Items Created:** 0

| Finding | Severity | Fix Applied |
|---------|----------|-------------|
| H1: Tests don't guard view-layer fix (TDD red phase skipped) | HIGH | Added TDD limitation note to story explaining why unit tests can't reproduce visual flicker |
| M1: Missing test for AC3 (same‚Üísame correctness) | MEDIUM | Added `feedbackDisplaysCorrectlyOnConsecutiveSameCorrectness()` test |
| M2: Reduce Motion tests missing `@MainActor async` | MEDIUM | Added `@MainActor` and `async` to both tests |
| L1: Stale usage example in FeedbackIndicator doc | LOW | Updated doc comment to show `if` + `.transition(.opacity)` pattern |

**Test suite:** 309 passed, 0 failed. Code review complete.

### üßë Human (22:53:50)

commit this

### ü§ñ Assistant (22:53:54)

Let me check the current state of the repo.

### ü§ñ Assistant (22:54:04)

Committed as `d6323e5`. Working tree is clean.

---

[‚Üê Previous (bb6c28a637)](bb6c28a637.md) | [Index](index.md) | [Next (aafd7821f3) ‚Üí](aafd7821f3.md)
