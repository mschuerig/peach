---
commit: "8434cba54a7107e1f5d2f4380173c2c409b906a4"
date: "2026-02-23T23:31:24+01:00"
author: "Michael Sch√ºrig <michael@schuerig.de>"
subject: "Fix code review findings for 8-3-remove-sinewavenoteplayer-and-routingnoteplayer"
sessions: ["577b50ab-cea4-4fb2-8710-68922a9293f7"]
prev: "aa1f2b899c.md"
next: "4391637271.md"
---

[‚Üê Previous (aa1f2b899c)](aa1f2b899c.md) | [Index](index.md) | [Next (4391637271) ‚Üí](4391637271.md)

# Commit 8434cba54a

**Date:** 2026-02-23 23:31:24 UTC+01:00  
**Author:** Michael Sch√ºrig <michael@schuerig.de>

## Commit message

Fix code review findings for 8-3-remove-sinewavenoteplayer-and-routingnoteplayer

Add @MainActor async to 22 relocated FrequencyCalculation tests, update
architecture.md SineWaveNotePlayer references to SoundFontNotePlayer,
remove redundant import AVFAudio, remove legacy cello tag handling from
parseSF2Tag, remove stale Sine Wave localization entry, add missing
Localizable.xcstrings to story File List.

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>

## Changed files

```
Peach/Core/Audio/SoundFontNotePlayer.swift         |  3 --
 Peach/Resources/Localizable.xcstrings              | 11 ------
 .../Core/Audio/FrequencyCalculationTests.swift     | 44 +++++++++++-----------
 .../Core/Audio/SoundFontNotePlayerTests.swift      |  9 ++---
 ...ove-sinewavenoteplayer-and-routingnoteplayer.md |  4 +-
 docs/implementation-artifacts/sprint-status.yaml   |  2 +-
 docs/planning-artifacts/architecture.md            | 18 ++++-----
 7 files changed, 39 insertions(+), 52 deletions(-)
```

## Session `577b50ab‚Ä¶`

*2026-02-23 22:11:15 UTC ‚Üí 2026-02-23 22:31:30 UTC*

### üßë Human (22:11:15)

<command-message>bmad-bmm-code-review</command-message>
<command-name>/bmad-bmm-code-review</command-name>
<command-args>8-3</command-args>

### ü§ñ Assistant (22:11:17)

I'll start by loading the workflow execution framework and the code review workflow configuration.

### ü§ñ Assistant (22:11:22)

Now I'll load the config source and the instructions/checklist files.

### ü§ñ Assistant (22:11:30)

Now let me resolve variables and find the story file for 8-3. I'll load the project context and find the story file in parallel.

### ü§ñ Assistant (22:11:37)

Now let me load the story file and the planning artifacts in parallel.

### ü§ñ Assistant (22:11:47)

Git working tree is clean ‚Äî the story has been committed. Let me find the relevant commit and examine the actual changes.

### ü§ñ Assistant (22:12:00)

Now I have the story loaded and the git diff. Let me build the review attack plan.

**Step 2: Review Attack Plan**

**Acceptance Criteria (10 total):** All tasks marked [x] (8 tasks, all complete).

**Git vs Story Discrepancy:** 1 file changed in git (`Peach/Resources/Localizable.xcstrings`) but NOT listed in the story's File List.

Now let me execute the adversarial review by reading all implementation files.

### ü§ñ Assistant (22:12:07)

Now let me read the test files and verify the remaining claims.

### ü§ñ Assistant (22:12:15)

Now let me verify no orphaned references remain and check a few more things.

### ü§ñ Assistant (22:14:03)

Let me check a few more things for the adversarial review.

### ü§ñ Assistant (22:14:12)

Let me check one final thing ‚Äî which FrequencyCalculation tests were pre-existing vs relocated.

### ü§ñ Assistant (22:15:20)

I've completed the adversarial review. Let me present the findings.

---

**CODE REVIEW FINDINGS, Michael!**

**Story:** `docs/implementation-artifacts/8-3-remove-sinewavenoteplayer-and-routingnoteplayer.md`
**Git vs Story Discrepancies:** 1 found
**Issues Found:** 2 High, 4 Medium, 2 Low

---

## CRITICAL / HIGH Issues

### H1: Relocated tests violate project `@MainActor async` convention
**File:** `PeachTests/Core/Audio/FrequencyCalculationTests.swift:11-174`

20+ relocated test functions lack `@MainActor` and/or `async` annotations. Project rule (project-context.md): *"Every `@Test` function must be `@MainActor async`"*. The pre-existing tests in the **same file** (line 176+) properly use `@MainActor func ... async`, creating an inconsistency within one file.

Examples:
```swift
// Relocated tests (missing @MainActor async):
func frequencyCalculation_MiddleC() throws { ... }
func frequencyCalculation_A4() throws { ... }
func audioError_CasesExist() { ... }

// Pre-existing tests in same file (correct):
@MainActor func roundTrip_A4() async throws { ... }
```

### H2: Architecture.md has 8 stale `SineWaveNotePlayer` references
**File:** `docs/planning-artifacts/architecture.md` (lines 151, 171, 190, 204, 236, 290, 317, 354, 366)

While AC#10 only requires updating `project-context.md` (which was done correctly), the architecture doc remains the primary architectural reference. It still describes `SineWaveNotePlayer` as the MVP NotePlayer implementation, includes it in directory structures, and lists it in implementation sequences. Any future agent reading this doc will get incorrect information about the audio architecture.

---

## MEDIUM Issues

### M1: File List missing `Localizable.xcstrings`
**Story File List** does not include `Peach/Resources/Localizable.xcstrings`, which was modified in the commit (the "Sine Wave" string was marked as `"extractionState": "stale"` by Xcode).

### M2: Redundant `import AVFAudio`
**File:** `SoundFontNotePlayer.swift:2`

`AVFAudio` is a sub-module of `AVFoundation` (line 1). Importing both is unnecessary ‚Äî remove `import AVFAudio`.

### M3: `parseSF2Tag` inconsistent legacy tag handling
**File:** `SoundFontNotePlayer.swift:192-201`

The method handles legacy `"cello"` tag explicitly (returning `(bank: 0, program: 42)`) but does NOT handle legacy `"sine"`. The `"sine"` tag falls through to `nil` and is handled by the fallback path in `play()`. Both paths produce the correct result, but the inconsistency is confusing ‚Äî consider adding `if source == "sine" { return (bank: 8, program: 80) }` for symmetry.

### M4: Stale localization entry for "Sine Wave"
**File:** `Peach/Resources/Localizable.xcstrings`

The hardcoded "Sine Wave" was removed from the instrument picker (Task 5.2), but the localization entry was left stale instead of removed. German users previously saw "Sinuswelle" ‚Äî they now see "Sine Wave" (from SF2 file metadata). Minor localization regression.

---

## LOW Issues

### L1: Comment references wrong story
**File:** `SoundFontNotePlayer.swift:193`

Comment says `// Migrate legacy "cello" tag from story 8-1`. The cello tag and routing system were introduced in story 8-2, not 8-1.

### L2: `arc42/08-crosscutting-concepts.md` references deleted AudioError cases
References to `renderFailed` and `nodeAttachFailed` exist in the arc42 documentation. Outside story scope but adds to documentation staleness.

---

What should I do with these issues?

1. **Fix them automatically** ‚Äî I'll update the code and tests
2. **Create action items** ‚Äî Add to story Tasks/Subtasks for later
3. **Show me details** ‚Äî Deep dive into specific issues

Choose [1], [2], or specify which issue to examine.

### üßë Human (22:18:54)

1. Regarding M3: remove the legacy handling.

### ü§ñ Assistant (22:20:09)

I'll fix all HIGH and MEDIUM issues now, removing the legacy "cello" handling from `parseSF2Tag` per your instruction.

### ü§ñ Assistant (22:20:23)

Now let me fix H1 ‚Äî rewriting the FrequencyCalculationTests with proper annotations. I'll also start the independent M2/M3 edits in parallel.

### ü§ñ Assistant (22:21:45)

Those diagnostics are SourceKit indexing artifacts (macOS context vs iOS target) ‚Äî not real build errors. Let me continue with H2 and the remaining fixes.

### ü§ñ Assistant (22:21:57)

Now let me also fix the architecture.md descriptions that need updating beyond the name replacement, and handle M1 (story File List) and M4 (stale localization).

### ü§ñ Assistant (22:22:13)

All edits done. Now let me run the full test suite to verify nothing is broken.

### ü§ñ Assistant (22:23:15)

**TEST SUCCEEDED** ‚Äî all tests pass. Now let me update the story status and sprint tracking.

### ü§ñ Assistant (22:23:25)

Now let me update the story's Change Log with the review entry.

### ü§ñ Assistant (22:23:40)

---

**Review Complete!**

**Story Status:** done
**Issues Fixed:** 6 (2 High, 4 Medium)
**Action Items Created:** 0

| Issue | Fix Applied |
|---|---|
| **H1** Relocated tests missing `@MainActor async` | Added annotations to all 22 relocated test functions in `FrequencyCalculationTests.swift` |
| **H2** Architecture.md stale references | Replaced all 8 `SineWaveNotePlayer` ‚Üí `SoundFontNotePlayer`, updated file descriptions |
| **M1** File List missing `Localizable.xcstrings` | Added to story File List |
| **M2** Redundant `import AVFAudio` | Removed from `SoundFontNotePlayer.swift` |
| **M3** Legacy "cello" handling in `parseSF2Tag` | Removed per your instruction; updated test to expect `nil` for "cello" |
| **M4** Stale "Sine Wave" localization entry | Removed from `Localizable.xcstrings` |

Full test suite passes. Sprint status synced: `8-3-remove-sinewavenoteplayer-and-routingnoteplayer` ‚Üí done.

### üßë Human (22:31:09)

commit this

### ü§ñ Assistant (22:31:30)

Committed as `8434cba`. Working tree is clean.

---

[‚Üê Previous (aa1f2b899c)](aa1f2b899c.md) | [Index](index.md) | [Next (4391637271) ‚Üí](4391637271.md)
