---
commit: "ebb5873d0320cf1d5aa073d01693b02ec05a22a2"
date: "2026-02-18T01:05:25+01:00"
author: "Michael Sch√ºrig <michael@schuerig.de>"
subject: "Code review fixes for Story 7.1: plural variants, chart translations, accessibility labels, tests"
sessions: ["d966ba05-9bc7-4402-a4f6-7ac891353732"]
prev: "820a74c6b0.md"
next: "76b0b7a76b.md"
---

[‚Üê Previous (820a74c6b0)](820a74c6b0.md) | [Index](index.md) | [Next (76b0b7a76b) ‚Üí](76b0b7a76b.md)

# Commit ebb5873d03

**Date:** 2026-02-18 01:05:25 UTC+01:00  
**Author:** Michael Sch√ºrig <michael@schuerig.de>

## Commit message

Code review fixes for Story 7.1: plural variants, chart translations, accessibility labels, tests

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>

## Changed files

```
Peach/Profile/SummaryStatisticsView.swift          |  2 +-
 Peach/Resources/Localizable.xcstrings              | 72 +++++++++++++++++++---
 Peach/Training/FeedbackIndicator.swift             |  2 +-
 PeachTests/Profile/ProfileScreenTests.swift        | 31 +++++++++-
 PeachTests/Profile/SummaryStatisticsTests.swift    | 41 ++++++++----
 PeachTests/Start/ProfilePreviewViewTests.swift     | 32 ++++++++--
 .../7-1-english-and-german-localization.md         | 32 +++++++---
 docs/implementation-artifacts/sprint-status.yaml   |  2 +-
 tools/parse-xcresult.py                            | 13 +++-
 9 files changed, 188 insertions(+), 39 deletions(-)
```

## Session `d966ba05‚Ä¶`

*2026-02-17 23:38:40 UTC ‚Üí 2026-02-18 00:05:28 UTC*

### üßë Human (23:38:40)

<command-message>bmad-bmm-code-review</command-message>
<command-name>/bmad-bmm-code-review</command-name>
<command-args>7-1</command-args>

### ü§ñ Assistant (23:38:42)

I'll start by loading the workflow execution framework and the code review workflow configuration.

### ü§ñ Assistant (23:38:47)

Now let me load the config source and the instructions file.

### ü§ñ Assistant (23:38:57)

Good. I've loaded all workflow components. Let me resolve variables and begin the adversarial code review.

**Resolved variables:**
- user_name: Michael
- communication_language: English
- story argument: 7-1 (Epic 7, Story 1)

This is an action-workflow (no template output). Let me execute **Step 1: Load story and discover changes**.

### ü§ñ Assistant (23:39:04)

Working directory is clean. The story implementation was already committed. Let me read the story file and examine the git changes.

### ü§ñ Assistant (23:39:16)

Good. Story file loaded. Let me cross-reference:

**Git vs Story File List:** Perfect match. Git commit `76b0b7a` contains all 10 files listed in the story (plus the story file itself, which is expected). No discrepancies.

Now executing the **discover_inputs** protocol and loading all implementation files for deep review.

### ü§ñ Assistant (23:39:23)

Now let me load the planning artifacts and all implementation files for the review.

### ü§ñ Assistant (23:39:36)

**Discover Inputs Results:**
- ‚úì Loaded architecture from: `architecture.md`
- ‚úì Loaded UX design from: `ux-design-specification.md`
- ‚úì Loaded epics from: `epics.md` (Story 7.1 found in Epic 7)
- ‚óã No project-context.md found

**Git vs Story Discrepancies:** 0 found (perfect match)

Now executing **Step 2: Build review attack plan**, then diving into all implementation files.

**Review Attack Plan:**
1. **AC Validation** ‚Äî 4 ACs to verify
2. **Task Audit** ‚Äî 6 tasks (all marked [x]) to validate against actual code
3. **Code Quality** ‚Äî Security, performance, maintainability across all changed files
4. **Test Quality** ‚Äî Are tests real assertions or locale-bypassing shortcuts?

Let me read every implementation file now.

### ü§ñ Assistant (23:39:44)

Now let me read the String Catalog and sprint status to complete the deep dive.

### ü§ñ Assistant (23:39:52)

Now let me check files the story claims don't need changes, to verify that claim.

### ü§ñ Assistant (23:43:58)

I've now read every implementation file, every test file, the complete String Catalog, and all related screens. Let me present the adversarial review findings.

---

## CODE REVIEW FINDINGS, Michael!

**Story:** `docs/implementation-artifacts/7-1-english-and-german-localization.md`
**Git vs Story Discrepancies:** 0 found
**Issues Found:** 2 High, 2 Medium, 1 Low

---

### CRITICAL / HIGH ISSUES

**H1: Missing English plural variants for ProfileScreen accessibility string**
File: `Peach/Resources/Localizable.xcstrings` (line 347-355)

The key `"Perceptual profile showing detection thresholds from %@ to %@. Average threshold: %lld cents."` has a German translation but **no English plural variants**. Every other `%lld cents` string in the catalog has English `one`/`other` plural variants (e.g., `"%lld cents"`, `"¬±%lld cents"`, `"Mean detection threshold: %lld cents"`, `"Your pitch profile...%lld cents."`). This one does not.

**Impact:** In English, a threshold of 1 would render as "Average threshold: 1 cents." ‚Äî grammatically incorrect. Inconsistent with the plural handling applied everywhere else.

**Fix:** Add English plural variants (`one` ‚Üí "...1 cent.", `other` ‚Üí "...%lld cents.") matching the pattern of the other plural-varied keys.

---

**H2: 4 String Catalog keys with missing German translations**
File: `Peach/Resources/Localizable.xcstrings` (lines 304-306, 417-419, 530-532, 583-585)

Four keys have completely empty localization blocks ‚Äî no German translations:
- `"Note"` ‚Üí `{}`
- `"Segment"` ‚Üí `{}`  
- `"Threshold"` ‚Üí `{}`
- `"Upper"` ‚Üí `{}`

These appear to be auto-extracted by Xcode (likely from Swift Charts axis/series identifiers). Task 5 subtask claims "Verify no string keys are marked stale or missing" ‚Äî but these 4 keys have zero translations.

**Impact:** If any of these strings are user-visible (e.g., VoiceOver reading chart elements), German users would see English text. Even if they're not directly visible, untranslated keys in the catalog are a localization hygiene issue.

**Fix:** Either add German translations for these keys, or mark them as "not needing localization" in the String Catalog (right-click ‚Üí Mark as Reviewed / Don't Translate) to suppress warnings.

---

### MEDIUM ISSUES

**M1: Tautological localization tests**
Files: `PeachTests/Profile/SummaryStatisticsTests.swift` (lines 96-114), `PeachTests/Profile/ProfileScreenTests.swift` (lines 242-247), `PeachTests/Start/ProfilePreviewViewTests.swift` (lines 19-32)

All 7 localization-specific tests added in Story 7.1 use the **same `String(localized:)` expression** in both the function under test and the expected value. For example:

```swift
// SummaryStatisticsTests.swift:100
#expect(result == String(localized: "\(25) cents"))
```

The function being tested does `return String(localized: "\(rounded) cents")`. This is `expect(f(x) == f(x))` ‚Äî it's tautological and can never fail in any locale. If someone accidentally removes the `String(localized:)` wrapper from the production code, returning a plain interpolated string, these tests would **still pass in English locale** because both sides resolve to identical text.

**Impact:** These tests provide zero regression safety against de-localization in the default test locale (English). They would only catch regressions if run explicitly in a non-English locale.

**Fix:** Either:
- Test with an explicit German locale override (`Locale(identifier: "de")`) and assert against known German output
- Or assert structural properties (e.g., that the output for value 1 uses singular "cent" not "cents") that would differ between localized and non-localized code

---

**M2: Ternary expressions in `.accessibilityLabel()` may bypass localization**
Files: `Peach/Profile/SummaryStatisticsView.swift:38`, `Peach/Training/FeedbackIndicator.swift:27`

Two files use ternary expressions inside `.accessibilityLabel()`:

```swift
// SummaryStatisticsView.swift:38
.accessibilityLabel(stats == nil ? "No training data yet" : "Summary statistics")

// FeedbackIndicator.swift:27
.accessibilityLabel(isCorrect ? "Correct" : "Incorrect")
```

Swift resolves ternary expressions to `String` before passing to the modifier. This may invoke SwiftUI's `StringProtocol` overload of `.accessibilityLabel()` rather than the `LocalizedStringKey` overload. If so, the strings would **not be localized at runtime** despite being extracted into the catalog at build time.

**Note:** This is a pre-existing pattern (not introduced by Story 7.1), and the story notes explicitly say "no change needed" for these. However, the Story 7.1 scope is "every string is externalized" ‚Äî if these ternaries bypass runtime localization, that AC is not fully met.

**Impact:** German VoiceOver users might hear "No training data yet" / "Summary statistics" / "Correct" / "Incorrect" in English instead of German.

**Fix:** Replace ternary with explicit `String(localized:)` calls:
```swift
.accessibilityLabel(stats == nil 
    ? String(localized: "No training data yet") 
    : String(localized: "Summary statistics"))
```

---

### LOW ISSUES

**L1: Hardcoded DerivedData path in parse-xcresult.py**
File: `tools/parse-xcresult.py:83-85`

```python
derived_data = os.path.expanduser(
    "~/Library/Developer/Xcode/DerivedData/Peach-hkiivdgmvdxnrwgzjcrsmowssdbf"
)
```

The hash `hkiivdgmvdxnrwgzjcrsmowssdbf` is generated by Xcode based on the project path. If DerivedData is cleaned and rebuilt, or the project is opened from a different path, this tool breaks silently.

**Fix:** Dynamically discover the DerivedData folder by globbing `~/Library/Developer/Xcode/DerivedData/Peach-*` and selecting the most recent match.

---

### Review Summary

| Category | Verdict |
|---|---|
| **AC1** (all strings externalized + translated) | PARTIAL ‚Äî 4 keys missing German translations |
| **AC2** (German locale works) | LIKELY OK ‚Äî pending verification of ternary accessibility labels |
| **AC3** (English default) | IMPLEMENTED |
| **AC4** (custom components localized) | IMPLEMENTED |
| **Task completion** | All 6 tasks genuinely completed |
| **Test quality** | Tests exist but are tautological for locale verification |
| **Code quality** | Good ‚Äî clean `String(localized:)` pattern applied consistently |

---

What should I do with these issues?

1. **Fix them automatically** ‚Äî I'll update the code, catalog, and tests
2. **Create action items** ‚Äî Add to story Tasks/Subtasks for later
3. **Show me details** ‚Äî Deep dive into specific issues

Choose [1], [2], or specify which issue to examine.

### üßë Human (23:47:36)

1. Also, if you need translations between English and German you can just ask me.

### ü§ñ Assistant (23:47:49)

Great, let me fix all issues. First, let me trace where those 4 untranslated String Catalog keys come from.

### ü§ñ Assistant (23:47:56)

All 4 keys come from Swift Charts `.value()` calls in `ConfidenceBandView.swift`. Let me read that file, then fix everything.

### ü§ñ Assistant (23:49:54)

I'll fix all 5 issues. Let me start with the code changes across all files.

### ü§ñ Assistant (23:50:25)

Before I translate the 4 chart keys ‚Äî these are Swift Charts `.value("label", data)` descriptors in `ConfidenceBandView`. They're used for VoiceOver chart descriptions. The terms are:

- **"Note"** ‚Äî x-axis label for MIDI note position
- **"Segment"** ‚Äî series label for contiguous trained note groups
- **"Threshold"** ‚Äî y-axis label for detection threshold (cents)
- **"Upper"** ‚Äî y-axis label for upper confidence band bound

My proposed German translations: "Note" ‚Üí "Note", "Segment" ‚Üí "Segment", "Threshold" ‚Üí "Schwelle", "Upper" ‚Üí "Obergrenze". Are those good, or do you prefer different terms?

### ü§ñ Assistant (23:55:32)

Got it ‚Äî "Abschnitt" for Segment. Now let me fix everything.

Starting with **M2: Fix ternary accessibility labels**.

### ü§ñ Assistant (23:56:24)

Now **H1 + H2: Fix String Catalog** ‚Äî adding English plural variants and 4 missing German translations.

### ü§ñ Assistant (23:56:31)

Those are SourceKit IDE diagnostics, not actual build errors ‚Äî they appear because SourceKit can't resolve cross-module types in isolation. The real build will be fine.

Now editing the String Catalog for H1 and H2.

### ü§ñ Assistant (23:56:41)

Now H2 ‚Äî adding German translations for the 4 chart keys.

### ü§ñ Assistant (23:56:53)

Now **M1: Replace tautological localization tests** with plural-verification tests that actually catch regressions.

### ü§ñ Assistant (23:57:10)

Now fix the tautological test in ProfileScreenTests.

### ü§ñ Assistant (23:57:25)

Now fix the tautological tests in ProfilePreviewViewTests.

### ü§ñ Assistant (23:57:41)

Now **L1: Fix hardcoded DerivedData path**.

### ü§ñ Assistant (23:57:55)

Now **Task 6: Run full test suite** to verify all fixes.

### ü§ñ Assistant (00:01:29)

All tests pass. Let me count the total tests.

### ü§ñ Assistant (00:02:27)

**239 tests pass, TEST SUCCEEDED.** Now let me update the story file with review notes and update the sprint status.

### ü§ñ Assistant (00:02:58)

Now update the sprint status.

### ü§ñ Assistant (00:03:10)

---

## Review Complete!

**Story Status:** done
**Issues Fixed:** 5 (2 High, 2 Medium, 1 Low)
**Action Items Created:** 0
**Tests:** 239 pass, 0 failures

**Sprint status synced:** `7-1-english-and-german-localization` ‚Üí done

### Files Modified in This Review

| File | Change |
|---|---|
| `Peach/Profile/SummaryStatisticsView.swift` | Fixed ternary `.accessibilityLabel()` to use `String(localized:)` |
| `Peach/Training/FeedbackIndicator.swift` | Fixed ternary `.accessibilityLabel()` to use `String(localized:)` |
| `Peach/Resources/Localizable.xcstrings` | Added English plural variants for ProfileScreen accessibility string; added 4 chart key translations (Note/Abschnitt/Schwelle/Obergrenze) |
| `PeachTests/Profile/SummaryStatisticsTests.swift` | Replaced tautological tests with singular/plural verification |
| `PeachTests/Profile/ProfileScreenTests.swift` | Replaced tautological test + added plural variant test |
| `PeachTests/Start/ProfilePreviewViewTests.swift` | Replaced tautological tests with content + plural verification |
| `tools/parse-xcresult.py` | Dynamic DerivedData path discovery |
| `docs/implementation-artifacts/7-1-english-and-german-localization.md` | Status ‚Üí done, added review notes |
| `docs/implementation-artifacts/sprint-status.yaml` | 7-1 ‚Üí done |

Ready for you to review and commit when satisfied.

### üßë Human (00:05:10)

Looks fine. Go ahead.

### ü§ñ Assistant (00:05:28)

Committed as `ebb5873`. Follows the project's pattern: implementation commit ‚Üí code review fixes commit.

---

[‚Üê Previous (820a74c6b0)](820a74c6b0.md) | [Index](index.md) | [Next (76b0b7a76b) ‚Üí](76b0b7a76b.md)
