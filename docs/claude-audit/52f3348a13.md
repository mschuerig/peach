---
commit: "52f3348a13b428e2fd03801cd3bd995c84588867"
date: "2026-02-27T03:49:02+01:00"
author: "Michael Sch√ºrig <michael@schuerig.de>"
subject: "Fix code review findings for 19-5-trainingsession-protocol-and-dependency-cleanup and mark done"
sessions: ["84dd89ae-cade-401e-a754-c2636a017b14"]
prev: "a554709a45.md"
next: "81b96d39a5.md"
---

[‚Üê Previous (a554709a45)](a554709a45.md) | [Index](index.md) | [Next (81b96d39a5) ‚Üí](81b96d39a5.md)

# Commit 52f3348a13

**Date:** 2026-02-27 03:49:02 UTC+01:00  
**Author:** Michael Sch√ºrig <michael@schuerig.de>

## Commit message

Fix code review findings for 19-5-trainingsession-protocol-and-dependency-cleanup and mark done

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>

## Changed files

```
Peach/PitchMatching/PitchMatchingScreen.swift      |   8 +-
 Peach/PitchMatching/PitchMatchingSession.swift     |  19 +--
 Peach/PitchMatching/VerticalPitchSlider.swift      |  45 +++----
 .../PitchMatching/PitchMatchingSessionTests.swift  | 139 +++++++--------------
 .../PitchMatching/VerticalPitchSliderTests.swift   |  52 ++++----
 ...iningsession-protocol-and-dependency-cleanup.md |  15 ++-
 docs/implementation-artifacts/sprint-status.yaml   |   2 +-
 docs/project-context.md                            |   2 +-
 8 files changed, 122 insertions(+), 160 deletions(-)
```

## Session `84dd89ae‚Ä¶`

*2026-02-27 02:16:34 UTC ‚Üí 2026-02-27 02:49:35 UTC*

### üßë Human (02:16:34)

<command-message>bmad-bmm-code-review</command-message>
<command-name>/bmad-bmm-code-review</command-name>
<command-args>19.5</command-args>

### ü§ñ Assistant (02:16:36)

I'll start by loading the workflow execution framework and the code review workflow configuration.

### ü§ñ Assistant (02:16:41)

Now let me load the config source and the instruction/validation files.

### ü§ñ Assistant (02:16:57)

Good. All workflow components loaded. This is an **action-workflow** (no template). Let me resolve the variables and begin.

**Resolved Variables:**
- user_name: Michael
- communication_language: English
- user_skill_level: intermediate
- planning_artifacts: `/Users/michael/Projekte/peach/docs/planning-artifacts`
- implementation_artifacts: `/Users/michael/Projekte/peach/docs/implementation-artifacts`
- sprint_status: `/Users/michael/Projekte/peach/docs/implementation-artifacts/sprint-status.yaml`
- date: 2026-02-27
- story argument: 19.5 ‚Üí epic_num=19, story_num=5

---

## Step 1: Load story and discover changes

Let me find and load the story file, check git status, and discover input files.

### ü§ñ Assistant (02:17:06)

Good. Working tree is clean ‚Äî all changes for story 19.5 are in commit `81b96d3`. Let me load the story file and get the git diff for that commit.

### ü§ñ Assistant (02:17:20)

**Git vs Story File List comparison:**
- Story File List: 10 files (7 production + 3 test)
- Git commit: 12 files (10 source + story file + sprint-status.yaml)
- **Match: Perfect** ‚Äî the extra 2 files are the story file itself and sprint-status.yaml (meta-files)

Now let me load the project context and all changed source files for the adversarial review.

### ü§ñ Assistant (02:17:27)

Now let me load the test files.

### ü§ñ Assistant (02:17:35)

Now let me do some specific adversarial checks.

### ü§ñ Assistant (02:17:46)

Good ‚Äî REVIEW comments are gone, old slider parameters are gone, ContentView has no concrete session references. Let me do more adversarial checks.

### ü§ñ Assistant (02:18:02)

Let me check if the old `adjustFrequency` API is still called from production code and look at the `centRange` configuration.

### ü§ñ Assistant (02:19:31)

Let me check how other environment entries are organized in the project for comparison.

### ü§ñ Assistant (02:20:39)

Let me check for force unwraps in the changed files.

### ü§ñ Assistant (02:20:45)

Good, no force unwraps. Now I have all the data I need. Let me also quickly load the sprint-status.yaml to verify it was updated correctly.

### ü§ñ Assistant (02:21:25)

---

## Step 2: Review Attack Plan

**AC Validation targets:**
1. `TrainingSession` protocol with `stop()` + `isIdle` ‚Äî VERIFIED
2. `ContentView` uses protocol only ‚Äî VERIFIED (no concrete session references)
3. Active session tracking in PeachApp ‚Äî VERIFIED (onChange handlers)
4. VerticalPitchSlider normalized API ‚Äî VERIFIED (all old params removed)
5. PitchMatchingSession owns pitch calculations ‚Äî VERIFIED
6. No REVIEW comments remain ‚Äî VERIFIED (grep found zero)
7. All tests pass ‚Äî CLAIMED by dev agent, commit message confirms

**Task audit:** All 9 tasks marked [x] ‚Äî verified against actual code.

---

## Step 3: Adversarial Review ‚Äî Findings

**Git vs Story File List Discrepancies:** 0 found (perfect match)

---

**CODE REVIEW FINDINGS, Michael!**

**Story:** 19-5-trainingsession-protocol-and-dependency-cleanup.md
**Git vs Story Discrepancies:** 0 found
**Issues Found:** 0 High, 4 Medium, 1 Low

---

### MEDIUM ISSUES

**M1: `adjustFrequency(_ frequency: Double)` is dead production code with duplicated logic**
`Peach/PitchMatching/PitchMatchingSession.swift:99-103`

No production caller exists after the normalized API was introduced. `PitchMatchingScreen` now exclusively uses `adjustNormalizedPitch`. Furthermore, `adjustNormalizedPitch` (line 83-89) duplicates the `currentHandle?.adjustFrequency()` call instead of calling through `adjustFrequency` ‚Äî contrast with `commitNormalizedPitch` which properly delegates to `commitResult`. Two options:
- Make `adjustFrequency` `private` and have `adjustNormalizedPitch` call it (matching `commitNormalizedPitch` ‚Üí `commitResult` pattern)
- Or remove `adjustFrequency` entirely and keep only `adjustNormalizedPitch`

Tests at `PitchMatchingSessionTests.swift:168,291` exercise the old API directly and should be updated.

**M2: `commitResult(userFrequency:)` should be `private`**
`Peach/PitchMatching/PitchMatchingSession.swift:106`

Only called internally by `commitNormalizedPitch` now. No production code calls it directly. Per project convention: "Default to `private` ‚Äî only use `internal` when cross-file access within the module is needed" (project-context.md:48). Tests that call `commitResult` directly should go through the normalized API instead.

**M3: `centRange` / `initialCentOffsetRange` are silently coupled**
`Peach/PitchMatching/PitchMatchingSession.swift:40,81`

Two independent constants express the same value (100 cents):
```swift
private static let initialCentOffsetRange: ClosedRange<Double> = -100.0...100.0  // line 40
private static let centRange: Double = 100                                       // line 81
```
If one changes without the other, the slider's adjustment range silently falls out of sync with challenge generation. Fix: derive `centRange` from `initialCentOffsetRange.upperBound`.

**M4: Missing `accessibilityValue` on rewritten slider**
`Peach/PitchMatching/VerticalPitchSlider.swift:65-82`

The slider has `accessibilityLabel` and `accessibilityAdjustableAction`, but no `accessibilityValue`. VoiceOver users can adjust the slider but receive no spoken feedback about the current position. Should report the normalized value as a percentage or descriptive text (e.g., "center", "+30%"). This is particularly important since the slider was fully rewritten in this story and accessibility was part of the task list (Task 4: "Update accessibility actions to use normalized increments").

---

### LOW ISSUES

**L1: `project-context.md` not updated for `TrainingSession` dependency**
`docs/project-context.md:64`

The doc says "Views only interact with `ComparisonSession`, `PitchMatchingSession`, and `PerceptualProfile`" but `ContentView` now also depends on `TrainingSession` via `@Environment(\.activeSession)`. The doc should mention `TrainingSession` in the list of view-accessible types.

---

### AC Verification Summary

| AC | Status | Evidence |
|----|--------|----------|
| #1 TrainingSession protocol | IMPLEMENTED | `TrainingSession.swift:3-6` ‚Äî `stop()` + `isIdle`, both sessions conform |
| #2 ContentView uses protocol | IMPLEMENTED | `ContentView.swift:6` ‚Äî only `@Environment(\.activeSession)` |
| #3 Active session tracking | IMPLEMENTED | `PeachApp.swift:80-99` ‚Äî `onChange` handlers |
| #4 Slider normalized API | IMPLEMENTED | `VerticalPitchSlider.swift` ‚Äî `-1.0...1.0`, old params removed |
| #5 Session owns pitch calc | IMPLEMENTED | `PitchMatchingSession.swift:83-97` ‚Äî converts normalized‚Üífrequency |
| #6 No REVIEW comments | IMPLEMENTED | Grep confirms zero matches |
| #7 All tests pass | CLAIMED | Dev log says full suite passes |

---

What should I do with these issues?

1. **Fix them automatically** ‚Äî I'll update the code and tests
2. **Create action items** ‚Äî Add to story Tasks/Subtasks for later
3. **Show me details** ‚Äî Deep dive into specific issues

Choose [1], [2], or specify which issue to examine:

### üßë Human (02:34:27)

M1/M2/M3: The "normalized" naming is dumb. Here and in VerticalPitchSlider, too. We really need Value Types for float/double values that are restricted to -1.0...1.0 or 0.0...1.0. Otherwise the interface of adjustNormalizedPitch() and commitNormalizedPitch() is misleading. I suggset renaming these methods to adjustPitch() and commitPitch() and remove the older methods of those names. Beyond that, in PitchMatchingSession, there are too many places where cent values are naked doubles instead of Cents. The 100 in initialCentOffsetRange is the same in both places as the range is supposed to be symmetric around 0.0. It's also the same value as the 100 in centRange.

The others you can just fix.

### ü§ñ Assistant (02:34:56)

Let me check what value types already exist in the project and see how `Cents` is used.

### ü§ñ Assistant (02:35:04)

There's already a `Cents` value type. Let me read it and understand its structure.

### ü§ñ Assistant (02:37:18)

Good ‚Äî there's already a `Cents` value type at `Peach/Core/Audio/Cents.swift`. Now I have a complete picture. Let me fix all the issues.

### ü§ñ Assistant (02:37:28)

Starting with the production code changes.

**PitchMatchingSession.swift** ‚Äî Remove `centRange`, remove `adjustFrequency`, rename methods, make `commitResult` private:

### ü§ñ Assistant (02:37:46)

**VerticalPitchSlider.swift** ‚Äî Remove "normalized" naming, add `accessibilityValue`:

### ü§ñ Assistant (02:38:01)

Now rename the static methods and add `accessibilityValue`:

### ü§ñ Assistant (02:38:10)

Let me check the current state of the file after all the renames.

### ü§ñ Assistant (02:38:21)

Fix remaining "normalized" in the comment and add `accessibilityValue`:

### ü§ñ Assistant (02:38:37)

Now add `accessibilityValue`:

### ü§ñ Assistant (02:38:42)

Now update **PitchMatchingScreen.swift**:

### ü§ñ Assistant (02:38:49)

Now update **project-context.md** (L1):

### ü§ñ Assistant (02:38:57)

Good, production code is updated. Now the test files. Let me start with **VerticalPitchSliderTests.swift**:

### ü§ñ Assistant (02:39:00)

Let me verify the test file looks correct:

### ü§ñ Assistant (02:39:44)

Now the big one ‚Äî **PitchMatchingSessionTests.swift**. Let me do the bulk renames first.

### ü§ñ Assistant (02:39:59)

Now handle the remaining special `commitResult` calls individually. Let me read the current state of the affected sections.

### ü§ñ Assistant (02:40:08)

Now let me remove the `adjustFrequencyDelegatesToHandle` test and fix the remaining `commitResult` calls:

### ü§ñ Assistant (02:40:16)

Now fix the `commitResultComputesCentError` test ‚Äî simplify to use `commitPitch(0.0)`:

### ü§ñ Assistant (02:40:27)

Fix the sharp cent error test:

### ü§ñ Assistant (02:40:39)

Fix the remaining test names and the `commitResult` references:

### ü§ñ Assistant (02:40:49)

Now remove the `adjustFrequencyNoOpWhenNotPlayingTunable` test and fix the `commitResultNoOpWhenNotPlayingTunable` test:

### ü§ñ Assistant (02:41:14)

Now fix the flat cent error test:

### ü§ñ Assistant (02:41:25)

Now let me update the normalized pitch test names and descriptions:

### ü§ñ Assistant (02:41:34)

Now let me update all the test names and descriptions in the normalized pitch section:

### ü§ñ Assistant (02:42:13)

Now let me verify there are no remaining `commitResult` or `adjustFrequency` references in the test files:

### ü§ñ Assistant (02:42:23)

Good ‚Äî the remaining `adjustFrequencyCallCount` references are on the `MockPlaybackHandle` (verifying the handle protocol method was called), which is correct.

Let me also verify no remaining "normalized" in the slider tests and check all production files are clean:

### ü§ñ Assistant (02:42:33)

Let me clean up the "normalized" from the slider test descriptions and function names:

### ü§ñ Assistant (02:42:58)

Now let me also check that the `TrainingSessionTests.swift` doesn't reference any of the removed methods:

### ü§ñ Assistant (02:43:04)

Good. Now let me do a final verification of all changed files to make sure everything is consistent.

### ü§ñ Assistant (02:43:09)

Production code looks clean. Now let me run the full test suite to verify everything compiles and passes.

### ü§ñ Assistant (02:43:25)

Duplicate function name ‚Äî the old `commitResultNoOpWhenNotPlayingTunable` and `commitNormalizedPitchNoOpWhenNotPlayingTunable` both became `commitPitchNoOpWhenNotPlayingTunable`. Let me fix by removing the duplicate (they test the same thing).

### ü§ñ Assistant (02:43:39)

The second one (line 488-496) is a duplicate. Remove it:

### ü§ñ Assistant (02:45:38)

All tests pass. Now let me update the story file ‚Äî mark review findings as fixed and update status to "done".

### ü§ñ Assistant (02:45:48)

Now add the review notes and update the change log:

### ü§ñ Assistant (02:46:07)

Now update the sprint-status.yaml:

### ü§ñ Assistant (02:46:20)

---

## Step 5: Review Complete

**Review Complete!**

**Story Status:** done
**Issues Fixed:** 5 (4 Medium + 1 Low)
**Action Items Created:** 0

**Summary of fixes applied:**
- **M1:** Removed dead `adjustFrequency()`, renamed `adjustNormalizedPitch` ‚Üí `adjustPitch`, removed "normalized" naming throughout `VerticalPitchSlider` and `PitchMatchingSession`
- **M2:** Made `commitResult(userFrequency:)` `private`, renamed `commitNormalizedPitch` ‚Üí `commitPitch`, updated all 13 test call sites
- **M3:** Removed duplicate `centRange` constant ‚Äî now derives from `initialCentOffsetRange.upperBound`
- **M4:** Added `.accessibilityValue` to `VerticalPitchSlider` (reports current position as percentage)
- **L1:** Updated `project-context.md` to list `TrainingSession` as a view-accessible type

All tests pass. Sprint status synced: 19-5 ‚Üí done.

### üßë Human (02:48:49)

wrap it up

### ü§ñ Assistant (02:49:06)

Done. Committed as `52f3348`.

### üßë Human (02:49:35)

<command-name>/exit</command-name>
            <command-message>exit</command-message>
            <command-args></command-args>

### üßë Human (02:49:35)

<local-command-stdout>See ya!</local-command-stdout>

---

[‚Üê Previous (a554709a45)](a554709a45.md) | [Index](index.md) | [Next (81b96d39a5) ‚Üí](81b96d39a5.md)
