---
commit: "845def4f719a95b3bd085f66c90e3f75677c36ba"
date: "2026-02-13T15:13:37+01:00"
author: "Michael Sch√ºrig <michael@schuerig.de>"
subject: "Create Story 3.2: TrainingSession State Machine and Comparison Loop"
sessions: ["eaf3b0ec-22b0-4216-92eb-d351fcdbb3c7"]
prev: "c088dd354f.md"
next: "a51a71175d.md"
---

[‚Üê Previous (c088dd354f)](c088dd354f.md) | [Index](index.md) | [Next (a51a71175d) ‚Üí](a51a71175d.md)

# Commit 845def4f71

**Date:** 2026-02-13 15:13:37 UTC+01:00  
**Author:** Michael Sch√ºrig <michael@schuerig.de>

## Commit message

Create Story 3.2: TrainingSession State Machine and Comparison Loop

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>

## Changed files

```
...ingsession-state-machine-and-comparison-loop.md | 776 +++++++++++++++++++++
 docs/implementation-artifacts/sprint-status.yaml   |   2 +-
 2 files changed, 777 insertions(+), 1 deletion(-)
```

## Session `eaf3b0ec‚Ä¶`

*2026-02-13 14:06:53 UTC ‚Üí 2026-02-13 14:14:16 UTC*

### üßë Human (14:06:53)

<command-message>bmad-bmm-create-story</command-message>
<command-name>/bmad-bmm-create-story</command-name>

### ü§ñ Assistant (14:06:57)

I'll help you create a story following the BMAD workflow. Let me first load the core workflow system.

### ü§ñ Assistant (14:07:08)

I'll now execute the create-story workflow following the workflow.xml engine. Let me start by loading and initializing all required components.

### ü§ñ Assistant (14:07:19)

Now I'll begin executing the workflow steps. First, let me determine the target story by checking the sprint status.

### ü§ñ Assistant (14:07:30)

Great! I found the next backlog story. Let me now proceed with the workflow.

**Target Story Identified:**
- Story ID: 3.2
- Story Key: 3-2-trainingsession-state-machine-and-comparison-loop
- Epic: 3 (Train Your Ear - The Comparison Loop)

Now I'll load and analyze all core artifacts using the discover_inputs protocol.

### ü§ñ Assistant (14:07:37)

Now I'll load all the core planning artifacts to extract comprehensive context for the story.

### ü§ñ Assistant (14:07:46)

Now let me load the previous story to extract learnings and check recent git commits for patterns.

### ü§ñ Assistant (14:08:11)

Perfect! I now have all the context needed. Let me begin creating the comprehensive story file for Story 3.2 following the workflow. I'll build this section by section with complete developer context.

## Creating Story 3.2: TrainingSession State Machine and Comparison Loop

Let me start by initializing the story file with the header section.

### ü§ñ Assistant (14:09:12)

Now let me add the acceptance criteria and tasks from the epics analysis:

### ü§ñ Assistant (14:09:42)

Now let me add the comprehensive Dev Notes section - the critical developer context:

### ü§ñ Assistant (14:12:58)

Now let me complete the story file with references and the dev agent record section:

### ü§ñ Assistant (14:13:25)

Now I need to update the sprint status to mark this story as ready-for-dev. Let me update the sprint-status.yaml file:

### ü§ñ Assistant (14:13:34)

Excellent! Now let me commit these changes following the established git workflow:

### ü§ñ Assistant (14:14:16)

**üéØ ULTIMATE BMad Method STORY CONTEXT CREATED, Michael!**

## Story Details

- **Story ID:** 3.2
- **Story Key:** 3-2-trainingsession-state-machine-and-comparison-loop
- **Epic:** Epic 3 - Train Your Ear: The Comparison Loop
- **File:** docs/implementation-artifacts/3-2-trainingsession-state-machine-and-comparison-loop.md
- **Status:** ready-for-dev

## What Was Created

I've created a **comprehensive, battle-tested story file** that provides the developer with EVERYTHING needed for flawless implementation of the core training loop - the heart of Peach.

### Story Context Analysis

This story implements **TrainingSession**, the central state machine that orchestrates the comparison loop:
- **The defining product experience**: Two notes play ‚Üí user answers ‚Üí immediate next comparison
- **First real system integration**: Brings together NotePlayer (Story 2.1), TrainingDataStore (Story 1.2), and Training Screen (Story 3.1)
- **Critical UX moment**: "First 10 seconds" where training must feel reflexive, not deliberative
- **Foundation for adaptive algorithm**: Epic 4 will plug into TrainingSession's comparison generation

### Comprehensive Developer Context Provided

**Technical Requirements:**
- ‚úÖ **State Machine Design**: Detailed 5-state flow (idle ‚Üí playingNote1 ‚Üí playingNote2 ‚Üí awaitingAnswer ‚Üí showingFeedback ‚Üí loop)
- ‚úÖ **Swift Concurrency**: Async/await patterns for audio coordination timing
- ‚úÖ **@Observable Pattern**: Modern iOS 26 state management (not deprecated ObservableObject)
- ‚úÖ **Protocol-Based Architecture**: Mock-testable with injected dependencies
- ‚úÖ **Error Boundary**: Graceful service failure handling (audio/data errors never reach UI)

**Architecture Compliance:**
- ‚úÖ **TrainingSession as central orchestrator** (Architecture lines 143-156)
- ‚úÖ **Protocol dependencies** for NotePlayer and TrainingDataStore
- ‚úÖ **Placeholder comparison generation** (random 100 cents until Epic 4)
- ‚úÖ **Frequency calculation** from MIDI + cents (from Story 2.2)
- ‚úÖ **Project structure**: Training/ directory placement

**UX Design Requirements:**
- ‚úÖ **Zero-delay looping**: < 100ms round-trip between comparisons (NFR2)
- ‚úÖ **Button state choreography**: Disabled during note1, enabled during note2
- ‚úÖ **Sensory hierarchy**: Ears > fingers > eyes (audio-first design)
- ‚úÖ **Timing diagram**: Precise note playback and button state coordination
- ‚úÖ **Critical success moment**: First 10 seconds must feel reflexive

**Previous Story Intelligence:**
- ‚úÖ **Story 3.1 patterns**: @Observable usage, stock SwiftUI, NavigationDestination enum, code review learnings
- ‚úÖ **Zero warnings standard**: Maintained across all stories
- ‚úÖ **Test-first development**: Comprehensive mock-based testing strategy
- ‚úÖ **Protocol-based design**: Enables full test isolation

**Git Intelligence:**
- ‚úÖ **Code review patterns**: 8 issues found in Story 3.1 (critical, high, medium, low categories)
- ‚úÖ **Expected test coverage**: 18-24 tests (vs 12 for simpler Story 3.1)
- ‚úÖ **Common review findings**: Unused variables, architecture violations, deprecated APIs, missing docs
- ‚úÖ **Commit sequence**: create ‚Üí implement ‚Üí review ‚Üí fixes ‚Üí done

**What NOT to Do:**
- ‚ùå No adaptive algorithm (Epic 4)
- ‚ùå No PerceptualProfile integration (Epic 4)
- ‚ùå No Feedback Indicator UI (Story 3.3)
- ‚ùå No lifecycle handling (Story 3.4)
- ‚ùå No ObservableObject (use @Observable)
- ‚ùå No session summaries (sessionless design)

### Implementation Roadmap Provided

**10-step implementation sequence:**
1. Create Comparison value type
2. Create TrainingSession state machine skeleton
3. Implement state machine logic with async audio coordination
4. Write mock implementations (MockNotePlayer, MockTrainingDataStore)
5. Write 18-24 comprehensive unit tests
6. Update Training Screen with TrainingSession integration
7. Integrate into app with dependency injection
8. Manual verification of end-to-end loop
9. Performance profiling (target < 100ms round-trip)
10. Documentation and integration notes

### Critical Developer Guardrails

**State Machine Correctness:**
- All 5 states explicitly defined
- All transitions documented with trigger conditions
- Error transitions to idle from any state
- Zero-delay loop continuation strategy

**Testing Strategy:**
- Mock-based unit tests (no real audio/data dependencies)
- State transition coverage (8-10 tests)
- Comparison generation tests (2-3 tests)
- NotePlayer integration tests (3-4 tests)
- TrainingDataStore integration tests (3-4 tests)
- Timing coordination tests (2-3 tests)

**Performance Requirements:**
- NFR2: < 100ms round-trip verified with Instruments
- Pre-generate next comparison during feedback phase
- Async audio coordination with zero artificial delays

## Next Steps

1. **Review the comprehensive story** in `docs/implementation-artifacts/3-2-trainingsession-state-machine-and-comparison-loop.md`
2. **Run dev agents** to implement TrainingSession following the 10-step sequence
3. **Run code-review** when complete (expect thorough review of state machine correctness)
4. **Optional:** Run `/bmad:tea:automate` after implementation to generate guardrail tests (if Test Architect module installed)

---

**The developer now has everything needed for flawless implementation of the core training loop!**

The story file provides:
- üéØ **Complete context**: Why this story is critical, what depends on it, what NOT to do
- üèóÔ∏è **Architecture deep dive**: State machine design, async coordination, error handling
- üé® **UX requirements**: Zero-delay looping, button choreography, timing precision
- üìö **Previous story learnings**: Patterns to continue, code review expectations
- üß™ **Testing strategy**: 18-24 tests with mock implementations
- üìã **10-step implementation roadmap**: Clear sequence from skeleton to integration

This is the **ultimate context engine** that prevents LLM developer mistakes! üöÄ

---

[‚Üê Previous (c088dd354f)](c088dd354f.md) | [Index](index.md) | [Next (a51a71175d) ‚Üí](a51a71175d.md)
