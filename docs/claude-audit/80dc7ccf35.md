---
commit: "80dc7ccf35298ae08062b3c83d72372af5db2aae"
date: "2026-02-23T18:07:11+01:00"
author: "Michael Sch√ºrig <michael@schuerig.de>"
subject: "Add Epic 8 stories: sampled instrument NotePlayer and preset discovery"
sessions: ["ff8c2ea4-338b-496f-bbff-9305cfe0d330"]
prev: "cd5e79c9fb.md"
next: "5e2aabbfd2.md"
---

[‚Üê Previous (cd5e79c9fb)](cd5e79c9fb.md) | [Index](index.md) | [Next (5e2aabbfd2) ‚Üí](5e2aabbfd2.md)

# Commit 80dc7ccf35

**Date:** 2026-02-23 18:07:11 UTC+01:00  
**Author:** Michael Sch√ºrig <michael@schuerig.de>

## Commit message

Add Epic 8 stories: sampled instrument NotePlayer and preset discovery

Story 8-1: SoundFontNotePlayer with fixed Cello preset, RoutingNotePlayer
for sound source switching, FrequencyCalculation reverse conversion.
Story 8-2: SF2 PHDR metadata parsing, SoundFontLibrary, dynamic instrument
picker in Settings with all GeneralUser GS presets.
Updated future-work.md with SF2 pruning and user SF2 import as ideas.

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>

## Changed files

```
.../8-1-implement-soundfont-noteplayer.md          | 236 ++++++++++++++++++
 ...f2-preset-discovery-and-instrument-selection.md | 269 +++++++++++++++++++++
 docs/implementation-artifacts/future-work.md       |  69 ++++--
 docs/implementation-artifacts/sprint-status.yaml   |   5 +
 4 files changed, 559 insertions(+), 20 deletions(-)
```

## Session `ff8c2ea4‚Ä¶`

*2026-02-23 16:28:50 UTC ‚Üí 2026-02-23 17:07:17 UTC*

### üßë Human (16:28:50)

<command-message>bmad-bmm-create-story</command-message>
<command-name>/bmad-bmm-create-story</command-name>
<command-args>Look at docs/planning-artifacts/research/technical-sampled-instrument-noteplayer-research-2026-02-23.md . We still need to create and prioritize a few stories.</command-args>

### ü§ñ Assistant (16:28:53)

I'll start by loading the workflow system and configuration files.

### ü§ñ Assistant (16:29:00)

Now let me load the config source, instructions, and template files.

### ü§ñ Assistant (16:29:16)

Good. I've loaded all workflow components. Let me now execute **Step 1: Determine target story**.

The user says we need to "create and prioritize a few stories" from the research document. Let me check the current sprint status and epics to understand what stories already exist.

### ü§ñ Assistant (16:29:51)

Now I have full context. Let me analyze the current state and what stories emerge from the research.

---

**Project State Analysis:**

- Epics 1-7 are all done (core app complete)
- Various hotfixes/bugfixes are done
- `infra-sf2-build-download-cache` is done (SF2 download cache at build time)
- The research recommends **AVAudioUnitSampler + SF2** for sampled instruments with MIDI pitch bend for sub-cent pitch shifting

**Stories identified from the research roadmap:**

Looking at the research's Implementation Roadmap and the project's current state, I see these potential stories:

| # | Story Idea | Scope |
|---|-----------|-------|
| 1 | **SoundFontNotePlayer prototype** | Core: Create `SoundFontNotePlayer` conforming to `NotePlayer`, load SF2 via `AVAudioUnitSampler`, play notes with `startNote()`, shift pitch with `sendPitchBend()`. Validate pitch accuracy and latency. |
| 2 | **SF2 preset discovery & instrument selection** | Parse SF2 PHDR metadata for instrument auto-discovery, display instruments in Settings, allow user selection (FR34 currently says "MVP: sine wave only") |
| 3 | **SF2 pruning pipeline** | Prune GeneralUser GS to ~15-20 ear-training presets via Polyphone, document the runbook in `tools/build-sf2.md` |
| 4 | **User-provided SF2 import** (future) | Import via share sheet/Files, crash recovery sentinel pattern |

Story 3 (pruning) may already be partially addressed by `infra-sf2-build-download-cache`. Story 4 is explicitly marked "future" in the research.

### ü§ñ Assistant (16:31:32)

What would you like to clarify, Michael? Happy to adjust the story breakdown or answer any questions about what I identified from the research.

### üßë Human (16:34:40)

Create stories 1 and 2. For story 1 use a fixed preset (Cello). For 3 and 4 add entries in future-work.md and clearly mark them as ideas that may never be implemented.

### ü§ñ Assistant (16:35:08)

Got it. Let me load the necessary context to create comprehensive stories.

### ü§ñ Assistant (16:35:13)

Now let me examine the existing audio code and the completed SF2 infrastructure story for full context.

### ü§ñ Assistant (16:37:04)

Excellent. I now have full context from the codebase. Let me set up the work.

### ü§ñ Assistant (16:37:13)

Let me check an existing story for format reference before writing.

### ü§ñ Assistant (16:40:24)

I'll start with **Story 8-1**. Let me initialize the output file with the header section.

### ü§ñ Assistant (16:44:03)

**Story 8.1 header + requirements saved.** Here's the summary:

**Story 8.1: Implement SoundFontNotePlayer with Fixed Cello Preset**

- `SoundFontNotePlayer` ‚Äî AVAudioUnitSampler + GeneralUser GS SF2, fixed Cello (GM Program 42)
- `RoutingNotePlayer` ‚Äî reads `soundSource` setting on each `play()`, delegates to sine or cello
- `FrequencyCalculation.midiNoteAndCents()` ‚Äî reverse conversion for freq -> MIDI + cent remainder
- Settings gets "Cello" as second Sound Source option
- PeachApp wires `RoutingNotePlayer` wrapping both players
- Graceful fallback to sine-only if SF2 loading fails

6 tasks, 7 acceptance criteria, comprehensive dev notes with pitch bend formulas, RPN setup, and architecture compliance notes.

**[a]** Advanced Elicitation | **[c]** Continue to Story 8-2 | **[p]** Party-Mode | **[y]** YOLO the rest

### üßë Human (16:47:01)

c

### ü§ñ Assistant (16:48:54)

**Story 8.2 saved.** Here's the summary:

**Story 8.2: SF2 Preset Discovery and Instrument Selection**

- `SF2PresetParser` ‚Äî lightweight binary parser reading PHDR 38-byte records from the SF2's `pdta` chunk (name, program, bank per preset; EOP sentinel excluded)
- `SoundFontLibrary` ‚Äî discovers SF2 files in bundle, enumerates presets, filters drum kits, provides list for Settings UI
- Settings picker becomes dynamic ‚Äî "Sine Wave" + all ~261 melodic presets from GeneralUser GS, ordered by GM program number
- `SoundFontNotePlayer` gains `loadPreset()` for dynamic switching without recreating the sampler
- `RoutingNotePlayer` parses `"sf2:{program}"` tags, replacing the hardcoded `"cello"` from 8-1
- Fallback handling for stale settings (preset removed/unavailable)

7 tasks, 8 acceptance criteria. The PHDR binary format is fully documented in Dev Notes (offsets, field sizes, RIFF navigation pseudocode).

**[a]** Advanced Elicitation | **[c]** Continue to future-work.md + sprint-status | **[p]** Party-Mode | **[y]** YOLO the rest

### üßë Human (16:57:45)

y

### ü§ñ Assistant (16:57:48)

YOLO mode activated. Let me finish everything in parallel.

### ü§ñ Assistant (16:58:48)

All done, Michael.

**Story Details:**

| Story | Key | File | Status |
|-------|-----|------|--------|
| 8.1 | `8-1-implement-soundfont-noteplayer` | `docs/implementation-artifacts/8-1-implement-soundfont-noteplayer.md` | backlog |
| 8.2 | `8-2-sf2-preset-discovery-and-instrument-selection` | `docs/implementation-artifacts/8-2-sf2-preset-discovery-and-instrument-selection.md` | backlog |

**Sprint status updated:**
- Added Epic 8: "Real Instruments ‚Äî Sampled Sound Sources" (backlog)
- Both stories registered as backlog

**Future work updated:**
- "Swappable Sound Sources" marked as in-progress (addressed by Epic 8)
- Added "SF2 Pruning Pipeline" as idea ‚Äî may never be implemented
- Added "User-Provided SF2 Import" as idea ‚Äî may never be implemented (crash risk noted)

**Next steps:**
1. Review stories in their files
2. Run `dev-story` on 8-1 first (8-2 depends on it)
3. Run `code-review` when each is complete

### üßë Human (17:06:57)

commit this

### ü§ñ Assistant (17:07:17)

Committed `80dc7cc` ‚Äî 4 files changed, 559 insertions. Working tree clean.

---

[‚Üê Previous (cd5e79c9fb)](cd5e79c9fb.md) | [Index](index.md) | [Next (5e2aabbfd2) ‚Üí](5e2aabbfd2.md)
