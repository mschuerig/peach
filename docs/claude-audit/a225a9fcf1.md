---
commit: "a225a9fcf1f8ad9126c19f49ce5ed46e0c0d3485"
date: "2026-02-17T08:31:45+01:00"
author: "Michael Sch√ºrig <michael@schuerig.de>"
subject: "Add stories: tune Kazez convergence and investigate signed mean"
sessions: ["8dd4ff2b-0def-4b20-bd29-971209b6f850"]
prev: "a00f6dac87.md"
next: "ee0d6c2fed.md"
---

[‚Üê Previous (a00f6dac87)](a00f6dac87.md) | [Index](index.md) | [Next (ee0d6c2fed) ‚Üí](ee0d6c2fed.md)

# Commit a225a9fcf1

**Date:** 2026-02-17 08:31:45 UTC+01:00  
**Author:** Michael Sch√ºrig <michael@schuerig.de>

## Commit message

Add stories: tune Kazez convergence and investigate signed mean

Two hotfix stories created from future-work.md open items:
- hotfix-tune-kazez-convergence: increase coefficient 0.05‚Üí0.08, filter unrefined neighbors
- hotfix-investigate-signed-mean: replace signed mean with absolute mean in PerceptualProfile

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>

## Changed files

```
.../hotfix-investigate-signed-mean.md              | 156 +++++++++++++++++++++
 .../hotfix-tune-kazez-convergence.md               | 132 +++++++++++++++++
 docs/implementation-artifacts/sprint-status.yaml   |   4 +
 3 files changed, 292 insertions(+)
```

## Session `8dd4ff2b‚Ä¶`

*2026-02-17 07:22:58 UTC ‚Üí 2026-02-17 07:31:54 UTC*

### üßë Human (07:22:58)

<command-message>bmad-bmm-dev-story</command-message>
<command-name>/bmad-bmm-dev-story</command-name>
<command-args>Look at docs/implementation-artifacts/future-work.md , check what issues are still open, tell me about them and then let us make a plan for implementing them</command-args>

### ü§ñ Assistant (07:23:01)

I'll start by loading the workflow system and configuration files.

### ü§ñ Assistant (07:23:05)

Now let me load the config and instructions files.

### ü§ñ Assistant (07:23:12)

Good, I've loaded the workflow system. Now let me check the current state of the codebase to understand which of these future-work items have already been addressed.

### ü§ñ Assistant (07:23:40)

Now I have a clear picture of the current state. Let me present my findings to you, Michael.

---

## Open Issues in `future-work.md`

I've reviewed all three items and cross-referenced them against the current codebase. Here's the status:

### 1. Investigate Signed Mean in Perceptual Profile
**Priority:** Medium | **Status:** Still open

This is an algorithm design question about whether `PerceptualProfile` should use a **signed mean** for detection thresholds. The concern is that threshold should represent magnitude of discriminable pitch difference, not directional bias. This is more of a research/design investigation ‚Äî no code changes have been made toward it.

### 2. AdaptiveNoteStrategy: Slow Difficulty Convergence
**Priority:** High | **Status:** RESOLVED

This was about replacing the fixed `narrowingFactor: 0.95` with Kazez sqrt(P) formulas. Looking at the current code (line 215), Kazez formulas **are already integrated**: `p * (1.0 - 0.05 * ‚àöP)` for correct and `p * (1.0 + 0.09 * ‚àöP)` for incorrect. This item is done.

### 3. Weighted Effective Difficulty: Convergence Still Too Slow
**Priority:** Critical | **Status:** PARTIALLY resolved

The future-work doc proposes **two fixes**:

| Fix | Proposed | Current Code | Status |
|-----|----------|-------------|--------|
| **Increase Kazez coefficient** from 0.05 ‚Üí 0.08 | Yes | Still `0.05` (line 215) | **NOT done** |
| **Filter unrefined neighbors** (require `!= defaultDifficulty`) | Yes | Only checks `sampleCount > 0` (lines 256, 267) | **NOT done** |

The `defaultDifficulty` guard was added for the **current note** (line 247) and for the Kazez input selection (line 211), but the **neighbor collection loops** at lines 256 and 267 still only check `sampleCount > 0` ‚Äî meaning unrefined notes at 100 cents can still anchor weighted averages upward.

---

## Summary

- **Item 1 (Signed Mean):** Open ‚Äî research/design investigation
- **Item 2 (Kazez Integration):** Done ‚Äî can be closed
- **Item 3 (Convergence tuning):** Two concrete code changes remain

The actionable work is **Item 3** ‚Äî the two targeted code changes to the Kazez coefficient and neighbor filtering. Would you like me to:

1. **Create a story** for Item 3 (the two convergence fixes + test updates)?
2. Also close Item 2 as resolved in future-work.md?
3. Leave Item 1 for later investigation?

What's your preference?

### üßë Human (07:24:59)

Create stories for 3 (first) and 1.

### ü§ñ Assistant (07:25:03)

Let me find the create-story workflow to properly generate these stories.

### ü§ñ Assistant (07:25:08)

Let me look at existing story files for the template format, and check if there are any hotfix stories already.

### ü§ñ Assistant (07:25:16)

Good, I can see the format. Now let me look at the most recent hotfix to understand the naming convention, and also read the full AdaptiveNoteStrategy to have precise line references for the stories.

### ü§ñ Assistant (07:25:20)

Now let me read the existing tests to understand exactly what needs updating.

### ü§ñ Assistant (07:25:39)

I have a thorough understanding of the codebase. Let me create both story files now. I'll write Story 3 (convergence tuning) first, then Story 1 (signed mean investigation).

---

## Story 1: Convergence Tuning (Item 3 from future-work)

Here's the story for the two remaining convergence fixes:

**Title:** Tune Kazez coefficient and filter unrefined neighbors for faster convergence

**Scope:**
1. Increase the Kazez correct-answer coefficient from `0.05` to `0.08` (line 215)
2. Add `!= defaultDifficulty` guard to neighbor collection loops (lines 256, 267) so unrefined notes at 100 cents don't anchor weighted averages

**Expected convergence (cold start, all correct):**
- Comp 1: Note A at 100 (nil lastComparison, no Kazez)
- Comp 2: Note B ‚Üí 100 ‚Üí Kazez: `100 √ó (1 - 0.08 √ó ‚àö100) = 20` 
- Comp 3: Note C ‚Üí bootstraps from B(20) ‚Üí Kazez: `20 √ó (1 - 0.08 √ó ‚àö20) ‚âà 12.8`
- Comp 4‚Äì10: Difficulties in 5‚Äì10 cent range

**Tests to update:**
- `regionalDifficultyNarrowsOnCorrect`: expects 50.0, should become 20.0
- `difficultyNarrowsAcrossJumps`: expects 50.0, should become 20.0
- `kazezConvergenceFromDefault`: should still pass (converges faster)
- `weightedDifficultyKernelNarrowing`: neighbor condition change may affect setup
- Widening formula test: unchanged (0.09 coefficient stays)

### ü§ñ Assistant (07:28:29)

Good point. Let me check the existing hotfix documents first.

### ü§ñ Assistant (07:28:36)

I already read that one earlier. Now let me check the second hotfix more carefully ‚Äî I already read `hotfix-integrate-kazez-into-adaptive-strategy.md` and it's in "review" status. That one covered integrating the Kazez formulas (0.05 coefficient) into AdaptiveNoteStrategy, which is **done**.

Neither existing hotfix covers the two remaining changes:
1. Increasing 0.05 ‚Üí 0.08
2. Filtering unrefined neighbors in the neighbor loops

So a new story is indeed needed. Let me also check if there are any other story-like documents I might have missed.

### ü§ñ Assistant (07:28:42)

Confirmed ‚Äî neither existing hotfix covers these changes. The existing hotfixes are:
- `hotfix-kazez-evaluation-strategy.md` ‚Üí **done** (created KazezNoteStrategy for evaluation)
- `hotfix-integrate-kazez-into-adaptive-strategy.md` ‚Üí **review** (integrated 0.05 coefficient into AdaptiveNoteStrategy)

The two remaining changes (0.05‚Üí0.08 coefficient, neighbor filtering) need a new story. Let me create it now.

### ü§ñ Assistant (07:30:07)

Story 1 created. Now let me discuss it with you before proceeding to Story 2.

---

**Story created:** `hotfix-tune-kazez-convergence.md`

Two surgical changes:
- **Task 1:** Kazez coefficient 0.05 ‚Üí 0.08 (one line change, line 215)
- **Task 2:** Neighbor filtering ‚Äî add `!= defaultDifficulty` guard to both neighbor loops (lines 256, 267)
- **Task 3:** Update 2 test expectations (50.0 ‚Üí 20.0) and verify remaining tests still pass
- **Task 4:** Full test suite regression check

Does this look right, or would you like to adjust anything before I create the second story for the signed mean investigation?

### üßë Human (07:30:25)

Go ahead.

### ü§ñ Assistant (07:30:29)

Now let me create the second story for the signed mean investigation. Let me re-read the relevant code to make sure the story is precise.

### ü§ñ Assistant (07:31:26)

Now let me update the sprint-status.yaml to register both stories.

### ü§ñ Assistant (07:31:36)

Both stories are created and registered. Let me also check ‚Äî should I close the existing hotfix that's already done in sprint status? The `hotfix-kazez-evaluation-strategy` (done) and `hotfix-integrate-kazez-into-adaptive-strategy` (review) aren't tracked there. Let me leave those as-is since they weren't in the sprint status before.

Now let me commit both stories.

### ü§ñ Assistant (07:31:54)

Both stories are created, registered in sprint-status, and committed. Here's the summary:

---

## Stories Created

### 1. `hotfix-tune-kazez-convergence.md` (Critical)
Two surgical changes to `AdaptiveNoteStrategy.swift`:
- **Task 1:** Kazez coefficient 0.05 ‚Üí 0.08 (line 215) ‚Äî single correct answer from 100 cents goes to 20 instead of 50
- **Task 2:** Add `!= defaultDifficulty` guard to neighbor loops (lines 256, 267) ‚Äî prevents unrefined 100-cent notes from anchoring averages
- **Task 3:** Update 2 test expectations + verify remaining tests
- **Task 4:** Full regression suite

### 2. `hotfix-investigate-signed-mean.md` (Medium)
Fix signed mean corruption in `PerceptualProfile`:
- **Task 1:** Pass unsigned `centDifference` to `update()` instead of signed value
- **Task 2:** Remove `abs()` wrapper in `weakSpots()`
- **Task 3-4:** Update documentation on `PerceptualNote.mean` and `update()` 
- **Task 5:** Update ~4 test assertions that expect negative means
- **Task 6:** Full regression suite

Both are marked `ready-for-dev` in sprint-status. Would you like to start implementing one?

---

[‚Üê Previous (a00f6dac87)](a00f6dac87.md) | [Index](index.md) | [Next (ee0d6c2fed) ‚Üí](ee0d6c2fed.md)
