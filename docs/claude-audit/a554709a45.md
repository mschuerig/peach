---
commit: "a554709a4577fa35489887f95aa145398b309c3b"
date: "2026-02-27T11:18:14+01:00"
author: "Michael Sch√ºrig <michael@schuerig.de>"
subject: "Add Epic 20: Right Direction ‚Äî Dependency Inversion Cleanup"
sessions: ["56f98140-b303-4f56-8959-27cfadf631d3"]
prev: "d5967393ee.md"
next: "52f3348a13.md"
---

[‚Üê Previous (d5967393ee)](d5967393ee.md) | [Index](index.md) | [Next (52f3348a13) ‚Üí](52f3348a13.md)

# Commit a554709a45

**Date:** 2026-02-27 11:18:14 UTC+01:00  
**Author:** Michael Sch√ºrig <michael@schuerig.de>

## Commit message

Add Epic 20: Right Direction ‚Äî Dependency Inversion Cleanup

10 stories addressing 12 dependency violations found by adversarial
code review: move shared domain types to Core/, extract @Entry keys,
inject services via environment, use protocols at boundaries, remove
UIKit/SwiftUI from domain layer, and move mock to test target.

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>

## Changed files

```
.../20-1-move-shared-domain-types-to-core.md       | 107 +++++++++++++++
 .../20-10-update-documentation.md                  | 125 +++++++++++++++++
 .../20-2-move-soundsourceid-to-core.md             |  81 +++++++++++
 ...-cross-feature-feedback-icon-size-dependency.md |  72 ++++++++++
 .../20-4-use-protocols-in-profile-views.md         |  78 +++++++++++
 ...0-5-extract-entry-environment-keys-from-core.md | 130 ++++++++++++++++++
 ...e-uikit-from-audiosessioninterruptionmonitor.md |  99 ++++++++++++++
 ...-7-resettable-protocol-for-comparisonsession.md | 110 +++++++++++++++
 ...ove-mockhapticfeedbackmanager-to-test-target.md |  84 ++++++++++++
 ...inject-trainingdatastore-into-settingsscreen.md |  97 ++++++++++++++
 docs/implementation-artifacts/sprint-status.yaml   |  16 ++-
 docs/planning-artifacts/epics.md                   | 148 +++++++++++++++++++++
 12 files changed, 1146 insertions(+), 1 deletion(-)
```

## Session `56f98140‚Ä¶`

*2026-02-27 09:24:27 UTC ‚Üí 2026-02-27 10:18:29 UTC*

### üßë Human (09:24:27)

* /bmad-review-adversarial-general

### ü§ñ Assistant (09:24:37)

I've loaded the adversarial review task. I need content to review.

**What would you like me to cynically review?** Please provide one of the following:

- A file path or set of files
- A git diff or branch name to compare
- A document, spec, story, or any other artifact
- Uncommitted changes or a recent commit range

What content should I tear apart?

### üßë Human (09:31:25)

I want you to look at the complete app code, excluding tests. In particular, I want you to look at dependencies
 * does each part of the code only depend on what it needs to function?
 * do these dependencies go in the right direction?
 * e.g., I don't want the UI to depend on implementation details, such as exactly sounds are generated (soundfont, calculation, whatever)
 * places where the Dependency Inversion Principle ought to be applied

### ü§ñ Assistant (09:31:30)

Let me thoroughly explore the codebase to map out all dependencies. I'll start with the project structure and then dig into every source file.

### ü§ñ Assistant (09:33:03)

Good, I have the full map. Now let me read every production source file to trace actual import statements and type dependencies.

### ü§ñ Assistant (09:37:41)

## Adversarial Review: Dependency Analysis

Content type: **Full production codebase (57 Swift files), dependency direction and coupling**

---

### Findings

1. **Core/ has massive upward dependencies on feature modules.** `TrainingDataStore`, `PerceptualProfile`, `TrendAnalyzer`, `ThresholdTimeline`, `NextComparisonStrategy`, and `KazezNoteStrategy` ‚Äî all living in `Core/` ‚Äî depend on `Comparison`, `CompletedComparison`, and `ComparisonObserver` which are defined in `Comparison/`. Similarly, `TrainingDataStore` and `PerceptualProfile` depend on `CompletedPitchMatching` and `PitchMatchingObserver` from `PitchMatching/`. This is the dependency arrow pointing the wrong way: the foundational layer reaches upward into feature modules for types that are clearly shared domain concepts. These value types and observer protocols should live in `Core/`, not in the feature directories that happen to have introduced them first.

2. **Four Core/ files import `SwiftUI` for no domain reason.** `SoundFontLibrary.swift`, `TrendAnalyzer.swift`, `ThresholdTimeline.swift`, and `TrainingSession.swift` all `import SwiftUI` solely to declare `extension EnvironmentValues { @Entry var ... }`. The actual classes and protocols in these files have zero SwiftUI usage. This means your domain layer has a compile-time dependency on a UI framework because the environment key declarations are co-located with the domain logic instead of being extracted into a view-layer or app-layer file.

3. **`SettingsScreen` instantiates `TrainingDataStore` directly**, violating both the Dependency Inversion Principle and the project's own rule that "all service instantiation happens in `PeachApp.swift`." In `resetAllTrainingData()`, the view constructs `TrainingDataStore(modelContext: modelContext)` ad-hoc. The view should receive `TrainingDataStore` through `@Environment`, not build it from a raw `ModelContext`. This also means the view knows about `SwiftData`'s `ModelContext` ‚Äî an implementation detail that should be hidden behind the data store abstraction.

4. **`ComparisonScreen` and `PitchMatchingScreen` have compile-time dependencies on concrete implementation types through `@Entry` default values.** The `@Entry` fallback closures reference `PerceptualProfile`, `KazezNoteStrategy`, `AppUserSettings`, and `MockHapticFeedbackManager`. Even though these defaults exist as fallbacks, they force the UI file to import and depend on concrete Core/ and Settings/ implementations. A screen file should not know that `KazezNoteStrategy` exists ‚Äî that is an algorithm implementation detail.

5. **`SummaryStatisticsView` and `MatchingStatisticsView` use `PerceptualProfile` as a concrete type where protocols exist.** `computeStats(from:)` takes `PerceptualProfile` directly instead of `PitchDiscriminationProfile`. `computeMatchingStats(from:)` takes `PerceptualProfile` instead of `PitchMatchingProfile`. The protocols were designed for exactly this purpose ‚Äî to let consumers depend on capability, not implementation ‚Äî and they're being ignored.

6. **`AudioSessionInterruptionMonitor` (Core/) imports `UIKit`** for `UIApplication.didEnterBackgroundNotification` and `UIApplication.willEnterForegroundNotification`. A Core/ service should not depend on UIKit. These notification names could be injected or the monitor could accept notification names as parameters, or the notification constants could be referenced via their string equivalents without the UIKit import.

7. **`ComparisonSession` and `PitchMatchingSession` depend on `AudioSessionInterruptionMonitor` as a concrete type** with no protocol abstraction. This is a service that monitors system events ‚Äî exactly the kind of dependency that should be behind a protocol for testability and to respect DIP. If you ever want a different interruption strategy or need to mock it in tests, you're stuck.

8. **`TrendAnalyzer` and `ThresholdTimeline` are injected into `ComparisonSession` as concrete types** with no protocol boundary. `ComparisonSession` stores `private let trendAnalyzer: TrendAnalyzer?` and `private let thresholdTimeline: ThresholdTimeline?` ‚Äî concrete classes, not protocols. The session shouldn't need to know these are specifically `TrendAnalyzer` and `ThresholdTimeline`; they're just `ComparisonObserver` conformances that happen to also need resetting. If the reset behavior were part of a protocol, the session could be fully decoupled.

9. **Production code contains a mock.** `MockHapticFeedbackManager` lives in `Comparison/HapticFeedbackManager.swift` alongside the production `HapticFeedbackManager`. The project's own conventions state mocks belong in the test target. This mock pollutes the production binary and blurs the boundary between production and test code.

10. **Cross-feature coupling between `PitchMatching/` and `Comparison/`.** `PitchMatchingFeedbackIndicator` reaches into `ComparisonFeedbackIndicator.defaultIconSize` ‚Äî a static property on a Comparison/ view ‚Äî to share a UI constant. This creates a dependency from one independent training module to another. If the constant is shared, it should live in a shared location, or each module should define its own.

11. **`SoundFontNotePlayer` (Core/Audio/) depends on `SoundSourceID` from `Settings/`.** A Core/ implementation type reaches into the Settings/ module for a value type. `SoundSourceID` is a simple tag struct that arguably belongs in Core/ if Core/ needs it, or the dependency should flow through the `UserSettings` protocol without Core/ ever seeing the `SoundSourceID` type directly.

12. **`SettingsScreen` imports `SwiftData` and accesses `@Environment(\.modelContext)` directly.** The project rule says "only `TrainingDataStore` accesses SwiftData." By importing SwiftData and pulling the `ModelContext` from the environment, the settings view is coupled to the persistence framework's implementation. The data-reset operation should be a method on an injected service, not something the view assembles from raw framework primitives.

### üßë Human (09:42:28)

Make a plan for an epic to resolve these issues. If it fits, one story per issue. Also remember that docs need to be updated, include the arc42 docs.

### ü§ñ Assistant (09:42:34)

Let me explore the existing documentation structure, story conventions, and the specific files involved.

### ü§ñ Assistant (09:43:22)

Now let me read the arc42 docs and the epics file to understand what needs updating.

### ü§ñ Assistant (09:45:00)

Now let me design the plan with all the information gathered.

### ü§ñ Assistant (09:50:25)

Let me verify a few critical details before finalizing the plan.

### ü§ñ Assistant (09:50:37)

Good ‚Äî confirmed Xcode objectVersion 77 (file-system-synchronized groups), so `git mv` is sufficient for moves. Let me read the sprint status format and then write the final plan.

### ü§ñ Assistant (09:50:42)

Let me read the Epic 19 section from the epics file to understand the format precisely.

### ü§ñ Assistant (09:50:57)

Now I have everything I need. Let me write the plan file.

### ü§ñ Assistant (09:56:47)

Understood ‚Äî I'll write the story files, update epics.md, and update sprint-status.yaml. Let me first read a complete recent story file to match the format exactly.

### ü§ñ Assistant (09:57:03)

Good, I have the exact format. Now let me create all the story files and update the planning documents. I'll batch them for efficiency.

### ü§ñ Assistant (10:01:34)

Now let me add Epic 20 to `epics.md` and update `sprint-status.yaml`.

### ü§ñ Assistant (10:02:39)

Now let me also add the Epic List Overview entry. Let me find where the epic list overview is.

### ü§ñ Assistant (10:03:26)

I see ‚Äî Epic 19 is also missing from the overview list. Let me add both 19 and 20 to the overview.

### ü§ñ Assistant (10:03:35)

Now update sprint-status.yaml.

### ü§ñ Assistant (10:03:58)

All documents are created. Here's a summary of everything written:

**10 story files created** in `docs/implementation-artifacts/`:
| Story | File | Scope |
|-------|------|-------|
| 20.1 | `20-1-move-shared-domain-types-to-core.md` | Move Comparison, CompletedComparison, ComparisonObserver, CompletedPitchMatching, PitchMatchingObserver to Core/Training/ |
| 20.2 | `20-2-move-soundsourceid-to-core.md` | Move SoundSourceID from Settings/ to Core/Audio/ |
| 20.3 | `20-3-extract-entry-environment-keys-from-core.md` | Consolidate all @Entry definitions into App/EnvironmentKeys.swift, remove SwiftUI from Core/ |
| 20.4 | `20-4-inject-trainingdatastore-into-settingsscreen.md` | Inject TrainingDataStore via @Environment, remove SwiftData import from SettingsScreen |
| 20.5 | `20-5-use-protocols-in-profile-views.md` | Use PitchDiscriminationProfile/PitchMatchingProfile in Profile views |
| 20.6 | `20-6-move-mockhapticfeedbackmanager-to-test-target.md` | Move mock from production to PeachTests/ |
| 20.7 | `20-7-remove-uikit-from-audiosessioninterruptionmonitor.md` | Inject notification names, remove UIKit import |
| 20.8 | `20-8-remove-cross-feature-feedback-icon-size-dependency.md` | Define local icon size constant, remove PitchMatching‚ÜíComparison dep |
| 20.9 | `20-9-resettable-protocol-for-comparisonsession.md` | Resettable protocol, decouple ComparisonSession from TrendAnalyzer/ThresholdTimeline |
| 20.10 | `20-10-update-documentation.md` | Update arc42, project-context, epics, sprint-status |

**Updated planning docs:**
- `docs/planning-artifacts/epics.md` ‚Äî Added Epic 20 to overview list and full story definitions
- `docs/implementation-artifacts/sprint-status.yaml` ‚Äî Added all Epic 20 entries as `ready-for-dev`, also marked Epic 19 as `done`

**Execution order:** 20.1 ‚Üí 20.2 ‚Üí 20.8 ‚Üí 20.5 ‚Üí 20.3 ‚Üí 20.7 ‚Üí 20.9 ‚Üí 20.6 ‚Üí 20.4 ‚Üí 20.10

### üßë Human (10:13:25)

Change the story numbering so that their number coincides with the execution order.

### ü§ñ Assistant (10:13:50)

I need to renumber stories 3-9 to match the execution order. Here's the mapping:

| Execution | Current | New | Topic |
|-----------|---------|-----|-------|
| 1 | 20.1 | 20.1 | Move domain types (stays) |
| 2 | 20.2 | 20.2 | Move SoundSourceID (stays) |
| 3 | 20.8 | 20.3 | Icon size dependency |
| 4 | 20.5 | 20.4 | Protocols in profile views |
| 5 | 20.3 | 20.5 | Extract @Entry keys |
| 6 | 20.7 | 20.6 | UIKit from monitor |
| 7 | 20.9 | 20.7 | Resettable protocol |
| 8 | 20.6 | 20.8 | Move mock to tests |
| 9 | 20.4 | 20.9 | Inject TrainingDataStore |
| 10 | 20.10 | 20.10 | Documentation (stays) |

First, rename the files via temp names to avoid conflicts.

### ü§ñ Assistant (10:13:56)

Files are untracked (newly created). Use regular `mv`.

### ü§ñ Assistant (10:14:24)

Good. Now update the story numbers inside each renamed file, plus update references between stories.

### ü§ñ Assistant (10:14:35)

Need to read the files first since they were renamed. Let me read all 7 renamed files.

### ü§ñ Assistant (10:14:43)

Good. Now update the titles and commit messages in all 7 files, plus update cross-references between stories.

### ü§ñ Assistant (10:15:11)

Now update the cross-references. Story 20.5 (extract @Entry) references "20.1" as a dependency (still correct). Story 20.8 (move mock) references "Story 20.3" for the @Entry cleanup ‚Äî that's now 20.5. Story 20.9 (inject TrainingDataStore) references "20.3" ‚Äî now 20.5. Let me fix those.

### ü§ñ Assistant (10:15:24)

Story 20.8 references "Story 20.3" (the old number for @Entry extraction, now 20.5). Let me fix those.

### ü§ñ Assistant (10:15:39)

Now check for cross-references in story 20.5 (extract @Entry) ‚Äî it mentions "Depends on: 20.1" and "from 20.1" which are still correct. Let me also fix the dependency references in 20.5 and 20.9.

### ü§ñ Assistant (10:15:45)

Good ‚Äî no stale cross-references in those files. Now update `epics.md` and `sprint-status.yaml` with the new numbering.

### ü§ñ Assistant (10:15:54)

Now I need to replace the entire Epic 20 story section with the reordered stories.

### ü§ñ Assistant (10:16:20)

Now update sprint-status.yaml.

### ü§ñ Assistant (10:16:31)

Now let me also update the "Depends on" references inside stories 20.5 and 20.9 since they reference the @Entry story by number. Let me also check story 20.8 references are correct now.

### ü§ñ Assistant (10:16:42)

Good. Story 20.8 correctly references 20.5 (the @Entry extraction story). Story 20.10 references "Story 20.6" and "Story 20.4" ‚Äî those need updating since the mock move is now 20.8 and the TrainingDataStore injection is now 20.9.

### ü§ñ Assistant (10:16:53)

Let me do a final verification that all files are consistent.

### ü§ñ Assistant (10:17:04)

All consistent. Final numbering now matches the execution order:

| # | Story | Dependencies |
|---|-------|-------------|
| 20.1 | Move shared domain types to Core/Training/ | -- |
| 20.2 | Move SoundSourceID to Core/Audio/ | -- |
| 20.3 | Remove cross-feature feedback icon size dep | -- |
| 20.4 | Use protocols in Profile views | -- |
| 20.5 | Extract @Entry environment keys from Core/ | 20.1 |
| 20.6 | Remove UIKit from AudioSessionInterruptionMonitor | -- |
| 20.7 | Resettable protocol for ComparisonSession | -- |
| 20.8 | Move MockHapticFeedbackManager to test target | 20.5 |
| 20.9 | Inject TrainingDataStore into SettingsScreen | 20.5 |
| 20.10 | Update documentation | all |

Updated files: 10 story files, `epics.md`, `sprint-status.yaml`. All cross-references between stories are consistent.

### üßë Human (10:17:57)

commit

### ü§ñ Assistant (10:18:22)

Committed as `a554709`. 12 files changed: 10 new story files, updated `epics.md` and `sprint-status.yaml`. Working tree is clean.

### üßë Human (10:18:29)

<command-name>/exit</command-name>
            <command-message>exit</command-message>
            <command-args></command-args>

### üßë Human (10:18:29)

<local-command-stdout>Catch you later!</local-command-stdout>

---

[‚Üê Previous (d5967393ee)](d5967393ee.md) | [Index](index.md) | [Next (52f3348a13) ‚Üí](52f3348a13.md)
