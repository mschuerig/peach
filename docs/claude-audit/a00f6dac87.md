---
commit: "a00f6dac877433cc5375221881b0e029aaad9deb"
date: "2026-02-17T09:11:46+01:00"
author: "Michael SchÃ¼rig <michael@schuerig.de>"
subject: "Tune Kazez convergence: coefficient 0.05â†’0.08, filter unrefined neighbors"
sessions: ["8dd4ff2b-0def-4b20-bd29-971209b6f850"]
prev: "afa5dccda9.md"
next: "a225a9fcf1.md"
---

[â† Previous (afa5dccda9)](afa5dccda9.md) | [Index](index.md) | [Next (a225a9fcf1) â†’](a225a9fcf1.md)

# Commit a00f6dac87

**Date:** 2026-02-17 09:11:46 UTC+01:00  
**Author:** Michael SchÃ¼rig <michael@schuerig.de>

## Commit message

Tune Kazez convergence: coefficient 0.05â†’0.08, filter unrefined neighbors

- Increase Kazez correct-answer coefficient from 0.05 to 0.08 in
  determineCentDifference() for faster multi-note convergence
  (100â†’20 in one step vs 100â†’50)
- Add != defaultDifficulty guard to neighbor collection loops in
  weightedEffectiveDifficulty() to prevent unrefined 100-cent notes
  from anchoring weighted averages upward
- Update two test expectations (50.0â†’20.0) with approximate comparison
  for floating-point precision
- Mark convergence issues as resolved in future-work.md
- All 172 tests passing, zero regressions

Implements hotfix-tune-kazez-convergence

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>

## Changed files

```
Peach/Core/Algorithm/AdaptiveNoteStrategy.swift    | 12 ++--
 .../Core/Algorithm/AdaptiveNoteStrategyTests.swift |  8 +--
 docs/implementation-artifacts/future-work.md       | 84 +++-------------------
 .../hotfix-tune-kazez-convergence.md               | 53 ++++++++------
 docs/implementation-artifacts/sprint-status.yaml   |  2 +-
 5 files changed, 54 insertions(+), 105 deletions(-)
```

## Session `8dd4ff2bâ€¦`

*2026-02-17 07:22:58 UTC â†’ 2026-02-17 08:12:00 UTC*

### ğŸ§‘ Human (07:22:58)

<command-message>bmad-bmm-dev-story</command-message>
<command-name>/bmad-bmm-dev-story</command-name>
<command-args>Look at docs/implementation-artifacts/future-work.md , check what issues are still open, tell me about them and then let us make a plan for implementing them</command-args>

### ğŸ¤– Assistant (07:23:01)

I'll start by loading the workflow system and configuration files.

### ğŸ¤– Assistant (07:23:05)

Now let me load the config and instructions files.

### ğŸ¤– Assistant (07:23:12)

Good, I've loaded the workflow system. Now let me check the current state of the codebase to understand which of these future-work items have already been addressed.

### ğŸ¤– Assistant (07:23:40)

Now I have a clear picture of the current state. Let me present my findings to you, Michael.

---

## Open Issues in `future-work.md`

I've reviewed all three items and cross-referenced them against the current codebase. Here's the status:

### 1. Investigate Signed Mean in Perceptual Profile
**Priority:** Medium | **Status:** Still open

This is an algorithm design question about whether `PerceptualProfile` should use a **signed mean** for detection thresholds. The concern is that threshold should represent magnitude of discriminable pitch difference, not directional bias. This is more of a research/design investigation â€” no code changes have been made toward it.

### 2. AdaptiveNoteStrategy: Slow Difficulty Convergence
**Priority:** High | **Status:** RESOLVED

This was about replacing the fixed `narrowingFactor: 0.95` with Kazez sqrt(P) formulas. Looking at the current code (line 215), Kazez formulas **are already integrated**: `p * (1.0 - 0.05 * âˆšP)` for correct and `p * (1.0 + 0.09 * âˆšP)` for incorrect. This item is done.

### 3. Weighted Effective Difficulty: Convergence Still Too Slow
**Priority:** Critical | **Status:** PARTIALLY resolved

The future-work doc proposes **two fixes**:

| Fix | Proposed | Current Code | Status |
|-----|----------|-------------|--------|
| **Increase Kazez coefficient** from 0.05 â†’ 0.08 | Yes | Still `0.05` (line 215) | **NOT done** |
| **Filter unrefined neighbors** (require `!= defaultDifficulty`) | Yes | Only checks `sampleCount > 0` (lines 256, 267) | **NOT done** |

The `defaultDifficulty` guard was added for the **current note** (line 247) and for the Kazez input selection (line 211), but the **neighbor collection loops** at lines 256 and 267 still only check `sampleCount > 0` â€” meaning unrefined notes at 100 cents can still anchor weighted averages upward.

---

## Summary

- **Item 1 (Signed Mean):** Open â€” research/design investigation
- **Item 2 (Kazez Integration):** Done â€” can be closed
- **Item 3 (Convergence tuning):** Two concrete code changes remain

The actionable work is **Item 3** â€” the two targeted code changes to the Kazez coefficient and neighbor filtering. Would you like me to:

1. **Create a story** for Item 3 (the two convergence fixes + test updates)?
2. Also close Item 2 as resolved in future-work.md?
3. Leave Item 1 for later investigation?

What's your preference?

### ğŸ§‘ Human (07:24:59)

Create stories for 3 (first) and 1.

### ğŸ¤– Assistant (07:25:03)

Let me find the create-story workflow to properly generate these stories.

### ğŸ¤– Assistant (07:25:08)

Let me look at existing story files for the template format, and check if there are any hotfix stories already.

### ğŸ¤– Assistant (07:25:16)

Good, I can see the format. Now let me look at the most recent hotfix to understand the naming convention, and also read the full AdaptiveNoteStrategy to have precise line references for the stories.

### ğŸ¤– Assistant (07:25:20)

Now let me read the existing tests to understand exactly what needs updating.

### ğŸ¤– Assistant (07:25:39)

I have a thorough understanding of the codebase. Let me create both story files now. I'll write Story 3 (convergence tuning) first, then Story 1 (signed mean investigation).

---

## Story 1: Convergence Tuning (Item 3 from future-work)

Here's the story for the two remaining convergence fixes:

**Title:** Tune Kazez coefficient and filter unrefined neighbors for faster convergence

**Scope:**
1. Increase the Kazez correct-answer coefficient from `0.05` to `0.08` (line 215)
2. Add `!= defaultDifficulty` guard to neighbor collection loops (lines 256, 267) so unrefined notes at 100 cents don't anchor weighted averages

**Expected convergence (cold start, all correct):**
- Comp 1: Note A at 100 (nil lastComparison, no Kazez)
- Comp 2: Note B â†’ 100 â†’ Kazez: `100 Ã— (1 - 0.08 Ã— âˆš100) = 20` 
- Comp 3: Note C â†’ bootstraps from B(20) â†’ Kazez: `20 Ã— (1 - 0.08 Ã— âˆš20) â‰ˆ 12.8`
- Comp 4â€“10: Difficulties in 5â€“10 cent range

**Tests to update:**
- `regionalDifficultyNarrowsOnCorrect`: expects 50.0, should become 20.0
- `difficultyNarrowsAcrossJumps`: expects 50.0, should become 20.0
- `kazezConvergenceFromDefault`: should still pass (converges faster)
- `weightedDifficultyKernelNarrowing`: neighbor condition change may affect setup
- Widening formula test: unchanged (0.09 coefficient stays)

### ğŸ¤– Assistant (07:28:29)

Good point. Let me check the existing hotfix documents first.

### ğŸ¤– Assistant (07:28:36)

I already read that one earlier. Now let me check the second hotfix more carefully â€” I already read `hotfix-integrate-kazez-into-adaptive-strategy.md` and it's in "review" status. That one covered integrating the Kazez formulas (0.05 coefficient) into AdaptiveNoteStrategy, which is **done**.

Neither existing hotfix covers the two remaining changes:
1. Increasing 0.05 â†’ 0.08
2. Filtering unrefined neighbors in the neighbor loops

So a new story is indeed needed. Let me also check if there are any other story-like documents I might have missed.

### ğŸ¤– Assistant (07:28:42)

Confirmed â€” neither existing hotfix covers these changes. The existing hotfixes are:
- `hotfix-kazez-evaluation-strategy.md` â†’ **done** (created KazezNoteStrategy for evaluation)
- `hotfix-integrate-kazez-into-adaptive-strategy.md` â†’ **review** (integrated 0.05 coefficient into AdaptiveNoteStrategy)

The two remaining changes (0.05â†’0.08 coefficient, neighbor filtering) need a new story. Let me create it now.

### ğŸ¤– Assistant (07:30:07)

Story 1 created. Now let me discuss it with you before proceeding to Story 2.

---

**Story created:** `hotfix-tune-kazez-convergence.md`

Two surgical changes:
- **Task 1:** Kazez coefficient 0.05 â†’ 0.08 (one line change, line 215)
- **Task 2:** Neighbor filtering â€” add `!= defaultDifficulty` guard to both neighbor loops (lines 256, 267)
- **Task 3:** Update 2 test expectations (50.0 â†’ 20.0) and verify remaining tests still pass
- **Task 4:** Full test suite regression check

Does this look right, or would you like to adjust anything before I create the second story for the signed mean investigation?

### ğŸ§‘ Human (07:30:25)

Go ahead.

### ğŸ¤– Assistant (07:30:29)

Now let me create the second story for the signed mean investigation. Let me re-read the relevant code to make sure the story is precise.

### ğŸ¤– Assistant (07:31:26)

Now let me update the sprint-status.yaml to register both stories.

### ğŸ¤– Assistant (07:31:36)

Both stories are created and registered. Let me also check â€” should I close the existing hotfix that's already done in sprint status? The `hotfix-kazez-evaluation-strategy` (done) and `hotfix-integrate-kazez-into-adaptive-strategy` (review) aren't tracked there. Let me leave those as-is since they weren't in the sprint status before.

Now let me commit both stories.

### ğŸ¤– Assistant (07:31:54)

Both stories are created, registered in sprint-status, and committed. Here's the summary:

---

## Stories Created

### 1. `hotfix-tune-kazez-convergence.md` (Critical)
Two surgical changes to `AdaptiveNoteStrategy.swift`:
- **Task 1:** Kazez coefficient 0.05 â†’ 0.08 (line 215) â€” single correct answer from 100 cents goes to 20 instead of 50
- **Task 2:** Add `!= defaultDifficulty` guard to neighbor loops (lines 256, 267) â€” prevents unrefined 100-cent notes from anchoring averages
- **Task 3:** Update 2 test expectations + verify remaining tests
- **Task 4:** Full regression suite

### 2. `hotfix-investigate-signed-mean.md` (Medium)
Fix signed mean corruption in `PerceptualProfile`:
- **Task 1:** Pass unsigned `centDifference` to `update()` instead of signed value
- **Task 2:** Remove `abs()` wrapper in `weakSpots()`
- **Task 3-4:** Update documentation on `PerceptualNote.mean` and `update()` 
- **Task 5:** Update ~4 test assertions that expect negative means
- **Task 6:** Full regression suite

Both are marked `ready-for-dev` in sprint-status. Would you like to start implementing one?

### ğŸ§‘ Human (07:34:41)

Ok. Then go ahead and implement hotfix-tune-kazez-convergence.md. Make sure to update all relevant docs when you do so.

### ğŸ¤– Assistant (07:34:50)

Let me follow the story's task sequence. Starting with the sprint status update and then Task 1.

### ğŸ¤– Assistant (07:34:53)

Mark story in-progress in sprint status:

### ğŸ¤– Assistant (07:34:57)

Now **Task 1: Increase Kazez coefficient from 0.05 to 0.08**.

### ğŸ¤– Assistant (07:35:08)

Those are SourceKit indexing issues, not real compilation errors. Now verify the incorrect coefficient (0.09) is unchanged:

### ğŸ¤– Assistant (07:35:13)

Good â€” 0.09 is untouched. Task 1 complete.

Now **Task 2: Filter unrefined neighbors in `weightedEffectiveDifficulty()`**.

### ğŸ¤– Assistant (07:35:23)

Task 2 complete. Now **Task 3: Update tests**. Let me update the two tests that expect 50.0 (should now be 20.0 with 0.08 coefficient).

### ğŸ¤– Assistant (07:35:40)

Now I need to verify the remaining tests. Let me check `weightedDifficultyKernelNarrowing` and `weightedDifficultyNeighborsOnly` â€” these use `profile.update()` AND `profile.setDifficulty()`, so the neighbor filter should still find them (their `currentDifficulty` is set to non-default values).

Let me re-read the test code for the two tests that might be affected by the neighbor filtering change:

### ğŸ¤– Assistant (07:35:54)

Both tests set `setDifficulty()` to non-default values (40.0 and 50.0), so the `!= defaultDifficulty` guard passes. Let me also verify the boundary note test and current-note-dominates test:

### ğŸ¤– Assistant (07:35:59)

All weighted difficulty tests explicitly call `setDifficulty()` with non-default values (30.0, 40.0, 50.0, 80.0). The neighbor filter won't affect them. Good â€” no test changes needed beyond the two narrowing tests.

Now let me run the **full test suite** (Task 4):

### ğŸ¤– Assistant (07:37:21)

There's a failure. Let me find which test failed:

### ğŸ¤– Assistant (07:38:34)

Let me check the exact failure messages and verify my edits took:

### ğŸ¤– Assistant (07:38:39)

The edits are correct in the file. Let me check if there's a build caching issue â€” let me clean and retry:

### ğŸ¤– Assistant (07:41:45)

Let me check the xcresult for details:

### ğŸ¤– Assistant (07:49:28)

Let me run just the failing tests with verbose output to see the actual vs expected values:

### ğŸ¤– Assistant (07:50:12)

The two tests **pass** when run individually. The issue must be test ordering/state contamination when running the full suite. Let me run the full suite again to confirm:

### ğŸ¤– Assistant (07:53:26)

The tests pass individually but fail in the full suite â€” this suggests test ordering/parallelization. Let me run just the AdaptiveNoteStrategy suite:

### ğŸ¤– Assistant (07:55:27)

The tests are being run twice and failing on both attempts. Let me get the actual failure message by looking at the console output:

### ğŸ¤– Assistant (08:07:27)

Found it! The issue is floating-point precision: `19.999999999999996 == 20.0` fails. The actual value is `100.0 * (1.0 - 0.08 * 10.0)` = `100.0 * 0.2` which gives `19.999999999999996` due to floating-point arithmetic.

With the old 0.05 coefficient, `100.0 * (1.0 - 0.05 * 10.0) = 100.0 * 0.5 = 50.0` â€” that was exact. But `0.08 * 10.0 = 0.7999999999999999` instead of `0.8`, causing the tiny error.

I need to use approximate comparison instead of exact equality:

### ğŸ¤– Assistant (08:07:40)

Now let me run the full test suite:

### ğŸ¤– Assistant (08:10:31)

All 172 tests pass. Now let me update the story file and docs. Let me read the story file first:

### ğŸ¤– Assistant (08:10:35)

Now let me update the story file with all tasks checked and completion notes:

### ğŸ¤– Assistant (08:11:03)

Now update sprint-status to "review":

### ğŸ¤– Assistant (08:11:07)

Now update `future-work.md` to mark the convergence issue as resolved:

### ğŸ¤– Assistant (08:11:31)

Now let me commit:

### ğŸ¤– Assistant (08:12:00)

Implementation complete, Michael. Here's the summary:

---

## hotfix-tune-kazez-convergence â€” Done

**Changes made:**

| File | Change |
|------|--------|
| `AdaptiveNoteStrategy.swift` | Coefficient 0.05 â†’ 0.08 (line 215), doc comment updated, neighbor filter added to both loops (lines 258, 270) |
| `AdaptiveNoteStrategyTests.swift` | Two expectations updated: 50.0 â†’ 20.0 with `abs(diff - 20.0) < 0.01` for floating-point precision |
| `future-work.md` | Both convergence issues marked as RESOLVED |
| `hotfix-tune-kazez-convergence.md` | All tasks checked, status â†’ review, completion notes filled |
| `sprint-status.yaml` | `hotfix-tune-kazez-convergence: review` |

**Test results:** 172 tests, all passing, zero regressions.

**Expected convergence improvement (single note, all correct):**
- Before: 100 â†’ 50 â†’ 32 â†’ 23 â†’ 17 â†’ 13 (5 steps)
- After: 100 â†’ 20 â†’ 12.8 â†’ 9.1 â†’ 6.9 â†’ 5.5 (5 steps)

---

[â† Previous (afa5dccda9)](afa5dccda9.md) | [Index](index.md) | [Next (a225a9fcf1) â†’](a225a9fcf1.md)
