---
commit: "3cb6ee762871f272c4e4c696935a559f8f382ab6"
date: "2026-02-24T17:10:32+01:00"
author: "Michael Sch√ºrig <michael@schuerig.de>"
subject: "Update future-work.md and extract shared test factory"
sessions: ["7068c6e4-20a4-4993-b28b-ee990b49c53d"]
prev: "9541747f73.md"
next: "a18dbb497e.md"
---

[‚Üê Previous (9541747f73)](9541747f73.md) | [Index](index.md) | [Next (a18dbb497e) ‚Üí](a18dbb497e.md)

# Commit 3cb6ee7628

**Date:** 2026-02-24 17:10:32 UTC+01:00  
**Author:** Michael Sch√ºrig <michael@schuerig.de>

## Commit message

Update future-work.md and extract shared test factory

Mark 8 resolved issues (U5, S2, O2, O3, D1, Show Progress, Session
Acknowledgment, Redesign Profile Graph). Update partially resolved items
(S1, Tap-to-Inspect). Downgrade Convergence Chain Persistence to Low.

Extract duplicated makeTrainingSession() across 8 test files into shared
TrainingSessionFixture and factory in TrainingTestHelpers.swift.

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>

## Changed files

```
.../Training/TrainingScreenFeedbackTests.swift     | 138 ++++++---------
 .../TrainingSessionAudioInterruptionTests.swift    |  76 ++++----
 .../Training/TrainingSessionDifficultyTests.swift  | 122 ++++++-------
 .../Training/TrainingSessionFeedbackTests.swift    | 137 +++++++--------
 .../Training/TrainingSessionIntegrationTests.swift | 157 +++++++----------
 .../Training/TrainingSessionLifecycleTests.swift   | 169 ++++++++----------
 .../Training/TrainingSessionSettingsTests.swift    |  44 +----
 PeachTests/Training/TrainingSessionTests.swift     | 134 ++++++--------
 PeachTests/Training/TrainingTestHelpers.swift      |  62 +++++++
 docs/implementation-artifacts/future-work.md       | 192 ++++-----------------
 10 files changed, 499 insertions(+), 732 deletions(-)
```

## Session `7068c6e4‚Ä¶`

*2026-02-24 15:38:53 UTC ‚Üí 2026-02-24 16:10:40 UTC*

### üßë Human (15:38:53)

<command-message>bmad-bmm-code-review</command-message>
<command-name>/bmad-bmm-code-review</command-name>
<command-args>I want you to look at docs/implementation-artifacts/future-work.md and
* determine if there are any more issues that have been resolved
* make suggestions for resolving remaining issues
* remove issue O3: note2 is only redundant for now; I have plans where it will be different from note1</command-args>

### ü§ñ Assistant (15:39:02)

Now let me load the instructions and config to execute this workflow properly.

### ü§ñ Assistant (15:39:28)

I'll now systematically check the codebase against all open issues in `future-work.md` to determine which have been resolved. Let me launch parallel investigations.

### ü§ñ Assistant (15:42:49)

## Code Review: `future-work.md` Accuracy Audit

Michael, here are my findings after checking every open issue against the current codebase.

---

### Newly Resolved Issues (should be marked as RESOLVED)

These items are listed as open but the code shows they've been fixed:

| Issue | Evidence |
|-------|----------|
| **U5: Polling Loop in Training Session** | The polling loop (`Task.sleep(for: .milliseconds(100))`) has been removed. `TrainingSession` now uses a purely event-driven chain. |
| **S2: SettingsScreen Creates Services and Orchestrates Business Logic** | `SettingsScreen.resetAllTrainingData()` now delegates to `trainingSession.resetTrainingData()`, which centrally orchestrates profile, trend analyzer, and threshold timeline resets. |
| **O2: KazezNoteStrategy Ignores User-Configured Note Range** | Fixed during story 9.1 promotion. Line 66 now uses `settings.noteRangeMin...settings.noteRangeMax` instead of hardcoded MIDI 48-72. |
| **UX: Show Progress Over Time** | Story 9.2 added `ThresholdTimelineView` ‚Äî a scrollable line chart showing rolling mean threshold over time with stdDev band. |
| **UX: No Sense of Session or Progress Acknowledgment** | `DifficultyDisplayView` shows "Current: X ¬¢" and "Session Best: Y ¬¢" during training. |

### Partially Resolved Issues (should be updated)

| Issue | Status | Detail |
|-------|--------|--------|
| **UX: Redesign Profile Graph for Interpretability** | Largely resolved by 9.2 | Old confidence band + piano keyboard replaced with `ThresholdTimelineView` + `SummaryStatisticsView`. Plain-language stats. The old `ConfidenceBandView` / `PianoKeyboardView` code may still exist in the filesystem but is no longer used from Profile. |
| **UX: Tap-to-Inspect Note Detail** | Partially resolved | `ThresholdTimelineView` has tap-to-inspect per time period (date, mean, correct/total), but not per-individual-note. The original request was per-note detail ‚Äî that part remains open. |
| **S1: Mock Classes Ship in Production Binary** | Partially resolved | `MockDataStoreForPreview` was removed. `MockNotePlayerForPreview` remains but is scoped to `#Preview`. `MockHapticFeedbackManager` still ships in the production binary (not behind `#if DEBUG`). |
| **D1: makeTrainingSession() Duplicated** | Worse | Now **8 copies** across test files (added `TrainingSessionDifficultyTests`, `TrainingSessionFeedbackTests`, `TrainingScreenFeedbackTests`). `TrainingTestHelpers.swift` still doesn't include this factory. |

### Still Open ‚Äî No Changes

All remaining items are confirmed still open: U1, U2, U3, U4, D2, D4, O1, and all remaining Technical Debt and UX items.

---

### Suggestions for Resolving Remaining Issues

**Quick wins (Low effort, high value):**

1. **O1: Dead Code `previousScenePhase`** ‚Äî Delete the `@State` declaration and assignment. 2 lines, zero risk.

2. **D4: `hasTrainingData` duplication** ‚Äî Add `var hasData: Bool { overallMean != nil }` to `PerceptualProfile` and replace both call sites. 5-minute fix.

3. **U2: `precondition()` ‚Üí `guard/throw`** ‚Äî Replace with `guard midiNote >= 0 && midiNote <= 127 else { throw AudioError.invalidFrequency(...) }`. Straightforward, already has the error type.

**Medium effort:**

4. **U1: `fatalError()` in PeachApp** ‚Äî Add an `initializationError: Error?` state and show an error screen instead of crashing. SwiftUI pattern: conditionally show either the main content or an error view.

5. **S1: MockHapticFeedbackManager** ‚Äî Move to `PeachTests` target. Ensure test files import it.

6. **D1: Shared test factory** ‚Äî Extract `makeTrainingSession()` into `TrainingTestHelpers.swift`. Update all 8 test files to use it. High leverage ‚Äî reduces maintenance burden for any future `TrainingSession` init changes.

**Larger investments (defer or batch):**

7. **U3 + D2: `nonisolated(unsafe)` pattern** ‚Äî This is a Swift concurrency limitation. Consider a `@MainActor`-safe helper type, or wait for Swift 6.1+ improvements. Low urgency since SwiftUI environment keys are practically always accessed on the main thread.

8. **U4: Fire-and-forget Tasks** ‚Äî Store task references and cancel in `stop()`/`deinit`. Medium risk if left unfixed (orphan tasks after rapid deallocation), but unlikely in practice.

9. **Convergence Chain Persistence** ‚Äî Persist `lastCompletedComparison.centDifference` to `@AppStorage` / UserDefaults. Read it on launch to seed the chain. This is the most user-impactful remaining item.

---

Shall I go ahead and update `future-work.md` with these changes?

1. Mark the 5 newly resolved items as ~~RESOLVED~~
2. Update the partially resolved items with current status
3. Remove O3 (note2/note1 redundancy ‚Äî you have plans for divergence)
4. Update D1 to reflect 8 copies instead of 6

### üßë Human (15:50:24)

yes, update future-work.md with all those changes, except 4. Replace the duplicate makeTrainingSession with a single instance in TrainingTesthelpers.swift.

Regarding "Convergence Chain Persistence": I think this isn't really an issue, because the algorithm converges quickly, in a few comparisons.

### ü§ñ Assistant (15:50:36)

Let me start with the future-work.md updates. I'll also read the test files in parallel to prepare for task 2.

### ü§ñ Assistant (15:51:02)

Now I'll apply all the edits to `future-work.md`. Let me batch them ‚Äî starting with the items that need the most rewriting.

### ü§ñ Assistant (15:56:32)

Now the remaining edits for the Adversarial Review section.

### ü§ñ Assistant (15:57:16)

Good, `future-work.md` is updated. Now let me mark task 1 as complete and start on task 2 ‚Äî extracting the shared test factory.

### ü§ñ Assistant (15:57:20)

Now let me read the test files to understand the exact factory signatures and plan the shared factory.

### ü§ñ Assistant (15:57:43)

Let me also check the `TrainingSession` initializer to understand which parameters have defaults.

### ü§ñ Assistant (15:58:28)

Let me check all call sites across the test files to understand the refactoring scope.

### ü§ñ Assistant (15:59:05)

Now I have a clear picture of all 67 call sites across 8 files. Let me write the shared factory and then update each test file. I'll use a `TrainingSessionFixture` struct to cleanly hold all components.

### ü§ñ Assistant (15:59:21)

Now I'll update all 8 test files in parallel using agents, since each file is independent.

### ü§ñ Assistant (16:00:16)

The "No such module 'Testing'" diagnostics are just SourceKit noise ‚Äî the `Testing` framework resolves at build time through the test target, not through SourceKit indexing. These are expected and not real errors.

All 7 agents are still working on the test file updates. Let me wait for them to complete.

### ü§ñ Assistant (16:01:23)

TrainingSessionTests.swift is done. Let me check on the remaining agents.

### ü§ñ Assistant (16:03:34)

6 of 7 agents complete. The feedback tests agent is still running a build verification. Let me also check for a build issue ‚Äî the Integration Tests agent removed `import Foundation` but that file uses `Date()` directly.

### ü§ñ Assistant (16:03:54)

All 7 agents are done. The agents flagged a build issue: `TrainingSessionIntegrationTests.swift` uses `Date()` but `import Foundation` was removed. Let me fix that and then run the full build.

### ü§ñ Assistant (16:04:02)

Now let me build the test target to verify everything compiles.

### ü§ñ Assistant (16:04:12)

Build succeeded with no output (which means no errors). Now let me run the training tests to make sure everything passes.

### ü§ñ Assistant (16:07:30)

All tests pass. Let me also update `future-work.md` to mark D1 as resolved.

### ü§ñ Assistant (16:08:04)

Both tasks are complete. Here's a summary of everything done:

---

## Summary

### `future-work.md` ‚Äî Items marked RESOLVED (8 total)

| Item | Resolution |
|------|-----------|
| **U5**: Polling loop | Removed; event-driven chain now |
| **S2**: SettingsScreen orchestration | Delegates to `trainingSession.resetTrainingData()` |
| **O2**: KazezNoteStrategy hardcoded range | Fixed in story 9.1; uses `settings.noteRangeMin/Max` |
| **O3**: Redundant note1/note2 | **Removed** per your request (future plans for divergence) |
| **Show Progress Over Time** | Story 9.2's `ThresholdTimelineView` |
| **Session/Progress Acknowledgment** | `DifficultyDisplayView` + story 9.2 |
| **Redesign Profile Graph** | Story 9.2 replaced confidence band with timeline chart |
| **D1**: Duplicated test factories | Extracted to shared `TrainingSessionFixture` |

### `future-work.md` ‚Äî Items updated

- **S1** (Mocks in production): Downgraded to Medium, noted `MockDataStoreForPreview` removed
- **Tap-to-Inspect**: Noted per-period tap works; per-note detail still open
- **Convergence Chain Persistence**: Downgraded from Medium to Low (fast convergence)

### Code changes ‚Äî D1 fix

- **`TrainingTestHelpers.swift`**: Added `TrainingSessionFixture` struct and shared `makeTrainingSession()` factory with flexible parameters
- **8 test files**: Removed local factories, updated all 67 call sites to use the shared fixture
- **Build**: Passes. **All affected tests**: Pass.

### üßë Human (16:09:57)

<task-notification>
<task-id>b6f4377</task-id>
<tool-use-id>toolu_01AoshVmMV8c7862i4HDqxGn</tool-use-id>
<output-file>/private/tmp/claude-502/-Users-michael-Projekte-peach/tasks/b6f4377.output</output-file>
<status>completed</status>
<summary>Background command "Count passed vs failed tests" completed (exit code 0)</summary>
</task-notification>
Read the output file to retrieve the result: /private/tmp/claude-502/-Users-michael-Projekte-peach/tasks/b6f4377.output

### ü§ñ Assistant (16:10:01)

That was just the count command from earlier finishing in the background ‚Äî the test results are already confirmed: all tests pass, build succeeds. Everything is complete.

### üßë Human (16:10:12)

Unknown skill: commit

### üßë Human (16:10:16)

commit

### ü§ñ Assistant (16:10:19)

It looks like you want to commit. Let me check the current state.

### ü§ñ Assistant (16:10:40)

Committed as `3cb6ee7`. The only remaining unstaged change is `Localizable.xcstrings` which was already modified before this session.

---

[‚Üê Previous (9541747f73)](9541747f73.md) | [Index](index.md) | [Next (a18dbb497e) ‚Üí](a18dbb497e.md)
