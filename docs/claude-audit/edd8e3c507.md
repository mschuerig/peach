---
commit: "edd8e3c507ab7e2ad82fb4c9e6363df67f6ac8f3"
date: "2026-02-27T23:59:12+01:00"
author: "Michael Sch√ºrig <michael@schuerig.de>"
subject: "Add story: fix SoundFont click artifact on note stop"
sessions: ["7a78b839-ac58-4f0f-8d9a-abc15be25ac4"]
prev: "7fc0d8394c.md"
next: "c71efa7733.md"
---

[‚Üê Previous (7fc0d8394c)](7fc0d8394c.md) | [Index](index.md) | [Next (c71efa7733) ‚Üí](c71efa7733.md)

# Commit edd8e3c507

**Date:** 2026-02-27 23:59:12 UTC+01:00  
**Author:** Michael Sch√ºrig <michael@schuerig.de>

## Commit message

Add story: fix SoundFont click artifact on note stop

Reintroduce proven volume-mute fade-out for SoundFontPlaybackHandle.stop()
and SoundFontNotePlayer.stopAll() to eliminate audible clicks, especially
with the Sine Wave preset which lacks an SF2 release envelope.

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>

## Changed files

```
.../fix-soundfont-click-on-note-stop.md            | 139 +++++++++++++++++++++
 docs/implementation-artifacts/sprint-status.yaml   |   3 +
 2 files changed, 142 insertions(+)
```

## Session `7a78b839‚Ä¶`

*2026-02-27 22:40:25 UTC ‚Üí 2026-02-27 22:59:33 UTC*

### üßë Human (22:40:25)

<command-message>bmad-agent-bmm-analyst</command-message>
<command-name>/bmad-agent-bmm-analyst</command-name>
<command-args>I hope you're the right agent for this issue. Originally, we used SineWaveNotePlayer (conforming to NotePlayer) for playing notes. We soon discovered that cutting of the sound at arbitrary positions in the wave cause audible clicks. To avoid these, we introduced a short fade out (and fade in) for all notes. The same problem affects the Sine Wave preset/sample when using the current SoundFontNotePlayer. I'd like to discuss our options for avoiding this. You may consult the architect if that would help.</command-args>

### ü§ñ Assistant (22:40:37)

Hey Michael! Great to see you! I'm Mary, your Business Analyst. 

Now, you've come to me with a fascinating technical challenge ‚Äî audio clicks from abrupt waveform cutoffs. I love a good root cause analysis! Before I jump into the menu, let me engage with your question directly since you're looking to **chat** about options.

Let me first get my bearings on the current implementation so I can give you a well-grounded analysis. Let me peek at the relevant code.

### ü§ñ Assistant (22:42:42)

Oh, this is a *fascinating* root cause analysis problem! I can already see the pattern here. Let me lay out what I've discovered and the options as I see them.

---

## Root Cause Analysis

Here's the crux of the issue I've uncovered:

1. **Original problem (solved, then removed):** `SineWaveNotePlayer` generated raw sine waves via `AVAudioSourceNode`. Stopping at an arbitrary sample position ‚Üí discontinuity ‚Üí audible click. You solved this with a **volume-mute + 25ms propagation delay** before calling `playerNode.stop()`.

2. **Current problem:** `SineWaveNotePlayer` was removed in Story 8.3 and replaced entirely by `SoundFontNotePlayer`. The click-avoidance logic went with it. The `SoundFontNotePlayer` relies on the SF2 sampler's **built-in release envelope** via MIDI note-off. This works beautifully for acoustic instruments (piano, cello) that have natural decay/release envelopes baked into their SF2 instrument definitions...

3. **But the Sine Wave preset (bank 8, program 80)** in `GeneralUser-GS.sf2` is a **synthetic waveform sample** ‚Äî it almost certainly has a **minimal or zero-length release envelope**. When `SoundFontPlaybackHandle.stop()` sends `sampler.stopNote()`, it cuts off the sine wave abruptly ‚Üí same click artifact as before.

The root cause is clear: **not all SF2 presets have adequate release envelopes for click-free stopping, and the current code has no fallback mechanism.**

---

## Options Analysis

I see several approaches, each with different trade-offs. Let me lay them out:

### Option A: Universal Volume Fade-Out (Reintroduce Proven Approach)

Apply the old volume-mute technique at the `SoundFontPlaybackHandle.stop()` or engine mixer level ‚Äî for **all** presets.

| Aspect | Assessment |
|--------|-----------|
| **Effort** | Low ‚Äî proven pattern, already existed |
| **Risk** | Low ‚Äî known behavior |
| **Latency** | +25ms on every note stop |
| **Downside** | Instruments with proper release envelopes (piano, cello) would get an artificial cutoff instead of their natural release tail |

### Option B: Conditional Fade-Out (Per-Preset)

Only apply fade-out for presets known to lack adequate release envelopes (e.g., Sine Wave).

| Aspect | Assessment |
|--------|-----------|
| **Effort** | Medium ‚Äî need preset classification mechanism |
| **Risk** | Medium ‚Äî must maintain a "needs-fade" list as presets change |
| **Latency** | +25ms only for problematic presets |
| **Downside** | Brittle; new SF2 files could introduce new problematic presets |

### Option C: MIDI Expression Fade-Down Before Note-Off

Send MIDI CC#11 (Expression) or CC#7 (Volume) ramp-down before the note-off message.

| Aspect | Assessment |
|--------|-----------|
| **Effort** | Medium ‚Äî need to implement MIDI CC sequencing with timing |
| **Risk** | Medium ‚Äî timing depends on MIDI processing latency |
| **Latency** | Configurable fade duration |
| **Upside** | More "musically correct"; works within the MIDI paradigm |
| **Downside** | MIDI CC volume affects ALL notes on the channel, not just the target note |

### Option D: AVAudioEngine Mixer Volume Ramp

Use the engine's output mixer node with a short volume ramp before stopping.

| Aspect | Assessment |
|--------|-----------|
| **Effort** | Low-Medium |
| **Risk** | Low |
| **Latency** | Short configurable ramp |
| **Downside** | Same as Option A ‚Äî affects all presets; also affects any concurrent notes |

### Option E: Insert an Envelope Effect Node

Add an `AVAudioUnitEffect` (e.g., an amplitude envelope or limiter) in the audio processing chain between sampler and output.

| Aspect | Assessment |
|--------|-----------|
| **Effort** | High ‚Äî custom AU or finding a suitable built-in |
| **Risk** | High ‚Äî complexity, maintenance burden |
| **Upside** | Most technically correct; independent of preset behavior |
| **Downside** | Over-engineered for this problem |

---

## My Recommendation

I'd lean toward **Option A (Universal Volume Fade-Out)** as the simplest and most robust solution, *unless* the natural release tails of acoustic instruments are important to preserve ‚Äî in which case **Option B (Conditional)** is the pragmatic middle ground.

Here's the thing that excites me though: we should check whether the 25ms fade actually interferes with acoustic preset release tails in practice. If the user experience with piano/cello presets is indistinguishable (because the fade is so short), then Option A gives us maximum safety with minimum complexity.

---

What's your thinking, Michael? Would you like me to dig deeper into any of these options, or shall I consult the architect to evaluate the technical feasibility of the top candidates? I'm particularly curious whether you've noticed click artifacts with any presets *other* than Sine Wave.

---

Here's what else I can help with:

| # | Command | Description |
|---|---------|-------------|
| **MH** | Menu Help | Redisplay this menu |
| **CH** | Chat | Chat with me about anything |
| **BP** | Brainstorm Project | Expert guided brainstorming facilitation |
| **MR** | Market Research | Market analysis, competitive landscape |
| **DR** | Domain Research | Industry domain deep dive |
| **TR** | Technical Research | Technical feasibility & architecture options |
| **CB** | Create Brief | Nail down your product idea into an executive brief |
| **DP** | Document Project | Analyze existing project for documentation |
| **PM** | Party Mode | Start Party Mode |
| **DA** | Dismiss Agent | Exit |

You can also type `/bmad-help` anytime for guidance on what to do next (e.g., `/bmad-help where should I start with an idea I have that does XYZ`).

### üßë Human (22:47:10)

I think we should go with Option A and only make it any more complicated if it becomes necessary.

### ü§ñ Assistant (22:47:34)

Great call, Michael! I love the pragmatism ‚Äî **YAGNI until proven otherwise**. Option A gives us the highest confidence-to-complexity ratio: proven pattern, minimal code, universal coverage. If acoustic presets ever need their natural release tails preserved, we can refine later with real user feedback rather than speculative engineering.

Let me capture the key requirements for this change:

## Requirements: Universal Volume Fade-Out for SoundFontNotePlayer

**Problem:** Stopping notes on presets without adequate SF2 release envelopes (notably Sine Wave, bank 8, program 80) causes audible clicks due to abrupt waveform discontinuity.

**Solution:** Reintroduce the proven volume-mute approach from the former `SineWaveNotePlayer` into the current `SoundFontPlaybackHandle.stop()` path.

**Acceptance Criteria:**
1. Before sending MIDI note-off, mute the audio output (volume ‚Üí 0)
2. Wait for the audio render thread to process the volume change (~25ms propagation delay, covering 2+ render cycles at standard buffer sizes)
3. Then send the MIDI note-off / stop note
4. Restore volume to previous level after stop
5. Applies universally to all presets ‚Äî no per-preset branching
6. All existing stop paths remain covered (navigation, early answer, backgrounding, audio interruption)

**Out of Scope (for now):**
- Per-preset conditional fade logic
- Fade-in at note start (revisit only if click artifacts observed on note onset)
- Custom envelope effect nodes

---

Would you like me to:
1. **Consult the architect** to validate the technical approach and nail down exactly where in `SoundFontPlaybackHandle` the change should go?
2. **Write this up as a story** ready for sprint planning?
3. **Both** ‚Äî architect review first, then formalize the story?

### üßë Human (22:50:13)

1

### ü§ñ Assistant (22:50:21)

Let me pull in the architect to validate the technical approach. I'll review the exact code that needs to change.

### ü§ñ Assistant (22:50:27)

Now let me check how stops are triggered in practice ‚Äî the `ComparisonSession` and any other callers.

### ü§ñ Assistant (22:51:33)

Alright, I've done a thorough review with my architect hat on. Here's the technical assessment:

---

## Architect's Technical Analysis

### Two Stop Paths Need Treatment

There are **two distinct stop paths** in the code, and both need the fade-out:

| Path | Location | Mechanism | When Used |
|------|----------|-----------|-----------|
| **Individual note stop** | `SoundFontPlaybackHandle.stop()` | `sampler.stopNote()` | Early answer during note 2, pitch matching stop |
| **All notes off** | `SoundFontNotePlayer.stopAll()` | MIDI CC#123 | Session cleanup, navigation away, backgrounding, audio interruption |

### Recommended Implementation

**The change point is `sampler.volume`** (inherited from `AVAudioNode`). This is separate from `sampler.overallGain` which controls MIDI amplitude ‚Äî they don't interfere with each other.

**`SoundFontPlaybackHandle.stop()`** ‚Äî currently at line 23:

```swift
// Before (current):
func stop() async throws {
    guard !hasStopped else { return }
    hasStopped = true
    sampler.stopNote(midiNote, onChannel: channel)
    sampler.sendPitchBend(SoundFontNotePlayer.pitchBendCenter, onChannel: channel)
}

// After:
func stop() async throws {
    guard !hasStopped else { return }
    hasStopped = true
    sampler.volume = 0
    try? await Task.sleep(for: SoundFontNotePlayer.stopPropagationDelay)
    sampler.stopNote(midiNote, onChannel: channel)
    sampler.sendPitchBend(SoundFontNotePlayer.pitchBendCenter, onChannel: channel)
    sampler.volume = 1.0
}
```

**`SoundFontNotePlayer.stopAll()`** ‚Äî currently at line 151:

```swift
// Before (current):
func stopAll() async throws {
    sampler.sendController(123, withValue: 0, onChannel: Self.channel)
    sampler.sendPitchBend(Self.pitchBendCenter, onChannel: Self.channel)
}

// After:
func stopAll() async throws {
    sampler.volume = 0
    try? await Task.sleep(for: Self.stopPropagationDelay)
    sampler.sendController(123, withValue: 0, onChannel: Self.channel)
    sampler.sendPitchBend(Self.pitchBendCenter, onChannel: Self.channel)
    sampler.volume = 1.0
}
```

**New constant** on `SoundFontNotePlayer`:

```swift
static let stopPropagationDelay: Duration = .milliseconds(25)
```

### Key Design Decisions

1. **`try?` on the sleep** ‚Äî critical. Many callers use `try? await handle.stop()`. If the task is cancelled during the 25ms wait, `try?` ensures we still execute the actual stop and restore volume, rather than leaving the sampler muted.

2. **`sampler.volume` vs `engine.mainMixerNode.volume`** ‚Äî `sampler.volume` is more targeted. The handle already holds a `sampler` reference, so no new dependencies needed.

3. **Constant shared via `SoundFontNotePlayer`** ‚Äî the handle already references `SoundFontNotePlayer.pitchBendCenter`, so this follows the established pattern.

4. **No guard needed on `stopAll()`** ‚Äî it's inherently idempotent (CC#123 on no playing notes is a no-op). The 25ms overhead on a redundant call is acceptable.

### Risk Assessment

- **Test impact:** Adds 25ms per stop call in integration tests. Minimal ‚Äî tests already handle 20ms preset-load delays.
- **Behavioral impact on acoustic presets:** The 25ms mute will cut the very beginning of their natural release tails. At 25ms this is imperceptible ‚Äî well below the ~100ms threshold for human temporal resolution of amplitude envelopes.
- **Concurrency:** Only one note plays at a time in both `ComparisonSession` and `PitchMatchingSession`, so no concurrent volume manipulation risk.

---

Solid, clean, minimal change. The architect confirms this is the right approach. Shall I write this up as a formal story for implementation, Michael?

### üßë Human (22:54:16)

yes, write it up as a story

### ü§ñ Assistant (22:54:20)

Let me check the existing story format first.

### ü§ñ Assistant (22:54:34)

Now let me check the current sprint status and future-work file to understand the epic/story numbering.

### ü§ñ Assistant (22:54:41)

Now I have all the context I need. Let me write the story.

### ü§ñ Assistant (22:56:01)

Story's written and ready, Michael! 

Filed at `docs/implementation-artifacts/fix-soundfont-click-on-note-stop.md` with status **ready-for-dev**.

Here's the quick summary of what's in there:

- **2 files to modify** (`SoundFontPlaybackHandle.swift`, `SoundFontNotePlayer.swift`) + **2 test files** to extend
- **Zero API changes** ‚Äî `PlaybackHandle` and `NotePlayer` protocols untouched
- **Zero caller changes** ‚Äî `ComparisonSession` and `PitchMatchingSession` already route through the right stop paths
- **4 tasks**: add constant, fade-out in `handle.stop()`, fade-out in `stopAll()`, full test suite regression check
- **7 acceptance criteria** covering both stop paths, acoustic preset behavior, idempotency, cancellation safety, and regression

The dev notes include the exact code for both modifications, the `try?` rationale for cancellation safety, and the propagation delay justification from the original fix.

Shall I do anything else with this ‚Äî update the sprint status, or are you ready to hand it off to the dev agent?

### üßë Human (22:58:26)

Should the fix be added to epics.md and sprint-status.yaml?

### ü§ñ Assistant (22:58:35)

Good question! Looking at the existing patterns in your project:

**sprint-status.yaml ‚Äî yes.** The previous standalone fixes (`fix-audio-clicks-when-navigating-away`, `fix-reset-all-data-should-reset-difficulty`, `fix-feedback-icon-flicker-on-correctness-change`) are all tracked directly in sprint-status.yaml without belonging to an epic. They're grouped under a sprint date header.

**epics.md ‚Äî no.** Those same fixes don't appear in the epics structure. Epics are for planned feature work, not individual bug fixes.

So the story should get a line in `sprint-status.yaml` only. Want me to add it?

### üßë Human (22:58:55)

yes, go ahead and then commit.

### ü§ñ Assistant (22:59:16)

Done! Committed as `edd8e3c`:

- **New file:** `docs/implementation-artifacts/fix-soundfont-click-on-note-stop.md` (story, ready-for-dev)
- **Updated:** `docs/implementation-artifacts/sprint-status.yaml` (added tracking entry)

The story is ready for the dev agent whenever you want to kick it off, Michael. Anything else?

### üßë Human (22:59:33)

<command-name>/exit</command-name>
            <command-message>exit</command-message>
            <command-args></command-args>

### üßë Human (22:59:33)

<local-command-stdout>Catch you later!</local-command-stdout>

---

[‚Üê Previous (7fc0d8394c)](7fc0d8394c.md) | [Index](index.md) | [Next (c71efa7733) ‚Üí](c71efa7733.md)
