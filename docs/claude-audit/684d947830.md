---
commit: "684d9478301faa59f1f0fb75c47ad64de212b172"
date: "2026-02-22T20:09:32+01:00"
author: "Michael SchÃ¼rig <michael@schuerig.de>"
subject: "Fix signed mean cancellation in PerceptualProfile"
sessions: ["d94bf064-2105-4664-bba1-d9740ce399e8"]
prev: "d60e1ffb50.md"
next: "4d8fb0e274.md"
---

[â† Previous (d60e1ffb50)](d60e1ffb50.md) | [Index](index.md) | [Next (4d8fb0e274) â†’](4d8fb0e274.md)

# Commit 684d947830

**Date:** 2026-02-22 20:09:32 UTC+01:00  
**Author:** Michael SchÃ¼rig <michael@schuerig.de>

## Commit message

Fix signed mean cancellation in PerceptualProfile

Replace signed centOffset with unsigned centDifference in
comparisonCompleted() and profile loading so that the per-note mean
accurately represents the detection threshold instead of being
corrupted by directional cancellation.

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>

## Changed files

```
Peach/App/PeachApp.swift                           |  2 +-
 Peach/Core/Profile/PerceptualProfile.swift         | 14 ++---
 .../AdaptiveNoteStrategyRegionalTests.swift        | 14 ++---
 PeachTests/Profile/ProfileScreenTests.swift        | 19 +++----
 PeachTests/Profile/SummaryStatisticsTests.swift    | 10 ++--
 .../Training/TrainingSessionIntegrationTests.swift | 15 ++---
 .../hotfix-investigate-signed-mean.md              | 65 +++++++++++++++-------
 docs/implementation-artifacts/sprint-status.yaml   | 12 +++-
 tools/validate-sprint-status.py                    | 27 +++++++++
 9 files changed, 114 insertions(+), 64 deletions(-)
```

## Session `d94bf064â€¦`

*2026-02-22 18:52:04 UTC â†’ 2026-02-22 19:10:14 UTC*

### ğŸ§‘ Human (18:52:04)

<command-message>bmad-bmm-dev-story</command-message>
<command-name>/bmad-bmm-dev-story</command-name>
<command-args>hotfix-investigate-signed-mean</command-args>

### ğŸ¤– Assistant (18:52:07)

I'll start by loading the workflow engine and configuration files.

### ğŸ¤– Assistant (18:52:11)

Now loading the config source and instructions.

### ğŸ¤– Assistant (18:52:25)

All workflow components loaded. Now executing **Step 1: Find next ready story and load it**.

The argument `hotfix-investigate-signed-mean` appears to be a story key. Let me find the story file.

### ğŸ¤– Assistant (18:52:29)

Found the story file. Let me read it completely.

### ğŸ¤– Assistant (18:52:38)

Story loaded successfully. Now executing **Step 2: Load project context**.

### ğŸ¤– Assistant (18:52:51)

âœ… **Context Loaded** â€” Story and project context available for implementation.

---

**Step 3: Detect review continuation**

No "Senior Developer Review (AI)" section exists.

ğŸš€ **Starting Fresh Implementation**

- **Story:** hotfix-investigate-signed-mean
- **Story Status:** ready-for-dev
- **First incomplete task:** Task 1 â€” Change `comparisonCompleted()` to pass unsigned centOffset

---

**Step 4: Mark story in-progress**

### ğŸ¤– Assistant (18:53:41)

ğŸš€ Starting work on story **hotfix-investigate-signed-mean**
Status updated: ready-for-dev â†’ in-progress

---

Now entering **Step 5: Implement tasks**. Let me first read the source files I need to modify.

### ğŸ¤– Assistant (18:53:47)

Now let me read the other test files that need updates.

### ğŸ¤– Assistant (18:54:04)

Let me search for the specific test assertions mentioned in the story that need updating.

### ğŸ¤– Assistant (18:54:12)

Found the actual test files with negative mean assertions. Let me read them.

### ğŸ¤– Assistant (18:54:39)

Let me also check how `ComparisonRecord` stores data and how the profile is loaded from stored records, since one test loads from stored data.

### ğŸ¤– Assistant (18:57:02)

I have a complete picture now. Let me check git status before starting.

### ğŸ¤– Assistant (18:57:09)

Good, only the sprint-status change I just made. Now let me implement the source code changes.

### Task 1: Change `comparisonCompleted()` to pass unsigned centOffset

### ğŸ¤– Assistant (18:57:18)

Also updating `PeachApp.swift` to use `abs()` when loading from stored records (which have signed `note2CentOffset`).

### ğŸ¤– Assistant (18:57:24)

### Task 2: Simplify `weakSpots()` to remove `abs()` wrapper

### ğŸ¤– Assistant (18:57:33)

### Task 3: Update `PerceptualNote.mean` documentation

### ğŸ¤– Assistant (18:57:38)

### Task 4: Update `update()` method documentation

### ğŸ¤– Assistant (18:57:45)

Also update the `averageThreshold` method which uses `abs()` on mean â€” now unnecessary but harmless. Let me leave it since the story says "NEVER implement anything not mapped to a specific task/subtask".

Now let me verify the source changes look correct.

### ğŸ¤– Assistant (18:57:50)

Source code changes look good. Now let me implement **Task 5: Update tests**. Let me update all affected test files.

### ğŸ¤– Assistant (18:58:12)

Now update the `profileLoadedFromDataStore` test â€” since `PeachApp.swift` now uses `abs()` when loading, the test should mirror that behavior.

### ğŸ¤– Assistant (18:58:23)

Now update `AdaptiveNoteStrategyRegionalTests.weakSpotsUseAbsoluteValue` â€” with unsigned means, negative centOffset produces positive mean, so the ranking assertions need updating.

### ğŸ¤– Assistant (18:58:33)

Now update the `ProfileScreenTests` and `SummaryStatisticsTests` which use negative centOffset values.

### ğŸ¤– Assistant (18:58:53)

Now let me also update the `confidenceBandAbsoluteMean` test and `confidenceBandLowerBoundClamped` test in ProfileScreenTests which use negative centOffset values.

### ğŸ¤– Assistant (18:59:00)

Now update the `confidenceBandLowerBoundClamped` test which uses mixed signed centOffset values.

### ğŸ¤– Assistant (18:59:09)

Now let me run **Task 6: Full test suite** to verify everything passes.

### ğŸ¤– Assistant (19:03:36)

All tests pass. Now let me update the story file to mark tasks complete and record the implementation.

### ğŸ¤– Assistant (19:03:42)

Now let me update the story file with task completion, dev agent record, file list, change log, and status.

### ğŸ¤– Assistant (19:04:23)

Now update sprint-status.yaml to "review".

### ğŸ¤– Assistant (19:04:34)

âœ… Story status updated to "review" in sprint-status.yaml

---

**Step 10: Completion**

Story **hotfix-investigate-signed-mean** is complete and ready for review, Michael.

### Summary

**What was fixed:** The `PerceptualProfile` was using signed centOffset values for its running mean, causing directional cancellation. A note with equal "higher" and "lower" comparisons at 50 cents would show a mean of 0.0 instead of 50.0.

**Key changes:**
- `comparisonCompleted()` now passes `comparison.centDifference` (always positive) instead of applying a sign based on direction
- `PeachApp.swift` profile loading now uses `abs(record.note2CentOffset)` to handle signed values in stored records
- `weakSpots()` uses `stats.mean` directly instead of `abs(stats.mean)` since mean is now always non-negative
- Documentation updated to reflect unsigned semantics
- 8 tests updated across 4 test files, 3 renamed for clarity

**All tests pass** â€” full suite, zero regressions.

**Story file:** `docs/implementation-artifacts/hotfix-investigate-signed-mean.md`

Would you like me to explain any of the technical decisions, or would you like to proceed with something else?

ğŸ’¡ **Tip:** For best results, run `code-review` using a **different** LLM than the one that implemented this story.

### ğŸ§‘ Human (19:09:09)

commit your changes, don't forget the new tool script

### ğŸ¤– Assistant (19:09:25)

Everything looks correct. Let me stage and commit all changes including the tool script.

### ğŸ¤– Assistant (19:09:42)

Committed as `684d947`. Working tree is clean â€” all 8 modified files plus the new `tools/validate-sprint-status.py` script are included.

### ğŸ§‘ Human (19:10:14)

<command-name>/exit</command-name>
            <command-message>exit</command-message>
            <command-args></command-args>

### ğŸ§‘ Human (19:10:14)

<local-command-stdout>Goodbye!</local-command-stdout>

---

[â† Previous (d60e1ffb50)](d60e1ffb50.md) | [Index](index.md) | [Next (4d8fb0e274) â†’](4d8fb0e274.md)
