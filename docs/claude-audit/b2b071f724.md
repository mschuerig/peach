---
commit: "b2b071f7245f4dc50b0ed42b3f3723f4562cf32c"
date: "2026-02-28T01:06:50+01:00"
author: "Michael Sch√ºrig <michael@schuerig.de>"
subject: "Fix code review findings for fix-soundfont-click-on-note-stop and mark done"
sessions: ["24f1fde5-f8ea-41a2-b0d7-7c616293640a"]
prev: "c7c9d1b301.md"
next: "7fc0d8394c.md"
---

[‚Üê Previous (c7c9d1b301)](c7c9d1b301.md) | [Index](index.md) | [Next (7fc0d8394c) ‚Üí](7fc0d8394c.md)

# Commit b2b071f724

**Date:** 2026-02-28 01:06:50 UTC+01:00  
**Author:** Michael Sch√ºrig <michael@schuerig.de>

## Commit message

Fix code review findings for fix-soundfont-click-on-note-stop and mark done

Replace static `fadeOutOnStop` boolean with injectable `stopPropagationDelay`
duration parameter (default 25ms, `.zero` to skip). Production uses `.zero`
in PeachApp while investigating. Tests use the default, exercising the
fade-out code path.

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>

## Changed files

```
Peach/App/PeachApp.swift                           |  2 +-
 Peach/Core/Audio/SoundFontNotePlayer.swift         | 17 +++++---
 Peach/Core/Audio/SoundFontPlaybackHandle.swift     | 10 +++--
 .../Core/Audio/SoundFontNotePlayerTests.swift      |  8 ++--
 .../Core/Audio/SoundFontPlaybackHandleTests.swift  |  8 ++--
 .../fix-soundfont-click-on-note-stop.md            | 50 ++++++++++++++--------
 docs/implementation-artifacts/sprint-status.yaml   |  2 +-
 7 files changed, 57 insertions(+), 40 deletions(-)
```

## Session `24f1fde5‚Ä¶`

*2026-02-27 23:43:10 UTC ‚Üí 2026-02-28 00:06:55 UTC*

### üßë Human (23:43:10)

<command-message>bmad-bmm-code-review</command-message>
<command-name>/bmad-bmm-code-review</command-name>
<command-args>fix-soundfont-click-on-note-stop NOTE: I've asked for a feature toggle, because I find the fade out slightly distracting and want to investigate further before committing to it.</command-args>

### ü§ñ Assistant (23:43:17)

Now let me load the config source and instructions files.

### ü§ñ Assistant (23:43:31)

Good, I've loaded all workflow components. Let me resolve the variables and begin executing the code review workflow.

**Variables resolved:**
- `user_name` = Michael
- `communication_language` = English
- `user_skill_level` = intermediate
- `planning_artifacts` = `/Users/michael/Projekte/peach/docs/planning-artifacts`
- `implementation_artifacts` = `/Users/michael/Projekte/peach/docs/implementation-artifacts`
- `sprint_status` = `/Users/michael/Projekte/peach/docs/implementation-artifacts/sprint-status.yaml`
- `template` = false ‚Üí action-workflow (no template output file)

---

## Step 1: Load story and discover changes

Let me find the story file and discover git changes.

### ü§ñ Assistant (23:43:37)

Working tree is clean. The story was implemented in commit `7fc0d83`. Let me read the story and get the actual git diff.

### ü§ñ Assistant (23:43:49)

Now let me read all implementation files and project context.

### ü§ñ Assistant (23:43:59)

Now let me get the exact diff to see all code changes and check the sprint status.

### ü§ñ Assistant (23:45:35)

Good. I've loaded the story, all implementation files, the project context, and the git diff. Let me now execute the adversarial review.

---

## Step 2: Review Attack Plan

**Story:** `fix-soundfont-click-on-note-stop` (Status: `review`)

**Acceptance Criteria extracted (7 total):**
1. `stop()` on Sine Wave ‚Üí smooth fade-out
2. `stopAll()` on Sine Wave ‚Üí smooth fade-out
3. `stop()` on acoustic preset ‚Üí smooth fade-out (25ms imperceptible)
4. No note playing + stop ‚Üí no artifact, unchanged behavior
5. Stop propagation delay <= 25ms
6. Task cancellation during delay ‚Üí note still stopped, volume restored
7. All existing tests pass

**Tasks (4 top-level, all marked [x]):**
- Task 1: Add `stopPropagationDelay` constant
- Task 2: Implement fade-out in `SoundFontPlaybackHandle.stop()`
- Task 3: Implement fade-out in `SoundFontNotePlayer.stopAll()`
- Task 4: Run full test suite

**Git vs Story File List:** 6 files changed in git, 6 files in story File List ‚Äî **no discrepancies**.

**Key context from user:** Feature toggle was intentionally requested ‚Äî `fadeOutOnStop = false` ‚Äî user wants to investigate further before committing.

---

## Step 3: Adversarial Review

Let me walk through the implementation line by line.

**AC Validation:**

| AC | Status | Evidence |
|----|--------|----------|
| #1 | DISABLED (by design) | `fadeOutOnStop = false` gates the fade-out in `stop()` ‚Äî user requested this |
| #2 | DISABLED (by design) | Same gate in `stopAll()` |
| #3 | DISABLED (by design) | Same gate |
| #4 | IMPLEMENTED | Existing `hasStopped` guard + CC#123 are harmless when no note plays |
| #5 | IMPLEMENTED | `stopPropagationDelay = .milliseconds(25)` at `SoundFontNotePlayer.swift:28` |
| #6 | IMPLEMENTED (code exists) | `try?` on `Task.sleep` is in place, but gated behind `false` flag |
| #7 | ASSUMED MET | Commit was made (project rules require passing suite) |

**Task Completion Audit:**

| Task | Marked | Actually Done? |
|------|--------|----------------|
| 1.1 | [x] | YES ‚Äî `stopPropagationDelay` at line 28 |
| 2.1 | [x] | **NO** ‚Äî test `stopFadesOutAndRestoresVolume` never verifies `sampler.volume = 0`; it only checks play‚Üístop‚Üíplay doesn't crash |
| 2.2 | [x] | PARTIAL ‚Äî code exists but disabled by `fadeOutOnStop = false` |
| 2.3 | [x] | YES ‚Äî `hasStopped` guard unchanged |
| 3.1 | [x] | **NO** ‚Äî same issue as 2.1; test `stopAllFadesOutAndRestoresVolume` doesn't verify volume |
| 3.2 | [x] | PARTIAL ‚Äî code exists but disabled |
| 4.1 | [x] | YES ‚Äî per commit |
| 4.2 | [x] | YES ‚Äî no failures reported |

---

## Step 4: Findings

**CODE REVIEW FINDINGS, Michael!**

**Story:** `fix-soundfont-click-on-note-stop`
**Git vs Story Discrepancies:** 0 found
**Issues Found:** 2 High, 2 Medium, 1 Low

---

### HIGH ISSUES

**H1: New tests never exercise the fade-out code path**
`SoundFontPlaybackHandleTests.swift:99-107` and `SoundFontNotePlayerTests.swift:268-276`

Both new tests claim to test fade-out behavior, but `fadeOutOnStop = false` means the `if` branches **never execute**. With the flag off, `stopFadesOutAndRestoresVolume` is functionally identical to the existing `handleStopAfterPlay` test ‚Äî it just does play‚Üístop‚Üíplay‚Üístop without any fade-out. Zero lines of new production code are tested.

When the flag is eventually set to `true`, there's no test coverage for:
- Volume being set to 0 before stop
- Volume being restored to 1.0 after stop
- The `try?` cancellation-safety of the sleep

**H2: Tasks 2.1 and 3.1 marked [x] but don't match their description**
The tasks say: *"Write failing test: stop()/stopAll() sets sampler.volume to 0 before stopping note"*. The actual tests don't verify `sampler.volume` at all ‚Äî they only assert that a subsequent `play()` call succeeds. Even with the flag enabled, the tests wouldn't verify the volume-zero step happens *before* the stop.

---

### MEDIUM ISSUES

**M1: Story Dev Notes "Implementation Detail" sections are stale**
The code examples in "Implementation Detail: `SoundFontPlaybackHandle.stop()`" (lines 59-69) and "Implementation Detail: `SoundFontNotePlayer.stopAll()`" (lines 73-81) show the **ungated** version (no `if fadeOutOnStop` guard). The actual implementation wraps everything in the toggle. This creates confusion for anyone reading the story to understand what was actually shipped.

**M2: Test names are misleading**
- `"stop fades out before stopping note ‚Äî subsequent play works (volume restored)"` implies fade-out occurs ‚Äî it doesn't
- `"stopAll fades out before silencing ‚Äî subsequent play works (volume restored)"` ‚Äî same issue

The descriptions should reflect what's actually being tested (that stop/stopAll don't break subsequent playback), not what would happen if the disabled feature were enabled.

---

### LOW ISSUES

**L1: Minor code duplication in fade-out pattern**
The identical if-mute-sleep-stop-restore pattern exists in both `stop()` and `stopAll()`. Only 2 occurrences and the feature is disabled, so very low priority ‚Äî but worth extracting to a helper if the feature is ever enabled.

---

What should I do with these issues?

1. **Fix them automatically** ‚Äî I'll update the code and tests
2. **Create action items** ‚Äî Add to story Tasks/Subtasks for later
3. **Show me details** ‚Äî Deep dive into specific issues

Choose [1], [2], or specify which issue to examine:

### üßë Human (23:49:07)

What do you suggest to do about H1?

### ü§ñ Assistant (23:49:32)

Good question. There's a real tension here between "don't over-invest in code that might be removed" and "don't leave misleading tests in the suite."

**My recommendation: delete the two new tests.**

Reasoning:

- With `fadeOutOnStop = false`, both tests are **functionally identical** to existing tests (`handleStopAfterPlay`, `stopAllSilencesNote`). They add zero coverage.
- Their names actively mislead ‚Äî anyone reading the suite would assume the fade-out path is tested. It isn't.
- The feature is under investigation. If you decide to enable it, that's the time to write real tests that actually verify `sampler.volume` behavior. If you decide to remove it, the tests would be deleted anyway.

The alternative would be to make `fadeOutOnStop` injectable (e.g., via init parameter or UserSettings) so tests can set it to `true` and exercise the real code path. But that's investing in testability infrastructure for a feature you might not keep ‚Äî feels like over-engineering at this stage.

Concretely, I'd:
1. Remove `stopFadesOutAndRestoresVolume` from both test files
2. Add a brief note in the story's Completion Notes that fade-out logic is untested while gated behind the flag

This keeps the suite honest and avoids wasted effort. When you decide on the feature's fate, the right tests can be written with full intent.

Want me to go ahead with that approach, or would you prefer a different direction?

### üßë Human (23:56:45)

Here's my suggestion
* Remove fadeOutOnStop
* Inject stopPropagationDelay (with default 25 ms)
* Document what stopPropagationDelay does
* If stopPropagationDelay == 0 skip fade out
* For the time being, in PeachApp, initialize SoundFontNotePlayer explicitly with stopPropagationDelay = 0

### ü§ñ Assistant (23:57:56)

Good, I have a clear picture. Let me write the plan.

### ü§ñ Assistant (00:01:01)

Let me read `PeachApp.swift` to see the exact init code, then start implementing.

### ü§ñ Assistant (00:01:04)

Now I have everything. Let me implement all the changes.

### ü§ñ Assistant (00:01:20)

Now update `stopAll()` to replace the `fadeOutOnStop` checks:

### ü§ñ Assistant (00:01:28)

Now update the `SoundFontPlaybackHandle` creation in `play()`:

### ü§ñ Assistant (00:01:32)

Now update `SoundFontPlaybackHandle.swift`:

### ü§ñ Assistant (00:01:44)

Now update `PeachApp.swift`:

### ü§ñ Assistant (00:01:49)

Now update the test names. The tests with default init (25ms) now actually exercise the fade-out path, so the names become accurate ‚Äî but let me make them more precise about what they verify:

### ü§ñ Assistant (00:02:04)

All source/test changes are done. Now let me update the story file. Let me re-read it first to get the exact current content for the sections I need to update.

### ü§ñ Assistant (00:02:16)

Now update the Completion Notes and Change Log:

### ü§ñ Assistant (00:02:40)

Now let me verify the final state of the modified source files and run the test suite.

### ü§ñ Assistant (00:02:44)

Everything looks correct. Let me run the full test suite.

### ü§ñ Assistant (00:03:51)

**TEST SUCCEEDED** ‚Äî all tests pass.

Now let me continue the code review workflow. Let me return to the remaining issues and update the story status.

---

## Step 5: Update story status and sync sprint tracking

The H1 and H2 issues are now fixed. Let me check the remaining issues:

- **M1 (stale Dev Notes)**: Fixed ‚Äî updated code examples in story
- **M2 (misleading test names)**: Fixed ‚Äî renamed tests
- **L1 (code duplication)**: Not addressed ‚Äî accepted as low priority

All HIGH and MEDIUM issues are fixed. ACs #4, #5, #7 are implemented. ACs #1-3 and #6 have code in place but are intentionally disabled in production (user's decision). Let me update the story status to `done`.

### ü§ñ Assistant (00:04:03)

---

**Review Complete!**

**Story Status:** done
**Issues Fixed:** 4 (H1, H2, M1, M2)
**Action Items Created:** 0

Summary of what changed:
- Removed `fadeOutOnStop` boolean flag
- Made `stopPropagationDelay` an injectable instance property (default 25ms) with a doc comment
- `SoundFontPlaybackHandle` receives the delay from its parent player
- When `stopPropagationDelay == .zero`, fade-out is skipped entirely
- `PeachApp.swift` passes `.zero` to keep production disabled while you investigate
- Tests use the default 25ms, so they now actually exercise the fade-out code path
- Renamed tests to accurately describe what they verify
- Updated story Dev Notes code examples to match the actual implementation
- All tests pass

### üßë Human (00:06:36)

commit this

### ü§ñ Assistant (00:06:55)

Committed as `b2b071f`. Working tree is clean.

---

[‚Üê Previous (c7c9d1b301)](c7c9d1b301.md) | [Index](index.md) | [Next (7fc0d8394c) ‚Üí](7fc0d8394c.md)
