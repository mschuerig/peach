---
commit: "01ed9692fd8aac44139057c75c5d6009efac70f1"
date: "2026-02-17T23:34:39+01:00"
author: "Michael Sch√ºrig <michael@schuerig.de>"
subject: "Code review fixes for Story 6.2: cache duration, add mid-training test, fix docs"
sessions: ["f1c9a772-1ae8-4866-a1c6-558ae3110dc7"]
prev: "05e06c849a.md"
next: "91123423be.md"
---

[‚Üê Previous (05e06c849a)](05e06c849a.md) | [Index](index.md) | [Next (91123423be) ‚Üí](91123423be.md)

# Commit 01ed9692fd

**Date:** 2026-02-17 23:34:39 UTC+01:00  
**Author:** Michael Sch√ºrig <michael@schuerig.de>

## Commit message

Code review fixes for Story 6.2: cache duration, add mid-training test, fix docs

- Cache currentNoteDuration per comparison in playNextComparison() for
  consistency with currentSettings caching pattern
- Add settingsChangedMidTrainingTakeEffect test verifying real-time
  settings application between comparisons
- Fix Dev Notes: correct @AppStorage/@Observable claim to reflect actual
  UserDefaults.standard approach, update code examples and flow diagram
- Remove stale "Epic 6 will..." docstrings from Comparison.swift and
  NextNoteStrategy.swift
- 234 tests pass (227 existing + 7 new)

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>

## Changed files

```
Peach/Core/Algorithm/NextNoteStrategy.swift        |  2 +-
 Peach/Training/Comparison.swift                    |  5 +--
 Peach/Training/TrainingSession.swift               |  6 ++-
 PeachTests/Training/TrainingSessionTests.swift     | 49 ++++++++++++++++++++++
 .../6-2-apply-settings-to-training-in-real-time.md | 42 +++++++++++--------
 docs/implementation-artifacts/sprint-status.yaml   |  2 +-
 6 files changed, 81 insertions(+), 25 deletions(-)
```

## Session `f1c9a772‚Ä¶`

*2026-02-17 22:15:01 UTC ‚Üí 2026-02-17 22:34:47 UTC*

### üßë Human (22:15:01)

<command-message>bmad-bmm-code-review</command-message>
<command-name>/bmad-bmm-code-review</command-name>
<command-args>6-2</command-args>

### ü§ñ Assistant (22:15:04)

I'll start by loading the workflow engine and the code review workflow configuration.

### ü§ñ Assistant (22:15:10)

Now I'll load the configuration and instructions files.

### ü§ñ Assistant (22:15:25)

Good. All components loaded. Let me resolve variables and begin executing the workflow.

**Resolved Variables:**
- `user_name`: Michael
- `communication_language`: English
- `user_skill_level`: intermediate
- `planning_artifacts`: `/Users/michael/Projekte/peach/docs/planning-artifacts`
- `implementation_artifacts`: `/Users/michael/Projekte/peach/docs/implementation-artifacts`
- `sprint_status`: `/Users/michael/Projekte/peach/docs/implementation-artifacts/sprint-status.yaml`
- `date`: 2026-02-17
- `epic_num`: 6 (from argument "6-2")
- `template`: false ‚Üí action-workflow

---

## Step 1: Load story and discover changes

Let me find and load the story file, check git status, and discover input files.

### ü§ñ Assistant (22:15:33)

Clean working directory. Now let me load the story file, and discover input files (architecture, UX, epic).

### ü§ñ Assistant (22:15:39)

Let me search more broadly for architecture and epic files.

### ü§ñ Assistant (22:15:45)

Now let me load the architecture doc, the epic context, and the actual implementation files. I'll also check git history for the story 6.2 commit.

### ü§ñ Assistant (22:15:54)

Good. Now let me check the git diff for the implementation commit, and also verify key supporting files.

### ü§ñ Assistant (22:16:04)

Let me also check the sprint status and the Comparison struct to verify frequency methods.

### ü§ñ Assistant (22:16:11)

Let me check the mock implementations to verify test quality.

### ü§ñ Assistant (22:18:10)

Let me verify one more critical piece ‚Äî the SettingsScreen to confirm type compatibility.

### ü§ñ Assistant (22:18:56)

I now have a complete picture of the implementation. Let me proceed with the review.

---

## Step 2: Review Attack Plan

**Acceptance Criteria extracted:**
1. naturalVsMechanical slider ‚Üí AdaptiveNoteStrategy uses updated balance ratio
2. note range bounds ‚Üí AdaptiveNoteStrategy uses new range
3. note duration ‚Üí NotePlayer uses updated duration
4. reference pitch ‚Üí frequencies derived from new reference pitch
5. settings persist across app restart
6. unit tests verify the flow

**Tasks (all marked [x]):**
1. Make TrainingSession read settings from @AppStorage at comparison time
2. Wire @AppStorage reads into TrainingSession
3. Update PeachApp initialization
4. Update TrainingSession.init() to support both modes
5. Write tests (6 new)

**File List (story vs git):**
| File | Story | Git | Match |
|------|-------|-----|-------|
| `Peach/Training/TrainingSession.swift` | modified | modified | ‚úÖ |
| `PeachTests/Training/TrainingSessionTests.swift` | modified | modified | ‚úÖ |
| `docs/implementation-artifacts/6-2-*.md` | modified | modified | ‚úÖ |
| `docs/implementation-artifacts/sprint-status.yaml` | modified | modified | ‚úÖ |

**Git vs Story Discrepancies: 0** ‚Äî perfect match.

---

## Step 3: Adversarial Review

I've read every file in the File List plus supporting files (`SettingsKeys.swift`, `PeachApp.swift`, `Comparison.swift`, `NextNoteStrategy.swift`, `SettingsScreen.swift`, mocks). Here are my findings.

---

**üî• CODE REVIEW FINDINGS, Michael!**

**Story:** `6-2-apply-settings-to-training-in-real-time.md`
**Git vs Story Discrepancies:** 0 found
**Issues Found:** 1 High, 2 Medium, 2 Low

---

### üî¥ HIGH ISSUES

**H1: Missing test for mid-training real-time settings change**
- File: `PeachTests/Training/TrainingSessionTests.swift`
- The entire point of Story 6.2 is "Apply Settings to Training **in Real Time**" ‚Äî settings changed *during* an active training session should take effect on the *next* comparison.
- **All 4 UserDefaults tests set values BEFORE `startTraining()`**, then verify the first comparison. No test changes UserDefaults *between* comparison 1 and comparison 2 to verify the second comparison picks up new values.
- The implementation supports this (since `currentSettings` is a computed property read on each `playNextComparison()` call), but there's no test proving it works.
- A proper test would: start training ‚Üí answer comparison 1 ‚Üí change UserDefaults mid-session ‚Üí wait for comparison 2 ‚Üí verify strategy received new settings.
- This is AC#1 and AC#2's exact language: "**when the next comparison is selected**, then the AdaptiveNoteStrategy uses the updated balance ratio" ‚Äî this implies mid-session changes.

### üü° MEDIUM ISSUES

**M1: `currentNoteDuration` not cached per comparison ‚Äî inconsistent with `currentSettings` pattern**
- File: `Peach/Training/TrainingSession.swift:325,345,356`
- Line 325 correctly caches settings: `let settings = currentSettings`
- But lines 345 and 356 call `currentNoteDuration` directly (twice ‚Äî once per note), reading UserDefaults on each call instead of caching once.
- If duration somehow changed between note1 and note2 playback, they'd use different durations. Inconsistent with the settings pattern and violates the "settings apply to the next comparison" contract.
- Fix: add `let noteDuration = currentNoteDuration` at line 326 and use the local variable.

**M2: Dev Notes "Architecture & Patterns" section contains factually incorrect claim**
- File: `docs/implementation-artifacts/6-2-apply-settings-to-training-in-real-time.md:53`
- First bullet states: *"@AppStorage property wrapper works inside @Observable classes on iOS 26"*
- But the Debug Log section (line 194) directly contradicts this: *"@AppStorage inside @Observable class causes `invalid redeclaration of synthesized property` errors"*
- The actual implementation correctly uses direct `UserDefaults.standard` reads, but the Architecture section was never updated to reflect this pivot.
- The Dev Notes section labeled "Key Code Changes" (lines 80-125) still shows `@AppStorage` property declarations that don't exist in the actual code.

### üü¢ LOW ISSUES

**L1: Stale docstring in Comparison.swift**
- File: `Peach/Training/Comparison.swift:27-28`
- Comment says: *"Epic 6 will expose reference pitch configuration from Settings."*
- Epic 6 is now implemented. This is stale forward-reference documentation.

**L2: Stale docstring in NextNoteStrategy.swift**
- File: `Peach/Core/Algorithm/NextNoteStrategy.swift:46`
- TrainingSettings doc comment says: *"Epic 6 will create SettingsScreen to expose these via @AppStorage."*
- Epic 6 is now implemented. Same stale forward-reference.

---

What should I do with these issues?

1. **Fix them automatically** ‚Äî I'll update the code, add the missing test, and fix the docs
2. **Create action items** ‚Äî Add to story Tasks/Subtasks for later
3. **Show me details** ‚Äî Deep dive into specific issues

Choose [1], [2], or specify which issue to examine.

### üßë Human (22:20:38)

1

### ü§ñ Assistant (22:20:46)

I'll fix all HIGH and MEDIUM issues now, plus the LOW ones since they're quick. Let me start with the code fixes in parallel.

### ü§ñ Assistant (22:21:13)

Now fix the stale docstrings in Comparison.swift and NextNoteStrategy.swift.

### ü§ñ Assistant (22:21:26)

Now fix the Dev Notes documentation (M2). Let me read the current story file to get the exact text.

### ü§ñ Assistant (22:21:46)

Now let me also fix the "Key Code Changes" section that shows `@AppStorage` property declarations which don't match actual code.

### ü§ñ Assistant (22:22:02)

Now the critical fix ‚Äî add the missing test for mid-training real-time settings change (H1).

### ü§ñ Assistant (22:22:22)

All fixes applied. Now let me run the full test suite to verify everything passes.

### ü§ñ Assistant (22:28:27)

All **234 tests pass** (233 + 1 new mid-training test). Now let me update the story file ‚Äî File List and Completion Notes.

### ü§ñ Assistant (22:28:45)

Now update the story status to "done" since all issues are fixed.

### ü§ñ Assistant (22:28:49)

---

## Step 5: Update story status and sync sprint tracking

### ü§ñ Assistant (22:28:58)

Sprint status synced: `6-2-apply-settings-to-training-in-real-time` ‚Üí done

---

**Review Complete!**

**Story Status:** done
**Issues Fixed:** 5 (1 High, 2 Medium, 2 Low)
**Action Items Created:** 0

### Summary of fixes applied:

| # | Severity | Issue | Fix |
|---|----------|-------|-----|
| H1 | HIGH | No test for mid-training real-time settings change | Added `settingsChangedMidTrainingTakeEffect` test |
| M1 | MEDIUM | `currentNoteDuration` not cached per comparison | Added `let noteDuration = currentNoteDuration` at top of `playNextComparison()` |
| M2 | MEDIUM | Dev Notes claimed @AppStorage works in @Observable (it doesn't) | Corrected docs, code examples, and flow diagram to reflect actual UserDefaults approach |
| L1 | LOW | Stale "Epic 6 will..." docstring in Comparison.swift | Updated to present tense |
| L2 | LOW | Stale "Epic 6 will..." docstring in NextNoteStrategy.swift | Updated to present tense |

**All 234 tests pass** (227 existing + 7 new). Code review complete!

### üßë Human (22:34:22)

commit this

### ü§ñ Assistant (22:34:47)

Committed as `01ed969`. Working tree clean.

---

[‚Üê Previous (05e06c849a)](05e06c849a.md) | [Index](index.md) | [Next (91123423be) ‚Üí](91123423be.md)
