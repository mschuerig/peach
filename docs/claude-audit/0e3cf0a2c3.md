---
commit: "0e3cf0a2c307069d4936af518dc31b0fcd2e28d7"
date: "2026-02-26T21:22:33+01:00"
author: "Michael SchÃ¼rig <michael@schuerig.de>"
subject: "Implement story 19.1: Clamping utility and magic value constants"
sessions: ["52b58b05-46a2-4782-a775-9e635df192b6"]
prev: "6ae97ad451.md"
next: "f2ff6e6497.md"
---

[â† Previous (6ae97ad451)](6ae97ad451.md) | [Index](index.md) | [Next (f2ff6e6497) â†’](f2ff6e6497.md)

# Commit 0e3cf0a2c3

**Date:** 2026-02-26 21:22:33 UTC+01:00  
**Author:** Michael SchÃ¼rig <michael@schuerig.de>

## Commit message

Implement story 19.1: Clamping utility and magic value constants

Add Comparable.clamped(to:) extension to replace scattered min(max(...))
patterns. Replace all 7 inline clamping sites across 6 files. Add named
constants for amplitude dB range and initial cent offset range.

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>

## Changed files

```
Peach/Comparison/ComparisonSession.swift        |  6 ++--
 Peach/Core/Algorithm/AdaptiveNoteStrategy.swift | 14 +-------
 Peach/Core/Algorithm/KazezNoteStrategy.swift    |  3 +-
 Peach/Core/Audio/SoundFontNotePlayer.swift      |  4 +--
 Peach/Core/Comparable+Clamped.swift             |  5 +++
 Peach/PitchMatching/PitchMatchingSession.swift  |  8 ++---
 Peach/PitchMatching/VerticalPitchSlider.swift   |  2 +-
 Peach/Profile/ThresholdTimelineView.swift       |  4 +--
 PeachTests/Core/ComparableClampedTests.swift    | 43 +++++++++++++++++++++++++
 9 files changed, 63 insertions(+), 26 deletions(-)
```

## Session `52b58b05â€¦`

*2026-02-26 20:16:12 UTC â†’ 2026-02-26 20:22:56 UTC*

### ğŸ§‘ Human (20:16:12)

Implement the following plan:

# Epic 19: Code Review Refactoring

## Context

A code review of the app (non-test code) identified several systemic issues documented as `REVIEW:` comments across 10 files. The codebase works correctly but suffers from: naked primitive types where Value Objects would provide safety, overly long methods, magic values, direct UserDefaults access without encapsulation, and components knowing too much about each other. This epic addresses all findings as one story per theme.

## Stories

### Story 19.1: Clamping Utility and Magic Value Constants

**Problem:** At least 4 places use inline `min(max(...))` clamping. Magic values like `-100.0...100.0` (cent range) and `-90.0...12.0` (amplitude bounds) are scattered without names.

**Changes:**
- Add `Comparable.clamped(to:)` extension in `Peach/Core/` (replaces the local `clamp()` in `AdaptiveNoteStrategy.swift:308`)
- Replace all inline `min(max(...))` / `max(..., min(...))` patterns with `.clamped(to:)`
- Add named constants for:
  - Max initial cent offset range (`PitchMatchingSession.swift:165`)
  - Amplitude dB bounds (`ComparisonSession.swift:398-399`)

**Files:** `AdaptiveNoteStrategy.swift`, `KazezNoteStrategy.swift`, `ComparisonSession.swift`, `PitchMatchingSession.swift`, new `Comparable+Clamped.swift`

---

### Story 19.2: Value Objects for Domain Primitives

**Problem:** MIDI notes (Int), velocity (UInt8), cents (Double), frequency (Double), and amplitude (Float) are passed as naked primitives. Range violations are caught by scattered preconditions/guards or not at all.

**Changes:**
- **`MIDINote`** (rich): validated 0-127, provides `.name` (e.g. "A4"), `.frequency(referencePitch:)`, `Comparable`, `Hashable`, `Codable`. Lives in `Peach/Core/Audio/`
- **`MIDIVelocity`** (minimal): validated 1-127, `.rawValue: UInt8`
- **`Cents`** (minimal): signed Double wrapper, `.rawValue: Double`
- **`Frequency`** (minimal): must be positive, `.rawValue: Double`, validated against audible range
- **`AmplitudeDB`** (minimal): validated and clamped to -90...+12, `.rawValue: Float`
- Update `FrequencyCalculation` to accept/return Value Objects
- Update `NotePlayer` protocol signatures
- Update `Comparison`, `PitchMatchingChallenge`, `ComparisonRecord`, `PitchMatchingRecord`
- Update `PitchDiscriminationProfile`/`PitchMatchingProfile` protocol signatures
- Update `PerceptualProfile` implementation
- **Comparison redesign:** `centDifference` becomes signed `Cents`; `isSecondNoteHigher` becomes a computed property (`centDifference.rawValue > 0`); keep `note1`/`note2` as separate `MIDINote` fields
- Views that display these values access `.rawValue` for formatting

**Key files (25+):** `Comparison.swift`, `ComparisonSession.swift`, `PitchMatchingSession.swift`, `PitchMatchingChallenge.swift`, `FrequencyCalculation.swift`, `NotePlayer.swift`, `SoundFontNotePlayer.swift`, `PlaybackHandle.swift`, `SoundFontPlaybackHandle.swift`, `PerceptualProfile.swift`, `PitchDiscriminationProfile.swift`, `PitchMatchingProfile.swift`, `ComparisonRecord.swift`, `PitchMatchingRecord.swift`, `KazezNoteStrategy.swift`, `AdaptiveNoteStrategy.swift`, `NextComparisonStrategy.swift`, `SettingsKeys.swift`, `PianoKeyboardView.swift`, all test mocks

**Note:** `SF2Preset` already exists and is well-formed. Ensure `SoundFontNotePlayer` uses it consistently instead of raw `loadedProgram: Int, loadedBank: Int` fields (`SoundFontNotePlayer.swift:5` review comment).

---

### Story 19.3: UserSettings Wrapper for UserDefaults

**Problem:** `ComparisonSession`, `PitchMatchingSession`, and `SoundFontNotePlayer` access `UserDefaults.standard` directly with verbose `object(forKey:) as? T ?? default` casting. This couples business logic to a singleton and makes testing require `settingsOverride` workarounds.

**Changes:**
- Create `UserSettings` protocol + `AppUserSettings` implementation in `Peach/Settings/`
- `UserSettings` exposes typed properties: `noteRangeMin: MIDINote`, `noteRangeMax: MIDINote`, `noteDuration: TimeInterval`, `referencePitch: Double`, `soundSource: String`, `varyLoudness: Double`, `naturalVsMechanical: Double`
- `AppUserSettings` reads from `UserDefaults` internally, provides defaults from `SettingsKeys`
- Inject `UserSettings` as a dependency into `ComparisonSession`, `PitchMatchingSession`, and `SoundFontNotePlayer`
- Remove `settingsOverride`, `noteDurationOverride`, `varyLoudnessOverride` parameters â€” tests inject a `MockUserSettings` instead
- Wire `AppUserSettings` in `PeachApp.swift`
- `@AppStorage` in `SettingsScreen` continues to work (writes to same UserDefaults backing store)
- Create `MockUserSettings` for tests

**Files:** new `UserSettings.swift`, new `AppUserSettings.swift`, `ComparisonSession.swift`, `PitchMatchingSession.swift`, `SoundFontNotePlayer.swift`, `PeachApp.swift`, new `MockUserSettings.swift`, all test files that currently use `settingsOverride`

---

### Story 19.4: Extract Long Methods

**Problem:** Three methods have grown too long with comment-separated sections that should be their own methods.

**Changes:**
- **`PeachApp.init()`** (~70 lines): Extract into named methods like `createModelContainer()`, `loadPerceptualProfile(from:)`, `createComparisonSession(...)`, `createPitchMatchingSession(...)`
- **`ComparisonSession.handleAnswer()`** (~60 lines): Extract `stopNote2IfPlaying()`, `trackSessionBest(_:)`, `transitionToFeedback(_:)`
- **`ComparisonSession.playNextComparison()`** (~70 lines): Extract `calculateNote2Amplitude(varyLoudness:)`, `playComparisonNotes(comparison:settings:noteDuration:amplitudeDB:)`

**Files:** `PeachApp.swift`, `ComparisonSession.swift`

---

### Story 19.5: TrainingSession Protocol and Dependency Cleanup

**Problem:** `ContentView` knows about both concrete session types (feature envy). `VerticalPitchSlider` knows about cents and frequencies when it should only provide normalized input.

**Changes:**
- **TrainingSession protocol:** `stop()` method and `var isIdle: Bool` computed property. Both `ComparisonSession` and `PitchMatchingSession` conform.
- **Active session tracking in PeachApp:** PeachApp tracks the single active `TrainingSession?`. When a new session starts, the previous one is stopped. ContentView receives only `activeSession: TrainingSession?` for backgrounding â€” it calls `activeSession?.stop()` without knowing the concrete type.
- Implementation approach: PeachApp observes both sessions and updates the active session reference. The concrete session environment values remain for their respective screens.
- **VerticalPitchSlider normalization:** Slider API changes to accept/produce normalized values in -1.0...1.0. `PitchMatchingSession` does the centâ†”frequency conversion. Remove `centRange`, `referenceFrequency`, `onFrequencyChange`, `onRelease` from slider; replace with `onNormalizedValueChange: (Double) -> Void` and `onCommit: (Double) -> Void`.

**Files:** new `TrainingSession.swift`, `ComparisonSession.swift`, `PitchMatchingSession.swift`, `PeachApp.swift`, `ContentView.swift`, `VerticalPitchSlider.swift`, `PitchMatchingScreen.swift`

---

## Story Order and Dependencies

```
19.1 (clamping + constants)  â”€â”
                               â”œâ”€â”€â†’ 19.2 (value objects) â”€â”€â†’ 19.3 (UserSettings) â”€â”€â†’ 19.4 (extract methods)
                               â”‚                                                         â”‚
                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ 19.5 (protocols + slider)
```

- **19.1** first: small foundation, enables cleaner Value Object implementations
- **19.2** next: largest change, touches the most files; must stabilize before other refactoring
- **19.3** after VOs: UserSettings properties can use the new Value Object types
- **19.4** after UserSettings: extracted methods will use the new clean APIs
- **19.5** last: can be done after or in parallel with 19.4; most architectural

## Verification

After each story:
1. Run full test suite: `xcodebuild test -scheme Peach -destination 'platform=iOS Simulator,name=iPhone 17'`
2. All existing tests must pass (updated to use new types where needed)
3. New Value Object types get their own test files
4. `MockUserSettings` replaces all `settingsOverride` usage in tests

After the epic:
- All `REVIEW:` comments in the codebase are resolved and removed
- No direct `UserDefaults.standard` access outside `AppUserSettings`
- No `min(max(...))` clamping outside the `clamped(to:)` extension
- `ContentView` has no reference to concrete session types
- `VerticalPitchSlider` has no concept of cents or frequencies


If you need specific details from before exiting plan mode (like exact code snippets, error messages, or content you generated), read the full transcript at: /Users/michael/.claude/projects/-Users-michael-Projekte-peach/15408414-9ea2-4086-b956-8ecc1c3d856c.jsonl

### ğŸ¤– Assistant (20:16:16)

I'll start by reading the project context and memory files, then explore the relevant source files for Story 19.1.

### ğŸ¤– Assistant (20:16:20)

Let me explore the relevant files for Story 19.1 first.

### ğŸ¤– Assistant (20:17:06)

Excellent. I have a clear picture of the codebase. Let me create the task list for the full epic and start with Story 19.1.

### ğŸ¤– Assistant (20:17:21)

Now let me read the files I need to modify for Story 19.1.

### ğŸ¤– Assistant (20:17:27)

Now let me read the remaining files with clamping patterns and the existing test structure.

### ğŸ¤– Assistant (20:17:38)

Now I have everything needed. Let me implement Story 19.1. First, I'll create the clamping extension and its tests, then update all files.

### ğŸ¤– Assistant (20:17:43)

Now let me check where the existing test files are for Core and read the SettingsKeys file for the constants.

### ğŸ¤– Assistant (20:18:39)

Now let me apply all the changes. I'll do the independent edits in parallel.

### ğŸ¤– Assistant (20:18:48)

Those are SourceKit cross-file resolution issues, not real errors. Let me continue with the remaining edits.

### ğŸ¤– Assistant (20:19:12)

Let me check if `Comparable.clamped(to:)` already exists in Swift 6.2 â€” the SourceKit diagnostic suggests a conflict.

### ğŸ¤– Assistant (20:19:25)

Not in the Swift stdlib. The SourceKit diagnostic is a false positive. Let me continue with the remaining edits.

### ğŸ¤– Assistant (20:19:43)

All edits applied. Now I need to write a test for the clamping extension and then add the new file to the Xcode project. Let me first check if there's a project.pbxproj or if it uses automatic file discovery.

### ğŸ¤– Assistant (20:19:55)

Now let me run the full test suite to verify everything compiles and passes.

### ğŸ¤– Assistant (20:20:05)

The issue is that my `clamped(to:)` extension is implicitly `@MainActor` (project-wide default), but it's called from a `nonisolated static` method. I need to mark it `nonisolated`.

### ğŸ¤– Assistant (20:20:23)

The test target needs `@testable import`. Let me check how existing tests import the module.

### ğŸ¤– Assistant (20:22:18)

All tests pass. Let me verify the new clamped tests ran.

### ğŸ¤– Assistant (20:22:22)

All 6 clamped tests passed. Story 19.1 is complete. Let me commit and move on to Story 19.2.

### ğŸ¤– Assistant (20:22:39)

Now for **Story 19.2: Value Objects for domain primitives** â€” the largest change. Let me read all the files I need to understand first.

### ğŸ¤– Assistant (20:22:51)

Let me read more files needed for this story.

### ğŸ¤– Assistant (20:22:56)

Now let me find all test mocks and usages I'll need to update.

---

[â† Previous (6ae97ad451)](6ae97ad451.md) | [Index](index.md) | [Next (f2ff6e6497) â†’](f2ff6e6497.md)
