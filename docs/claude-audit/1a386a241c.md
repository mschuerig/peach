---
commit: "1a386a241c83db1944332cc21825b5f08deb0591"
date: "2026-02-22T13:18:56+01:00"
author: "Michael Sch√ºrig <michael@schuerig.de>"
subject: "Add adversarial review findings to future work"
sessions: ["559d91dd-f27d-4dc4-a085-4cc600988c7c"]
prev: "9d8d8ea9ce.md"
next: "684492ca77.md"
---

[‚Üê Previous (9d8d8ea9ce)](9d8d8ea9ce.md) | [Index](index.md) | [Next (684492ca77) ‚Üí](684492ca77.md)

# Commit 1a386a241c

**Date:** 2026-02-22 13:18:56 UTC+01:00  
**Author:** Michael Sch√ºrig <michael@schuerig.de>

## Commit message

Add adversarial review findings to future work

Document 16 findings from whole-project adversarial review covering
unsafe practices, separation of concerns, duplication, and other issues.

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>

## Changed files

```
docs/implementation-artifacts/future-work.md | 239 +++++++++++++++++++++++++++
 1 file changed, 239 insertions(+)
```

## Session `559d91dd‚Ä¶`

*2026-02-22 11:57:05 UTC ‚Üí 2026-02-22 12:19:00 UTC*

### üßë Human (11:57:05)

<command-message>bmad-review-adversarial-general</command-message>
<command-name>/bmad-review-adversarial-general</command-name>

### ü§ñ Assistant (11:57:07)

Let me read the task file first.

### ü§ñ Assistant (11:57:12)

I need content to review. No content has been provided yet.

**What would you like me to review?**

I can adversarially review any of the following:
- A **diff** or **branch** (e.g., a specific PR or set of uncommitted changes)
- A **document** in the project (spec, story, design doc, etc.)
- A **file or set of files** in the codebase
- Any other **artifact** you provide

Please specify the content to review, and optionally any areas you'd like me to pay special attention to.

### üßë Human (12:00:27)

I want you to do a whole-project review. Look especially for 
* unsafe practices
* unwanted dependencies
* separation of concerns
* duplication

### ü§ñ Assistant (12:00:31)

Let me start by understanding the project structure and then perform a thorough adversarial review across multiple dimensions.

### ü§ñ Assistant (12:04:31)

This is a Swift/iOS project. Let me find all the Swift source files and explore the codebase in depth.

### ü§ñ Assistant (12:04:41)

Now let me read all the key source files in parallel to perform a thorough review.

### ü§ñ Assistant (12:06:26)

Let me verify a few critical findings directly.

### ü§ñ Assistant (12:08:07)

Now I have everything I need. Here is the adversarial review.

---

## Adversarial Review ‚Äî Peach (Whole Project)

**Content type:** Full codebase (~3,400 LOC production Swift, ~5,500 LOC tests, 30 source files, 29 test files)

---

### Findings

1. **`fatalError()` in app initialization (`PeachApp.swift:57`) is a hard crash with no recovery.** If `ModelContainer`, `SineWaveNotePlayer`, or `dataStore.fetchAll()` fails at launch, the app dies instantly. No error UI, no retry, no graceful degradation. A corrupted SwiftData store or an audio entitlement issue on a fresh install = user sees nothing but a crash report.

2. **`precondition()` for MIDI note validation in `FrequencyCalculation.swift:60` is the wrong tool.** `precondition` is stripped under `-Ounchecked` optimization. More importantly, `AudioError.invalidFrequency` already exists as a typed error ‚Äî the validation should `guard`/`throw` instead of trapping. A bad MIDI note from a corrupt `ComparisonRecord` would crash the app in debug and silently pass in some release configurations.

3. **Three environment keys use `nonisolated(unsafe)` with `MainActor.assumeIsolated()` ‚Äî a pattern that bypasses actor isolation.** Found in `TrainingScreen.swift:152`, `ProfileScreen.swift:149`, and `TrendAnalyzer.swift:93`. This tells the compiler "trust me" about actor isolation. If an `EnvironmentKey.defaultValue` is ever accessed off the main thread (e.g., during SwiftUI's internal diffing on a background queue), it's undefined behavior. The project's own rules demand strict concurrency ‚Äî this contradicts that.

4. **`MockHapticFeedbackManager` ships in the production binary** (`HapticFeedbackManager.swift:65-86`). This `@MainActor final class` with test tracking (`incorrectFeedbackCount`, `reset()`) lives in the main Peach target, not `PeachTests`. It's used by preview mocks in `TrainingScreen.swift:158`. Test infrastructure has no business in a shipping app.

5. **`SettingsScreen` directly instantiates `TrainingDataStore` and orchestrates a 3-service reset** (`SettingsScreen.swift:123-135`). The view creates `TrainingDataStore(modelContext:)` on line 125, then calls `dataStore.deleteAll()`, `profile.reset()`, and `trendAnalyzer.reset()` in sequence. This violates two of the project's own hard rules: *"All service instantiation happens in PeachApp.swift"* and *"Views contain zero business logic."* This is an orchestration operation disguised as a button action.

6. **`ComparisonRecordStoring` protocol is incomplete ‚Äî the abstraction leaks.** The protocol defines only `save()` and `fetchAll()` (`ComparisonRecordStoring.swift:8-17`), but `TrainingDataStore` also exposes `delete(_:)` and `deleteAll()`. `SettingsScreen` calls `deleteAll()` directly on the concrete type, bypassing the protocol entirely. The protocol creates a false sense of decoupling when real callers need methods it doesn't declare.

7. **Kazez formula coefficients differ between strategies with no documented rationale.** `KazezNoteStrategy.swift:82` uses `0.05` for narrowing; `AdaptiveNoteStrategy.swift:216` uses `0.08`. Both cite Kazez et al. (2001). Either one is wrong, or they're intentionally different tuning choices ‚Äî but neither documents why. This is the kind of silent algorithmic divergence that causes subtle training behavior differences nobody can explain later.

8. **`TrainingSession.runTrainingLoop()` uses a 100ms spin-wait polling loop** (`TrainingSession.swift:318-321`). The entire training flow is event-driven (play note ‚Üí await answer ‚Üí show feedback ‚Üí next comparison), yet the loop busy-waits with `Task.sleep(for: .milliseconds(100))` to detect state changes. This is architecturally inconsistent and unnecessarily burns CPU. The `Task` could simply `await` on the event-driven chain and exit when cancelled.

9. **Fire-and-forget `Task`s in `TrainingSession` are untracked and could outlive their context.** Three locations spawn tasks without storing references: `stop()` at line 286 (`notePlayer.stop()`), `handleAnswer()` at line 239 (stopping note2 early), and `HapticFeedbackManager.playIncorrectFeedback()` at line 41 (second haptic impact). If the session is stopped and deallocated quickly, these orphan tasks may reference dead objects or execute after cleanup.

10. **`ContentView.previousScenePhase` is dead code.** Declared at line 15, written at line 37, but never read anywhere. It's tracking state for no purpose.

11. **`makeTrainingSession()` test fixture is duplicated across 6 test files** with near-identical signatures and body: `TrainingSessionTests`, `TrainingSessionIntegrationTests`, `TrainingSessionLifecycleTests`, `TrainingSessionSettingsTests`, `TrainingSessionAudioInterruptionTests`, and `TrainingSessionUserDefaultsTests`. The shared `TrainingTestHelpers.swift` file exists but doesn't include this factory. Six copies of the same fixture means six places to update when `TrainingSession`'s initializer changes.

12. **`nonisolated(unsafe)` environment key boilerplate is copy-pasted 3 times.** The identical 8-line pattern (`nonisolated(unsafe) static var defaultValue = { ... MainActor.assumeIsolated { ... } }()`) appears in `TrainingScreen.swift`, `ProfileScreen.swift`, and `TrendAnalyzer.swift`. This is both duplication and an unsafe pattern ‚Äî a generic helper or macro would eliminate both problems.

13. **Preview mock classes are defined inside `TrainingScreen.swift`** (lines 182-199). `MockNotePlayerForPreview` and `MockDataStoreForPreview` are private but still compiled into the production app. Combined with finding #4, the app ships with at least 3 mock classes in the binary. These should be behind `#if DEBUG` guards or moved to the test target with a separate preview scheme.

14. **`KazezNoteStrategy` ignores user-configured note range** (`KazezNoteStrategy.swift:35-36`). Hardcoded to C3-C5 (MIDI 48-72) while `TrainingSettings.noteRangeMin/Max` defaults to C2-C6 (36-84). The `settings` parameter is passed to `nextComparison()` but the range is never used. If a user narrows their range in Settings, `KazezNoteStrategy` will still select notes outside it.

15. **`hasTrainingData` check is duplicated across views.** Both `ProfileScreen.swift:86` and `ProfilePreviewView.swift:27` independently check `profile.overallMean != nil` to determine if training data exists. This semantic question ("has the user trained?") should be a single computed property on `PerceptualProfile`, not duplicated knowledge in two views.

16. **`ComparisonRecord` stores `note1` and `note2` redundantly.** Per the code and project-context (`note2 = same MIDI note as note1`), both notes are always identical. The model stores two `Int` fields for one value. Every record written to SwiftData carries this redundancy, and the domain rule that note1 == note2 is enforced by convention rather than by the data model. If they ever diverge, nothing validates or catches it.

### üßë Human (12:13:32)

Great. Document these findings for future work. docs/implementation-artifacts/future-work.md might be a good place.

### ü§ñ Assistant (12:13:36)

Let me read the existing future-work file first.

### ü§ñ Assistant (12:13:46)

Now I'll add the adversarial review findings to this document. Let me cross-reference with existing items to avoid duplication.

### ü§ñ Assistant (12:15:19)

Findings documented. Added 16 new items to `docs/implementation-artifacts/future-work.md` under "Adversarial Review Findings (2026-02-22)", organized into four sections:

- **Unsafe Practices (U1-U5):** `fatalError` on init, `precondition` instead of throwing, `nonisolated(unsafe)` environment keys, untracked fire-and-forget Tasks, polling loop
- **Separation of Concerns (S1-S3):** Mock classes in production binary, SettingsScreen orchestrating business logic and creating services, incomplete protocol abstraction
- **Duplication (D1-D4):** Test fixture factory copied 6 times, environment key boilerplate repeated 3 times, undocumented Kazez coefficient divergence, `hasTrainingData` check duplicated across views
- **Other (O1-O3):** Dead code in ContentView, KazezNoteStrategy ignoring settings, redundant ComparisonRecord fields

Cross-referenced existing items where applicable to avoid duplication with prior entries.

### üßë Human (12:18:42)

ok. commit these changes.

### ü§ñ Assistant (12:19:00)

Committed as `1a386a2`. One file changed, 239 insertions ‚Äî 16 findings documented across 4 categories.

---

[‚Üê Previous (9d8d8ea9ce)](9d8d8ea9ce.md) | [Index](index.md) | [Next (684492ca77) ‚Üí](684492ca77.md)
