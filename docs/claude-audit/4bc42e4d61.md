---
commit: "4bc42e4d618133b912fd2546efdc52d477a9b7f0"
date: "2026-02-23T00:46:55+01:00"
author: "Michael Sch√ºrig <michael@schuerig.de>"
subject: "Fix code review findings for hotfix-tune-kazez-convergence"
sessions: ["34787df9-c053-496a-996f-1ddaaca90836"]
prev: "f1e596a6c8.md"
next: "bb6c28a637.md"
---

[‚Üê Previous (f1e596a6c8)](f1e596a6c8.md) | [Index](index.md) | [Next (bb6c28a637) ‚Üí](bb6c28a637.md)

# Commit 4bc42e4d61

**Date:** 2026-02-23 00:46:55 UTC+01:00  
**Author:** Michael Sch√ºrig <michael@schuerig.de>

## Commit message

Fix code review findings for hotfix-tune-kazez-convergence

Extract magic number Kazez coefficients (0.08, 0.09) to named constants
in DifficultyParameters. Mark story as done.

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>

## Changed files

```
Peach/Core/Algorithm/AdaptiveNoteStrategy.swift         | 17 +++++++++++++----
 .../hotfix-tune-kazez-convergence.md                    |  2 +-
 docs/implementation-artifacts/sprint-status.yaml        |  2 +-
 3 files changed, 15 insertions(+), 6 deletions(-)
```

## Session `34787df9‚Ä¶`

*2026-02-22 23:24:24 UTC ‚Üí 2026-02-22 23:47:03 UTC*

### üßë Human (23:24:24)

<command-message>bmad-help</command-message>
<command-name>/bmad-help</command-name>

### ü§ñ Assistant (23:24:33)

Now let me scan for module configs and project knowledge.

### ü§ñ Assistant (23:24:40)

Now let me check what planning/implementation artifacts exist to determine your current progress.

### ü§ñ Assistant (23:25:28)

Here's where you stand and what comes next.

---

## Current State

**Project:** Peach | **Module:** bmm | **Phase:** 4-implementation

- **Epics 1-4, 7:** Done
- **Epics 5 & 6:** All stories done, but epics still marked `in-progress` (can be closed)
- **Sprint 2026-02-22 bug fixes:** All done
- **`hotfix-tune-kazez-convergence`:** In **review** status ‚Äî awaiting code review
- **`hotfix-profile-band-segmentation`:** In **backlog** ‚Äî not yet started

---

## Recommended Next Steps

### 1. Code Review for `hotfix-tune-kazez-convergence` (in review)

`/bmad-bmm-code-review`
**Agent:** Amelia, üíª Developer Agent
**Description:** Review the Kazez convergence tuning hotfix. If issues are found, route back to Dev Story; if approved, mark done.
**Tip:** Run this in a **fresh context window**, ideally with a different high-quality LLM for independence.

### 2. Create Story for `hotfix-profile-band-segmentation` (backlog)

`/bmad-bmm-create-story`
**Agent:** Bob, üèÉ Scrum Master
**Description:** Prepare the story for the profile band segmentation fix (confidence band draws across untrained gaps). This kicks off the next story cycle: CS -> VS -> DS -> CR.

### 3. Sprint Status (optional, anytime)

`/bmad-bmm-sprint-status`
**Agent:** Bob, üèÉ Scrum Master
**Description:** Summarize sprint status and route to next workflow. Useful for closing out epics 5 & 6 since all their stories are done.

### 4. Retrospectives (optional)

`/bmad-bmm-retrospective`
**Agent:** Bob, üèÉ Scrum Master
**Description:** Review completed work and lessons learned. You have optional retrospectives pending for epics 1-7.

---

## Beyond the Current Sprint

Your `future-work.md` has a substantial backlog including high-priority items like onboarding, profile graph redesign, and safety fixes (fatalError, precondition). When you're ready to tackle those, you'd use:

- **Correct Course** (`/bmad-bmm-correct-course`) if changes require updating the PRD, architecture, or epics
- **Sprint Planning** (`/bmad-bmm-sprint-planning`) to plan a new sprint from future work items

**Recommendation:** Start with the **Code Review** for the Kazez hotfix since it's already in review status.

### üßë Human (23:37:22)

<command-message>bmad-bmm-code-review</command-message>
<command-name>/bmad-bmm-code-review</command-name>
<command-args>hotfix-tune-kazez-convergence</command-args>

### ü§ñ Assistant (23:37:46)

Now I have the full workflow engine and configuration loaded. Let me execute the code review workflow.

**Resolved variables:**
- user_name: Michael
- communication_language: English
- user_skill_level: intermediate
- date: 2026-02-23
- planning_artifacts: `docs/planning-artifacts`
- implementation_artifacts: `docs/implementation-artifacts`
- sprint_status: `docs/implementation-artifacts/sprint-status.yaml`
- template: false (action-workflow, no template output)

---

## Step 1: Load Story and Discover Changes

Let me load the story file and check git reality.

### ü§ñ Assistant (23:37:53)

Git working tree is clean ‚Äî all changes are committed. Let me find the commits related to this hotfix and load the actual implementation files.

### ü§ñ Assistant (23:38:02)

Let me find the test files that contain the tests referenced in the story, and also load the project context and input file patterns.

### ü§ñ Assistant (23:38:12)

Now I have the story, both implementation files, both test files, git status, architecture, and project context. Let me also check the epics file for this hotfix context and verify the git commit for this story.

### ü§ñ Assistant (23:38:17)

Good. The commit `a00f6da` matches the story's File List exactly. Now let me also verify that subsequent commits didn't modify the same files (checking for conflicts or regressions).

### ü§ñ Assistant (23:41:21)

Good. I have everything loaded. Let me now execute the adversarial code review.

---

## Step 2: Review Attack Plan

**Story:** `hotfix-tune-kazez-convergence`
**Story Key:** `hotfix-tune-kazez-convergence`
**Status:** review

**Acceptance Criteria to validate:**
1. AC1: Correct-answer coefficient = `0.08`: `N = P √ó [1 - (0.08 √ó ‚àöP)]`
2. AC2: Neighbor filter requires `currentDifficulty != defaultDifficulty`
3. AC3: 5 correct from 100 cents ‚Üí below 10 cents (100 ‚Üí 20 ‚Üí 12.8 ‚Üí 9.1 ‚Üí 6.9 ‚Üí 5.5)
4. AC4: Full test suite passes, zero regressions
5. AC5: Incorrect-answer coefficient unchanged at `0.09`

**Tasks to audit (all marked [x]):**
1. Coefficient 0.05 ‚Üí 0.08
2. Filter unrefined neighbors in both left/right loops
3. Update tests for new coefficient
4. Run full test suite

**Review plan:** AC validation ‚Üí Task audit ‚Üí Code quality deep dive ‚Üí Test quality

---

## Step 3: Adversarial Review Execution

### Git vs Story File List

**Commit `a00f6da`** changed:
- `Peach/Core/Algorithm/AdaptiveNoteStrategy.swift` ‚úì matches
- `PeachTests/Core/Algorithm/AdaptiveNoteStrategyTests.swift` ‚úì matches
- `docs/implementation-artifacts/future-work.md` ‚úì matches
- `docs/implementation-artifacts/hotfix-tune-kazez-convergence.md` ‚úì matches
- `docs/implementation-artifacts/sprint-status.yaml` ‚úì matches

**Git discrepancies:** 0

### AC Validation

**AC1 ‚Äî Coefficient 0.08:** `AdaptiveNoteStrategy.swift:216` ‚Äî `? max(p * (1.0 - 0.08 * p.squareRoot()),` ‚Äî **IMPLEMENTED** ‚úì
Doc comment at line 181 updated: `N = P √ó [1 - (0.08 √ó ‚àöP)]` ‚úì
Test: `regionalDifficultyNarrowsOnCorrect` expects `abs(comp2.centDifference - 20.0) < 0.01` ‚úì

**AC2 ‚Äî Neighbor filtering:** Left loop (lines 258-259) and right loop (lines 271-272) both have `&& stats.currentDifficulty != DifficultyParameters.defaultDifficulty` ‚Äî **IMPLEMENTED** ‚úì

**AC3 ‚Äî 5-step convergence path:**
Manual verification: 100 ‚Üí 20.0 ‚Üí 12.84 ‚Üí 9.16 ‚Üí 6.94 ‚Üí 5.48. Reaches below 10 cents after step 3 (9.16). ‚úì Math confirmed.
However, **no test validates this specific 5-step claim** ‚Äî see findings.

**AC4 ‚Äî Full test suite:** Story reports 172 tests passing. Git tree was clean at commit. **CLAIMED** ‚úì

**AC5 ‚Äî Incorrect coefficient unchanged:** `AdaptiveNoteStrategy.swift:218` ‚Äî `min(p * (1.0 + 0.09 * p.squareRoot()),` ‚Äî **IMPLEMENTED** ‚úì
Test: `regionalDifficultyWidensOnIncorrect` validates expected widening with 0.09 ‚úì

### Task Audit

All 4 tasks marked `[x]` verified against implementation:
- Task 1: Coefficient change confirmed at line 216, doc comment updated at line 181 ‚úì
- Task 2: Both left (258-259) and right (271-272) loops have the guard ‚úì
- Task 3: `regionalDifficultyNarrowsOnCorrect` and `difficultyNarrowsAcrossJumps` updated to 20.0 ‚úì
- Task 4: Test suite passed per completion notes ‚úì

### Code Quality Deep Dive

Now presenting findings.

---

## Step 4: Findings

**CODE REVIEW FINDINGS, Michael!**

**Story:** `hotfix-tune-kazez-convergence.md`
**Git vs Story Discrepancies:** 0
**Issues Found:** 0 High, 3 Medium, 3 Low

---

### MEDIUM Issues

**M1: Dev Notes claim consistency that doesn't exist**
**File:** `docs/implementation-artifacts/hotfix-tune-kazez-convergence.md:99`

The Dev Notes state: *"The current-note check at line 246-247 already has this dual condition. This change makes the neighbor loops consistent."*

But the current-note check (line 247-248) uses **OR** (`||`):
```swift
if currentStats.sampleCount > 0
    || currentStats.currentDifficulty != DifficultyParameters.defaultDifficulty {
```

While the neighbor loops use **AND** (`&&`):
```swift
if stats.sampleCount > 0
    && stats.currentDifficulty != DifficultyParameters.defaultDifficulty {
```

These are **opposite** operators ‚Äî the claim of consistency is wrong. The behavioral choice is arguably correct (OR is more permissive for the target note, AND is more restrictive for neighbors), but the documentation is misleading.

---

**M2: AC3's specific convergence path has no dedicated test**
**File:** `PeachTests/Core/Algorithm/AdaptiveNoteStrategyRegionalTests.swift`

AC3 specifies: *"Given a single note trained from 100 cents with 5 consecutive correct answers [...] difficulty reaches below 10 cents: 100 ‚Üí 20 ‚Üí 12.8 ‚Üí 9.1 ‚Üí 6.9 ‚Üí 5.5"*

The only convergence test (`kazezConvergenceFromDefault`, line 89) runs **10** iterations and asserts `< 10.0`. It doesn't validate:
- The 5-step convergence claim
- Any of the specific intermediate values (20.0, 12.8, 9.1, 6.9, 5.5)

The math checks out manually, but there's no regression guard on the specific step-by-step behavior AC3 defines.

---

**M3: Kazez coefficients are magic numbers**
**File:** `Peach/Core/Algorithm/AdaptiveNoteStrategy.swift:216, 218`

The `DifficultyParameters` enum extracts `regionalRange`, `defaultDifficulty`, and `maxNeighbors` as named constants. But the Kazez coefficients `0.08` (correct narrowing) and `0.09` (incorrect widening) are bare literals embedded in the formula:

```swift
? max(p * (1.0 - 0.08 * p.squareRoot()),
: min(p * (1.0 + 0.09 * p.squareRoot()),
```

These are the most tuned, most discussed parameters in the entire algorithm (multiple hotfixes to get them right), yet they have no named constants. They should live in `DifficultyParameters` as e.g. `correctNarrowingCoefficient` and `incorrectWideningCoefficient`.

---

### LOW Issues

**L1: Neighbor filter has an edge case at exact default difficulty**
**File:** `Peach/Core/Algorithm/AdaptiveNoteStrategy.swift:258-259, 271-272`

If a note's `currentDifficulty` equals `defaultDifficulty` (100.0) after legitimate Kazez refinement ‚Äî e.g., an incorrect answer from 100 cents clamped to `maxCentDifference` of 100 ‚Äî the note is excluded from neighbor calculations despite having real training data.

In practice this is near-impossible with chain-based convergence (the chain moves away from 100 quickly). But the semantic equivalence of "untrained default" and "trained-but-clamped-to-max" is a design gap.

---

**L2: Test setup noise in `weightedDifficultyKernelNarrowing`**
**File:** `PeachTests/Core/Algorithm/AdaptiveNoteStrategyRegionalTests.swift:227-232`

The test sets up notes 0-51 and 61-127 with `profile.update()` but no `setDifficulty()`. These notes are **already excluded by the range constraint** (`noteRangeMin: 52, noteRangeMax: 60`), making the `update()` calls dead setup code that doesn't affect the test result. This noise makes the test harder to reason about.

---

**L3: Inconsistent floating-point comparison pattern**
**File:** `PeachTests/Core/Algorithm/AdaptiveNoteStrategyRegionalTests.swift:24, 84`

Tests use ad-hoc `abs(x - y) < 0.01` for approximate equality. While functional, this tolerance threshold is:
- Not documented (why 0.01? Is 0.001 too tight?)
- Not extracted to a shared test helper

Other tests in the same file use exact `==` comparison. The inconsistency makes it unclear which tests need approximate comparison and which are exact by design.

---

What should I do with these issues?

1. **Fix them automatically** - I'll update the code and tests
2. **Create action items** - Add to story Tasks/Subtasks for later
3. **Show me details** - Deep dive into specific issues

Choose [1], [2], or specify which issue to examine:

### üßë Human (23:41:21)

In practice, the hotfix worked out very well.

### ü§ñ Assistant (23:41:31)

Good to hear. Given there are no HIGH or CRITICAL issues, and the algorithm convergence is validated both mathematically and in practice, this is a clean hotfix.

Do you want to:

1. **Mark it done as-is** ‚Äî close the story, sync sprint status
2. **Create action items** ‚Äî add M1-M3 as future low-priority tech debt in the story
3. **Fix M3 only** ‚Äî extract the magic number coefficients to named constants (the most impactful improvement, small change)

### üßë Human (23:42:13)

3

### ü§ñ Assistant (23:42:45)

Those diagnostics are just SourceKit noise (cross-file type resolution). Now update the formula to use the named constants.

### ü§ñ Assistant (23:42:51)

Now let me run the full test suite to verify no regressions.

### ü§ñ Assistant (23:45:55)

**309 tests passed, 0 failed.** All green.

---

## Step 5: Update Story Status and Sync Sprint Tracking

Now marking the story as done and syncing sprint status.

### ü§ñ Assistant (23:46:12)

Sprint status synced: `hotfix-tune-kazez-convergence` ‚Üí done

---

**Review Complete!**

**Story Status:** done
**Issues Fixed:** 1 (M3 ‚Äî extracted magic number coefficients to named constants)
**Action Items Created:** 0

Changes made:
- `AdaptiveNoteStrategy.swift` ‚Äî added `correctNarrowingCoefficient` (0.08) and `incorrectWideningCoefficient` (0.09) to `DifficultyParameters`, replaced inline literals, updated doc comment
- `hotfix-tune-kazez-convergence.md` ‚Äî status ‚Üí done
- `sprint-status.yaml` ‚Äî synced to done

309 tests passing, zero regressions.

### üßë Human (23:46:45)

commit this

### ü§ñ Assistant (23:47:03)

Committed as `4bc42e4`. Working tree clean.

---

[‚Üê Previous (f1e596a6c8)](f1e596a6c8.md) | [Index](index.md) | [Next (bb6c28a637) ‚Üí](bb6c28a637.md)
