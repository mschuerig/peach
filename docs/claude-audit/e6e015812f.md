---
commit: "e6e015812f05e7b1165bb274b9cae9351d1626eb"
date: "2026-03-01T01:40:00+01:00"
author: "Michael SchÃ¼rig <michael@schuerig.de>"
subject: "Implement story 23.1: Data Model and Value Type Updates for Interval Context"
sessions: ["138b8fb1-26c5-4036-ae1a-7c316a583901", "fd5d7415-0285-43c7-adf2-e70c887d60b5"]
prev: "6cb70bc10c.md"
next: "d7ccc07ef5.md"
---

[â† Previous (6cb70bc10c)](6cb70bc10c.md) | [Index](index.md) | [Next (d7ccc07ef5) â†’](d7ccc07ef5.md)

# Commit e6e015812f

**Date:** 2026-03-01 01:40:00 UTC+01:00  
**Author:** Michael SchÃ¼rig <michael@schuerig.de>

## Commit message

Implement story 23.1: Data Model and Value Type Updates for Interval Context

Add interval and tuningSystem fields to ComparisonRecord, PitchMatchingRecord,
CompletedComparison, CompletedPitchMatching, and PitchMatchingChallenge to
support interval training data integrity. Add TuningSystem storageIdentifier
for SwiftData persistence. Update TrainingDataStore observers, all production
call sites (using unison defaults), and all test fixtures. Confirm Comparison
shape is already correct for interval training.

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>

## Changed files

```
Peach/Comparison/ComparisonSession.swift           |   2 +-
 Peach/Core/Audio/TuningSystem.swift                |  15 +++
 Peach/Core/Data/ComparisonRecord.swift             |  17 +--
 Peach/Core/Data/PitchMatchingRecord.swift          |   8 +-
 Peach/Core/Data/TrainingDataStore.swift            |   7 ++
 Peach/Core/Training/Comparison.swift               |   4 +-
 Peach/Core/Training/CompletedPitchMatching.swift   |   6 +-
 Peach/PitchMatching/PitchMatchingChallenge.swift   |   1 +
 Peach/PitchMatching/PitchMatchingSession.swift     |   6 +-
 Peach/Profile/ProfileScreen.swift                  |   4 +
 Peach/Profile/SummaryStatisticsView.swift          |   2 +
 Peach/Profile/ThresholdTimelineView.swift          |   2 +
 Peach/Start/ProfilePreviewView.swift               |   2 +
 .../ComparisonSessionIntegrationTests.swift        |   6 +-
 .../Comparison/ComparisonSessionResetTests.swift   |   8 +-
 PeachTests/Comparison/MockTrainingDataStore.swift  |   7 ++
 .../Core/Algorithm/KazezNoteStrategyTests.swift    |   6 +-
 .../Core/Data/PitchMatchingRecordTests.swift       |  24 +++-
 .../Core/Data/TrainingDataStoreEdgeCaseTests.swift |  18 +--
 PeachTests/Core/Data/TrainingDataStoreTests.swift  |  52 +++++---
 .../Core/Profile/PitchMatchingProfileTests.swift   |   2 +-
 .../Core/Profile/ThresholdTimelineTests.swift      |  12 +-
 PeachTests/Core/Training/ComparisonTests.swift     |   7 +-
 PeachTests/Profile/ProfileScreenLayoutTests.swift  |   2 +
 PeachTests/Profile/TrendAnalyzerTests.swift        |   3 +
 PeachTests/Settings/SettingsTests.swift            |  17 ++-
 PeachTests/Start/ProfilePreviewViewTests.swift     |   2 +
 ...-and-value-type-updates-for-interval-context.md | 133 ++++++++++++++-------
 docs/implementation-artifacts/sprint-status.yaml   |   2 +-
 29 files changed, 276 insertions(+), 101 deletions(-)
```

## Session 1 (`138b8fb1â€¦`)

*2026-03-01 00:40:34 UTC â†’ 2026-03-01 00:40:53 UTC*

### ğŸ§‘ Human (00:40:34)

<command-message>bmad-bmm-code-review</command-message>
<command-name>/bmad-bmm-code-review</command-name>
<command-args>23.1</command-args>

### ğŸ¤– Assistant (00:40:53)

Now I'll execute the code review workflow for story 23.1. Let me start with **Step 1: Load story and discover changes**.

## Session 2 (`fd5d7415â€¦`)

*2026-03-01 00:27:24 UTC â†’ 2026-03-01 00:40:21 UTC*

### ğŸ§‘ Human (00:27:24)

<command-message>bmad-bmm-dev-story</command-message>
<command-name>/bmad-bmm-dev-story</command-name>
<command-args>23.1</command-args>

### ğŸ¤– Assistant (00:27:32)

Now I need to load the config source and instructions. Let me read those files.

### ğŸ¤– Assistant (00:27:43)

Now I'll execute **Step 1: Find next ready story and load it**. The argument "23.1" suggests story 23.1. Let me locate the story file and load the sprint status.

### ğŸ¤– Assistant (00:27:47)

Found story 23-1. Let me load the complete story file and the project context.

### ğŸ¤– Assistant (00:28:05)

**Step 2: Context loaded.** Project context and story Dev Notes fully parsed.

**Step 3: Fresh implementation** â€” no Senior Developer Review section found.

ğŸš€ **Starting Fresh Implementation**

- **Story:** 23-1-data-model-and-value-type-updates-for-interval-context
- **Story Status:** ready-for-dev
- **First incomplete task:** Task 1 â€” Add `interval` and `tuningSystem` to `ComparisonRecord`

**Step 4:** Marking story as in-progress in sprint-status.yaml.

### ğŸ¤– Assistant (00:28:13)

ğŸš€ Starting work on story 23-1. Status updated: ready-for-dev â†’ in-progress

Now let me read all the source files referenced in the Dev Notes before starting implementation.

### ğŸ¤– Assistant (00:28:21)

Now let me read the session files and existing tests to understand call sites.

### ğŸ¤– Assistant (00:28:30)

Now let me read the existing test files and mock that need updating.

### ğŸ¤– Assistant (00:28:35)

Let me also read the session files where call sites need updating.

### ğŸ¤– Assistant (00:28:41)

I now have a thorough understanding of all source files and call sites. Let me create task tracking and begin implementation.

### ğŸ¤– Assistant (00:28:59)

Now I'll begin **Step 5: Implementation** following TDD. Let me start with Task 1.

### ğŸ¤– Assistant (00:29:02)

## Task 1: Add `interval` and `tuningSystem` to `ComparisonRecord`

First, I need to add `TuningSystem` storage identifiers. Let me read TuningSystem.swift again and add the extension.

### ğŸ¤– Assistant (00:29:08)

Now add `interval` and `tuningSystem` to `ComparisonRecord`:

### ğŸ¤– Assistant (00:29:18)

The SourceKit diagnostics are pre-existing cross-file resolution issues, not actual build errors. Let me now write failing tests for ComparisonRecord with the new fields. Let me check for existing ComparisonRecord tests.

### ğŸ¤– Assistant (00:29:30)

Now let me write tests for the new ComparisonRecord fields. I'll add them to the existing TrainingDataStoreTests since that's where ComparisonRecord tests live.

### ğŸ¤– Assistant (00:29:43)

Now I need to update all existing `ComparisonRecord(` call sites with the new `interval` and `tuningSystem` parameters. Since Tasks 1-8 are tightly coupled (adding parameters that break all call sites), I'll implement the type changes in order and then update all call sites systematically.

Let me continue with **Task 2**: Add fields to `PitchMatchingRecord`.

### ğŸ¤– Assistant (00:29:56)

## Task 3: Add `tuningSystem` to `CompletedComparison`

Per the Dev Notes, `CompletedComparison` does NOT need a separate `interval` field â€” interval will be derived in `TrainingDataStore` when constructing the record.

### ğŸ¤– Assistant (00:30:06)

## Task 4: Add `targetNote` to `PitchMatchingChallenge`

### ğŸ¤– Assistant (00:30:13)

## Task 5: Add `targetNote` and `tuningSystem` to `CompletedPitchMatching`

### ğŸ¤– Assistant (00:30:22)

## Task 6: Update `TrainingDataStore` observer conformances

Now update `ComparisonObserver` to map `interval` and `tuningSystem`, and `PitchMatchingObserver` to map `targetNote`, `interval`, and `tuningSystem`.

### ğŸ¤– Assistant (00:30:37)

## Task 7: Update all call sites

Now update `ComparisonSession` where it creates `CompletedComparison`:

### ğŸ¤– Assistant (00:30:44)

Now update `PitchMatchingSession` â€” both `PitchMatchingChallenge` creation and `CompletedPitchMatching` creation:

### ğŸ¤– Assistant (00:30:53)

Now I need to update the SwiftUI preview call sites that create `ComparisonRecord` instances. Let me also check for any view call sites that create records.

### ğŸ¤– Assistant (00:31:01)

Now I need to update all the view preview `ComparisonRecord` call sites with the new `interval` and `tuningSystem` parameters. For all existing unison previews: `interval: 0, tuningSystem: "equalTemperament"`.

### ğŸ¤– Assistant (00:31:28)

## Task 8: Update mocks and test fixtures

Now I need to update the `MockTrainingDataStore` and all test files. Let me update the mock first, then systematically update all test call sites.

### ğŸ¤– Assistant (00:31:40)

Now let me update all the test files. I'll use an agent to handle the large number of test file updates in parallel with my work on the remaining test files.

### ğŸ¤– Assistant (00:31:46)

Now let me update all the test files systematically. I'll handle the `ComparisonRecord` call sites first â€” there are many. I'll add `interval: 0, tuningSystem: "equalTemperament"` to all of them.

### ğŸ¤– Assistant (00:32:03)

Now update the fractional cent precision test:

### ğŸ¤– Assistant (00:32:08)

Now update `TrainingDataStoreTests.swift` â€” many `ComparisonRecord` and `PitchMatchingRecord` call sites:

### ğŸ¤– Assistant (00:32:31)

Now update the persistence test:

### ğŸ¤– Assistant (00:32:36)

Now update the `PitchMatchingRecord` call sites in TrainingDataStoreTests and the observer test:

### ğŸ¤– Assistant (00:32:48)

Now update the deleteAll test and the observer tests:

### ğŸ¤– Assistant (00:32:54)

Now update the PitchMatchingObserver tests:

### ğŸ¤– Assistant (00:33:06)

Now update the pitch matching atomic write test:

### ğŸ¤– Assistant (00:33:12)

Now update `PitchMatchingRecordTests.swift`:

### ğŸ¤– Assistant (00:33:35)

Now let me update the `CompletedComparison` call sites in test files. Let me update all test files that create `CompletedComparison`:

### ğŸ¤– Assistant (00:33:45)

Now update the remaining test files with `CompletedComparison` calls. Let me read and update them.

### ğŸ¤– Assistant (00:33:57)

Now update the `ComparisonRecord` call sites in ThresholdTimelineTests:

### ğŸ¤– Assistant (00:34:11)

Now let me find and update the remaining ComparisonRecord calls in ThresholdTimelineTests:

### ğŸ¤– Assistant (00:34:22)

Now update the remaining test files. Let me handle them in parallel:

### ğŸ¤– Assistant (00:34:42)

Now let me also update the TrendAnalyzerTests ComparisonRecord helper and the ProfilePreviewViewTests helper:

### ğŸ¤– Assistant (00:34:59)

Now update the ComparisonSessionResetTests and ComparisonSessionIntegrationTests:

### ğŸ¤– Assistant (00:35:06)

Now update ComparisonSessionIntegrationTests:

### ğŸ¤– Assistant (00:35:12)

Now let me update the Settings tests:

### ğŸ¤– Assistant (00:35:33)

Now let me check the ProfileScreenLayoutTests:

### ğŸ¤– Assistant (00:35:41)

Now let me verify there are no remaining call sites I've missed. Let me do a final check:

### ğŸ¤– Assistant (00:35:46)

All `ComparisonRecord` call sites in Swift source files are updated. Now let me verify `PitchMatchingRecord` and `CompletedPitchMatching` call sites:

### ğŸ¤– Assistant (00:35:50)

Good, all `PitchMatchingRecord` call sites are updated. Let me also check `CompletedComparison` and `CompletedPitchMatching`:

### ğŸ¤– Assistant (00:35:54)

All `CompletedComparison` call sites are updated. Let me check `CompletedPitchMatching`:

### ğŸ¤– Assistant (00:35:58)

All updated. Let me verify `PitchMatchingChallenge`:

### ğŸ¤– Assistant (00:36:02)

All call sites are updated. Now let me mark tasks complete and move to Task 9.

### ğŸ¤– Assistant (00:36:07)

## Task 9: Confirm `Comparison` shape is already correct

### ğŸ¤– Assistant (00:36:12)

**Confirmed:** `Comparison` has `referenceNote: MIDINote` and `targetNote: DetunedMIDINote` â€” already correct for interval training. `targetNote.note` is the transposed note, `targetNote.offset` is the training cent offset. No code changes needed.

### ğŸ¤– Assistant (00:36:16)

## Task 10: Run full test suite

### ğŸ¤– Assistant (00:38:27)

All tests pass. Now let me also run the dependency checker:

### ğŸ¤– Assistant (00:38:45)

All dependency rules pass. Now let me update the story file with completed tasks and the Dev Agent Record.

### ğŸ¤– Assistant (00:38:49)

Now let me update the story file â€” mark all tasks complete, update the Dev Agent Record, File List, Change Log, and Status.

### ğŸ¤– Assistant (00:39:39)

Now update sprint-status.yaml to "review":

### ğŸ¤– Assistant (00:39:44)

Now let me commit all changes:

### ğŸ¤– Assistant (00:40:13)

## Step 10: Completion

Michael, story 23.1 implementation is complete and ready for review.

### Summary

**Story:** 23.1 â€” Data Model and Value Type Updates for Interval Context
**Status:** review
**Files changed:** 29 files, +276 / -101 lines

### Key Changes

- **`ComparisonRecord`** â€” added `interval: Int` and `tuningSystem: String` fields
- **`PitchMatchingRecord`** â€” added `targetNote: Int`, `interval: Int`, `tuningSystem: String` fields
- **`CompletedComparison`** â€” added `tuningSystem: TuningSystem` property
- **`PitchMatchingChallenge`** â€” added `targetNote: MIDINote` property
- **`CompletedPitchMatching`** â€” added `targetNote: MIDINote` and `tuningSystem: TuningSystem`
- **`TuningSystem`** â€” added `storageIdentifier` / `fromStorageIdentifier` for SwiftData persistence
- **`TrainingDataStore`** â€” observer conformances derive interval via `Interval.between()` and map tuningSystem via `storageIdentifier`
- All call sites pass unison defaults (`.prime`, `.equalTemperament`, `targetNote == referenceNote`)
- **`Comparison`** shape confirmed correct â€” no changes needed

### Tests

All existing tests pass with updated parameters. Existing observer tests now verify the new fields are persisted correctly (interval, tuningSystem, targetNote). Dependency checks pass.

### Recommended Next Steps

- Run `code-review` workflow (ideally with a different LLM)
- After review, story 23.2 (ComparisonSession interval parameterization) is next in the backlog

### ğŸ§‘ Human (00:40:21)

<command-name>/exit</command-name>
            <command-message>exit</command-message>
            <command-args></command-args>

### ğŸ§‘ Human (00:40:21)

<local-command-stdout>Goodbye!</local-command-stdout>

---

[â† Previous (6cb70bc10c)](6cb70bc10c.md) | [Index](index.md) | [Next (d7ccc07ef5) â†’](d7ccc07ef5.md)
