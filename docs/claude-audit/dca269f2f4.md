---
commit: "dca269f2f49f087472974f25ed0be537adddc333"
date: "2026-02-27T02:00:14+01:00"
author: "Michael Sch√ºrig <michael@schuerig.de>"
subject: "Remove dead naturalVsMechanical setting and AdaptiveNoteStrategy"
sessions: ["612cd80d-43a4-4dc0-8328-cb1441fc92be", "eba67b46-cbbc-4499-941e-6eb285ae4fe2"]
prev: "4ece90cd5f.md"
next: "b52f8364a4.md"
---

[‚Üê Previous (4ece90cd5f)](4ece90cd5f.md) | [Index](index.md) | [Next (b52f8364a4) ‚Üí](b52f8364a4.md)

# Commit dca269f2f4

**Date:** 2026-02-27 02:00:14 UTC+01:00  
**Author:** Michael Sch√ºrig <michael@schuerig.de>

## Commit message

Remove dead naturalVsMechanical setting and AdaptiveNoteStrategy

AdaptiveNoteStrategy was replaced by KazezNoteStrategy in story 9.1
but never cleaned up. This removes the dead strategy, its tests, and
the naturalVsMechanical property that only it consumed. Also fixes
NoteDuration clamping in test factories (0.0/0.01 ‚Üí NoteDuration(0.3)).

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>

## Changed files

```
Peach/Comparison/ComparisonScreen.swift            |   2 +-
 Peach/Comparison/ComparisonSession.swift           |   1 -
 Peach/Core/Algorithm/AdaptiveNoteStrategy.swift    | 177 ------------
 Peach/Core/Algorithm/NextComparisonStrategy.swift  |   6 +-
 Peach/Settings/AppUserSettings.swift               |   4 -
 Peach/Settings/SettingsKeys.swift                  |   2 -
 Peach/Settings/UserSettings.swift                  |   1 -
 .../ComparisonSessionAudioInterruptionTests.swift  |  22 +-
 .../ComparisonSessionIntegrationTests.swift        |   2 +-
 .../Comparison/ComparisonSessionResetTests.swift   |   6 +-
 .../ComparisonSessionSettingsTests.swift           |   4 -
 .../ComparisonSessionUserDefaultsTests.swift       |   5 -
 .../AdaptiveNoteStrategyRegionalTests.swift        | 305 ---------------------
 .../Core/Algorithm/AdaptiveNoteStrategyTests.swift | 271 ------------------
 PeachTests/Mocks/MockUserSettings.swift            |   1 -
 .../PitchMatching/PitchMatchingSessionTests.swift  |   2 +-
 PeachTests/Settings/SettingsTests.swift            |   2 -
 .../19-3-usersettings-wrapper-for-userdefaults.md  |  11 +
 18 files changed, 29 insertions(+), 795 deletions(-)
```

## Session 1 (`612cd80d‚Ä¶`)

*2026-02-27 01:01:11 UTC ‚Üí 2026-02-27 01:01:11 UTC*

### üßë Human (01:01:11)

<command-message>bmad-bmm-code-review</command-message>
<command-name>/bmad-bmm-code-review</command-name>
<command-args>19.3</command-args>

## Session 2 (`eba67b46‚Ä¶`)

*2026-02-27 00:53:28 UTC ‚Üí 2026-02-27 01:00:49 UTC*

### üßë Human (00:53:28)

Implement the following plan:

# Plan: Remove `naturalVsMechanical` and `AdaptiveNoteStrategy`

## Context

Code review of story 19.3 found that `naturalVsMechanical` is the only `UserSettings` property still using a raw `Double` instead of a value object. Michael confirmed it's a holdover from `AdaptiveNoteStrategy`, which was replaced by `KazezNoteStrategy` in story 9.1 but never cleaned up. This plan removes both the dead strategy and the dead setting, as part of the 19.3 code review fix-up.

## Scope

**Delete files (2 production, 2 test):**
- `Peach/Core/Algorithm/AdaptiveNoteStrategy.swift`
- `PeachTests/Core/Algorithm/AdaptiveNoteStrategyTests.swift`
- `PeachTests/Core/Algorithm/AdaptiveNoteStrategyRegionalTests.swift`

**Modify files:**

### 1. `Peach/Settings/UserSettings.swift`
- Remove `var naturalVsMechanical: Double { get }`

### 2. `Peach/Settings/AppUserSettings.swift`
- Remove `naturalVsMechanical` computed property (lines 28-30)

### 3. `PeachTests/Mocks/MockUserSettings.swift`
- Remove `var naturalVsMechanical: Double = ...`

### 4. `Peach/Settings/SettingsKeys.swift`
- Remove `static let naturalVsMechanical = "naturalVsMechanical"` (line 6)
- Remove `static let defaultNaturalVsMechanical: Double = 0.5` (line 16)

### 5. `Peach/Core/Algorithm/NextComparisonStrategy.swift`
- Remove `naturalVsMechanical` from `TrainingSettings` struct (property, init param, init body)
- Update doc comment: remove "Natural/Mechanical: 0.5" line and AdaptiveNoteStrategy mention
- Remove protocol doc line referencing AdaptiveNoteStrategy

### 6. `Peach/Comparison/ComparisonSession.swift`
- Remove `naturalVsMechanical: userSettings.naturalVsMechanical` from `currentSettings` computed property (line 44)

### 7. `Peach/Comparison/ComparisonScreen.swift`
- Change preview mock from `AdaptiveNoteStrategy()` to `KazezNoteStrategy()` (line 166)

### 8. `PeachTests/Comparison/ComparisonSessionSettingsTests.swift`
- Remove all `mockSettings.naturalVsMechanical = X` lines
- Remove all `#expect(mockStrategy.lastReceivedSettings?.naturalVsMechanical == X)` assertions

### 9. `PeachTests/Comparison/ComparisonSessionUserDefaultsTests.swift`
- Remove all `mockSettings.naturalVsMechanical = X` lines
- Remove all `#expect(mockStrategy.lastReceivedSettings?.naturalVsMechanical == X)` assertions

### 10. `PeachTests/Settings/SettingsTests.swift`
- Remove `#expect(SettingsKeys.defaultNaturalVsMechanical == trainingDefaults.naturalVsMechanical)` (line 15)
- Remove `#expect(SettingsKeys.naturalVsMechanical == "naturalVsMechanical")` (line 31)

### 11. `PeachTests/Comparison/ComparisonSessionResetTests.swift`
- 2 tests use `AdaptiveNoteStrategy()` ‚Äî replace with `KazezNoteStrategy()`
  - `afterResetFirstComparisonUses100Cents` (line 43)
  - `afterResetWeightedEffectiveDifficultyReturnsDefault` (line 70)

### 12. `PeachTests/Comparison/ComparisonSessionIntegrationTests.swift`
- 1 test uses `AdaptiveNoteStrategy()` ‚Äî replace with `KazezNoteStrategy()` (line 215)

### 13. Story file update
- Update `docs/implementation-artifacts/19-3-usersettings-wrapper-for-userdefaults.md`:
  - Add change log entry for code review fixes
  - Update File List with all newly changed/deleted files
  - Fix other review findings (NoteDuration clamping in test factories)

## Other review findings to fix in same pass

- **Finding #3 (NoteDuration clamping):** Change `s.noteDuration = 0.0` to `NoteDuration(0.3)` in `PitchMatchingSessionTests` factory default. Change `s.noteDuration = 0.01` to `NoteDuration(0.3)` in `ComparisonSessionAudioInterruptionTests`.

## Files NOT changed (docs only ‚Äî no code impact)
- `docs/planning-artifacts/epics.md`, `docs/arc42/`, old story files ‚Äî historical references, not actionable

## Verification

1. Run full test suite: `xcodebuild test -scheme Peach -destination 'platform=iOS Simulator,name=iPhone 17'`
2. Grep for `naturalVsMechanical` in `Peach/` and `PeachTests/` ‚Äî zero matches expected
3. Grep for `AdaptiveNoteStrategy` in `Peach/` ‚Äî zero matches expected (test references to `KazezNoteStrategy` only)


If you need specific details from before exiting plan mode (like exact code snippets, error messages, or content you generated), read the full transcript at: /Users/michael/.claude/projects/-Users-michael-Projekte-peach/44adad9a-ba4a-4896-b1b8-b41c03c5201e.jsonl

### ü§ñ Assistant (00:53:31)

I'll implement this plan to remove the dead `naturalVsMechanical` setting and `AdaptiveNoteStrategy`. Let me start by reading all the files that need modification.

### ü§ñ Assistant (00:53:48)

Let me read all the files I need to modify in parallel.

### ü§ñ Assistant (00:54:00)

Now let me read the remaining files I need.

### ü§ñ Assistant (00:54:07)

Let me read the PitchMatchingSessionTests factory and the ComparisonSessionAudioInterruptionTests for the NoteDuration fix.

### ü§ñ Assistant (00:54:11)

Let me check the NoteDuration type to understand its clamping behavior.

### ü§ñ Assistant (00:54:17)

Good. `NoteDuration` clamps to `0.3...3.0`, so `0.0` becomes `0.3` and `0.01` becomes `0.3`. The plan says to change these to `NoteDuration(0.3)` which is the minimum valid value. Now I have everything I need. Let me start implementing.

First, delete the AdaptiveNoteStrategy files.

### ü§ñ Assistant (00:54:27)

The files weren't deleted (sandbox confirmation). Let me try again with the `-f` flag.

### ü§ñ Assistant (00:54:35)

Files deleted. Now I need to remove them from the Xcode project file too.

### ü§ñ Assistant (00:54:39)

Good ‚Äî no Xcode project file references (likely using folder references or SPM structure).

### ü§ñ Assistant (00:54:43)

Now let me make all the production file edits.

### ü§ñ Assistant (00:54:53)

Those diagnostics are just SourceKit noise from the LSP not having the full module context. Let me continue with the remaining production edits.

### ü§ñ Assistant (00:55:11)

Production files done. Now let me also check if PitchMatchingSession has a `currentSettings` that passes `naturalVsMechanical`.

### ü§ñ Assistant (00:55:16)

Zero matches for `naturalVsMechanical` in production code. Now let me update all the test files.

### ü§ñ Assistant (00:55:35)

Now the UserDefaultsTests file.

### ü§ñ Assistant (00:55:48)

Now SettingsTests, ComparisonSessionResetTests, and ComparisonSessionIntegrationTests.

### ü§ñ Assistant (00:56:03)

Now fix the NoteDuration clamping issues.

### ü§ñ Assistant (00:56:09)

Now let me verify there are no remaining references to `naturalVsMechanical` or `AdaptiveNoteStrategy` in the source.

### ü§ñ Assistant (00:56:16)

Zero matches across both `Peach/` and `PeachTests/` for both `naturalVsMechanical` and `AdaptiveNoteStrategy`.

### ü§ñ Assistant (00:56:19)

Now update the story file and run the test suite.

### ü§ñ Assistant (00:56:29)

Now update the File List section to include the newly changed/deleted files.

### ü§ñ Assistant (00:56:42)

Now let me run the full test suite.

### ü§ñ Assistant (00:58:50)

All tests pass. Let me do the final grep verifications.

### ü§ñ Assistant (00:59:07)

All done. Here's the summary:

## Completed: Remove `naturalVsMechanical` and `AdaptiveNoteStrategy`

**Deleted (3 files):**
- `Peach/Core/Algorithm/AdaptiveNoteStrategy.swift`
- `PeachTests/Core/Algorithm/AdaptiveNoteStrategyTests.swift`
- `PeachTests/Core/Algorithm/AdaptiveNoteStrategyRegionalTests.swift`

**Modified production files (6):**
- `UserSettings.swift` ‚Äî removed `naturalVsMechanical` property
- `AppUserSettings.swift` ‚Äî removed `naturalVsMechanical` computed property
- `SettingsKeys.swift` ‚Äî removed key and default constant
- `NextComparisonStrategy.swift` ‚Äî removed `naturalVsMechanical` from `TrainingSettings` struct, init, and doc comments
- `ComparisonSession.swift` ‚Äî removed from `currentSettings` construction
- `ComparisonScreen.swift` ‚Äî preview mock uses `KazezNoteStrategy()` instead of `AdaptiveNoteStrategy()`

**Modified test files (8):**
- `MockUserSettings.swift` ‚Äî removed `naturalVsMechanical` property
- `ComparisonSessionSettingsTests.swift` ‚Äî removed all `naturalVsMechanical` assignments and assertions
- `ComparisonSessionUserDefaultsTests.swift` ‚Äî same
- `SettingsTests.swift` ‚Äî removed default and key assertions for `naturalVsMechanical`
- `ComparisonSessionResetTests.swift` ‚Äî replaced `AdaptiveNoteStrategy()` with `KazezNoteStrategy()`
- `ComparisonSessionIntegrationTests.swift` ‚Äî same
- `PitchMatchingSessionTests.swift` ‚Äî fixed `noteDuration = 0.0` ‚Üí `NoteDuration(0.3)`
- `ComparisonSessionAudioInterruptionTests.swift` ‚Äî fixed `noteDuration = 0.01` ‚Üí `NoteDuration(0.3)` (11 occurrences)

**Verification:**
- Full test suite: **TEST SUCCEEDED**
- `naturalVsMechanical` in `Peach/` + `PeachTests/`: **0 matches**
- `AdaptiveNoteStrategy` in `Peach/` + `PeachTests/`: **0 matches**

### üßë Human (00:59:59)

commit this

### ü§ñ Assistant (01:00:21)

Committed as `dca269f`. 18 files changed, net -766 lines ‚Äî clean removal of the dead code.

### üßë Human (01:00:49)

<command-name>/exit</command-name>
            <command-message>exit</command-message>
            <command-args></command-args>

### üßë Human (01:00:49)

<local-command-stdout>Goodbye!</local-command-stdout>

---

[‚Üê Previous (4ece90cd5f)](4ece90cd5f.md) | [Index](index.md) | [Next (b52f8364a4) ‚Üí](b52f8364a4.md)
