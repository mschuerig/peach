---
commit: "28538901ca5d38719c3832f7b7f6eed83b6696ff"
date: "2026-03-01T00:36:49+01:00"
author: "Michael SchÃ¼rig <michael@schuerig.de>"
subject: "Implement story 22.4: Unified Reference/Target Naming"
sessions: ["66c738e2-2c9d-4f9a-993f-4cc8c30459ec", "e1c8d2e1-7edc-4030-9c4f-083fadcd7dfb"]
prev: "d41b79d29c.md"
next: "ed595ea1db.md"
---

[â† Previous (d41b79d29c)](d41b79d29c.md) | [Index](index.md) | [Next (ed595ea1db) â†’](ed595ea1db.md)

# Commit 28538901ca

**Date:** 2026-03-01 00:36:49 UTC+01:00  
**Author:** Michael SchÃ¼rig <michael@schuerig.de>

## Commit message

Implement story 22.4: Unified Reference/Target Naming

Rename note1/note2 to referenceNote/targetNote across Comparison,
ComparisonRecord, TimelineDataPoint, and all callers, tests, mocks,
previews, and docs. Comparison.targetNote is now DetunedMIDINote,
absorbing the old note2 + centDifference fields.

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>

## Changed files

```
Peach/App/EnvironmentKeys.swift                    |   2 +-
 Peach/App/PeachApp.swift                           |   4 +-
 Peach/Comparison/ComparisonSession.swift           |  12 +-
 Peach/Core/Algorithm/KazezNoteStrategy.swift       |   9 +-
 Peach/Core/Data/ComparisonRecord.swift             |  26 +--
 Peach/Core/Data/TrainingDataStore.swift            |   6 +-
 Peach/Core/Profile/PerceptualProfile.swift         |   4 +-
 Peach/Core/Profile/ThresholdTimeline.swift         |  14 +-
 Peach/Core/Profile/TrendAnalyzer.swift             |   6 +-
 Peach/Core/Training/Comparison.swift               |  19 +-
 Peach/Profile/ProfileScreen.swift                  |  10 +-
 Peach/Profile/SummaryStatisticsView.swift          |   4 +-
 Peach/Profile/ThresholdTimelineView.swift          |   6 +-
 Peach/Start/ProfilePreviewView.swift               |   6 +-
 .../ComparisonSessionDifficultyTests.swift         |  14 +-
 .../ComparisonSessionIntegrationTests.swift        |  20 +-
 .../ComparisonSessionLifecycleTests.swift          |   6 +-
 .../ComparisonSessionLoudnessTests.swift           |  44 ++--
 .../Comparison/ComparisonSessionResetTests.swift   |  16 +-
 .../ComparisonSessionUserDefaultsTests.swift       |  10 +-
 PeachTests/Comparison/ComparisonTestHelpers.swift  |   4 +-
 .../Comparison/MockNextComparisonStrategy.swift    |   2 +-
 PeachTests/Comparison/MockTrainingDataStore.swift  |   6 +-
 .../Core/Algorithm/KazezNoteStrategyTests.swift    |  51 +++--
 .../Core/Data/TrainingDataStoreEdgeCaseTests.swift |  26 +--
 PeachTests/Core/Data/TrainingDataStoreTests.swift  |  64 +++---
 .../Core/Profile/ThresholdTimelineTests.swift      |  54 +++--
 PeachTests/Core/Training/ComparisonTests.swift     |  52 ++---
 PeachTests/Profile/ProfileScreenLayoutTests.swift  |   6 +-
 PeachTests/Profile/TrendAnalyzerTests.swift        |  11 +-
 PeachTests/Settings/SettingsTests.swift            |  18 +-
 PeachTests/Start/ProfilePreviewViewTests.swift     |   6 +-
 .../22-4-unified-reference-target-naming.md        | 233 +++++++++++++--------
 docs/implementation-artifacts/sprint-status.yaml   |   2 +-
 docs/project-context.md                            |   4 +-
 35 files changed, 411 insertions(+), 366 deletions(-)
```

## Session 1 (`66c738e2â€¦`)

*2026-02-28 23:16:22 UTC â†’ 2026-02-28 23:37:27 UTC*

### ğŸ§‘ Human (23:16:22)

<command-message>bmad-bmm-dev-story</command-message>
<command-name>/bmad-bmm-dev-story</command-name>
<command-args>22.4</command-args>

### ğŸ¤– Assistant (23:16:25)

I'll start by loading the core workflow XML and the dev-story workflow configuration.

### ğŸ¤– Assistant (23:16:30)

Now let me load the config source, instructions, and validation files.

### ğŸ¤– Assistant (23:16:41)

Now I have all workflow components loaded. Let me execute **Step 1** - find and load story 22.4.

The argument `22.4` was provided, so I'll search for the matching story file.

### ğŸ¤– Assistant (23:16:45)

Found story file. Let me read it and the project context.

### ğŸ¤– Assistant (23:16:49)

Now let me load the project context.

### ğŸ¤– Assistant (23:17:04)

All context loaded. Let me execute the workflow steps.

**Step 2:** âœ… **Context Loaded** â€” Story and project context available for implementation.

**Step 3:** ğŸš€ **Starting Fresh Implementation**
- Story: `22-4-unified-reference-target-naming`
- Story Status: `ready-for-dev`
- First incomplete task: Task 1 â€” Refactor `Comparison` struct

**Step 4:** Updating sprint status to `in-progress`.

### ğŸ¤– Assistant (23:17:10)

ğŸš€ Starting work on story `22-4-unified-reference-target-naming`
Status updated: ready-for-dev â†’ in-progress

Now entering **Step 5** â€” implementation. Let me start with **Task 1: Refactor `Comparison` struct**. First, I need to read the current source files.

### ğŸ¤– Assistant (23:17:14)

Good, I have the current source. Let me read the remaining production files that need changes.

### ğŸ¤– Assistant (23:17:20)

Now let me read the remaining production files.

### ğŸ¤– Assistant (23:17:38)

I now have complete visibility into all production files. This is a pure rename story â€” the most efficient approach is to apply all renames systematically (core type â†’ production callers â†’ tests â†’ views â†’ docs) and then verify with the full test suite.

Let me start implementing. **Task 1: Refactor `Comparison` struct.**

### ğŸ¤– Assistant (23:17:46)

Task 1 done. Now **Task 2: Rename `ComparisonRecord` fields.**

### ğŸ¤– Assistant (23:17:58)

Now **Task 3: Update `KazezNoteStrategy`.**

### ğŸ¤– Assistant (23:18:07)

Now **Task 4: Update `ComparisonSession`.**

### ğŸ¤– Assistant (23:18:26)

Now **Task 5: Update `TrainingDataStore` observer.**

### ğŸ¤– Assistant (23:18:30)

Now **Task 6: Update `PerceptualProfile` observer.**

### ğŸ¤– Assistant (23:18:35)

Now **Task 7: Update `ThresholdTimeline` and `TimelineDataPoint`.**

### ğŸ¤– Assistant (23:18:52)

Now **Task 8: Update `TrendAnalyzer`.**

### ğŸ¤– Assistant (23:19:06)

Now **Task 9: Update `PeachApp.swift` profile loading.**

### ğŸ¤– Assistant (23:19:11)

Now **Task 10: Update `EnvironmentKeys.swift` preview strategy.**

### ğŸ¤– Assistant (23:19:17)

Production code tasks 1-10 done. Now **Tasks 11-12: Update all test and mock files.** Let me read and update them. I'll launch parallel agents to handle the many test files efficiently.

### ğŸ¤– Assistant (23:22:58)

All test/mock/view files updated by the agents. The SourceKit diagnostics are indexing artifacts â€” let me verify by running the actual build. First, let me handle **Task 14: Update `project-context.md`** and then run the full test suite.

### ğŸ¤– Assistant (23:23:04)

Now let me also update the domain rules section that references note1/note2.

### ğŸ¤– Assistant (23:23:09)

Now **Task 15: Run full test suite** and grep verification in parallel.

### ğŸ¤– Assistant (23:24:29)

**TEST SUCCEEDED** â€” all tests pass with zero regressions.

The grep results show remaining matches that are all **correct/expected**:
1. `SoundFontPlaybackHandle.swift` â€” uses `centDifference` as a local variable (not a struct property), unrelated to Comparison
2. `DetunedMIDINoteTests.swift` â€” uses `note1`/`note2` as local variable names for `DetunedMIDINote` instances, not Comparison properties
3. `KazezNoteStrategyTests.swift` â€” uses `centDifference` as a helper function parameter name, not a struct property

None of these are the old `Comparison.note1`/`.note2`/`.centDifference` patterns. The rename is complete.

Now let me run the dependency check and update the story file.

### ğŸ¤– Assistant (23:25:34)

All dependency rules pass. Now let me update the story file â€” mark all tasks complete, update the Dev Agent Record, File List, Change Log, and Status.

### ğŸ¤– Assistant (23:25:39)

Now let me update the story file â€” mark all tasks complete, update Dev Agent Record, File List, Change Log, and Status.

### ğŸ¤– Assistant (23:26:35)

Now update the Dev Agent Record, File List, and Change Log.

### ğŸ¤– Assistant (23:26:53)

Now update sprint status to "review".

### ğŸ¤– Assistant (23:27:05)

âœ… Story status updated to "review" in sprint-status.yaml.

---

**Step 10: Completion communication.**

Michael, story **22.4: Unified Reference/Target Naming** is complete and ready for review.

**Summary of changes:**
- **`Comparison` struct** refactored from 3 fields (`note1`, `note2`, `centDifference`) to 2 fields (`referenceNote`, `targetNote: DetunedMIDINote`) â€” absorbing the old note2 + centDifference into a single `DetunedMIDINote`
- **`ComparisonRecord`** fields renamed: `note1`â†’`referenceNote`, `note2`â†’`targetNote`, `note2CentOffset`â†’`centOffset`
- **`TimelineDataPoint`** fields renamed: `centDifference`â†’`centOffset`, `note1`â†’`referenceNote`
- **Method renames**: `isSecondNoteHigher`â†’`isTargetHigher`, `note1Frequency`â†’`referenceFrequency`, `note2Frequency`â†’`targetFrequency`
- **35 files** modified across production code, tests, mocks, previews, and docs
- **Full test suite passes** â€” zero regressions, zero behavioral changes
- **Dependency check passes** â€” all architectural rules satisfied
- **Grep verification** confirms no old naming patterns remain in struct/property access (only unrelated local variables)

**Story file:** `docs/implementation-artifacts/22-4-unified-reference-target-naming.md`

**Suggested next steps:**
- Review the changes and verify acceptance criteria
- Run `code-review` workflow (ideally with a different LLM)
- Check `docs/implementation-artifacts/sprint-status.yaml` for overall project progress

Would you like me to commit these changes, or do you have any questions about the implementation?

### ğŸ§‘ Human (23:36:31)

commit this

### ğŸ¤– Assistant (23:36:39)

35 files, all expected. Let me stage and commit.

### ğŸ¤– Assistant (23:36:54)

Committed as `2853890` â€” working tree is clean. 35 files changed, 411 insertions, 366 deletions.

### ğŸ§‘ Human (23:37:27)

<command-name>/exit</command-name>
            <command-message>exit</command-message>
            <command-args></command-args>

### ğŸ§‘ Human (23:37:27)

<local-command-stdout>See ya!</local-command-stdout>

## Session 2 (`e1c8d2e1â€¦`)

*2026-02-28 23:37:41 UTC â†’ 2026-02-28 23:37:47 UTC*

### ğŸ§‘ Human (23:37:41)

<command-message>bmad-bmm-code-review</command-message>
<command-name>/bmad-bmm-code-review</command-name>
<command-args>22.4</command-args>

### ğŸ¤– Assistant (23:37:43)

I'll start by loading the workflow execution framework and the code review workflow configuration.

### ğŸ¤– Assistant (23:37:47)

Now let me load the config source and instructions.

---

[â† Previous (d41b79d29c)](d41b79d29c.md) | [Index](index.md) | [Next (ed595ea1db) â†’](ed595ea1db.md)
