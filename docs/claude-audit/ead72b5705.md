---
commit: "ead72b57056153f29cdbf775fc77ac7ea488be8f"
date: "2026-02-24T23:55:55+01:00"
author: "Michael Sch√ºrig <michael@schuerig.de>"
subject: "Fix code review findings for 10-3-add-amplitude-parameter-to-noteplayer"
sessions: ["7597ede3-cf3c-4fbe-8c0c-0d18d560b65a"]
prev: "b1a1ea56f0.md"
next: "7cb7e08584.md"
---

[‚Üê Previous (b1a1ea56f0)](b1a1ea56f0.md) | [Index](index.md) | [Next (7cb7e08584) ‚Üí](7cb7e08584.md)

# Commit ead72b5705

**Date:** 2026-02-24 23:55:55 UTC+01:00  
**Author:** Michael Sch√ºrig <michael@schuerig.de>

## Commit message

Fix code review findings for 10-3-add-amplitude-parameter-to-noteplayer

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>

## Changed files

```
PeachTests/Training/TrainingSessionIntegrationTests.swift           | 6 ++++--
 .../10-3-add-amplitude-parameter-to-noteplayer.md                   | 5 +++--
 docs/implementation-artifacts/sprint-status.yaml                    | 2 +-
 3 files changed, 8 insertions(+), 5 deletions(-)
```

## Session `7597ede3‚Ä¶`

*2026-02-24 22:38:44 UTC ‚Üí 2026-02-24 22:55:58 UTC*

### üßë Human (22:38:44)

<command-message>bmad-bmm-code-review</command-message>
<command-name>/bmad-bmm-code-review</command-name>
<command-args>10-3</command-args>

### ü§ñ Assistant (22:38:47)

I'll start by loading the workflow execution framework and the code review workflow configuration.

### ü§ñ Assistant (22:38:52)

Now let me load the config source and the instructions file.

### ü§ñ Assistant (22:39:04)

Good, I've loaded all workflow components. Let me resolve the variables:

- **user_name**: Michael
- **communication_language**: English
- **user_skill_level**: intermediate
- **planning_artifacts**: `/Users/michael/Projekte/peach/docs/planning-artifacts`
- **implementation_artifacts**: `/Users/michael/Projekte/peach/docs/implementation-artifacts`
- **template**: false (action-workflow)
- **Arguments**: 10-3 ‚Üí epic 10, story 3

---

## Step 1: Load Story and Discover Changes

Let me find the story file, check git status, and load project context.

### ü§ñ Assistant (22:39:11)

Working tree is clean. Let me load the story file, project context, and find the git changes related to this story.

### ü§ñ Assistant (22:39:17)

Now let me get the actual files changed in the implementation commit and load the architecture/epic inputs.

### ü§ñ Assistant (22:39:30)

Good. Let me now load the architecture, epic context, and all implementation files for the adversarial review.

### ü§ñ Assistant (22:39:37)

Let me also check for the test helper methods at the bottom of the integration test file and look at the sprint status file.

### ü§ñ Assistant (22:40:04)

Now I have all the context I need. Let me execute the adversarial review.

---

## Step 2: Build Review Attack Plan

**Acceptance Criteria extracted:**
1. AC#1: Signature becomes `play(frequency:duration:velocity:amplitudeDB:)` where `amplitudeDB: Float` controls `masterGain` (-90.0 to +12.0, default 0.0)
2. AC#2: `amplitudeDB: 0.0` plays at unchanged volume (`masterGain = 0.0`)
3. AC#3: `sampler.masterGain` set to `amplitudeDB` before `startNote`
4. AC#4: Out-of-range throws `AudioError.invalidAmplitude`
5. AC#5: Mock captures `lastAmplitudeDB` and `playHistory` tuple
6. AC#6: All existing tests pass with `amplitudeDB: 0.0`

**Tasks: 9 tasks, all marked [x]**

**Story File List (8 files)** vs **Git changes (8 source files + 2 meta files)** ‚Äî match confirmed.

**Review plan:**
1. AC Validation
2. Task Audit
3. Code Quality
4. Test Quality

---

## Step 3: Execute Adversarial Review

Let me now systematically go through each dimension.

### Git vs Story Discrepancies

- **Git has 10 files**, story lists 8. The extra 2 are `docs/implementation-artifacts/10-3-add-amplitude-parameter-to-noteplayer.md` (the story itself) and `docs/implementation-artifacts/sprint-status.yaml` ‚Äî these are meta-files, not source. **No discrepancy.**
- All 8 source files in the story's File List appear in git. **No false claims.**

### AC Validation

**AC#1 ‚Äî Protocol signature updated**: `NotePlayer.swift:42` shows `func play(frequency: Double, duration: TimeInterval, velocity: UInt8, amplitudeDB: Float) async throws` ‚Äî **IMPLEMENTED**

**AC#2 ‚Äî Default 0.0 plays unchanged**: `TrainingSession.swift:401,412` both pass `amplitudeDB: 0.0`. `SoundFontNotePlayer.swift:159` sets `sampler.masterGain = amplitudeDB`. When 0.0 is passed, masterGain = 0.0. ‚Äî **IMPLEMENTED**

**AC#3 ‚Äî masterGain set before startNote**: `SoundFontNotePlayer.swift:159` (`sampler.masterGain = amplitudeDB`) comes before line 163 (`sampler.startNote(...)`) ‚Äî **IMPLEMENTED**

**AC#4 ‚Äî Out-of-range throws invalidAmplitude**: `SoundFontNotePlayer.swift:135-139` validates `(-90.0...12.0).contains(amplitudeDB)` and throws `AudioError.invalidAmplitude`. `AudioError` has `case invalidAmplitude(String)` at `NotePlayer.swift:21`. ‚Äî **IMPLEMENTED**

**AC#5 ‚Äî Mock captures amplitudeDB**: `MockNotePlayer.swift:13` has `var lastAmplitudeDB: Float?`. Line 14 has the updated `playHistory` tuple. Line 40 captures `lastAmplitudeDB = amplitudeDB`. Line 70 `reset()` clears `lastAmplitudeDB = nil`. ‚Äî **IMPLEMENTED**

**AC#6 ‚Äî All existing tests pass**: Story claims all tests pass. I'll need to trust the claim since working tree is clean and the commit was made. Let me spot-check call sites.

### ü§ñ Assistant (22:41:22)

Let me also check if there are any other test files that call `play()` or reference the old signature.

### ü§ñ Assistant (22:41:36)

Let me check if AudioError has a custom description that needs updating.

### ü§ñ Assistant (22:42:22)

---

## Step 4: Present Findings

**CODE REVIEW FINDINGS, Michael!**

**Story:** `docs/implementation-artifacts/10-3-add-amplitude-parameter-to-noteplayer.md`
**Git vs Story Discrepancies:** 0 found (clean match)
**Issues Found:** 0 High, 2 Medium, 3 Low

---

### CRITICAL ISSUES

None. All tasks marked [x] are genuinely implemented. All ACs are implemented. Story File List matches git reality.

---

### MEDIUM ISSUES

**M1: Story Task 6 description contradicts actual implementation ordering**
- Task 6 says: *"Add `sampler.masterGain = amplitudeDB` before the `sampler.startNote(...)` call (after pitch bend, before startNote)"*
- Actual code (`SoundFontNotePlayer.swift:159-163`): masterGain is set **BEFORE** `sendPitchBend`, not after
- The Dev Notes code example (line 118-122 of story) correctly shows `masterGain` before pitch bend ‚Äî so the Dev Notes are right and the Task 6 parenthetical is wrong
- Functionally irrelevant (order between masterGain and pitchBend doesn't matter), but the story is the record of truth

**M2: `passesDefaultAmplitude` test only verifies note2's amplitude, not note1's**
- `TrainingSessionIntegrationTests.swift:60`: `#expect(f.mockPlayer.lastAmplitudeDB == 0.0)` ‚Äî this is note2's value (last play call)
- Note1's `amplitudeDB` is never explicitly verified
- AC#6 says "all existing tests pass with `amplitudeDB: 0.0` at **all call sites**" ‚Äî both play calls (line 401 and 412 of TrainingSession) should be verified
- A more robust test would check `playHistory[0].amplitudeDB == 0.0` (note1) AND `playHistory[1].amplitudeDB == 0.0` (note2)

---

### LOW ISSUES

**L1: No test explicitly verifies `playHistory` tuple's `amplitudeDB` field**
- AC#5 specifies the mock captures amplitude in both `lastAmplitudeDB` *and* `the playHistory tuple for test verification`
- No test anywhere accesses `playHistory[n].amplitudeDB` ‚Äî only `lastAmplitudeDB` is asserted
- The `playHistory` tuple is correctly extended (MockNotePlayer.swift:14,41), just not tested

**L2: Amplitude range constants are inline magic numbers**
- `-90.0` and `12.0` appear as literals in: validation guard (SoundFontNotePlayer.swift:135), error message (:138), protocol doc comment (NotePlayer.swift:41), and 4 test cases
- `validFrequencyRange` has a `private static let` constant (SoundFontNotePlayer.swift:28), but amplitude has none
- Consistent with velocity validation style (also inline), but inconsistent with frequency validation

**L3: Amplitude doc comment could be more descriptive**
- `NotePlayer.swift:40`: `amplitudeDB: dB offset for sound volume (-90.0 to +12.0, 0.0 = no change)` 
- Doesn't indicate direction: positive = louder, negative = quieter. A developer unfamiliar with dB might not know which direction increases volume.

---

What should I do with these issues?

1. **Fix them automatically** - I'll update the code and tests
2. **Create action items** - Add to story Tasks/Subtasks for later
3. **Show me details** - Deep dive into specific issues

Choose [1], [2], or specify which issue to examine:

### üßë Human (22:44:19)

1

### ü§ñ Assistant (22:44:24)

I'll fix both MEDIUM issues now.

**M1**: Fix Task 6 description in the story file.
**M2**: Strengthen the `passesDefaultAmplitude` test to verify both notes' amplitude via `playHistory`.

### ü§ñ Assistant (22:45:12)

Both fixes applied. Now let me update the story's Change Log and File List to reflect the review fixes, then run the full test suite.

### ü§ñ Assistant (22:51:20)

**TEST SUCCEEDED** ‚Äî all tests pass. Now let me update the story status to "done" and sync sprint status.

---

## Step 5: Update Story Status and Sync Sprint Tracking

All HIGH and MEDIUM issues are fixed. All ACs are implemented. Tests pass.

### ü§ñ Assistant (22:51:34)

Sprint status synced: 10-3-add-amplitude-parameter-to-noteplayer ‚Üí done

---

## Review Complete!

**Story Status:** done
**Issues Fixed:** 2 (both MEDIUM)
**Action Items Created:** 0

**Fixes applied:**
1. **M1**: Corrected Task 6 description to accurately reflect implementation ordering (`masterGain` before `sendPitchBend`, not after)
2. **M2**: Strengthened `passesDefaultAmplitude` test to verify both note1 and note2 receive `amplitudeDB: 0.0` via `playHistory`, not just `lastAmplitudeDB`

**Remaining LOW issues** (3 items ‚Äî not fixed, documented only):
- L1: No test explicitly asserts `playHistory[n].amplitudeDB` (partially addressed by M2 fix)
- L2: Amplitude range magic numbers not extracted to constants (consistent with velocity pattern)
- L3: Doc comment could clarify dB direction (positive = louder)

All tests pass. Code review complete!

### üßë Human (22:54:27)

Do you want to fix the remaining issues or should we wrap it up?

### ü§ñ Assistant (22:54:32)

L1 is already resolved by the M2 fix (we now assert `playHistory[0].amplitudeDB` and `playHistory[1].amplitudeDB`). L2 and L3 are cosmetic and I'd leave them ‚Äî extracting the range constant would be inconsistent with how velocity validation already works, and the doc comment is adequate for developers working with dB.

Let's wrap it up. Want me to commit?

### üßë Human (22:55:45)

yes

### ü§ñ Assistant (22:55:58)

Committed as `ead72b5`.

---

[‚Üê Previous (b1a1ea56f0)](b1a1ea56f0.md) | [Index](index.md) | [Next (7cb7e08584) ‚Üí](7cb7e08584.md)
