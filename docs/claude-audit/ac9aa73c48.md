---
commit: "ac9aa73c48b3015dfcbe443de9cf67b18f916305"
date: "2026-02-28T23:42:09+01:00"
author: "Michael SchÃ¼rig <michael@schuerig.de>"
subject: "Implement story 22.3: Introduce DetunedMIDINote and Two-World Architecture"
sessions: ["ac3ea666-1f7a-46d7-9403-f196074f65ce"]
prev: "ce2162ab2b.md"
next: "819996a0cd.md"
---

[â† Previous (ce2162ab2b)](ce2162ab2b.md) | [Index](index.md) | [Next (819996a0cd) â†’](819996a0cd.md)

# Commit ac9aa73c48

**Date:** 2026-02-28 23:42:09 UTC+01:00  
**Author:** Michael SchÃ¼rig <michael@schuerig.de>

## Commit message

Implement story 22.3: Introduce DetunedMIDINote and Two-World Architecture

Establish two-world architecture: logical (MIDINote, DetunedMIDINote,
Interval, Cents) and physical (Frequency), bridged explicitly by
TuningSystem.frequency(for:referencePitch:). Dissolve the Pitch struct
that conflated both worlds, migrate all call sites, and privatize the
inverse conversion inside the SoundFont layer.

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>

## Changed files

```
Peach/Comparison/ComparisonSession.swift           |   4 +-
 Peach/Core/Audio/Cents.swift                       |   6 +-
 Peach/Core/Audio/DetunedMIDINote.swift             |  21 ++
 Peach/Core/Audio/Frequency.swift                   |   5 +-
 Peach/Core/Audio/Interval.swift                    |  13 +-
 Peach/Core/Audio/MIDINote.swift                    |   6 +-
 Peach/Core/Audio/Pitch.swift                       |  41 ---
 Peach/Core/Audio/SoundFontNotePlayer.swift         |  24 +-
 Peach/Core/Audio/SoundFontPlaybackHandle.swift     |   4 +-
 Peach/Core/Audio/TuningSystem.swift                |  17 +
 Peach/Core/Training/Comparison.swift               |   8 +-
 Peach/PitchMatching/PitchMatchingSession.swift     |   9 +-
 PeachTests/Core/Audio/DetunedMIDINoteTests.swift   |  88 +++++
 PeachTests/Core/Audio/MIDINoteTests.swift          |  14 +-
 PeachTests/Core/Audio/PitchTests.swift             | 388 ---------------------
 .../Core/Audio/SoundFontNotePlayerTests.swift      |  94 +++++
 PeachTests/Core/Audio/TuningSystemTests.swift      | 160 +++++++++
 PeachTests/Core/Training/ComparisonTests.swift     |  10 +-
 ...e-detunedmidinote-and-two-world-architecture.md | 137 +++++---
 docs/implementation-artifacts/sprint-status.yaml   |   2 +-
 docs/project-context.md                            |   5 +-
 21 files changed, 529 insertions(+), 527 deletions(-)
```

## Session `ac3ea666â€¦`

*2026-02-28 22:22:14 UTC â†’ 2026-02-28 22:42:16 UTC*

### ğŸ§‘ Human (22:22:14)

<command-message>bmad-bmm-dev-story</command-message>
<command-name>/bmad-bmm-dev-story</command-name>
<command-args>22.3</command-args>

### ğŸ¤– Assistant (22:22:16)

I'll start by loading the workflow execution framework and the dev-story workflow configuration.

### ğŸ¤– Assistant (22:22:20)

Now let me load the config source and the instructions file.

### ğŸ¤– Assistant (22:22:35)

Good, I've loaded all workflow components. Let me resolve variables and begin **Step 1: Find next ready story and load it**.

The argument "22.3" indicates story 3 of epic 22. Let me locate the story file and sprint status.

### ğŸ¤– Assistant (22:22:46)

Story found and parsed. Let me proceed to **Step 2** and load the project context.

### ğŸ¤– Assistant (22:22:56)

âœ… **Context Loaded** â€” Story and project context available for implementation.

---

**Step 3: Detect review continuation**

ğŸš€ **Starting Fresh Implementation**

- **Story:** 22-3-introduce-detunedmidinote-and-two-world-architecture
- **Story Status:** ready-for-dev
- **First incomplete task:** Task 1 â€” Create `DetunedMIDINote` struct (AC: #1, #2)

---

**Step 4: Mark story in-progress**

### ğŸ¤– Assistant (22:23:15)

ğŸš€ Starting work on story 22-3-introduce-detunedmidinote-and-two-world-architecture
Status updated: ready-for-dev â†’ in-progress

---

**Step 5: Implement tasks following red-green-refactor cycle**

Starting with **Task 1: Create `DetunedMIDINote` struct (AC: #1, #2)**

Let me first read the existing related files to understand patterns.

### ğŸ¤– Assistant (22:23:21)

Good, I've read the existing domain types and understand the patterns. Let me also check existing test files for patterns.

### ğŸ¤– Assistant (22:23:36)

Now I have full context. Let me start implementing.

### Task 1: Create `DetunedMIDINote` struct (AC: #1, #2)

**RED PHASE** â€” Writing tests first, then minimal implementation.

### ğŸ¤– Assistant (22:23:50)

**GREEN PHASE** â€” Creating the implementation.

### ğŸ¤– Assistant (22:23:59)

Now let me add the new files to the Xcode project and run tests.

### ğŸ¤– Assistant (22:25:10)

The SourceKit diagnostics are just IDE indexing issues â€” the project uses synchronized root groups so the files are already included. Let me run the tests to verify everything compiles and passes.

### ğŸ¤– Assistant (22:26:14)

All 10 tests pass. Task 1 complete. Let me mark it in the story file and move to Task 2.

### ğŸ¤– Assistant (22:26:25)

âœ… **Task 1 complete** â€” `DetunedMIDINote` struct created with 10 passing tests.

---

### Task 2: Add `TuningSystem.frequency(for:referencePitch:)` bridge methods (AC: #3, #4, #5)

**RED PHASE** â€” Writing tests first for both overloads.

### ğŸ¤– Assistant (22:26:56)

**GREEN PHASE** â€” Adding the bridge methods to `TuningSystem`.

### ğŸ¤– Assistant (22:27:03)

Now let me run the TuningSystem tests to verify.

### ğŸ¤– Assistant (22:28:02)

All 21 TuningSystem tests pass (7 pre-existing + 14 new). Let me mark Task 2 complete.

### ğŸ¤– Assistant (22:28:13)

âœ… **Task 2 complete** â€” Bridge methods added with 14 new tests, all passing.

---

### Task 3: Migrate 5 production call sites from `Pitch` to `DetunedMIDINote` + `TuningSystem.frequency()` (AC: #6)

Let me read the files that need migration.

### ğŸ¤– Assistant (22:28:18)

Now let me read the callers that need updating.

### ğŸ¤– Assistant (22:28:28)

Let me check how ComparisonSession gets its settings and how PitchMatchingSession handles tuning.

### ğŸ¤– Assistant (22:28:52)

Now I understand the full picture. Let me migrate all call sites.

**Subtask 3.1 & 3.2**: Migrate `Comparison.swift` frequency methods.

### ğŸ¤– Assistant (22:28:58)

**Subtask 3.3 & 3.4**: Migrate `PitchMatchingSession.swift`.

### ğŸ¤– Assistant (22:29:07)

**Subtask 3.6**: Update `ComparisonSession` callers to pass `tuningSystem`.

### ğŸ¤– Assistant (22:29:11)

**Subtask 3.7**: Update test callers to pass explicit `tuningSystem` parameter.

### ğŸ¤– Assistant (22:29:22)

Now let me also check if MIDINoteTests.swift uses Pitch for frequency conversion (story mentions this).

### ğŸ¤– Assistant (22:29:40)

Now let me verify the build compiles and tests pass with a quick compilation check.

### ğŸ¤– Assistant (22:30:41)

All tests pass. Let me mark Task 3 complete.

### ğŸ¤– Assistant (22:30:58)

âœ… **Task 3 complete** â€” All 5 production call sites migrated, tests updated and passing.

---

### Task 4: Remove `MIDINote.pitch(at:in:)` (AC: #7)

Let me verify there are no remaining callers.

### ğŸ¤– Assistant (22:31:03)

Only callers are in PitchTests.swift (test code being deleted) and doc comments. Let me remove the method and the tests.

### ğŸ¤– Assistant (22:31:17)

**Subtask 4.2**: Delete the `pitch(at:in:)` tests from PitchTests.swift.

### ğŸ¤– Assistant (22:31:29)

**Subtask 4.3**: Verify no file references `pitch(at:` or `pitch(in:`.

### ğŸ¤– Assistant (22:31:34)

Only in doc comments of files being deleted/updated later. Let me update the MIDINote doc comment now (Pitch.swift will be deleted in Task 6).

### ğŸ¤– Assistant (22:31:40)

Now let me mark Task 4 and move on.

### ğŸ¤– Assistant (22:31:50)

âœ… **Task 4 complete** â€” `pitch(at:in:)` removed, 5 tests deleted.

---

### Task 5: Privatize inverse conversion to SoundFont layer (AC: #8)

### ğŸ¤– Assistant (22:32:02)

Now I'll create the private helper and update both call sites. The dev notes recommend `nonisolated static` on `SoundFontNotePlayer`.

### ğŸ¤– Assistant (22:32:12)

Now update the call site in `SoundFontNotePlayer.play()`.

### ğŸ¤– Assistant (22:32:16)

Now update `SoundFontPlaybackHandle.adjustFrequency()`.

### ğŸ¤– Assistant (22:32:21)

Now let me also migrate the inverse conversion tests from PitchTests.swift to SoundFontNotePlayerTests.swift. Let me check the existing test file first.

### ğŸ¤– Assistant (22:32:29)

Now let me add the inverse conversion tests to this file. These test the `decompose()` method directly since it's `nonisolated static`.

### ğŸ¤– Assistant (22:32:54)

Let me run the SoundFont tests to verify.

### ğŸ¤– Assistant (22:33:09)

The `nonisolated` context can't access `@MainActor`-isolated members. I need to use raw values directly.

### ğŸ¤– Assistant (22:33:19)

Now I need to update the callers that use `decomposed.cents` â€” they now return `Double` instead of `Cents`. Let me update the call sites in both SoundFontNotePlayer and SoundFontPlaybackHandle.

### ğŸ¤– Assistant (22:33:29)

Now update the test assertions that expect `Cents` â€” they should use `.cents` as `Double`.

### ğŸ¤– Assistant (22:35:03)

All 40 SoundFontNotePlayer tests pass (30 pre-existing + 10 new decompose tests). Let me mark Task 5 complete.

### ğŸ¤– Assistant (22:35:16)

âœ… **Task 5 complete** â€” Inverse conversion privatized in SoundFont layer with `nonisolated static decompose()`, 10 new tests passing.

---

### Task 6: Delete `Pitch.swift` (AC: #6)

### ğŸ¤– Assistant (22:35:27)

Now handle PitchTests.swift â€” the forward conversion tests are now covered by TuningSystemTests, the inverse conversion tests by SoundFontNotePlayerTests, and the `pitch(at:in:)` tests were already deleted. Let me check what remains.

### ğŸ¤– Assistant (22:35:43)

All PitchTests have been migrated to their new locations. Let me delete the entire file.

### ğŸ¤– Assistant (22:35:49)

**Subtask 6.3**: Verify no file references `Pitch` as a type.

### ğŸ¤– Assistant (22:35:55)

Let me check specifically for `Pitch` used as a type (not in strings, comments, or "Pitch Matching").

### ğŸ¤– Assistant (22:36:02)

No references to the `Pitch` type itself. All remaining are method names like `adjustPitch`, `commitPitch` and `customReferencePitch` â€” these are feature-related, not referencing the deleted `Pitch` struct.

Let me update the stale doc comments in Cents.swift and Frequency.swift.

### ğŸ¤– Assistant (22:36:21)

âœ… **Task 6 complete** â€” `Pitch.swift` and `PitchTests.swift` deleted. No remaining type references.

---

### Task 7: Update `project-context.md` (AC: #9)

### ğŸ¤– Assistant (22:36:32)

Now update the "Domain Rules" and "Never Do This" sections.

### ğŸ¤– Assistant (22:36:53)

âœ… **Task 7 complete** â€” `project-context.md` updated with two-world architecture documentation.

---

### Task 8: Run full test suite and verify (AC: #10)

### ğŸ¤– Assistant (22:38:45)

All tests pass. Let me mark Task 8 complete.

### ğŸ¤– Assistant (22:38:52)

âœ… **Task 8 complete** â€” Full test suite passes with zero regressions.

---

### Step 9: Story completion and mark for review

All 8 tasks are complete. Let me update the story file with the Dev Agent Record, File List, Change Log, and status.

### ğŸ¤– Assistant (22:39:25)

Now update the status to "review".

### ğŸ¤– Assistant (22:39:49)

âœ… Story status updated to "review" in both story file and sprint-status.yaml.

---

### Step 10: Completion communication

Michael, story **22.3: Introduce DetunedMIDINote and Two-World Architecture** is complete and ready for review.

**Key accomplishments:**

- **New type**: `DetunedMIDINote(note:offset:)` â€” a logical-world value type holding a MIDI note with a microtonal cent offset
- **Bridge methods**: `TuningSystem.frequency(for:referencePitch:)` â€” the single explicit path from logical to physical world (two overloads: DetunedMIDINote and MIDINote)
- **5 call sites migrated**: Comparison (x2), PitchMatchingSession (x2), Interval.swift (x1, method removed)
- **Inverse conversion privatized**: `SoundFontNotePlayer.decompose(frequency:)` â€” `nonisolated static` helper for MIDI playback
- **`Pitch` struct dissolved**: `Pitch.swift` and `PitchTests.swift` deleted; all tests migrated to appropriate new locations
- **project-context.md updated**: Documents the two-world model, updated "Never Do This" section

**Tests**: 34 new tests added (10 DetunedMIDINote + 14 TuningSystem bridge + 10 SoundFont decompose). Full suite passes with zero regressions.

**Story file**: `docs/implementation-artifacts/22-3-introduce-detunedmidinote-and-two-world-architecture.md`

Would you like me to explain any technical decisions, or shall I suggest next steps?

- Run `code-review` workflow (recommended with a different LLM)
- Check `sprint-status.yaml` for project progress

### ğŸ§‘ Human (22:41:52)

commit this

### ğŸ¤– Assistant (22:42:16)

Committed as `ac9aa73` â€” clean working tree. 21 files changed, 529 insertions, 527 deletions.

---

[â† Previous (ce2162ab2b)](ce2162ab2b.md) | [Index](index.md) | [Next (819996a0cd) â†’](819996a0cd.md)
