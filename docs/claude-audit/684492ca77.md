---
commit: "684492ca77667f6cf7b87e70eb7a87333d97aff7"
date: "2026-02-22T12:55:04+01:00"
author: "Michael SchÃ¼rig <michael@schuerig.de>"
subject: "Extract shared test helpers and remove tautological assertions"
sessions: ["73ddd098-4b16-477e-b836-59cd2e6142db"]
prev: "1a386a241c.md"
next: "60121099d4.md"
---

[â† Previous (1a386a241c)](1a386a241c.md) | [Index](index.md) | [Next (60121099d4) â†’](60121099d4.md)

# Commit 684492ca77

**Date:** 2026-02-22 12:55:04 UTC+01:00  
**Author:** Michael SchÃ¼rig <michael@schuerig.de>

## Commit message

Extract shared test helpers and remove tautological assertions

DRY refactor: move waitForState(), waitForPlayCallCount(), and
waitForFeedbackToClear() into TrainingTestHelpers.swift, removing
duplicates from 7 test files (-229 lines). Replace always-true
mirror.children.count >= 0 assertions in StartScreenTests with
simple instantiation-succeeds tests. Closes all remaining TEA
review issues (P1 #1, P2 #4; P2 #6 and P3 #7 verified resolved).

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>

## Changed files

```
PeachTests/Start/StartScreenTests.swift            | 36 ++++---------------
 .../TrainingSessionAudioInterruptionTests.swift    | 26 --------------
 .../Training/TrainingSessionFeedbackTests.swift    | 39 --------------------
 .../Training/TrainingSessionIntegrationTests.swift | 26 --------------
 .../Training/TrainingSessionLifecycleTests.swift   | 26 --------------
 .../Training/TrainingSessionSettingsTests.swift    | 26 --------------
 PeachTests/Training/TrainingSessionTests.swift     | 26 --------------
 .../TrainingSessionUserDefaultsTests.swift         | 26 --------------
 PeachTests/Training/TrainingTestHelpers.swift      | 42 ++++++++++++++++++++++
 docs/test-artifacts/test-review.md                 |  6 ++--
 10 files changed, 50 insertions(+), 229 deletions(-)
```

## Session `73ddd098â€¦`

*2026-02-21 20:28:45 UTC â†’ 2026-02-22 11:55:07 UTC*

### ğŸ§‘ Human (20:28:45)

<command-message>bmad-tea-testarch-test-review</command-message>
<command-name>/bmad-tea-testarch-test-review</command-name>
<command-args>Read docs/test-artifacts/test-review.md and fix the remaining issues.</command-args>

### ğŸ¤– Assistant (20:28:47)

I'll start by loading the workflow engine and configuration files.

### ğŸ¤– Assistant (20:28:52)

Now let me load the config source, instructions, template, and the existing review document.

### ğŸ¤– Assistant (20:29:15)

Now let me load the step file referenced in the instructions to follow the workflow properly.

### ğŸ¤– Assistant (20:29:29)

I've loaded the workflow configuration, instructions, and the existing review document. The review has been through two fix rounds already, with a clear **Remaining Open Issues** section. Let me proceed with the workflow by understanding the current state and fixing the remaining issues.

**Resolved Variables:**
- `config_source`: `_bmad/tea/config.yaml`
- `test_artifacts`: `docs/test-artifacts`
- `user_name`: Michael
- `communication_language`: English
- `document_output_language`: English
- `date`: 2026-02-21
- `test_dir`: `tests` (project root)
- `review_scope`: suite

**Remaining Open Issues from the review:**
1. **P1 #1**: Extract shared test helpers to `PeachTests/TestHelpers/` â€” DRY refactor
2. **P2 #4**: Remove tautological assertions (`#expect(true)`, `count >= 0`)
3. **P2 #6**: Reduce real audio engine usage in tests
4. **P3 #7**: Reduce 1000-iteration loops to 100-200

Let me explore the current state of the test files to understand what's been fixed and what remains.

### ğŸ¤– Assistant (20:31:08)

Excellent. The exploration reveals:
- **P1 #1** (shared helpers): `waitForState()` duplicated in 7 files, `waitForPlayCallCount()` in 6 files, `makeTrainingSession()` in 6 files (with varying signatures)
- **P2 #4** (tautological assertions): 4 instances in `StartScreenTests.swift` - `#expect(mirror.children.count >= 0)` â€” always true
- **P2 #6** (audio engine): Already addressed â€” playback tests use 5-100ms durations, already split into separate file
- **P3 #7** (1000-iteration loops): Already fixed â€” no 1000-iteration loops found

Two issues remain actionable: **P1 #1** and **P2 #4**. Let me read the key files to understand the helper variations before refactoring.

### ğŸ¤– Assistant (20:31:18)

Let me read the helper functions from each file to understand the exact signatures and variations.

### ğŸ¤– Assistant (20:31:27)

Now let me read the feedback-specific helper and the StartScreenTests tautological assertions.

### ğŸ¤– Assistant (20:31:35)

Now let me check for the MockHapticFeedbackManager to understand the full dependency graph.

### ğŸ¤– Assistant (20:31:53)

Good â€” `MockHapticFeedbackManager` is defined in the main target. Now I have a complete picture of all the helper variations. Let me create the shared helpers file and then update all 7 files.

Here's my analysis of the `makeTrainingSession()` variants:

| File | Return Type | Key Differences |
|---|---|---|
| TrainingSessionTests | 5-tuple (session, player, dataStore, profile, strategy) | comparisons param, settingsOverride, noteDuration=1.0 |
| IntegrationTests | 5-tuple (same) | identical to above |
| SettingsTests | 5-tuple (same) | identical to above |
| LifecycleTests | 3-tuple (session, player, dataStore) | no settingsOverride/noteDuration |
| FeedbackTests | 4-tuple (session, player, dataStore, haptic) | includes MockHapticFeedbackManager, no settingsOverride |
| AudioInterruptionTests | 3-tuple (session, player, nc) | includes NotificationCenter, noteDuration=0.01 |
| UserDefaultsTests | no factory | just has waitFor helpers |

The factory functions have enough variation that extracting a single shared one would be awkward â€” each test suite needs different return tuples. However, the **wait helpers** are identical across all 7 files. I'll extract those and leave the factory methods in place (they're intentionally tailored per suite).

### ğŸ¤– Assistant (20:32:05)

You're out of extra usage Â· resets 12am (Europe/Berlin)

### ğŸ§‘ Human (20:33:42)

<command-name>/rate-limit-options</command-name>
            <command-message>rate-limit-options</command-message>
            <command-args></command-args>

### ğŸ§‘ Human (20:33:42)

<local-command-stdout>Login interrupted</local-command-stdout>

### ğŸ§‘ Human (20:58:48)

<command-name>/exit</command-name>
            <command-message>exit</command-message>
            <command-args></command-args>

### ğŸ§‘ Human (20:58:48)

<local-command-stdout>Bye!</local-command-stdout>

### ğŸ¤– Assistant (11:44:17)

No response requested.

### ğŸ§‘ Human (11:45:42)

continue

### ğŸ¤– Assistant (11:45:52)

Now I need to remove the duplicated helpers from all 7 test files. Let me do this systematically.

### ğŸ¤– Assistant (11:46:11)

I need to read the full files first. Let me do that.

### ğŸ¤– Assistant (11:46:18)

Good, now I have all files fully read. Let me remove the duplicated helpers from all 7 files in parallel.

### ğŸ¤– Assistant (11:46:47)

All 7 files updated. The "No such module 'Testing'" diagnostics are just SourceKit noise â€” the Testing framework is available when building the test target via Xcode, not standalone SourceKit indexing. Now let me fix the tautological assertions and run the tests.

### ğŸ¤– Assistant (11:46:54)

Now fixing the tautological assertions in `StartScreenTests.swift`. The 3 instances of `>= 0` on lines 35, 44, 53 are always true. But for `TrainingScreen`, `SettingsScreen`, and `ProfileScreen`, they may genuinely have 0 children via `Mirror` (SwiftUI views can reflect differently). Let me check what the `StartScreen` and `InfoScreen` assertions use â€” they use `> 0`. The safest fix: these "view exists" tests should just verify the view can be instantiated without crashing â€” the Mirror assertion is unnecessary. Let me simplify them.

### ğŸ¤– Assistant (11:47:02)

Now fix the `allNavigationDestinationsCanBeCreated` test which has 3 more `>= 0` assertions.

### ğŸ¤– Assistant (11:47:07)

Now let me build and run the tests to verify everything compiles and passes.

### ğŸ¤– Assistant (11:48:30)

The `Mirror.subjectType` comparison doesn't work with Swift's type system. The simplest fix: these tests just verify instantiation succeeds â€” if the constructor doesn't crash, the test passes. Remove the tautological assertions entirely.

### ğŸ¤– Assistant (11:48:42)

Now let me run the tests again to verify.

### ğŸ¤– Assistant (11:49:38)

All tests pass. Now let me update the task status and the review document.

### ğŸ¤– Assistant (11:49:42)

Now let me update the test-review.md fix log and remaining issues section.

### ğŸ¤– Assistant (11:50:06)

All three tasks are complete. Here's a summary of what was done:

## Summary of Fixes

### P1 #1: Extract Shared Test Helpers (DRY Refactor)
- **Created** `PeachTests/Training/TrainingTestHelpers.swift` with three shared free functions:
  - `waitForState(_:_:timeout:)` â€” was duplicated in 7 files
  - `waitForPlayCallCount(_:_:timeout:)` â€” was duplicated in 6 files
  - `waitForFeedbackToClear(_:timeout:)` â€” was in FeedbackTests only
- **Removed** duplicated implementations from all 7 training test files

### P2 #4: Remove Tautological Assertions
- **Removed** 5 always-true `#expect(mirror.children.count >= 0)` assertions in `StartScreenTests.swift`
- View instantiation tests now verify creation succeeds without crashing (no assertion needed â€” Swift Testing passes if no error is thrown)

### P2 #6 / P3 #7: Verified Already Resolved
- Audio tests already use short durations (5-100ms), already split into separate file
- No 1000-iteration loops remain in the codebase

### Verification
- **All 279 tests pass** across 29 test files (28 test files + 1 helper)
- Updated `docs/test-artifacts/test-review.md` fix log â€” no remaining open issues

### ğŸ§‘ Human (11:54:49)

very well. wrap it up.

### ğŸ¤– Assistant (11:55:07)

Done. Committed as `684492c` â€” 10 files changed, +50/-229 lines. All TEA review issues are now resolved.

---

[â† Previous (1a386a241c)](1a386a241c.md) | [Index](index.md) | [Next (60121099d4) â†’](60121099d4.md)
