---
commit: "addde03299a9eb34d2d9e9131efe0bd9bb3277ab"
date: "2026-02-15T02:04:53+01:00"
author: "Michael Sch√ºrig <michael@schuerig.de>"
subject: "Code review fixes for Story 4.3: remove dead code, add deterministic tests"
sessions: ["279e6e0c-dbad-4c61-8b0c-4e6bd73629a3"]
prev: "e92dd618f6.md"
next: "be7d038e2c.md"
---

[‚Üê Previous (e92dd618f6)](e92dd618f6.md) | [Index](index.md) | [Next (be7d038e2c) ‚Üí](be7d038e2c.md)

# Commit addde03299

**Date:** 2026-02-15 02:04:53 UTC+01:00  
**Author:** Michael Sch√ºrig <michael@schuerig.de>

## Commit message

Code review fixes for Story 4.3: remove dead code, add deterministic tests

Review found 10 issues (4 High, 4 Medium, 2 Low). Fixes applied:
- Remove unused Comparison.random() and its 3 stale tests
- Create MockNextNoteStrategy for deterministic test behavior
- Add startup logging (record count, elapsed time) to PeachApp
- Make TrainingSettings injectable via TrainingSession initializer
- Update stale docstrings referencing placeholder/Story 3.2
- Add tests: settings propagation, profile-from-datastore, cold start
- Fix tautological assertion in comparisonRecordContainsCorrectData
- Update epic statuses 1-4 to done in sprint-status.yaml

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>

## Changed files

```
Peach/App/PeachApp.swift                           |   6 +
 Peach/Training/Comparison.swift                    |  41 +--
 Peach/Training/TrainingSession.swift               |  11 +-
 PeachTests/Training/MockNextNoteStrategy.swift     |  67 +++++
 .../Training/TrainingSessionFeedbackTests.swift    |   4 +-
 .../Training/TrainingSessionLifecycleTests.swift   |   4 +-
 PeachTests/Training/TrainingSessionTests.swift     | 280 ++++++++++++---------
 ...rate-adaptive-algorithm-into-trainingsession.md |  15 +-
 docs/implementation-artifacts/sprint-status.yaml   |   8 +-
 9 files changed, 266 insertions(+), 170 deletions(-)
```

## Session `279e6e0c‚Ä¶`

*2026-02-15 00:42:11 UTC ‚Üí 2026-02-15 01:05:01 UTC*

### üßë Human (00:42:11)

<command-message>bmad-bmm-code-review</command-message>
<command-name>/bmad-bmm-code-review</command-name>

### ü§ñ Assistant (00:42:18)

Now let me load the config source and the instructions file.

### ü§ñ Assistant (00:42:29)

Alright, I've loaded and initialized the code review workflow. All variables resolved:

- **User:** Michael
- **Language:** English
- **Skill Level:** intermediate
- **Planning Artifacts:** `docs/planning-artifacts`
- **Implementation Artifacts:** `docs/implementation-artifacts`
- **Template:** false (action-workflow, no output document)

---

**Step 1: Load story and discover changes**

I need to know which story to review. Let me find the available story files.

### ü§ñ Assistant (00:42:38)

Here are the available story files, Michael. Which one would you like me to review?

1. `1-1-create-xcode-project-and-folder-structure.md`
2. `1-2-implement-comparisonrecord-data-model-and-trainingdatastore.md`
3. `2-1-implement-noteplayer-protocol-and-sinewavenoteplayer.md`
4. `2-2-support-configurable-note-duration-and-reference-pitch.md`
5. `3-1-start-screen-and-navigation-shell.md`
6. `3-2-trainingsession-state-machine-and-comparison-loop.md`
7. `3-3-training-screen-ui-with-higher-lower-buttons-and-feedback.md`
8. `3-4-training-interruption-and-app-lifecycle-handling.md`
9. `4-1-implement-perceptualprofile.md`
10. `4-2-implement-nextnotestrategy-protocol-and-adaptivenotestrategy.md`
11. `4-3-integrate-adaptive-algorithm-into-trainingsession.md`

Which story should I review?

### üßë Human (00:43:51)

4-3

### ü§ñ Assistant (00:43:54)

Loading story 4-3 and discovering changes.

### ü§ñ Assistant (00:44:07)

Good - story loaded. No uncommitted changes. Let me check what files were actually changed in the story's commits and load the relevant source code.

### ü§ñ Assistant (00:44:13)

Good. Files match the story's File List plus the story/sprint docs. Now let me execute **Step 1** fully - I need to load the input files (discover_inputs protocol) and read all the implementation files.

### ü§ñ Assistant (00:44:20)

Now let me load the remaining context files - architecture, epic, and supporting source code.

### ü§ñ Assistant (00:44:58)

Good, I now have all the source code loaded. Let me check the sprint status and project context.

### ü§ñ Assistant (00:45:09)

All context loaded. Now I have everything I need. Let me proceed to **Step 2: Build review attack plan** and then **Step 3: Execute adversarial review**.

---

## Step 2: Review Attack Plan

**Acceptance Criteria to validate:**
1. AC#1: TrainingSession uses AdaptiveNoteStrategy instead of random placeholder
2. AC#2: App startup loads PerceptualProfile from stored data
3. AC#3: Profile updated incrementally after each answer, next comparison reflects update
4. AC#4: All algorithm parameters exposed and adjustable
5. AC#5: End-to-end integration tests verify full flow

**Tasks to audit (all marked [x]):** 6 tasks, 31 subtasks - all claimed complete.

**Files to review:**
- `Peach/App/PeachApp.swift`
- `Peach/Training/TrainingSession.swift`
- `Peach/Training/TrainingScreen.swift`
- `PeachTests/Training/TrainingSessionTests.swift`
- `PeachTests/Training/TrainingSessionFeedbackTests.swift`
- `PeachTests/Training/TrainingSessionLifecycleTests.swift`

Now executing the adversarial review against the actual code.

### ü§ñ Assistant (00:45:59)

Now let me check a few more things for the deep dive.

### ü§ñ Assistant (00:46:40)

I now have all the evidence. Here are my findings.

---

## Step 3 & 4: Adversarial Review Findings

**Story:** `4-3-integrate-adaptive-algorithm-into-trainingsession.md`
**Git vs Story Discrepancies:** 2 found (sprint-status.yaml and story .md modified in git but expected as part of workflow)
**Issues Found:** 4 High, 4 Medium, 2 Low

---

## CRITICAL/HIGH ISSUES

### H1: Dead code NOT removed ‚Äî `Comparison.random()` still exists
**Task 6 marked [x]: "Identify and remove temporary random comparison logic"**
- `Comparison.swift:29-55` ‚Äî The entire `random()` static method AND its doc comments describing "Story 3.2 Placeholder Implementation" remain. Task 6 explicitly says remove it, but it's still here.
- Additionally, 3 tests in `TrainingSessionTests.swift:182-211` still test `Comparison.random()` with the OLD range (48-72). These test dead production code.

### H2: No `MockNextNoteStrategy` ‚Äî tests are non-deterministic (AC#5 violation)
- AC#5 requires: "end-to-end flow...verified with mocks"
- The story's own dev notes describe a `MockNextNoteStrategy` extensively (lines 714-731)
- **Reality:** No such mock exists anywhere in the codebase. All 3 test files use the REAL `AdaptiveNoteStrategy` with random behavior.
- This makes every TrainingSession test non-deterministic ‚Äî note selection and difficulty are random, leading to flaky assertions like `TrainingSessionTests.swift:298`: `#expect(abs(record.note2CentOffset) == 100.0 || abs(record.note2CentOffset) <= 100.0)` which is always true for any value 0-100.

### H3: No startup logging for profile loading (Task 2 subtask violation)
- Task 2 subtask marked [x]: "Add startup logging for profile aggregation (record count, time taken)"
- **Reality:** `PeachApp.swift` has ZERO logging ‚Äî no `Logger` import, no log statements whatsoever. Record count and aggregation time are not measured or reported.

### H4: Settings not adjustable at runtime (AC#4 partial violation)
- AC#4: "all algorithm parameters are exposed and adjustable for tuning and discovery"
- **Reality:** `TrainingSession.swift:106`: `private let settings: TrainingSettings = TrainingSettings()` ‚Äî fully immutable. No way to change settings without recompiling.
- The completion notes say "TODO Epic 6: Replace defaults with @AppStorage values" but AC#4 explicitly requires adjustability NOW, not in Epic 6.

---

## MEDIUM ISSUES

### M1: Stale docstrings in TrainingSession.swift
- Line 29: Still says "Generate next comparison (placeholder: random 100 cents until Epic 4)" ‚Äî Epic 4 IS this story, which is supposedly done. This docstring now lies.
- Line 108: "hardcoded for Story 3.2" ‚Äî no longer reflects the story that owns it.

### M2: Stale header comments in Comparison.swift
- Lines 5-14: Entire struct header describes "Story 3.2 Placeholder Implementation" and says "Epic 4 will replace random generation" ‚Äî Epic 4 just did. Comments are misleading.

### M3: Missing test coverage for key ACs
- **No profile-from-datastore startup test (AC#2)**: Dev notes describe `profileLoadingOnStartup()` test ‚Äî does not exist. No test simulates app startup with pre-populated data.
- **No settings propagation test (AC#4)**: Dev notes describe `settingsPropagationToStrategy()` ‚Äî does not exist. Without `MockNextNoteStrategy`, can't verify settings pass-through.
- **No cold start integration test (AC#5)**: No test verifies empty database ‚Üí cold start ‚Üí 100 cent comparisons end-to-end.

### M4: Overly permissive test assertion
- `TrainingSessionTests.swift:298`: `#expect(abs(record.note2CentOffset) == 100.0 || abs(record.note2CentOffset) <= 100.0)` ‚Äî the `||` makes the second condition subsume the first. This passes for ANY value 0-100 cents. It's a tautology for cold start scenarios and provides no real validation.

---

## LOW ISSUES

### L1: Epic statuses not updated in sprint-status.yaml
- Epics 1-4 are ALL marked `in-progress` despite every story being `done`. At minimum `epic-4: done` should be set (this story completes Epic 4).

### L2: `nonisolated(unsafe)` in TrainingScreen preview default
- `TrainingScreen.swift:100`: `nonisolated(unsafe) static var defaultValue` is a Swift 6 concurrency workaround. Works but is a code smell ‚Äî worth a comment explaining why it's needed.

---

**Summary: 4 High, 4 Medium, 2 Low ‚Äî 10 issues total.**

What should I do with these issues, Michael?

1. **Fix them automatically** ‚Äî I'll update the code, remove dead code, add the mock, fix docs, and add missing tests
2. **Create action items** ‚Äî Add to story Tasks/Subtasks for later
3. **Show me details** ‚Äî Deep dive into specific issues

Choose [1], [2], or specify which issue to examine.

### üßë Human (00:48:53)

1

### ü§ñ Assistant (00:49:33)

I'll fix all HIGH and MEDIUM issues. Let me create a task list and start working through them.

### ü§ñ Assistant (00:50:07)

Now let me start implementing. Tasks 1-4 are independent, so I'll do them in parallel.

### ü§ñ Assistant (00:51:05)

Now fix TrainingSession.swift ‚Äî inject settings via init and update stale docstrings.

### ü§ñ Assistant (00:51:21)

Now update the initializer to accept settings.

### ü§ñ Assistant (00:51:34)

Now remove `Comparison.random()` and update the struct header.

### ü§ñ Assistant (00:51:57)

Now add startup logging to PeachApp.swift.

### ü§ñ Assistant (00:52:12)

Now the big one ‚Äî updating all test files. Let me start with TrainingSessionTests.swift.

### ü§ñ Assistant (00:52:22)

Now update all the call sites that destructure the tuple with 4 elements to 5.

### ü§ñ Assistant (00:52:28)

I need to add a 5th element to each tuple destructuring. Let me do a bulk replace.

### ü§ñ Assistant (00:52:45)

Now remove the `Comparison.random()` tests and fix the tautological assertion. Also replace the manually-constructed sessions in profile tests with the fixture.

### ü§ñ Assistant (00:52:53)

Now fix the tautological assertion (M4).

### ü§ñ Assistant (00:53:02)

Now update the manually-constructed TrainingSessions in profile tests to use the fixture. Let me also update those tests to use MockNextNoteStrategy.

### ü§ñ Assistant (00:54:10)

Now update TrainingSessionFeedbackTests.swift.

### ü§ñ Assistant (00:54:19)

Now update TrainingSessionLifecycleTests.swift.

### ü§ñ Assistant (00:54:31)

Now let me run the full test suite.

### ü§ñ Assistant (00:54:43)

Build error ‚Äî `ComparisonRecord` uses `Date` which needs `Foundation`. Let me check the initializer.

### ü§ñ Assistant (00:54:50)

The issue is that `TrainingSessionTests.swift` only imports `Testing` and `@testable import Peach` ‚Äî it doesn't import `Foundation`, which is needed for `Date()`. Let me fix the test.

### ü§ñ Assistant (00:59:03)

All tests pass, including the new ones. Let me update task status and proceed to Step 5.

### ü§ñ Assistant (00:59:09)

All tests pass. Now **Step 5: Update story status and sync sprint tracking.**

All HIGH and MEDIUM issues are fixed, and all ACs are now properly implemented. The story status should be **done**.

Let me update the story file and sprint status.

### ü§ñ Assistant (00:59:26)

Now update the sprint-status.yaml to mark epics 1-4 as done (L1 fix).

### ü§ñ Assistant (00:59:57)

---

**Review Complete!**

**Story Status:** done
**Issues Fixed:** 8 (4 High + 4 Medium)
**Action Items Created:** 0

### Summary of fixes applied:

| Issue | Severity | Fix |
|-------|----------|-----|
| H1: Dead `Comparison.random()` | HIGH | Removed method + 3 stale tests |
| H2: No `MockNextNoteStrategy` | HIGH | Created mock, updated all 3 test files to use it |
| H3: No startup logging | HIGH | Added Logger + timing to PeachApp.swift |
| H4: Settings not injectable | HIGH | Added `settings:` parameter to TrainingSession init |
| M1: Stale TrainingSession docs | MEDIUM | Updated docstrings to reflect adaptive algorithm |
| M2: Stale Comparison.swift header | MEDIUM | Updated struct header to describe current design |
| M3: Missing test coverage | MEDIUM | Added 3 new tests: settings propagation, profile loading, cold start |
| M4: Tautological assertion | MEDIUM | Replaced with deterministic assertions using mock |
| L1: Epic statuses stale | LOW | Updated epics 1-4 to `done` in sprint-status.yaml |

**LOW issue L2** (nonisolated(unsafe) comment) was not fixed as it's cosmetic and doesn't affect correctness.

All tests pass. Story remains **done**. Ready to commit when you'd like.

### üßë Human (01:04:36)

Yes, go ahead, but we need to talk afterwards.

### ü§ñ Assistant (01:05:01)

Committed as `addde03`. Working tree is clean.

What's on your mind, Michael?

---

[‚Üê Previous (e92dd618f6)](e92dd618f6.md) | [Index](index.md) | [Next (be7d038e2c) ‚Üí](be7d038e2c.md)
