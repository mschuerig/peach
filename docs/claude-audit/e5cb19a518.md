---
commit: "e5cb19a518670c8254c126398c577b4040fd7e95"
date: "2026-02-28T19:48:28+01:00"
author: "Michael SchÃ¼rig <michael@schuerig.de>"
subject: "Implement story 22.1: Migrate FrequencyCalculation to Domain Types"
sessions: ["226f58c2-abe6-4295-8e66-53ebd9dcf0e7", "7380dfff-6987-4ecc-b29c-44d481623e25"]
prev: "5fc64e6b6c.md"
next: "952d29df47.md"
---

[â† Previous (5fc64e6b6c)](5fc64e6b6c.md) | [Index](index.md) | [Next (952d29df47) â†’](952d29df47.md)

# Commit e5cb19a518

**Date:** 2026-02-28 19:48:28 UTC+01:00  
**Author:** Michael SchÃ¼rig <michael@schuerig.de>

## Commit message

Implement story 22.1: Migrate FrequencyCalculation to Domain Types

Replace standalone FrequencyCalculation utility with Pitch and MIDINote
domain methods. Add Pitch.init(frequency:referencePitch:) inverse
initializer, make MIDINote.frequency() and Comparison frequency methods
non-throwing, migrate all 7 call sites, migrate 35 tests to domain type
test files, and delete FrequencyCalculation.swift.

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>

## Changed files

```
Peach/Comparison/ComparisonSession.swift           |   4 +-
 Peach/Core/Audio/FrequencyCalculation.swift        |  92 ------
 Peach/Core/Audio/MIDINote.swift                    |   5 +-
 Peach/Core/Audio/Pitch.swift                       |  12 +
 Peach/Core/Audio/SoundFontNotePlayer.swift         |   7 +-
 Peach/Core/Audio/SoundFontPlaybackHandle.swift     |   4 +-
 Peach/Core/Training/Comparison.swift               |   8 +-
 Peach/PitchMatching/PitchMatchingSession.swift     |  19 +-
 .../Core/Audio/FrequencyCalculationTests.swift     | 324 ---------------------
 PeachTests/Core/Audio/MIDINoteTests.swift          |  20 +-
 PeachTests/Core/Audio/PitchTests.swift             | 247 ++++++++++++++++
 .../Core/Audio/SoundFontNotePlayerTests.swift      |   4 +-
 PeachTests/Core/Training/ComparisonTests.swift     |  16 +-
 .../PitchMatching/PitchMatchingSessionTests.swift  |  11 +-
 ...migrate-frequencycalculation-to-domain-types.md | 126 +++++---
 docs/implementation-artifacts/sprint-status.yaml   |   2 +-
 docs/project-context.md                            |   4 +-
 17 files changed, 393 insertions(+), 512 deletions(-)
```

## Session 1 (`226f58c2â€¦`)

*2026-02-28 18:49:17 UTC â†’ 2026-02-28 18:49:26 UTC*

### ğŸ§‘ Human (18:49:17)

<command-message>bmad-bmm-code-review</command-message>
<command-name>/bmad-bmm-code-review</command-name>
<command-args>22.1</command-args>

### ğŸ¤– Assistant (18:49:26)

Now let me load the config source and workflow components.

## Session 2 (`7380dfffâ€¦`)

*2026-02-28 18:18:17 UTC â†’ 2026-02-28 18:48:37 UTC*

### ğŸ§‘ Human (18:18:17)

<command-message>bmad-bmm-dev-story</command-message>
<command-name>/bmad-bmm-dev-story</command-name>
<command-args>22.1</command-args>

### ğŸ¤– Assistant (18:18:36)

Now I'll execute the workflow. Let me start with **Step 1: Find the story and load it**.

The argument "22.1" was provided. Let me find the story file.

### ğŸ¤– Assistant (18:18:39)

Found the story file. Let me load it along with the sprint status and project context.

### ğŸ¤– Assistant (18:18:46)

**Step 2: Load project context**

### ğŸ¤– Assistant (18:19:02)

âœ… **Context Loaded** â€” Story and project context available for implementation.

**Step 3: Detect review continuation**

No "Senior Developer Review (AI)" section exists in the story file.

ğŸš€ **Starting Fresh Implementation**

- Story: `22-1-migrate-frequencycalculation-to-domain-types`
- Story Status: ready-for-dev
- First incomplete task: Task 1 â€” Add `Pitch.init(frequency:referencePitch:)` inverse initializer with tests

**Step 4: Mark story in-progress**

### ğŸ¤– Assistant (18:19:10)

ğŸš€ Starting work on story `22-1-migrate-frequencycalculation-to-domain-types`
Status updated: ready-for-dev â†’ in-progress

Now let me load all the source files I need for Task 1 implementation.

**Step 5: Implement Task 1 â€” Add `Pitch.init(frequency:referencePitch:)` inverse initializer with tests**

### ğŸ¤– Assistant (18:19:37)

Good, `clamped(to:)` exists. Now let me write the failing tests first (RED phase).

### ğŸ¤– Assistant (18:20:11)

Now let me verify the tests fail (RED phase) by building:

### ğŸ¤– Assistant (18:20:33)

Tests correctly fail â€” `Pitch.init(frequency:referencePitch:)` doesn't exist yet. Let me fix the string interpolation compile error and implement the initializer (GREEN phase).

### ğŸ¤– Assistant (18:20:37)

Now implement the inverse initializer in `Pitch.swift`:

### ğŸ¤– Assistant (18:20:46)

Now run the full test suite to verify (GREEN phase):

### ğŸ¤– Assistant (18:21:01)

The issue is that adding a custom init inside the struct body suppresses the synthesized memberwise initializer. I need to put the new init in an extension.

### ğŸ¤– Assistant (18:25:09)

All tests pass. Let me verify the new Pitch tests specifically ran:

### ğŸ¤– Assistant (18:27:35)

All 33 PitchTests pass, including all new inverse conversion and round-trip tests. **TEST SUCCEEDED**.

**Task 1 complete.** Now let me mark Task 1 as done in the story file and move to Task 2.

### ğŸ¤– Assistant (18:27:52)

Now proceeding to **Task 2: Make `MIDINote.frequency()` self-contained**.

### ğŸ¤– Assistant (18:27:57)

Now let me implement Task 2. First, update `MIDINote.frequency()` to delegate to `Pitch` instead of `FrequencyCalculation`:

### ğŸ¤– Assistant (18:28:03)

Now I need to find all call sites that use `try` with `MIDINote.frequency()`:

### ğŸ¤– Assistant (18:28:07)

Now let me update the MIDINote tests to remove `try`:

### ğŸ¤– Assistant (18:28:16)

Now find and update all call sites of `MIDINote.frequency()` that use `try`. Let me check the callers in the production code:

### ğŸ¤– Assistant (18:28:28)

Good â€” no remaining call sites use `try` with `MIDINote.frequency()`. The `FrequencyCalculation` call sites will be migrated in later tasks. Let me now build and run the full test suite:

### ğŸ¤– Assistant (18:29:26)

All tests pass. **Task 2 complete.** Let me mark it and proceed to Task 3.

### ğŸ¤– Assistant (18:29:39)

Now **Task 3: Migrate `Comparison.swift` forward conversion call sites**.

### ğŸ¤– Assistant (18:29:49)

Now find and fix all callers of `note1Frequency()` and `note2Frequency()` that use `try`:

### ğŸ¤– Assistant (18:30:12)

Now let me run the tests to verify Task 3:

### ğŸ¤– Assistant (18:31:15)

All tests pass. **Task 3 complete.** Let me mark it and continue with Task 4.

### ğŸ¤– Assistant (18:31:28)

**Task 4: Migrate `PitchMatchingSession.swift` forward conversion call sites**.

### ğŸ¤– Assistant (18:31:41)

Let me check the types to make sure `referenceFrequency` is correct:

### ğŸ¤– Assistant (18:31:45)

Good â€” `referenceFrequency` is `Double?`, so `.rawValue` is correct. Now let me also check if `FrequencyCalculation` import is still used in PitchMatchingSession:

### ğŸ¤– Assistant (18:31:49)

No more `FrequencyCalculation` references in PitchMatchingSession. Let me also check the test file for PitchMatchingSession:

### ğŸ¤– Assistant (18:31:57)

The tests still reference `FrequencyCalculation` directly â€” those will be migrated in Task 7. Let me run the suite:

### ğŸ¤– Assistant (18:32:50)

**Task 4 complete.** Let me mark it and proceed to Task 5.

### ğŸ¤– Assistant (18:32:59)

**Task 5: Migrate `SoundFontNotePlayer.swift` inverse conversion call site**.

### ğŸ¤– Assistant (18:33:08)

Wait, I need to check what `freq` is typed as in the method signature:

### ğŸ¤– Assistant (18:33:17)

The parameter name is `frequency`, not `freq`. Let me fix:

### ğŸ¤– Assistant (18:34:19)

**Task 5 complete.** Mark it and proceed to Task 6.

### ğŸ¤– Assistant (18:34:26)

**Task 6: Migrate `SoundFontPlaybackHandle.swift` inverse conversion call site**.

### ğŸ¤– Assistant (18:35:33)

**Task 6 complete.** Mark it and proceed to Task 7.

### ğŸ¤– Assistant (18:35:43)

**Task 7: Migrate FrequencyCalculation tests to domain type tests**.

Let me analyze the existing FrequencyCalculation tests and map them to the appropriate domain type tests. I need to migrate:
1. Forward conversion tests â†’ `PitchTests.swift` and `MIDINoteTests.swift`
2. Inverse conversion tests â†’ `PitchTests.swift` (testing `Pitch.init(frequency:)`)
3. Round-trip tests â†’ `PitchTests.swift`
4. Reference pitch validation tests â†’ Drop (architecture says no validation)

Let me first check which tests are already covered by my new PitchTests, then add the remaining ones.

### ğŸ¤– Assistant (18:36:02)

Now I need to add the migrated tests that aren't already covered. Let me read the current PitchTests to find what's missing.

### ğŸ¤– Assistant (18:36:20)

Now let me add the migrated tests that aren't already covered. I'll add forward conversion edge cases and the cents range validation to PitchTests, and boundary frequency tests to MIDINoteTests:

### ğŸ¤– Assistant (18:36:42)

Now add MIDI boundary frequency tests to MIDINoteTests:

### ğŸ¤– Assistant (18:36:48)

Now I need to handle the PitchMatchingSessionTests that still reference FrequencyCalculation. Let me update those:

### ğŸ¤– Assistant (18:37:16)

Now check if `FrequencyCalculation` is still referenced anywhere in PitchMatchingSessionTests:

### ğŸ¤– Assistant (18:37:21)

Good. Now let me run the full test suite:

### ğŸ¤– Assistant (18:39:17)

All tests pass. Now delete `FrequencyCalculationTests.swift` as part of Task 7:

### ğŸ¤– Assistant (18:39:28)

Now run the suite again to make sure nothing broke:

### ğŸ¤– Assistant (18:40:28)

**Task 7 complete.** Mark it and proceed to Task 8.

### ğŸ¤– Assistant (18:40:38)

**Task 8: Delete `FrequencyCalculation.swift` and verify**.

First, check remaining references:

### ğŸ¤– Assistant (18:40:44)

Two remaining references in test files:

1. `SoundFontNotePlayerTests.swift:60` â€” uses `FrequencyCalculation.midiNoteAndCents`
2. `ComparisonSessionIntegrationTests.swift:22` â€” function name `usesCorrectFrequencyCalculation` (just a function name, not a type reference)

Let me fix the SoundFontNotePlayerTests:

### ğŸ¤– Assistant (18:40:53)

Now check the ComparisonSessionIntegrationTests reference:

### ğŸ¤– Assistant (18:40:58)

Good â€” `usesCorrectFrequencyCalculation` is just a function name, not a type reference. No change needed.

Now verify there are no remaining `FrequencyCalculation` type references in Swift files (excluding FrequencyCalculation.swift itself and comments):

### ğŸ¤– Assistant (18:41:03)

- `PitchTests.swift` â€” just a comment (`// MARK: - Forward Conversion Edge Cases (migrated from FrequencyCalculationTests)`)
- `ComparisonSessionIntegrationTests.swift` â€” just a function name
- `FrequencyCalculation.swift` â€” the file itself, about to be deleted

Let me now delete `FrequencyCalculation.swift`:

### ğŸ¤– Assistant (18:41:06)

Now run the dependency check and full test suite:

### ğŸ¤– Assistant (18:43:09)

All dependency rules pass, all tests pass. Let me do the final grep verification:

### ğŸ¤– Assistant (18:43:14)

Zero references to `FrequencyCalculation` in production code. 

**Task 8 complete.** Let me mark it in the story file:

### ğŸ¤– Assistant (18:43:23)

All 8 tasks complete. Now proceeding to **Step 9: Story completion and mark for review**.

Let me do the final validation:

### ğŸ¤– Assistant (18:45:05)

Now update the story file with the Dev Agent Record, File List, Change Log, and Status:

### ğŸ¤– Assistant (18:45:33)

Now update the sprint status to "review":

### ğŸ¤– Assistant (18:45:39)

âœ… Story status updated to "review" in sprint-status.yaml

Now I also need to update `project-context.md` â€” there's a rule referencing `FrequencyCalculation.swift` that's now outdated:

### ğŸ¤– Assistant (18:45:48)

Also update the "Domain Rules" section:

### ğŸ¤– Assistant (18:46:04)

Now **Step 10: Completion communication**.

---

âœ… **Story 22.1 implementation complete and ready for review.**

**Summary:**

- **Story:** 22-1-migrate-frequencycalculation-to-domain-types
- **Key changes:**
  - Added `Pitch.init(frequency:referencePitch:)` â€” inverse conversion (Hz â†’ Pitch) using `69 + 12 * log2(freq/ref)` formula
  - Made `MIDINote.frequency()` non-throwing by delegating to `Pitch.frequency()`
  - Made `Comparison.note1Frequency()`/`note2Frequency()` non-throwing
  - Migrated all 7 `FrequencyCalculation` call sites across `Comparison.swift`, `PitchMatchingSession.swift`, `SoundFontNotePlayer.swift`, and `SoundFontPlaybackHandle.swift`
  - Migrated all 35 FrequencyCalculation tests to `PitchTests` and `MIDINoteTests` (reference pitch validation tests dropped per architecture)
  - Deleted `FrequencyCalculation.swift` and `FrequencyCalculationTests.swift`
  - Updated `project-context.md` to reflect the new canonical conversion methods
- **Tests:** 28 new tests added, all existing tests pass (zero regressions)
- **Files modified:** 12 files, 2 files deleted
- **Story file:** `docs/implementation-artifacts/22-1-migrate-frequencycalculation-to-domain-types.md` (status: review)

Michael, would you like me to explain any of the implementation decisions, or would you like to run the code review workflow next?

### ğŸ§‘ Human (18:48:13)

commit this

### ğŸ¤– Assistant (18:48:33)

Committed as `e5cb19a`. Working tree is clean.

### ğŸ§‘ Human (18:48:37)

<command-name>/exit</command-name>
            <command-message>exit</command-message>
            <command-args></command-args>

### ğŸ§‘ Human (18:48:37)

<local-command-stdout>Goodbye!</local-command-stdout>

---

[â† Previous (5fc64e6b6c)](5fc64e6b6c.md) | [Index](index.md) | [Next (952d29df47) â†’](952d29df47.md)
