---
commit: "069399246057ce0b7f3423d42ca58ae2d7f26a12"
date: "2026-02-24T14:09:52+01:00"
author: "Michael SchÃ¼rig <michael@schuerig.de>"
subject: "Implement story 9.2: Rethink Profile Display and Progress Tracking"
sessions: ["015cc230-6e45-44b6-8794-2543094490d5"]
prev: "a18dbb497e.md"
next: "71ea1a2cd5.md"
---

[â† Previous (a18dbb497e)](a18dbb497e.md) | [Index](index.md) | [Next (71ea1a2cd5) â†’](71ea1a2cd5.md)

# Commit 0693992460

**Date:** 2026-02-24 14:09:52 UTC+01:00  
**Author:** Michael SchÃ¼rig <michael@schuerig.de>

## Commit message

Implement story 9.2: Rethink Profile Display and Progress Tracking

Replace per-note confidence band with threshold convergence time-series
chart. Data is aggregated by period (default: day) with internally
parameterized aggregation component. Chart shows aggregated period dots,
rolling mean line, and stddev band. Tap popup shows day summary instead
of individual comparison details.

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>

## Changed files

```
Peach/App/PeachApp.swift                           |  11 +-
 Peach/Core/Profile/ThresholdTimeline.swift         | 135 +++++++
 Peach/Profile/ConfidenceBandView.swift             | 137 -------
 Peach/Profile/PianoKeyboardView.swift              |  62 ---
 Peach/Profile/ProfileScreen.swift                  | 127 ++----
 Peach/Profile/ThresholdTimelineView.swift          | 215 +++++++++++
 Peach/Resources/Localizable.xcstrings              | 114 ++++++
 Peach/Start/ProfilePreviewView.swift               |  71 ++--
 Peach/Training/TrainingSession.swift               |   7 +
 .../Core/Profile/ThresholdTimelineTests.swift      | 424 +++++++++++++++++++++
 PeachTests/Profile/ProfileScreenLayoutTests.swift  |  58 ++-
 PeachTests/Profile/ProfileScreenTests.swift        | 200 +---------
 PeachTests/Start/ProfilePreviewViewTests.swift     | 105 ++---
 ...ethink-profile-display-and-progress-tracking.md | 189 +++++----
 docs/implementation-artifacts/sprint-status.yaml   |   2 +-
 15 files changed, 1155 insertions(+), 702 deletions(-)
```

## Session `015cc230â€¦`

*2026-02-24 12:51:56 UTC â†’ 2026-02-24 13:10:04 UTC*

### ğŸ§‘ Human (12:51:56)

<command-message>bmad-bmm-dev-story</command-message>
<command-name>/bmad-bmm-dev-story</command-name>
<command-args>9-2 We need to revisit the implementation and possibly the story. I think we should try to aggregate data over a period of time, not show every comparison. Change the graph, so that data for a day are aggregated. Make the period of time internally parameterized.</command-args>

### ğŸ¤– Assistant (12:52:04)

Now let me load the config source, instructions, and project context.

### ğŸ¤– Assistant (12:52:27)

I've loaded the story file and all context. Story 9-2 is currently in **review** status with all tasks marked complete. You're asking to revisit the implementation to aggregate data by time period (day) rather than showing every individual comparison, with the aggregation period being internally parameterized.

Let me first understand the current implementation before proposing changes.

### ğŸ¤– Assistant (12:52:38)

Now I have a clear picture of the current implementation. Let me also check the remaining test files that were modified.

### ğŸ¤– Assistant (12:53:23)

I've loaded the full context. Here's my analysis of the current state and what needs to change:

## Current State

Story 9-2 is in **review** status with all 9 tasks complete. The current implementation:
- Shows **every individual comparison** as a PointMark dot on the chart
- Rolling mean/stddev are computed per-comparison with a sliding window of 20 comparisons
- Tap-for-details shows individual comparison info (note name, cent difference, correct/incorrect)

## Proposed Changes

Your request is to **aggregate data by day** instead of showing every comparison, with the aggregation period internally parameterized. Here's what I'd change:

### 1. ThresholdTimeline (service layer)

- Add an `AggregatedDataPoint` struct:
  - `periodStart: Date` (start of day)
  - `meanThreshold: Double` (mean cent difference for all comparisons that day)
  - `comparisonCount: Int`
  - `correctCount: Int`
- Add a `aggregationComponent: Calendar.Component` parameter (default `.day`) â€” this is the internally parameterized period
- Add computed `aggregatedPoints` property that groups raw data points by period
- **Redefine `rollingMean()` and `rollingStdDev()`** to operate on aggregated period points, not individual comparisons. The window now counts periods (days), not individual comparisons.
- Keep raw `dataPoints` for internal storage and `ComparisonObserver` incremental updates

### 2. ThresholdTimelineView (chart)

- **PointMark** plots aggregated day points (`meanThreshold`) instead of individual comparisons
- Rolling mean/stddev lines and band unchanged in rendering â€” the data from the service is now aggregated
- **Tap popup** shows day summary: date, mean threshold, comparison count, accuracy rate â€” instead of individual comparison details
- Remove note name from popup (aggregated across many notes in a day)

### 3. ProfilePreviewView

- Uses `rollingMean()` â€” works unchanged since the service now returns aggregated data

### 4. Tests

- Add aggregation tests (grouping by day, correct counts, mean computation)
- Update rolling mean/stddev tests for period-based windowing
- Update detail popup expectations

### 5. Story file

- Update relevant ACs (particularly #1 dotsâ†’aggregated points, #4 tap details)
- Update tasks to reflect the changes

Does this direction look right to you, Michael? Any adjustments before I start implementing?

### ğŸ§‘ Human (12:55:15)

yes, go ahead

### ğŸ¤– Assistant (12:56:03)

Now let me start with TDD â€” write failing tests for the aggregation logic first, then implement.

### ğŸ¤– Assistant (12:58:14)

Let me also check how ThresholdTimeline is wired in PeachApp.swift and TrainingSession.swift.

### ğŸ¤– Assistant (12:58:25)

Good â€” I have the full picture. Let me implement the changes. Starting with the service layer (ThresholdTimeline), then tests, then the view.

### ğŸ¤– Assistant (12:58:44)

Now update the tests to cover aggregation behavior. The key change: rolling stats now operate on aggregated day points, so test data needs to span multiple days.

### ğŸ¤– Assistant (12:59:43)

The diagnostics are SourceKit resolution noise â€” those types exist in the project and compiled before. Now let me update the view to use aggregated data.

### ğŸ¤– Assistant (13:00:15)

Now update the ProfilePreviewView â€” its sparkline uses `rollingMean()` which now returns aggregated data, but the preview data needs to span multiple days.

### ğŸ¤– Assistant (13:00:22)

Now update the ProfileScreen preview data to use day-spaced records.

### ğŸ¤– Assistant (13:00:33)

Now update the ProfileScreen preview data to use day-spaced records.

### ğŸ¤– Assistant (13:00:40)

Now let me update the ProfileScreenLayoutTests that test the accessibility summary â€” they create records at hourly intervals which would all aggregate into the same day.

### ğŸ¤– Assistant (13:00:50)

Now update the ProfilePreviewViewTests â€” those create records at 60-second intervals which would all be on the same day.

### ğŸ¤– Assistant (13:01:00)

Now let me also add the localized strings for the new popup text. Let me check what new strings we need.

### ğŸ¤– Assistant (13:01:25)

The SourceKit "No such module 'Testing'" errors are IDE noise â€” the Testing framework resolves at build time. Let me run the full test suite to verify everything compiles and passes.

### ğŸ¤– Assistant (13:02:39)

**TEST SUCCEEDED** â€” all tests pass. Let me now update the tasks and add German translations for the new strings.

### ğŸ¤– Assistant (13:02:44)

Now let me add German translations for the new localized strings. Let me find the relevant section in the xcstrings file.

### ğŸ¤– Assistant (13:02:57)

Let me check if "Correct" and "Incorrect" are still used elsewhere (they were in the old popup).

### ğŸ¤– Assistant (13:03:01)

Good â€” "Correct"/"Incorrect" are still used in `FeedbackIndicator.swift`, so they stay. Now let me add the new German translations for the popup strings. Let me find where to insert them in the xcstrings file.

### ğŸ¤– Assistant (13:04:11)

Let me simplify the popup text to avoid percent-sign format string ambiguity in localization, and add the German translations.

### ğŸ¤– Assistant (13:04:17)

Now add German translations for the new strings. Let me insert them in alphabetical order in the xcstrings file.

### ğŸ¤– Assistant (13:04:28)

Now add the "average" string. It goes alphabetically between "Audio" and "Cello".

### ğŸ¤– Assistant (13:04:34)

Now let me run the full test suite again to make sure everything still passes after the localization changes.

### ğŸ¤– Assistant (13:05:33)

**TEST SUCCEEDED** â€” all tests pass. Now let me update the story file to document the aggregation changes.

### ğŸ¤– Assistant (13:05:42)

Now update AC #1 to reflect aggregated data instead of individual comparisons.

### ğŸ¤– Assistant (13:05:50)

Now update AC #4 for the tap-for-details popup.

### ğŸ¤– Assistant (13:05:57)

Now update the Change Log and Completion Notes in the Dev Agent Record.

### ğŸ¤– Assistant (13:06:10)

Now update the Completion Notes.

### ğŸ¤– Assistant (13:06:24)

Now update the story status back to "review" and the sprint status.

### ğŸ¤– Assistant (13:06:44)

Implementation complete. Here's a summary of all changes:

## Summary

### What changed

**ThresholdTimeline service** (`Peach/Core/Profile/ThresholdTimeline.swift`):
- Added `AggregatedDataPoint` struct: `periodStart`, `meanThreshold`, `comparisonCount`, `correctCount`
- Added `aggregationComponent: Calendar.Component` parameter (default `.day`) â€” this is the internally parameterized aggregation period
- Added computed `aggregatedPoints` property that groups raw data by calendar period using `Calendar.dateInterval(of:for:)`
- `rollingMean()` and `rollingStdDev()` now operate on aggregated period points instead of individual comparisons

**ThresholdTimelineView** (`Peach/Profile/ThresholdTimelineView.swift`):
- PointMark now plots `aggregatedPoints` (one dot per day) instead of individual comparisons
- Tap popup shows day summary: date, mean threshold, comparison count, accuracy fraction
- Zoom minimum changed from 20 comparisons to 7 periods

**ProfileScreen** (`Peach/Profile/ProfileScreen.swift`):
- Accessibility summary uses `aggregatedPoints` for date range

**Localization** (`Localizable.xcstrings`):
- Added German translations: "average"â†’"Durchschnitt", pluralized "%lld comparisons"â†’"%lld Vergleiche", "%lld of %lld correct"â†’"%lld von %lld richtig"

**Tests** (27 tests in `ThresholdTimelineTests.swift`):
- Rewrote with day-spaced data
- Added: `AggregatedDataPoint` fields, same-day aggregation, absolute values, correct counts, chronological ordering, hourly aggregation period, rolling stats over aggregated periods

**All tests pass** (full suite).

### ğŸ§‘ Human (13:09:35)

commit this

### ğŸ¤– Assistant (13:10:00)

Committed as `0693992` on `main`. Working tree is clean.

### ğŸ§‘ Human (13:10:04)

<command-name>/exit</command-name>
            <command-message>exit</command-message>
            <command-args></command-args>

### ğŸ§‘ Human (13:10:04)

<local-command-stdout>See ya!</local-command-stdout>

---

[â† Previous (a18dbb497e)](a18dbb497e.md) | [Index](index.md) | [Next (71ea1a2cd5) â†’](71ea1a2cd5.md)
