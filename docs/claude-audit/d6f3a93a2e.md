---
commit: "d6f3a93a2e0ebb42f66f54e85455dfcf2c92baa8"
date: "2026-02-28T21:01:29+01:00"
author: "Michael Sch√ºrig <michael@schuerig.de>"
subject: "Implement story 22.2: Domain Type Documentation and API Cleanup"
sessions: ["835cd325-840e-4499-9faa-01048fe3be26"]
prev: "a20bd35147.md"
next: "5fc64e6b6c.md"
---

[‚Üê Previous (a20bd35147)](a20bd35147.md) | [Index](index.md) | [Next (5fc64e6b6c) ‚Üí](5fc64e6b6c.md)

# Commit d6f3a93a2e

**Date:** 2026-02-28 21:01:29 UTC+01:00  
**Author:** Michael Sch√ºrig <michael@schuerig.de>

## Commit message

Implement story 22.2: Domain Type Documentation and API Cleanup

Add class-level doc comments to all 6 audio domain types (MIDINote,
Interval, Frequency, Pitch, TuningSystem, Cents). Remove
MIDINote.frequency() convenience method ‚Äî callers now go through
Pitch explicitly. Remove implicit defaults from Pitch.frequency(),
Pitch.init(frequency:), Comparison.note1Frequency/note2Frequency,
and TrainingSettings.init(referencePitch:). Change referencePitch
from Double to Frequency in TrainingSettings and Comparison methods.
Extract magic numbers in Pitch.swift into named constants
(referenceMIDINote, semitonesPerOctave, centsPerSemitone, octaveRatio).

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>

## Changed files

```
Peach/Comparison/ComparisonSession.swift           |  2 +-
 Peach/Core/Algorithm/NextComparisonStrategy.swift  |  4 +-
 Peach/Core/Audio/Cents.swift                       |  5 ++
 Peach/Core/Audio/Frequency.swift                   |  4 ++
 Peach/Core/Audio/Interval.swift                    |  4 ++
 Peach/Core/Audio/MIDINote.swift                    |  9 +--
 Peach/Core/Audio/Pitch.swift                       | 30 ++++++++--
 Peach/Core/Audio/TuningSystem.swift                |  5 ++
 Peach/Core/Training/Comparison.swift               |  8 +--
 Peach/PitchMatching/PitchMatchingSession.swift     |  6 +-
 .../ComparisonSessionIntegrationTests.swift        |  2 +-
 .../Comparison/ComparisonSessionResetTests.swift   |  4 +-
 .../Core/Algorithm/KazezNoteStrategyTests.swift    | 30 +++++-----
 PeachTests/Core/Audio/MIDINoteTests.swift          | 14 ++---
 PeachTests/Core/Audio/PitchTests.swift             | 12 ++--
 PeachTests/Core/Training/ComparisonTests.swift     | 10 ++--
 .../PitchMatching/PitchMatchingSessionTests.swift  | 18 +++---
 PeachTests/Settings/SettingsTests.swift            |  4 +-
 ...-2-domain-type-documentation-and-api-cleanup.md | 69 ++++++++++++++++++++++
 docs/project-context.md                            |  2 +-
 20 files changed, 174 insertions(+), 68 deletions(-)
```

## Session `835cd325‚Ä¶`

*2026-02-28 19:34:31 UTC ‚Üí 2026-02-28 20:01:47 UTC*

### üßë Human (19:34:31)

Implement the following plan:

# Plan: Domain Type Documentation and API Cleanup

## Context

The 6 audio domain types (MIDINote, Interval, Frequency, Pitch, TuningSystem, Cents) lack class-level documentation explaining their roles, relationships, and design decisions. Several methods have implicit 440.0/12-TET defaults that hide tuning system assumptions. `MIDINote.frequency()` is a convenience that bypasses the tuning-aware path (`MIDINote.pitch(at:in:)`). This work adds documentation, removes misleading defaults, and removes `MIDINote.frequency()`.

## Changes

### 1. Add class-level documentation to 6 domain types

Each type gets a `///` doc comment on the struct/enum explaining its role, key relationships, and design decisions.

**Files:**
- `Peach/Core/Audio/MIDINote.swift` ‚Äî discrete position on the 12-TET grid (0-127); use `pitch(at:in:)` for tuning-aware conversion
- `Peach/Core/Audio/Interval.swift` ‚Äî semitone distance between two notes (prime through octave)
- `Peach/Core/Audio/Frequency.swift` ‚Äî physical frequency in Hz; the final output of pitch-to-sound conversion
- `Peach/Core/Audio/Pitch.swift` ‚Äî resolved representation of a point in pitch space (note + baked-in cent offset); tuning system already applied by the time a Pitch exists; `frequency(referencePitch:)` is pure math
- `Peach/Core/Audio/TuningSystem.swift` ‚Äî defines how intervals map to cent offsets; enum (not protocol) for future Settings picker
- `Peach/Core/Audio/Cents.swift` ‚Äî microtonal offset in 1/1200ths of an octave; universal unit, not 12-TET specific

### 2. Remove `MIDINote.frequency()` method

- Delete `MIDINote.frequency(referencePitch:)` at `MIDINote.swift:22-24`
- This method hides the tuning system by assuming 12-TET (cents=0)
- **No production callers** ‚Äî only 3 test callers in `MIDINoteTests.swift`
- Update `MIDINoteTests` to use `Pitch(note:cents:).frequency(referencePitch:)` explicitly

### 3. Remove parameter defaults from frequency conversion methods

All production callers already pass explicit values. Only test code uses defaults (18 call sites).

| Method | File | Default removed | Test callers to fix |
|--------|------|----------------|-------------------|
| `Pitch.frequency(referencePitch:)` | `Pitch.swift:7` | `= .concert440` | 1 in PitchTests |
| `Pitch.init(frequency:referencePitch:)` | `Pitch.swift:14` | `= .concert440` | 1 in PitchTests |
| `Comparison.note1Frequency(referencePitch:)` | `Comparison.swift:12` | `= 440.0` | 3 in ComparisonTests |
| `Comparison.note2Frequency(referencePitch:)` | `Comparison.swift:16` | `= 440.0` | 2 in ComparisonTests |
| `TrainingSettings.init(referencePitch:)` | `NextComparisonStrategy.swift:62` | `= 440.0` | 5 across 4 test files |

### 4. Update test callers (18 call sites)

Add explicit `referencePitch:` / `.concert440` to all test call sites that relied on defaults:

- `PeachTests/Core/Audio/MIDINoteTests.swift` ‚Äî 3 calls: replace `MIDINote(x).frequency()` with `Pitch(note: MIDINote(x), cents: Cents(0)).frequency(referencePitch: .concert440)`
- `PeachTests/Core/Audio/PitchTests.swift` ‚Äî 2 calls: add explicit `.concert440`
- `PeachTests/Core/Training/ComparisonTests.swift` ‚Äî 5 calls: add explicit `referencePitch: 440.0`
- `PeachTests/Core/Algorithm/KazezNoteStrategyTests.swift` ‚Äî uses `TrainingSettings()`: add explicit params
- `PeachTests/Settings/SettingsTests.swift` ‚Äî uses `TrainingSettings()`: add explicit params
- `PeachTests/Comparison/ComparisonSessionResetTests.swift` ‚Äî 2 uses of `TrainingSettings()`: add explicit params
- `PeachTests/Comparison/ComparisonSessionIntegrationTests.swift` ‚Äî 1 use of `TrainingSettings()`: add explicit params

### 5. Update story file and sprint status

- Update `docs/implementation-artifacts/22-1-...` or create a new story file as appropriate
- Update `docs/project-context.md` line 81 to note that `MIDINote.frequency()` no longer exists

## Files modified (summary)

**Production (6 + 2):**
- `Peach/Core/Audio/Pitch.swift` ‚Äî docs + remove 2 defaults
- `Peach/Core/Audio/MIDINote.swift` ‚Äî docs + remove `frequency()` method
- `Peach/Core/Audio/Frequency.swift` ‚Äî docs only
- `Peach/Core/Audio/Interval.swift` ‚Äî docs only
- `Peach/Core/Audio/TuningSystem.swift` ‚Äî docs only
- `Peach/Core/Audio/Cents.swift` ‚Äî docs only
- `Peach/Core/Training/Comparison.swift` ‚Äî remove 2 defaults
- `Peach/Core/Algorithm/NextComparisonStrategy.swift` ‚Äî remove TrainingSettings default

**Tests (7):**
- `PeachTests/Core/Audio/MIDINoteTests.swift`
- `PeachTests/Core/Audio/PitchTests.swift`
- `PeachTests/Core/Training/ComparisonTests.swift`
- `PeachTests/Core/Algorithm/KazezNoteStrategyTests.swift`
- `PeachTests/Settings/SettingsTests.swift`
- `PeachTests/Comparison/ComparisonSessionResetTests.swift`
- `PeachTests/Comparison/ComparisonSessionIntegrationTests.swift`

**Docs (1-2):**
- `docs/project-context.md` ‚Äî update MIDI-to-Hz conversion guidance

## Verification

1. `xcodebuild test -scheme Peach -destination 'platform=iOS Simulator,name=iPhone 17'` ‚Äî all 643+ tests pass
2. `tools/check-dependencies.sh` ‚Äî no import violations
3. Grep for `MIDINote` + `.frequency(` ‚Äî zero results in production code
4. Grep for `= 440.0` in method signatures ‚Äî zero results
5. Grep for `= .concert440` in method signatures ‚Äî zero results


If you need specific details from before exiting plan mode (like exact code snippets, error messages, or content you generated), read the full transcript at: /Users/michael/.claude/projects/-Users-michael-Projekte-peach/226f58c2-abe6-4295-8e66-53ebd9dcf0e7.jsonl

### ü§ñ Assistant (19:34:35)

I'll start by reading the project context and all the files that need to be modified. Let me gather everything in parallel.

### ü§ñ Assistant (19:34:43)

Now let me read all the test files that need modification.

### ü§ñ Assistant (19:34:53)

Now let me verify there are no production callers of `MIDINote.frequency()` and check all `TrainingSettings()` usages.

### ü§ñ Assistant (19:34:58)

Let me check how `PitchMatchingSession` uses `.frequency(` to confirm it's not calling `MIDINote.frequency()`.

### ü§ñ Assistant (19:35:05)

Good ‚Äî all production callers already pass explicit parameters to both `TrainingSettings()` and `.frequency()`. Now I have everything I need. Let me create tasks and start implementing.

### ü§ñ Assistant (19:35:19)

### Task 1: Add class-level documentation to 6 domain types

### ü§ñ Assistant (19:35:43)

Those diagnostics are just SourceKit indexing issues from editing files individually ‚Äî they'll resolve on build. Let me continue with Task 2.

### ü§ñ Assistant (19:35:47)

### Task 2: Remove `MIDINote.frequency()` and update test callers

### ü§ñ Assistant (19:35:52)

Now update the 3 test callers in MIDINoteTests. I need to replace the frequency tests that used `MIDINote.frequency()` and the one that used `MIDINote.frequency(referencePitch:)`.

### ü§ñ Assistant (19:36:07)

### Task 3: Remove parameter defaults and update test callers

First, remove the defaults from production code:

### ü§ñ Assistant (19:36:18)

Now update all test callers. Let me handle them file by file:

**PitchTests.swift** ‚Äî 2 calls using defaults:

### ü§ñ Assistant (19:36:28)

**ComparisonTests.swift** ‚Äî 5 calls using defaults:

### ü§ñ Assistant (19:36:40)

**KazezNoteStrategyTests.swift** ‚Äî All `TrainingSettings()` calls need explicit `referencePitch: 440.0`:

### ü§ñ Assistant (19:36:44)

Now I need to check the `TrainingSettings` calls that already have some parameters but not `referencePitch:`. Let me re-read the file to check.

### ü§ñ Assistant (19:36:51)

I need to add `referencePitch: 440.0` to all `TrainingSettings(...)` calls that have other parameters but not `referencePitch`. Let me read the current file.

### ü§ñ Assistant (19:36:57)

I need to add `referencePitch: 440.0` to all the `TrainingSettings(...)` calls that have other parameters but missing `referencePitch`. Let me do them one by one, using unique enough context strings.

### ü§ñ Assistant (19:37:36)

Now **SettingsTests.swift** ‚Äî `TrainingSettings()` call:

### ü§ñ Assistant (19:37:40)

**ComparisonSessionResetTests.swift** ‚Äî 2 `TrainingSettings()` calls:

### ü§ñ Assistant (19:37:44)

**ComparisonSessionIntegrationTests.swift** ‚Äî 1 `TrainingSettings()` call:

### ü§ñ Assistant (19:37:49)

Now let me also check for any other test files that might use `TrainingSettings()` or have calls that use the removed defaults.

### ü§ñ Assistant (19:37:59)

I found additional callers. Let me check them.

### ü§ñ Assistant (19:38:08)

Good ‚Äî `SettingsTests` is just a function name match, not an actual call. The `PitchMatchingSessionTests` reference is just a comment. The `PitchTests` calls all already have explicit `referencePitch:`. No additional changes needed.

Now let me also check if there are any test files I might have missed that create `TrainingSettings` with partial parameters (no `referencePitch:`).

### ü§ñ Assistant (19:38:14)

All test callers now have explicit `referencePitch: 440.0`. Let me also check for any other callers of `.frequency()` without parameters or `Pitch(frequency:)` without `referencePitch:` in the production code.

### ü§ñ Assistant (19:38:22)

### Task 4: Update project-context.md

### ü§ñ Assistant (19:38:30)

Now let me check if there's an existing story file for this work.

### ü§ñ Assistant (19:38:39)

The existing story 22.1 is already done. I need to create a new story file for this work. Let me find the next available story number.

### ü§ñ Assistant (19:39:12)

### Task 5: Run full test suite and verify

### ü§ñ Assistant (19:41:07)

All tests pass. Now let me run the remaining verifications in parallel.

### ü§ñ Assistant (19:41:36)

All verifications pass:

- **Tests**: All pass (`TEST SUCCEEDED`)
- **Dependencies**: All rules pass
- **`MIDINote.frequency(`**: Zero results in production code
- **`= 440.0` in method signatures**: Zero results (the one match is `SettingsKeys.defaultReferencePitch` which is a constant, not a method default)
- **`= .concert440` in method signatures**: Zero results

### ü§ñ Assistant (19:41:46)

All tasks complete. Let me summarize what was done:

**Production changes (8 files):**
- Added `///` doc comments to `MIDINote`, `Interval`, `Frequency`, `Pitch`, `TuningSystem`, `Cents`
- Removed `MIDINote.frequency(referencePitch:)` ‚Äî forces callers through the tuning-aware `Pitch` path
- Removed default parameters from `Pitch.frequency()`, `Pitch.init(frequency:)`, `Comparison.note1Frequency()`, `Comparison.note2Frequency()`, `TrainingSettings.init(referencePitch:)`

**Test changes (7 files):**
- Updated all 18+ call sites to pass explicit `referencePitch:` / `.concert440` / `440.0`

**Docs (2 files):**
- Updated `project-context.md` MIDI-to-Hz conversion guidance
- Created story file `22-2-domain-type-documentation-and-api-cleanup.md`

**Verification:**
- Full test suite passes
- Dependency check passes
- No remaining implicit defaults or `MIDINote.frequency()` in production code

### üßë Human (19:45:41)

In the tests, in where currently the literal 440.0 is used, it should be .concert440.

### ü§ñ Assistant (19:45:48)

Good catch. Let me find all the test sites where `440.0` is used as a reference pitch and should be `.concert440` instead. There are two different patterns: `referencePitch: 440.0` on `Comparison` methods (which take `Double`) and `referencePitch: 440.0` on `TrainingSettings` (which also takes `Double`). Let me check the types first.

### ü§ñ Assistant (19:46:35)

The `Comparison` methods and `TrainingSettings.referencePitch` currently use `Double`, so `.concert440` won't type-check. The clean fix is to change those to `Frequency` so tests (and production code) use the domain type. Let me check the production callers first.

### ü§ñ Assistant (19:46:59)

`userSettings.referencePitch` already returns `Frequency` ‚Äî the production code is unwrapping with `.rawValue` just to pass `Double` to `TrainingSettings`. The right fix is to change `TrainingSettings.referencePitch` and `Comparison` methods to use `Frequency` directly. Let me check the remaining callers.

### ü§ñ Assistant (19:47:06)

I need to check `MockUserSettings` too, since it has `referencePitch` assignments.

### ü§ñ Assistant (19:47:34)

Good ‚Äî `UserSettings.referencePitch` already returns `Frequency`, and `MockUserSettings.referencePitch` is already `Frequency`. The production code unwraps to `Double` unnecessarily. I'll change `TrainingSettings.referencePitch` and `Comparison` methods to `Frequency`, then update all callers.

### ü§ñ Assistant (19:47:43)

Now update the production callers ‚Äî remove the unnecessary `.rawValue` unwrapping and `Frequency(...)` wrapping:

### ü§ñ Assistant (19:47:50)

Now simplify `PitchMatchingSession` where it wraps `Frequency(settings.referencePitch)` ‚Äî since `settings.referencePitch` is already `Frequency`:

### ü§ñ Assistant (19:47:55)

Now update all the test files. Let me do the bulk replacements:

### ü§ñ Assistant (19:48:05)

Now handle the `PitchMatchingSessionTests` and other test files that set `mockSettings.referencePitch = 440.0`. Since `MockUserSettings.referencePitch` is `Frequency`, I can use `.concert440`:

### ü§ñ Assistant (19:48:19)

Now check for `432.0` and other non-440 reference pitch values in tests ‚Äî those should use `Frequency(432.0)` since `.referencePitch` is now `Frequency`:

### ü§ñ Assistant (19:48:32)

The `432.0` values are intentionally non-standard and `Frequency: ExpressibleByFloatLiteral` handles the coercion. Now let me fix the SettingsTests assertion that compares `Double` with `Frequency`:

### ü§ñ Assistant (19:48:46)

Now I need to check for `MockNextComparisonStrategy` since it captures `TrainingSettings` and its `referencePitch` changed type:

### ü§ñ Assistant (19:48:55)

Good ‚Äî `MockNextComparisonStrategy` just stores `TrainingSettings`, so it will pick up the type change automatically. Now let me also check for any remaining `440.0` literals in test files that reference pitch:

### ü§ñ Assistant (19:49:07)

The remaining `440.0` occurrences are raw frequency values passed to `NotePlayer.play(frequency:)` (which takes `Double`) and assertion comparisons ‚Äî not reference pitch parameters. Those are correct as-is.

Let me run the tests to verify everything compiles and passes:

### ü§ñ Assistant (19:50:07)

All tests pass. Let me also update the story file to reflect the additional `Frequency` type change:

### ü§ñ Assistant (19:50:31)

Done. Here's a summary of the additional changes:

**Production:** Changed `TrainingSettings.referencePitch` and `Comparison.note1Frequency/note2Frequency` from `Double` to `Frequency`. This let us remove the `.rawValue` unwrap in `ComparisonSession` and `PitchMatchingSession` where `userSettings.referencePitch` (already `Frequency`) was being demoted to `Double`, and the redundant `Frequency(settings.referencePitch)` wrapping in `PitchMatchingSession`.

**Tests:** All `referencePitch: 440.0` call sites now use `referencePitch: .concert440` ‚Äî across `ComparisonTests`, `KazezNoteStrategyTests`, `SettingsTests`, `ComparisonSessionResetTests`, `ComparisonSessionIntegrationTests`, and `PitchMatchingSessionTests`. Non-440 values like `432.0` remain as numeric literals (they coerce via `ExpressibleByFloatLiteral`).

### üßë Human (19:57:10)

Pitch contains magic numbers: 69, 69.0, 100.0, 2.0, 12.0. All of them imply concepts that must be explicit.
* A4 is MIDI note 69. This is the note whose frequency is used as the reference pitch.
* The distance from one note to the next is one semitone or 100 cents
* There are 12 notes in an octave
* There's a factor of 2 for the frequency of a note and its octave.

All of this must be made a lot clearer.

### ü§ñ Assistant (19:57:15)

Let me read the current state of Pitch.swift.

### ü§ñ Assistant (19:57:19)

Let me also check if `MIDINote` already has a constant for A4, and what naming conventions exist.

### ü§ñ Assistant (19:57:27)

No existing constant. Let me check where `69` appears elsewhere to understand the scope.

### ü§ñ Assistant (19:57:34)

Only in Pitch.swift. Now I'll replace all magic numbers with named constants.

### ü§ñ Assistant (19:57:46)

Let me verify the result reads cleanly.

### ü§ñ Assistant (19:57:50)

Now run the tests to confirm nothing broke.

### ü§ñ Assistant (19:58:54)

All tests pass. The five magic numbers are now named constants:

- `referenceMIDINote = 69` ‚Äî A4, the MIDI note whose frequency equals the reference pitch
- `semitonesPerOctave = 12.0` ‚Äî MIDI steps in one octave
- `centsPerSemitone = 100.0` ‚Äî subdivision within a semitone
- `octaveRatio = 2.0` ‚Äî frequency doubles per octave

### üßë Human (20:01:03)

commit this

### ü§ñ Assistant (20:01:36)

Committed as `d6f3a93` on `main`. Working tree is clean.

### üßë Human (20:01:47)

<command-name>/exit</command-name>
            <command-message>exit</command-message>
            <command-args></command-args>

### üßë Human (20:01:47)

<local-command-stdout>Bye!</local-command-stdout>

---

[‚Üê Previous (a20bd35147)](a20bd35147.md) | [Index](index.md) | [Next (5fc64e6b6c) ‚Üí](5fc64e6b6c.md)
