---
commit: "ebdfd820800fd93a7e9f7239ebb350e3edb02ced"
date: "2026-02-27T19:23:50+01:00"
author: "Michael SchÃ¼rig <michael@schuerig.de>"
subject: "Implement story 20.6: Extract @Entry environment keys from Core/"
sessions: ["3af61217-43dd-4d51-856f-2a0b53726d8d"]
prev: "45340634d9.md"
next: "4204fddbad.md"
---

[â† Previous (45340634d9)](45340634d9.md) | [Index](index.md) | [Next (4204fddbad) â†’](4204fddbad.md)

# Commit ebdfd82080

**Date:** 2026-02-27 19:23:50 UTC+01:00  
**Author:** Michael SchÃ¼rig <michael@schuerig.de>

## Commit message

Implement story 20.6: Extract @Entry environment keys from Core/

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>

## Changed files

```
Peach/App/EnvironmentKeys.swift                    | 78 +++++++++++++++++++
 Peach/Comparison/ComparisonScreen.swift            | 43 -----------
 Peach/Core/Audio/SoundFontLibrary.swift            |  7 --
 Peach/Core/Profile/ThresholdTimeline.swift         |  7 --
 Peach/Core/Profile/TrendAnalyzer.swift             |  7 --
 Peach/Core/TrainingSession.swift                   |  6 +-
 Peach/PitchMatching/PitchMatchingScreen.swift      | 28 -------
 Peach/Profile/ProfileScreen.swift                  |  6 --
 ...0-6-extract-entry-environment-keys-from-core.md | 87 +++++++++++++++-------
 docs/implementation-artifacts/sprint-status.yaml   |  2 +-
 10 files changed, 139 insertions(+), 132 deletions(-)
```

## Session `3af61217â€¦`

*2026-02-27 18:06:53 UTC â†’ 2026-02-27 18:23:59 UTC*

### ğŸ§‘ Human (18:06:53)

<command-message>bmad-bmm-dev-story</command-message>
<command-name>/bmad-bmm-dev-story</command-name>
<command-args>20.6</command-args>

### ğŸ¤– Assistant (18:06:55)

I'll start by loading the workflow execution framework and the dev-story workflow configuration.

### ğŸ¤– Assistant (18:07:01)

Now let me load the config source and the instructions file.

### ğŸ¤– Assistant (18:07:16)

Now I have all workflow components loaded. Let me resolve variables and execute **Step 1: Find next ready story and load it**.

The argument `20.6` was provided, so I'll look for a story matching this pattern. Let me find the sprint status and the story file.

### ğŸ¤– Assistant (18:07:22)

Found the story. Let me load the complete story file and the project context.

### ğŸ¤– Assistant (18:07:29)

Now let me load the project context (Step 2).

### ğŸ¤– Assistant (18:07:40)

âœ… **Context Loaded** â€” Story and project context available for implementation.

---

**Step 3: Detect review continuation**

No "Senior Developer Review (AI)" section exists in the story file.

ğŸš€ **Starting Fresh Implementation**

- **Story:** `20-6-extract-entry-environment-keys-from-core`
- **Story Status:** ready-for-dev
- **First incomplete task:** Task 1 â€” Create `Peach/App/EnvironmentKeys.swift`

---

**Step 4: Mark story in-progress**

### ğŸ¤– Assistant (18:08:05)

ğŸš€ Starting work on story `20-6-extract-entry-environment-keys-from-core`
Status updated: ready-for-dev â†’ in-progress

---

Now proceeding to **Step 5: Implement tasks**. Let me first read all the source files that need to be modified to understand the existing code.

### ğŸ¤– Assistant (18:08:11)

Now let me read the screen files with @Entry blocks.

### ğŸ¤– Assistant (18:08:19)

Let me check the protocols and types I need for the preview stubs.

### ğŸ¤– Assistant (18:08:57)

Let me check the remaining protocols needed for the stubs.

### ğŸ¤– Assistant (18:09:31)

Let me check a few more types needed for the stubs.

### ğŸ¤– Assistant (18:09:48)

Now I have all the context needed. Let me also quickly check the `PerceptualProfile` class to confirm it conforms to both profile protocols.

### ğŸ¤– Assistant (18:09:55)

Good â€” `PerceptualProfile` conforms to both `PitchDiscriminationProfile` and `PitchMatchingProfile`, so I can use `PerceptualProfile()` directly in the @Entry defaults.

Now I have all the information. This is a structural refactoring (no new tests per Dev Notes), so I'll proceed with implementation.

---

### Task 1: Create `Peach/App/EnvironmentKeys.swift`

### ğŸ¤– Assistant (18:10:18)

### Task 2: Remove @Entry from Core/ files

### ğŸ¤– Assistant (18:10:51)

Now for `TrainingSession.swift` â€” remove the @Entry block and change `import SwiftUI` to `import Foundation`:

### ğŸ¤– Assistant (18:10:55)

### Task 3: Remove @Entry from screen files

### ğŸ¤– Assistant (18:11:19)

All three tasks (1, 2, 3) are complete. The SourceKit diagnostics are expected â€” they're from the IDE indexer which doesn't have the full module context. The real validation is the build. Let me now check if `TrendAnalyzer` and `ThresholdTimeline` need `import Observation` (they use `@Observable`).

### ğŸ¤– Assistant (18:11:32)

Let me check how other `@Observable` classes handle imports in this project.

### ğŸ¤– Assistant (18:11:40)

Good â€” `PerceptualProfile` uses just `import Foundation` + `import OSLog` and still uses `@Observable`. So `import Foundation` alone is sufficient in this project. My edits are correct.

Now let me run the full test suite (Tasks 4 & 5 â€” verify build and tests pass).

### ğŸ¤– Assistant (18:13:50)

All tests pass. Let me now update the story file to mark all tasks complete and update the Dev Agent Record.

### ğŸ¤– Assistant (18:13:55)

Now let me update the story file â€” marking all tasks complete, updating status, file list, dev agent record, and change log.

### ğŸ¤– Assistant (18:14:17)

Now add the Dev Agent Record, File List, and update Change Log.

### ğŸ¤– Assistant (18:14:36)

Now update the sprint status to "review".

### ğŸ¤– Assistant (18:14:50)

âœ… Story status updated to "review" in sprint-status.yaml

---

## Step 10: Completion

âœ… **Story 20.6 implementation complete and ready for review**

**Story:** `20-6-extract-entry-environment-keys-from-core`
**Title:** Extract @Entry Environment Keys from Core/

### Key changes:
- **New file** `Peach/App/EnvironmentKeys.swift` â€” consolidated all 7 `@Entry` definitions with 5 private preview stub types
- **4 Core/ files** no longer `import SwiftUI` â€” domain layer is now framework-free
- **3 screen files** cleaned up â€” @Entry blocks and preview mock classes removed
- **Preview stubs simplified** â€” no longer reference `KazezNoteStrategy`, `AppUserSettings`, or `MockHapticFeedbackManager`
- **Full test suite passes** â€” zero regressions

### Files modified: 10 total (1 new, 9 modified)

**Story file:** `docs/implementation-artifacts/20-6-extract-entry-environment-keys-from-core.md`

Michael, do you have any questions about the implementation? For example:
- How the preview stubs work and why they're simplified
- Why `import Observation` wasn't needed for `@Observable`
- How the environment key registry pattern works

**Next steps:**
- Verify previews render in Xcode (manual step)
- Run `code-review` workflow (recommended with a different LLM)
- Check sprint status: `docs/implementation-artifacts/sprint-status.yaml`

ğŸ’¡ **Tip:** For best results, run `code-review` using a **different** LLM than the one that implemented this story.

### ğŸ§‘ Human (18:23:35)

commit

### ğŸ¤– Assistant (18:23:44)

All changes look clean. Let me stage and commit.

### ğŸ¤– Assistant (18:23:59)

Committed successfully: `ebdfd82 Implement story 20.6: Extract @Entry environment keys from Core/` â€” working tree clean.

---

[â† Previous (45340634d9)](45340634d9.md) | [Index](index.md) | [Next (4204fddbad) â†’](4204fddbad.md)
