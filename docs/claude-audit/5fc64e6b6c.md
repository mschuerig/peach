---
commit: "5fc64e6b6cb8d35a07051890b1962846ef47f55c"
date: "2026-02-28T20:05:04+01:00"
author: "Michael Sch√ºrig <michael@schuerig.de>"
subject: "Fix code review findings for story 22.1 and mark done"
sessions: ["226f58c2-abe6-4295-8e66-53ebd9dcf0e7"]
prev: "d6f3a93a2e.md"
next: "e5cb19a518.md"
---

[‚Üê Previous (d6f3a93a2e)](d6f3a93a2e.md) | [Index](index.md) | [Next (e5cb19a518) ‚Üí](e5cb19a518.md)

# Commit 5fc64e6b6c

**Date:** 2026-02-28 20:05:04 UTC+01:00  
**Author:** Michael Sch√ºrig <michael@schuerig.de>

## Commit message

Fix code review findings for story 22.1 and mark done

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>

## Changed files

```
.../Comparison/ComparisonSessionIntegrationTests.swift       |  4 ++--
 PeachTests/Core/Audio/PitchTests.swift                       |  4 +++-
 PeachTests/Core/Audio/SoundFontNotePlayerTests.swift         |  5 ++---
 PeachTests/PitchMatching/PitchMatchingSessionTests.swift     | 12 ++++++------
 .../22-1-migrate-frequencycalculation-to-domain-types.md     |  5 ++++-
 docs/implementation-artifacts/sprint-status.yaml             |  2 +-
 6 files changed, 18 insertions(+), 14 deletions(-)
```

## Session `226f58c2‚Ä¶`

*2026-02-28 18:49:17 UTC ‚Üí 2026-02-28 19:05:18 UTC*

### üßë Human (18:49:17)

<command-message>bmad-bmm-code-review</command-message>
<command-name>/bmad-bmm-code-review</command-name>
<command-args>22.1</command-args>

### ü§ñ Assistant (18:49:26)

Now let me load the config source and workflow components.

### ü§ñ Assistant (18:49:39)

Good. I've loaded all workflow components. Let me resolve variables and begin executing the code review workflow.

**Resolved Variables:**
- `user_name` = Michael
- `communication_language` = English
- `user_skill_level` = intermediate
- `planning_artifacts` = `docs/planning-artifacts`
- `implementation_artifacts` = `docs/implementation-artifacts`
- `sprint_status` = `docs/implementation-artifacts/sprint-status.yaml`
- `date` = 2026-02-28
- `template` = false ‚Üí action-workflow
- Story argument: **22.1** ‚Üí `epic_num` = 22, `story_num` = 1

---

## Step 1: Load story and discover changes

Let me find the story file for 22.1 and check git status simultaneously.

### ü§ñ Assistant (18:49:47)

Good. Git working tree is **clean** ‚Äî all changes for story 22.1 are committed in `e5cb19a`. Let me now load the story file, project context, and discover input files.

### ü§ñ Assistant (18:50:11)

Good. Story file loaded successfully. Let me now cross-reference git vs story and load the architecture/epic context. I also need to read ALL implementation files.

**Git vs Story File List Cross-Reference:**

| Git Changed | In Story File List? |
|-------------|-------------------|
| `Peach/Comparison/ComparisonSession.swift` | Yes |
| `Peach/Core/Audio/FrequencyCalculation.swift` | Yes (deleted) |
| `Peach/Core/Audio/MIDINote.swift` | Yes |
| `Peach/Core/Audio/Pitch.swift` | Yes |
| `Peach/Core/Audio/SoundFontNotePlayer.swift` | Yes |
| `Peach/Core/Audio/SoundFontPlaybackHandle.swift` | Yes |
| `Peach/Core/Training/Comparison.swift` | Yes |
| `Peach/PitchMatching/PitchMatchingSession.swift` | Yes |
| `PeachTests/Core/Audio/FrequencyCalculationTests.swift` | Yes (deleted) |
| `PeachTests/Core/Audio/MIDINoteTests.swift` | Yes |
| `PeachTests/Core/Audio/PitchTests.swift` | Yes |
| `PeachTests/Core/Audio/SoundFontNotePlayerTests.swift` | Yes |
| `PeachTests/Core/Training/ComparisonTests.swift` | Yes |
| `PeachTests/PitchMatching/PitchMatchingSessionTests.swift` | Yes |
| `docs/project-context.md` | **Not in File List** |
| `docs/implementation-artifacts/sprint-status.yaml` | Expected (infra) |
| `docs/implementation-artifacts/22-1-...` | Expected (story itself) |

Now let me read all the implementation files to perform the adversarial review.

### ü§ñ Assistant (18:50:19)

Now let me read all the test files that were changed.

### ü§ñ Assistant (18:50:26)

Now let me verify `FrequencyCalculation` is truly gone, and check for any remaining issues.

### ü§ñ Assistant (18:50:34)

Let me check for `FrequencyCalculation` references specifically in production and test code (not docs).

### ü§ñ Assistant (18:54:27)

I've now read every file in the story's File List plus git-changed files. Let me complete the adversarial review.

---

## Step 2: Review Attack Plan

**Acceptance Criteria extracted:**
1. Forward conversion migrated ‚Äî all `FrequencyCalculation.frequency()` calls replaced
2. Inverse conversion migrated ‚Äî all `FrequencyCalculation.midiNoteAndCents()` calls replaced
3. FrequencyCalculation deleted ‚Äî zero references remain
4. Precision preserved ‚Äî 0.1-cent frequency precision
5. Full test suite passes

**Tasks marked [x]:** All 8 tasks (with 30+ subtasks) marked complete.

**Review plan:**
1. AC Validation ‚Äî verify each AC against implementation
2. Task Audit ‚Äî verify each [x] task is really done
3. Code Quality ‚Äî security, performance, maintainability
4. Test Quality ‚Äî real tests vs placeholder assertions

---

## Step 3: Adversarial Review Execution

### AC Validation

| AC | Status | Evidence |
|----|--------|----------|
| #1 Forward conversion | **IMPLEMENTED** | `MIDINote.swift:22-24`, `Comparison.swift:12-17`, `PitchMatchingSession.swift:185-186,199-200` ‚Äî all delegate to `Pitch.frequency()` |
| #2 Inverse conversion | **IMPLEMENTED** | `SoundFontNotePlayer.swift:141`, `SoundFontPlaybackHandle.swift:50` ‚Äî both use `Pitch(frequency:referencePitch:)` |
| #3 FrequencyCalculation deleted | **IMPLEMENTED** | No files match `**/FrequencyCalculation*`. Zero references in `Peach/` source. Two residual mentions in `PeachTests/` (function name + comment, neither references the type) |
| #4 Precision preserved | **IMPLEMENTED** | 17+ precision tests in PitchTests: sub-cent, round-trip, boundary, multiple reference pitches |
| #5 Full test suite passes | **CLAIMED** | Git tree is clean, commit passed pre-commit gate. Cannot independently verify without running tests. |

### Task Completion Audit

All 8 tasks and 30+ subtasks verified against code. All marked `[x]` appear genuinely complete. No false claims detected.

### Git vs Story File List Cross-Reference

**Discrepancy found:** `docs/project-context.md` was changed in commit `e5cb19a` (updated MIDI-to-Hz conversion docs at line 81) but is NOT listed in the story's File List section.

---

Now presenting findings.

## Step 4: Findings

**CODE REVIEW FINDINGS, Michael!**

**Story:** `docs/implementation-artifacts/22-1-migrate-frequencycalculation-to-domain-types.md`
**Git vs Story Discrepancies:** 1 found
**Issues Found:** 0 High, 3 Medium, 3 Low

---

### MEDIUM ISSUES

**M1: File List incomplete ‚Äî `docs/project-context.md` not documented**
`docs/project-context.md` was modified in commit `e5cb19a` (line 81 updated to document `Pitch.frequency()` / `Pitch(frequency:)` as canonical conversion methods), but the story's File List omits it. The File List should document all changed files.
- **File:** story file, File List section
- **Fix:** Add `docs/project-context.md` to the Modified section

**M2: PitchMatchingSessionTests compute expected frequencies using production code**
`PitchMatchingSessionTests.swift:125` and `:151-152` compute expected values using `Pitch(note:cents:).frequency()` ‚Äî the same production method being tested indirectly. Per review finding M3 from story 21.3: "Test values must be independently computed, not mirror production formula." While these are integration tests (testing session behavior, not math), using hardcoded values like `440.0` for A4@440Hz would be more robust.
- **File:** `PeachTests/PitchMatching/PitchMatchingSessionTests.swift:125,151-152`
- **Fix:** Replace `Pitch(note: MIDINote(69), cents: Cents(0)).frequency(referencePitch: Frequency(440.0)).rawValue` with `440.0` directly

**M3: Outdated function name references deleted concept**
`ComparisonSessionIntegrationTests.swift:22` has function `usesCorrectFrequencyCalculation()` ‚Äî the name references `FrequencyCalculation` which no longer exists. While this is a function name (not a type reference), it perpetuates terminology from the deleted utility.
- **File:** `PeachTests/Comparison/ComparisonSessionIntegrationTests.swift:22`
- **Fix:** Rename to `usesCorrectFrequencies()` or `playsCorrectFrequencies()`

---

### LOW ISSUES

**L1: MARK comment references deleted test file**
`PitchTests.swift:133`: `// MARK: - Forward Conversion Edge Cases (migrated from FrequencyCalculationTests)` ‚Äî references a file that no longer exists. The provenance note is nice but could confuse future readers.
- **File:** `PeachTests/Core/Audio/PitchTests.swift:133`
- **Fix:** Change to `// MARK: - Forward Conversion Edge Cases`

**L2: Boundary clamping tests don't verify cents behavior**
`PitchTests.swift:297-308` ‚Äî tests `inverseBelowRange` and `inverseAboveRange` only assert on `pitch.note` but don't verify `pitch.cents`. When MIDI is clamped but `cents` is computed from the unclamped `roundedMidi`, the cents value is still valid (-50..+50), but asserting this would make the tests more complete.
- **File:** `PeachTests/Core/Audio/PitchTests.swift:297-308`
- **Fix:** Add `#expect(pitch.cents.rawValue >= -50.0 && pitch.cents.rawValue <= 50.0)` to both tests

**L3: SoundFontNotePlayerTests pitch bend test uses unnecessary indirection**
`SoundFontNotePlayerTests.swift:60-61` creates a `Pitch(frequency:)` to derive `cents` when the expected value is known to be `Cents(0)`. The test could pass `Cents(0)` directly, avoiding coupling to the inverse conversion.
- **File:** `PeachTests/Core/Audio/SoundFontNotePlayerTests.swift:60-61`
- **Fix:** Replace with `SoundFontNotePlayer.pitchBendValue(forCents: Cents(0))`

---

What should I do with these issues?

1. **Fix them automatically** ‚Äî I'll update the code and tests
2. **Create action items** ‚Äî Add to story Tasks/Subtasks for later
3. **Show me details** ‚Äî Deep dive into specific issues

Choose [1], [2], or specify which issue to examine:

### üßë Human (18:56:57)

1

### ü§ñ Assistant (18:57:31)

Fixing all issues now. Let me apply the fixes in parallel.

### ü§ñ Assistant (18:57:55)

Now fixing M3, L1, L2, and L3.

### ü§ñ Assistant (18:58:16)

Good, all code fixes applied. The "No such module 'Testing'" diagnostics are SourceKit false positives ‚Äî Swift Testing compiles through Xcode only.

Now let me run the full test suite to verify nothing broke.

### ü§ñ Assistant (19:04:20)

All **643 tests passed, 0 failed**. Now let me update the story file ‚Äî add `docs/project-context.md` to File List, add review notes, and update the Change Log.

### ü§ñ Assistant (19:04:35)

Now let me proceed to **Step 5: Update story status and sync sprint tracking**.

All HIGH and MEDIUM issues are fixed. All ACs are fully implemented. All 643 tests pass.

### ü§ñ Assistant (19:04:44)

Sprint status synced: `22-1-migrate-frequencycalculation-to-domain-types` ‚Üí done

Now let me commit the fixes.

### ü§ñ Assistant (19:05:18)

---

**Review Complete!**

**Story Status:** done
**Issues Fixed:** 6 (3 Medium + 3 Low)
**Action Items Created:** 0

**Summary of fixes applied:**

| # | Severity | Fix |
|---|----------|-----|
| M1 | MEDIUM | Added `docs/project-context.md` and `ComparisonSessionIntegrationTests.swift` to story File List |
| M2 | MEDIUM | Replaced `Pitch.frequency()` calls in PitchMatchingSessionTests with hardcoded `440.0` and independent formula `440.0 * pow(2.0, offset/1200.0)` |
| M3 | MEDIUM | Renamed `usesCorrectFrequencyCalculation()` ‚Üí `playsCorrectFrequencies()` |
| L1 | LOW | Removed stale `(migrated from FrequencyCalculationTests)` from MARK comment |
| L2 | LOW | Added cents range assertions to boundary clamping tests |
| L3 | LOW | Simplified pitch bend center test to use `Cents(0)` directly |

All 643 tests pass. Story marked **done**. Sprint status synced.

---

[‚Üê Previous (d6f3a93a2e)](d6f3a93a2e.md) | [Index](index.md) | [Next (e5cb19a518) ‚Üí](e5cb19a518.md)
